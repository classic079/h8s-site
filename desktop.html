<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTC Overview — v1.6.3</title>
<style>
  :root{
    --bg:#0e0f13; --panel:#151823; --panel-2:#10131b; --text:#e5e7eb; --muted:#9aa3b2;
    --accent:#4da3ff; --up:#16c784; --down:#ff4d4d; --gap:16px; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui;overflow-x:hidden;}
  .wrap{max-width:1680px;margin:20px auto 40px;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;}
  header h1{margin:0;font-size:18px;font-weight:700}
  .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #27324a;background:#0b1220;color:#cbd5e1}
  .badge{font-size:12px;color:var(--muted)}

  /* Grid fixed for better fit */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(360px,1fr));
    gap:var(--gap);
    justify-content:center;
    align-items:start;
  }

  .col{
    background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
    border-radius:var(--radius);
    padding:12px;
    display:flex;
    flex-direction:column;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }

  /* Top row in each card */
  .title{display:flex;justify-content:space-between;align-items:center}
  .tf{color:var(--muted);font-weight:700;font-size:12px}
  .topbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
  .pill{font-size:12px;padding:3px 12px;border-radius:999px;border:1px solid #27324a;background:#0b1220;color:#cbd5e1;white-space:nowrap}
  .pill.up{background:var(--up);border-color:transparent;color:#09130e}
  .pill.down{background:var(--down);border-color:transparent;color:#140808}
  .pill.muted{background:#0b1220;color:#cbd5e1;border:1px solid #27324a}

  .chartCard{background:rgba(255,255,255,.02);border-radius:12px;height:200px;margin-top:8px}
  .volumeCard{background:rgba(255,255,255,.02);border-radius:12px;height:165px;margin-top:8px}

  #errOverlay{position:fixed;inset:12px auto auto 12px;max-width:520px;z-index:9999;
    background:#1b1b1b;border:1px solid #e11d48;color:#fff;border-radius:10px;padding:10px 12px;
    box-shadow:0 12px 30px rgba(0,0,0,.5);display:none;font:12px/1.4 ui-sans-serif,system-ui}
  #errOverlay pre{white-space:pre-wrap;margin:6px 0 0;color:#fde68a}

  @media (max-width:1280px){.grid{grid-template-columns:repeat(auto-fit,minmax(340px,1fr))}}
  @media (max-width:740px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BTC Overview</h1>
    <div class="meta">
      <span class="chip" id="ver">v1.6.3</span>
      <span class="badge" id="histStatus">History: loading…</span>
      <span class="badge" id="liveStatus">Live: starting…</span>
      <span class="chip" id="jsStatus" style="border-color:#2e7d32;color:#b7f5c8">JS: booting…</span>
    </div>
  </header>
  <section class="grid" id="dashboard"></section>
</div>

<div id="errOverlay">
  <strong>Script error</strong>
  <div id="errMsg"></div>
  <pre id="errStack"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(function safeBoot(){
  try{
    const APP_VERSION = 'v1.6.3';
    const TF = [
      { key:'24h', label:'24 HOURS', win:24*60*60*1000, sample:30000, granEX:3600, bin:12, bitstampStep:3600 },
      { key:'8h',  label:'8 HOURS',  win: 8*60*60*1000, sample:15000, granEX: 900, bin:12, bitstampStep: 900 },
      { key:'1h',  label:'1 HOUR',   win: 1*60*60*1000, sample: 5000, granEX:  60, bin:12, bitstampStep:  60 },
      { key:'10m', label:'10 MIN',   win:10*60*1000,    sample: 2000, granEX:  60, bin:12, bitstampStep:  60 }
    ];

    const dash = document.getElementById('dashboard');
    const jsStatus = document.getElementById('jsStatus');
    const histEl = document.getElementById('histStatus');
    const liveEl = document.getElementById('liveStatus');
    document.getElementById('ver').textContent = APP_VERSION;

    let html='';
    for(const t of TF){
      html += `
      <div class="col">
        <div class="title">
          <div class="tf">${t.label}</div>
          <div class="topbar">
            <span class="pill muted" id="tfc-${t.key}">—</span>
            <span class="pill muted" id="hlc-${t.key}">H/L — / —</span>
            <span class="pill muted" id="volc-${t.key}">Vol —</span>
          </div>
        </div>
        <div class="chartCard"><canvas id="c-${t.key}"></canvas></div>
        <div class="volumeCard"><canvas id="v-${t.key}"></canvas></div>
      </div>`;
    }
    dash.innerHTML = html;

    const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const state = {};
    let lastPriceGlobal = 65000;
    let lastVolGlobal   = 1;

    const avgLinePlugin = {
      id:'avgLine',
      afterDatasetsDraw(chart,_,opts){
        if(!opts || !opts.enabled) return;
        const arr = opts.getData?.() || [];
        if(!Array.isArray(arr) || arr.length === 0) return;
        const avg = arr.reduce((s,x)=>s+(+x||0),0)/arr.length;
        const y = chart.scales.y.getPixelForValue(avg);
        const ca = chart.chartArea, ctx = chart.ctx;
        ctx.save();
        ctx.setLineDash([6,6]);
        ctx.strokeStyle = 'rgba(255,255,255,0.35)';
        ctx.beginPath(); ctx.moveTo(ca.left,y); ctx.lineTo(ca.right,y); ctx.stroke();
        ctx.restore();
      }
    };

    function toRGBA(hex6,a){
      let h=(hex6||'#4da3ff').replace('#','');
      if(h.length!==6) return `rgba(77,163,255,${a})`;
      const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }

    function makeLineChart(ctx, key){
      const is10 = key==='10m';
      return new Chart(ctx,{
        type:'line',
        data:{labels:[],datasets:[{
          data:[],
          borderColor: cssVar('--accent')||'#4da3ff',
          borderWidth: is10?3:2,
          pointRadius:0,
          tension:is10?0.25:0,
          stepped:false,
          fill:is10,
          backgroundColor:'transparent'
        }]},
        options:{
          responsive:true,maintainAspectRatio:false,animation:{duration:0},
          plugins:{
            legend:{display:false},
            tooltip:{mode:'index',intersect:false,displayColors:false},
            avgLine: is10 ? {enabled:true,getData:()=>state['10m']?.arr?.map(p=>p.price)||[]} : {enabled:false}
          },
          scales:{
            x:{ticks:{display:false},grid:{display:false}},
            y:{ticks:{color:'#7f8796'},grid:{color:key==='10m'?'transparent':'rgba(255,255,255,.05)'}}
          }
        },
        plugins:is10?[avgLinePlugin]:[]
      });
    }

    function makeBarChart(ctx){
      return new Chart(ctx,{
        type:'bar',
        data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},
        options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:'#7f8796'}},y:{ticks:{display:false}}}}
      });
    }

    function computeTrendColor(key){
      const a=state[key].arr;
      if(a.length<2) return cssVar('--accent')||'#4da3ff';
      return (a[a.length-1].price>=a[0].price)?cssVar('--up'):cssVar('--down');
    }

    function applyAreaGradIf10(key){
      if(key!=='10m') return;
      const b=state[key], ch=b.pc, ca=ch.chartArea; if(!ca) return;
      const col=b.trendColor||cssVar('--accent')||'#4da3ff';
      const g=ch.ctx.createLinearGradient(0,ca.top,0,ca.bottom);
      g.addColorStop(0,toRGBA(col,0.24)); g.addColorStop(1,toRGBA(col,0.02));
      ch.data.datasets[0].backgroundColor=g;
    }

    const fmtUSD=n=>'$'+(n??0).toLocaleString(undefined,{maximumFractionDigits:2});
    const fmtVOL=n=>(n??0).toLocaleString(undefined,{maximumFractionDigits:3});

    function updateTopbar(key, prices, vols){
      const tfPill=document.getElementById(`tfc-${key}`);
      const hlPill=document.getElementById(`hlc-${key}`);
      const volPill=document.getElementById(`volc-${key}`);

      if(!prices.length){
        tfPill.textContent='—';tfPill.className='pill muted';
        hlPill.textContent='H/L — / —';hlPill.className='pill muted';
        volPill.textContent='Vol —';volPill.className='pill muted';
        return;
      }
      const first=prices[0],last=prices[prices.length-1];
      const delta=last-first;const pct=first?(delta/first)*100:0;
      const arrow=delta>=0?'▲':'▼';
      tfPill.textContent=`${arrow} ${fmtUSD(Math.abs(delta))} (${Math.abs(pct).toFixed(2)}%)`;
      tfPill.className='pill '+(delta>=0?'up':'down');

      const hi=Math.max(...prices),lo=Math.min(...prices);
      hlPill.textContent=`H/L ${fmtUSD(hi)} / ${fmtUSD(lo)}`;
      const volSum=(vols||[]).reduce((s,v)=>s+(+v||0),0);
      volPill.textContent=`Vol ${fmtVOL(volSum)}`;
    }

    function redraw(key){
      const tf=TF.find(x=>x.key===key),b=state[key],now=Date.now();
      b.arr=b.arr.filter(pt=>pt.t>=now-tf.win);
      b.trendColor=computeTrendColor(key);

      const labels=b.arr.map(pt=>new Date(pt.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
      const prices=b.arr.map(pt=>pt.price);
      const vols=b.arr.map(pt=>pt.vol||0);

      const pc=b.pc;
      pc.data.labels=labels;pc.data.datasets[0].data=prices;pc.data.datasets[0].borderColor=b.trendColor;
      applyAreaGradIf10(key);pc.update('none');

      updateTopbar(key,prices,vols);

      const bins=tf.bin,start=now-tf.win,w=tf.win/bins;
      const ag=Array.from({length:bins},(_,i)=>({start:start+i*w,vol:0,first:null,last:null}));
      for(const pt of b.arr){
        const i=Math.min(bins-1,Math.max(0,Math.floor((pt.t-start)/w)));
        const bin=ag[i];bin.vol+=(pt.vol||0);if(bin.first==null)bin.first=pt.price;bin.last=pt.price;
      }
      const vc=b.vc;
      vc.data.labels=ag.map(x=>new Date(x.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
      vc.data.datasets[0].data=ag.map(x=>x.vol);
      vc.data.datasets[0].backgroundColor=ag.map(x=>x.first==null?'#b9c2d0':(x.last>=x.first?cssVar('--up'):cssVar('--down')));
      vc.update('none');
    }

    for(const t of TF){
      state[t.key]={arr:[],tLast:0,trendColor:cssVar('--accent')||'#4da3ff',
        pc:makeLineChart(document.getElementById('c-'+t.key).getContext('2d'),t.key),
        vc:makeBarChart(document.getElementById('v-'+t.key).getContext('2d'))};
    }
    jsStatus.textContent='JS: loaded';

    async function pollLive(){
      try{
        const r1=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/ticker');
        if(r1.ok){const j=await r1.json();const p=parseFloat(j.price||j.last||j.bid||j.ask);
          if(Number.isFinite(p)){onQuote(p,parseFloat(j.size||j.volume||0.1)||0.1);liveEl.textContent='Live: Coinbase · '+APP_VERSION;return;}
        }
      }catch{}
      onQuote(lastPriceGlobal+(Math.random()-0.5)*20,Math.random()*2);
    }

    function onQuote(p,v){
      lastPriceGlobal=p;lastVolGlobal=v||lastVolGlobal;
      const n=Date.now();
      for(const t of TF){
        const b=state[t.key];
        if(n-b.tLast>=t.sample){b.arr.push({t:n,price:p,vol:v});b.tLast=n;}
        redraw(t.key);
      }
    }

    async function preload(){
      let source='mock';
      const now=Date.now();
      for(const tf of TF){
        const b=state[tf.key];let p=lastPriceGlobal;b.arr=[];
        const st=Math.max(2000,Math.floor(tf.win/60));
        for(let t=now-tf.win;t<=now;t+=st){p+=(Math.random()-0.5)*15;b.arr.push({t,price:p,vol:Math.random()*2});}
        b.tLast=now;redraw(tf.key);
      }
      histEl.textContent='History: mock · '+APP_VERSION;
    }

    preload(); pollLive(); setInterval(pollLive,2000);
    jsStatus.textContent='JS: running';
  }catch(err){
    const box=document.getElementById('errOverlay');
    document.getElementById('errMsg').textContent=err?.message||err;
    document.getElementById('errStack').textContent=err?.stack||'';
    box.style.display='block';
  }
})();
</script>
</body>
</html>
