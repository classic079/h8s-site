<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTC Overview — v1.9.0 WEBSOCKET</title>
<style>
  :root{
    --bg:#0e0f13; --panel:#151823; --panel-2:#10131b; --text:#e5e7eb; --muted:#9aa3b2;
    --accent:#4da3ff; --up:#16c784; --down:#ff4d4d; --gap:10px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui;overflow-x:hidden}
  .wrap{max-width:1920px;margin:16px auto 28px;padding:0 24px}
  header{display:grid;grid-template-columns:1fr minmax(360px,720px) 1fr;align-items:center;gap:8px;margin-bottom:10px}
  .metaLeft,.metaRight{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .metaRight{justify-self:end}
  .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #27324a;background:#0b1220;color:#cbd5e1}
  .badge{font-size:12px;color:var(--muted)}
  .pane{background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);border-radius:12px;padding:6px 12px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;box-shadow:0 3px 10px rgba(0,0,0,.24)}
  .pane label{color:#cbd5e1;font-weight:700;margin-right:12px}
  #headerPrice{justify-self:center;font-weight:900;font-size:clamp(20px,3.2vw,36px);letter-spacing:.2px;transition:color .18s,filter .18s}
  #headerPrice.up{color:var(--up);filter:drop-shadow(0 0 6px rgba(22,199,132,.22))}
  #headerPrice.down{color:#ff4d4d;filter:drop-shadow(0 0 6px rgba(255,77,77,.22))}
  #headerClock{justify-self:end;color:var(--muted);font-weight:600;font-variant-numeric:tabular-nums}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  @media (max-width:1500px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  .col{background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);border-radius:10px;padding:8px;display:flex;flex-direction:column;box-shadow:0 3px 12px rgba(0,0,0,.25)}
  .title{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .tf{color:var(--muted);font-weight:800;font-size:12px}
  .topbar{display:flex;gap:6px;flex-wrap:wrap}
  .pill{font-size:12px;padding:3px 10px;border-radius:999px;border:1px solid #27324a;background:#0b1220;color:#cbd5e1;white-space:nowrap}
  .pill.up{background:var(--up);border-color:transparent;color:#06140e}
  .pill.down{background:var(--down);border-color:transparent;color:#140808}
  .pill.muted{background:#0b1220;color:#cbd5e1;border:1px solid #27324a}
  .chartCard{background:rgba(255,255,255,.02);border-radius:8px;height:210px;margin-top:6px}
  .volumeCard{background:rgba(255,255,255,.02);border-radius:8px;height:170px;margin-top:6px}
  .biasRow{display:flex;align-items:center;gap:10px;margin:8px 6px 0}
  .gLabel{font-size:12px;opacity:.9}
  .gLabel.buy{color:var(--up)} .gLabel.sell{color:#f59e0b}
  .gaugeWrap{position:relative;flex:1}
  #biasGauge{height:22px;width:100%;border-radius:999px;background:transparent;box-shadow:inset 0 0 0 1px rgba(255,255,255,.12)}
  .needle{position:absolute;top:2px;width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:10px solid #fff;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35));transition:left .2s ease}
  .needleValue{position:absolute;top:-14px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;border:1px solid rgba(255,255,255,.25)}
  .error-banner{background:#ff4d4d22;border:1px solid #ff4d4d;color:#ffaaaa;padding:12px;border-radius:8px;margin-bottom:12px;font-size:13px}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="metaLeft">
      <span class="chip" id="ver">v1.9.0</span>
      <span class="badge" id="histStatus">History: loading…</span>
      <span class="badge" id="liveStatus">Live: starting…</span>
    </div>
    <div class="pane">
      <label>BTC/USD</label>
      <div id="headerPrice">$—</div>
      <div id="headerClock">—:—:—</div>
    </div>
    <div class="metaRight"><span class="chip" style="border-color:#2e7d32;color:#b7f5c8">JS: running</span></div>
  </header>
  <div id="errorBanner" style="display:none" class="error-banner"></div>
  <section class="grid" id="dashboard"></section>
</div>

<script>
  const APP_VERSION = 'v1.9.0 WEBSOCKET';
  const TF = [
    { key:'24h', label:'24 HOURS', win:24*60*60*1000, sample:30000, bin:12 },
    { key:'8h',  label:'8 HOURS',  win: 8*60*60*1000, sample:15000, bin:12 },
    { key:'1h',  label:'1 HOUR',   win: 1*60*60*1000, sample: 5000, bin:12 },
    { key:'10m', label:'10 MIN',   win:10*60*1000,    sample: 2000, bin:12 }
  ];
  document.getElementById('ver').textContent = APP_VERSION;

  const dash = document.getElementById('dashboard');
  dash.innerHTML = TF.map(t =>
    `<div class="col">
       <div class="title">
         <div class="tf">${t.label}</div>
         <div class="topbar">
           <span class="pill muted" id="tfc-${t.key}">—</span>
           <span class="pill muted" id="hlc-${t.key}">H/L — / —</span>
           <span class="pill muted" id="volc-${t.key}">Vol —</span>
         </div>
       </div>
       <div class="chartCard"><canvas id="c-${t.key}"></canvas></div>
       ${t.key==='10m'
         ? `<div class="biasRow">
              <span class="gLabel buy">Buys</span>
              <div class="gaugeWrap">
                <canvas id="biasGauge"></canvas>
                <div id="needle" class="needle" style="left:50%"></div>
                <div id="needleValue" class="needleValue" style="left:50%">0%</div>
              </div>
              <span class="gLabel sell">Sells</span>
            </div>`
         : ``}
       <div class="volumeCard"><canvas id="v-${t.key}"></canvas></div>
     </div>`
  ).join('');

  const headClock = document.getElementById('headerClock');
  headClock.textContent = new Date().toLocaleTimeString();
  setInterval(()=> headClock.textContent = new Date().toLocaleTimeString(), 1000);
</script>

<script>
(function(){
  const histEl = document.getElementById('histStatus');
  const liveEl = document.getElementById('liveStatus');
  const headPrice = document.getElementById('headerPrice');
  const errorBanner = document.getElementById('errorBanner');

  const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  const stateMap = {};
  let lastPriceGlobal = 95000; // Updated starting price
  let lastHeader = null;
  let wsConnection = null;
  let apiFailCount = 0;

  function showError(msg){
    errorBanner.textContent = msg;
    errorBanner.style.display = 'block';
    setTimeout(() => errorBanner.style.display = 'none', 5000);
  }

  // Charts
  function areaFill(chart,color){
    const ca=chart.chartArea; if(!ca) return null;
    const g=chart.ctx.createLinearGradient(0,ca.top,0,ca.bottom);
    g.addColorStop(0, color.replace('rgb','rgba').replace(')',' ,0.22)'));
    g.addColorStop(1, color.replace('rgb','rgba').replace(')',' ,0.02)'));
    return g;
  }
  function makeLineChart(ctx,key){
    const smooth=(key==='10m');
    return new Chart(ctx,{
      type:'line',
      data:{labels:[],datasets:[{data:[],borderColor:'#4da3ff',borderWidth:smooth?3:2,pointRadius:0,tension:smooth?0.25:0,fill:smooth,backgroundColor:'transparent'}]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},
        plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,displayColors:false}},
        scales:{x:{ticks:{display:false},grid:{display:false}},y:{ticks:{color:'#7f8796'},grid:{color:key==='10m'?'transparent':'rgba(255,255,255,.05)'}}}
    });
  }
  function makeBarChart(ctx){
    return new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#7f8796'}},y:{ticks:{display:false}}}});
  }
  function trendColor(arr){ if(arr.length<2) return '#4da3ff'; return (arr[arr.length-1].price>=arr[0].price)?cssVar('--up'):'#ff4d4d'; }
  function fmtUSD(n){ return '$'+(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmtVOL(n){ return (n||0).toLocaleString(undefined,{maximumFractionDigits:3}); }
  function setHeaderPrice(p){
    headPrice.classList.remove('up','down');
    headPrice.textContent=fmtUSD(p);
    if(lastHeader!=null){ if(p>lastHeader) headPrice.classList.add('up'); else if(p<lastHeader) headPrice.classList.add('down'); }
    lastHeader=p;
  }

  // Gauge
  let needlePos=0.5;
  const biasGauge=document.getElementById('biasGauge');
  const needle=document.getElementById('needle');
  const needleValue=document.getElementById('needleValue');
  function drawGauge(buy,sell){
    if(!biasGauge) return;
    const ctx=biasGauge.getContext('2d'), w=biasGauge.width=biasGauge.offsetWidth, h=biasGauge.height=biasGauge.offsetHeight;
    ctx.clearRect(0,0,w,h);
    const tot=buy+sell, target=tot?(buy/tot):0.5; needlePos += (target-needlePos)*0.25;
    const up=cssVar('--up'), dn=cssVar('--down'), g=ctx.createLinearGradient(0,0,w,0);
    g.addColorStop(0, up); g.addColorStop(Math.max(0,needlePos-0.001), up);
    g.addColorStop(Math.min(1,needlePos+0.001), dn); g.addColorStop(1, dn);
    const r=h/2;
    ctx.fillStyle=g;
    ctx.beginPath(); ctx.moveTo(r,1); ctx.lineTo(w-r,1);
    ctx.arcTo(w-1,1,w-1,r,r); ctx.lineTo(w-1,h-r); ctx.arcTo(w-1,h-1,w-r,h-1,r);
    ctx.lineTo(r,h-1); ctx.arcTo(1,h-1,1,h-r,r); ctx.lineTo(1,r); ctx.arcTo(1,1,r,1,r); ctx.fill();
    ctx.globalAlpha=.18; ctx.fillStyle=(needlePos>=0.5)?up:dn;
    const domW=(needlePos>=0.5)?(w*needlePos):(w*(1-needlePos)); const domX=(needlePos>=0.5)?0:(w*needlePos);
    ctx.fillRect(domX,1,domW,h-2); ctx.globalAlpha=1;
    const leftPx = Math.round(biasGauge.getBoundingClientRect().width * needlePos);
    needle.style.left = leftPx+'px';
    const biasPct = tot ? ((buy - sell)/tot)*100 : 0;
    needleValue.textContent = (biasPct>=0?'+':'')+biasPct.toFixed(0)+'%';
    needleValue.style.left = leftPx+'px';
  }

  // Build charts
  TF.forEach(t=>{
    stateMap[t.key]={arr:[],tLast:0,
      pc:makeLineChart(document.getElementById('c-'+t.key).getContext('2d'),t.key),
      vc:makeBarChart(document.getElementById('v-'+t.key).getContext('2d'))
    };
  });

  function redraw(key){
    const tf=TF.find(x=>x.key===key), s=stateMap[key], now=Date.now();
    s.arr=s.arr.filter(pt=>pt.t>=now-tf.win);
    const labels=s.arr.map(pt=>new Date(pt.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
    const prices=s.arr.map(pt=>pt.price), vols=s.arr.map(pt=>pt.vol||0);

    const pc=s.pc; pc.data.labels=labels; pc.data.datasets[0].data=prices;
    const col=trendColor(s.arr); pc.data.datasets[0].borderColor=col;
    if(key==='10m'){ const fill=areaFill(pc,col.replace('#','rgb(')); if(fill) pc.data.datasets[0].backgroundColor=fill; }
    pc.update('none');

    const tfP=document.getElementById('tfc-'+key), hlP=document.getElementById('hlc-'+key), voP=document.getElementById('volc-'+key);
    if(prices.length){
      const first=prices[0], last=prices.at(-1), delta=last-first, pct=first?(delta/first)*100:0;
      tfP.textContent=(delta>=0?'▲ ':'▼ ')+fmtUSD(Math.abs(delta))+' ('+Math.abs(pct).toFixed(2)+'%)';
      tfP.className='pill '+(delta>=0?'up':'down');
      hlP.textContent='H/L '+fmtUSD(Math.max(...prices))+' / '+fmtUSD(Math.min(...prices));
      voP.textContent='Vol '+fmtVOL(vols.reduce((a,b)=>a+(+b||0),0));
    }else{
      tfP.textContent='—'; tfP.className='pill muted'; hlP.textContent='H/L — / —'; voP.textContent='Vol —';
    }

    const bins=tf.bin, start=now-tf.win, w=tf.win/bins, ag=[...Array(bins)].map((_,i)=>({start:start+i*w,vol:0,first:null,last:null}));
    s.arr.forEach(pt=>{ const i=Math.min(bins-1,Math.max(0,Math.floor((pt.t-start)/w))); const b=ag[i]; b.vol+=(pt.vol||0); if(b.first===null) b.first=pt.price; b.last=pt.price; });

    const vc=s.vc;
    vc.data.labels=ag.map(x=>new Date(x.start).toLocaleTimeString([],{minute:'2-digit'}));
    vc.data.datasets[0].data=ag.map(x=>x.vol);
    vc.data.datasets[0].backgroundColor=ag.map(x=> x.first===null ? '#7f8796' : (x.last>=x.first?cssVar('--up'):cssVar('--down')) );
    vc.update('none');

    if(key==='10m'){
      let buy=0,sell=0; ag.forEach(x=>{ if(x.first!==null){ (x.last>=x.first?buy:sell)+=x.vol; } });
      drawGauge(buy,sell);
    }
  }

  // Enhanced realistic seed data
  (function seed(){
    const now=Date.now();
    let basePrice = lastPriceGlobal;
    
    TF.forEach(t=>{
      const s=stateMap[t.key];
      const points = 48;
      const step = t.win / points;
      let p = basePrice;
      
      for(let i=points; i>0; i--){ 
        // More realistic price movement
        const volatility = 100;
        const trend = (Math.random() - 0.48) * volatility; // Slight upward bias
        p += trend;
        p = Math.max(basePrice * 0.95, Math.min(basePrice * 1.05, p)); // Keep within 5% range
        
        s.arr.push({
          t: now - i * step,
          price: p,
          vol: Math.random() * 10 + 5 // Random volume 5-15
        }); 
      }
      redraw(t.key);
    });
    
    setHeaderPrice(lastPriceGlobal);
    histEl.textContent='History: Simulated data (APIs loading...)';
  })();

  const good = v => Number.isFinite(v) && v>0;

  // Try JSONP approach for better CORS handling
  function tryJSONP(url){
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      const callbackName = 'jsonp_' + Date.now();
      
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        resolve(data);
      };
      
      script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
      script.onerror = () => {
        delete window[callbackName];
        document.body.removeChild(script);
        reject(new Error('JSONP failed'));
      };
      
      setTimeout(() => {
        if (window[callbackName]) {
          delete window[callbackName];
          if(document.body.contains(script)) document.body.removeChild(script);
          reject(new Error('JSONP timeout'));
        }
      }, 5000);
      
      document.body.appendChild(script);
    });
  }

  // Use CryptoCompare API (better CORS support)
  function fetchCryptoCompare(){
    const url = 'https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=USD';
    return fetch(url, {mode: 'cors'})
      .then(r => r.json())
      .then(j => {
        if(j && j.USD && good(j.USD)){
          return {price: j.USD, source: 'CryptoCompare'};
        }
        throw new Error('Invalid data');
      });
  }

  // Try Blockchain.info API
  function fetchBlockchain(){
    return fetch('https://blockchain.info/ticker', {mode: 'cors'})
      .then(r => r.json())
      .then(j => {
        if(j && j.USD && j.USD.last && good(j.USD.last)){
          return {price: j.USD.last, source: 'Blockchain.info'};
        }
        throw new Error('Invalid data');
      });
  }

  // WebSocket connection to Binance (most reliable)
  function connectWebSocket(){
    try {
      if(wsConnection) wsConnection.close();
      
      wsConnection = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
      
      wsConnection.onopen = () => {
        console.log('WebSocket connected to Binance');
        liveEl.textContent = 'Live: Binance WebSocket ✓';
      };
      
      wsConnection.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if(data.p && good(parseFloat(data.p))){
            onQuote(parseFloat(data.p), parseFloat(data.q) || 0.1);
            liveEl.textContent = 'Live: Binance WebSocket ✓';
            apiFailCount = 0;
          }
        } catch(e) {
          console.error('WebSocket parse error:', e);
        }
      };
      
      wsConnection.onerror = (error) => {
        console.error('WebSocket error:', error);
        liveEl.textContent = 'Live: WebSocket error, retrying...';
      };
      
      wsConnection.onclose = () => {
        console.log('WebSocket closed, will retry...');
        liveEl.textContent = 'Live: Reconnecting...';
        setTimeout(connectWebSocket, 5000);
      };
      
    } catch(e) {
      console.error('WebSocket connection failed:', e);
      liveEl.textContent = 'Live: WebSocket unavailable';
    }
  }

  function onQuote(p,v){
    if(!good(p)) return;
    lastPriceGlobal=p; setHeaderPrice(p);
    const n=Date.now();
    TF.forEach(t=>{
      const s=stateMap[t.key];
      if(n-s.tLast>=t.sample){ 
        s.arr.push({t:n,price:p,vol: (good(v)?v:0.1) }); 
        s.tLast=n; 
      }
      redraw(t.key);
    });
  }

  // Fallback polling if WebSocket fails
  function pollPrice(){
    fetchCryptoCompare()
      .then(result => {
        onQuote(result.price, 0.1);
        liveEl.textContent = 'Live: ' + result.source;
        apiFailCount = 0;
      })
      .catch(() => {
        return fetchBlockchain()
          .then(result => {
            onQuote(result.price, 0.1);
            liveEl.textContent = 'Live: ' + result.source;
            apiFailCount = 0;
          });
      })
      .catch(() => {
        apiFailCount++;
        if(apiFailCount > 3){
          // Simulate realistic price movement
          const change = (Math.random() - 0.5) * 50;
          lastPriceGlobal += change;
          onQuote(lastPriceGlobal, Math.random() * 10);
          liveEl.textContent = 'Live: Simulated (APIs blocked by CORS)';
          
          if(apiFailCount === 4){
            showError('⚠️ Unable to connect to cryptocurrency APIs. Displaying simulated data. This may be due to CORS restrictions or network issues.');
          }
        }
      });
  }

  // Initialize
  console.log('BTC Dashboard v1.9.0 initializing...');
  histEl.textContent = 'History: Ready (simulated data loaded)';
  
  // Try WebSocket first (best option)
  connectWebSocket();
  
  // Also poll as backup
  setTimeout(pollPrice, 2000);
  setInterval(pollPrice, 5000);
  
  // Simulate more realistic price updates even if APIs fail
  setInterval(() => {
    if(apiFailCount > 3){
      const change = (Math.random() - 0.5) * 30;
      lastPriceGlobal += change;
      onQuote(lastPriceGlobal, Math.random() * 8 + 2);
    }
  }, 2500);
  
})();
</script>
</body>
</html>
