<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTC Overview — v1.0</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{--bg:#0e0f13;--panel:#151823;--panel-2:#10131b;--text:#e5e7eb;--muted:#9aa3b2;
        --accent:#4da3ff;--up:#16c784;--down:#ff4d4d;--gap:16px;--radius:16px;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui}
  .wrap{max-width:1720px;margin:20px auto 40px;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:14px}
  header h1{margin:0;font-size:18px;font-weight:700}
  header .meta{display:flex;gap:12px;align-items:center}
  .badge{font-size:12px;color:var(--muted)}
  .version{font-size:12px;color:#cbd5e1;background:#0b1220;border:1px solid #27324a;padding:2px 8px;border-radius:999px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  .col{background:linear-gradient(180deg,var(--panel)0%,var(--panel-2)100%);border-radius:var(--radius);
       padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(0,0,0,.35);}
  .title{display:flex;justify-content:space-between}
  .tf{color:var(--muted);font-weight:700;font-size:12px}
  .price{font-weight:700}
  .chartCard{background:rgba(255,255,255,.02);border-radius:12px;height:200px;margin-top:8px}
  .volumeCard{background:rgba(255,255,255,.02);border-radius:12px;height:110px;margin-top:6px}
  @media(max-width:1280px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:740px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BTC Overview</h1>
    <div class="meta">
      <span class="version" id="ver">v1.0</span>
      <span class="badge" id="status">Loading history…</span>
    </div>
  </header>
  <section class="grid" id="dashboard"></section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const APP_VERSION='v1.0';
console.log('BTC Dashboard',APP_VERSION);

const TF=[
  {key:'24h',label:'24 HOURS',win:24*60*60e3,sample:3e4,granEX:3600,bin:12,bitstampStep:3600},
  {key:'8h', label:'8 HOURS', win:8*60*60e3,sample:15e3,granEX:900,bin:12,bitstampStep:900},
  {key:'1h', label:'1 HOUR',  win:1*60*60e3,sample:5e3,granEX:60,bin:12,bitstampStep:60},
  {key:'10m',label:'10 MIN',  win:10*60e3,sample:2e3,granEX:60,bin:12,bitstampStep:60}
];

// Build layout safely (escaped backticks)
const dash=document.getElementById('dashboard');
let html='';
for(const t of TF){
  html+=
  '<div class="col">'+
    '<div class="title"><div class="tf">'+t.label+'</div><div class="price" id="p-'+t.key+'">$—</div></div>'+
    '<div class="chartCard"><canvas id="c-'+t.key+'"></canvas></div>'+
    '<div class="volumeCard"><canvas id="v-'+t.key+'"></canvas></div>'+
  '</div>';
}
dash.innerHTML=html;

// setup
const cssVar=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const state={};
TF.forEach(t=>{
  state[t.key]={arr:[],tLast:0,
    pc:new Chart(document.getElementById('c-'+t.key).getContext('2d'),{
      type:'line',
      data:{labels:[],datasets:[{data:[],borderColor:cssVar('--accent'),borderWidth:2,fill:false,tension:0,pointRadius:0}]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},
        plugins:{legend:{display:false}},
        scales:{x:{ticks:{display:false},grid:{display:false}},
                y:{ticks:{color:'#7f8796'},grid:{color:'rgba(255,255,255,.05)'}}}}
    }),
    vc:new Chart(document.getElementById('v-'+t.key).getContext('2d'),{
      type:'bar',
      data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:'#7f8796'}},y:{ticks:{display:false}}}}
    })
  };
});

let lastPrice=65000,lastVol=1;

function redraw(tfKey){
  const t=TF.find(x=>x.key===tfKey),b=state[tfKey],now=Date.now();
  b.arr=b.arr.filter(pt=>pt.t>=now-t.win);
  const labels=b.arr.map(pt=>new Date(pt.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
  const prices=b.arr.map(pt=>pt.price);
  b.pc.data.labels=labels;b.pc.data.datasets[0].data=prices;b.pc.update('none');
  const bins=t.bin,start=now-t.win,w=t.win/bins;
  const ag=Array.from({length:bins},(_,i)=>({start:start+i*w,vol:0,first:null,last:null}));
  for(const pt of b.arr){
    const i=Math.min(bins-1,Math.max(0,Math.floor((pt.t-start)/w)));
    const bin=ag[i];bin.vol+=(pt.vol||0);if(bin.first==null)bin.first=pt.price;bin.last=pt.price;
  }
  b.vc.data.labels=ag.map(x=>new Date(x.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
  b.vc.data.datasets[0].data=ag.map(x=>x.vol);
  b.vc.data.datasets[0].backgroundColor=ag.map(x=>!x.first?'#999':(x.last>=x.first?cssVar('--up'):cssVar('--down')));
  b.vc.update('none');
}
function setBadges(p){
  TF.forEach(t=>{
    const el=document.getElementById('p-'+t.key);
    el.textContent='$'+p.toLocaleString(undefined,{maximumFractionDigits:2});
    el.style.color=p>=lastPrice?cssVar('--up'):cssVar('--down');
  });
}
function onQuote(p,v){
  lastPrice=p;lastVol=v||lastVol;
  const n=Date.now();
  TF.forEach(t=>{
    const b=state[t.key];
    if(n-b.tLast>=t.sample){b.arr.push({t:n,price:p,vol:v});b.tLast=n;}
    redraw(t.key);
  });
  setBadges(p);
}

// live price
async function pollLive(){
  const status=document.getElementById('status');
  try{
    const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/ticker',{headers:{Accept:'application/json'}});
    if(r.ok){const j=await r.json();const p=parseFloat(j.price||j.last||j.bid);if(Number.isFinite(p)){onQuote(p,1);status.textContent='Live: Coinbase · '+APP_VERSION;return;}}
  }catch{}
  try{
    const r=await fetch('https://www.bitstamp.net/api/v2/ticker/btcusd/');
    if(r.ok){const j=await r.json();const p=parseFloat(j.last);if(Number.isFinite(p)){onQuote(p,1);status.textContent='Live: Bitstamp · '+APP_VERSION;return;}}
  }catch{}
  try{
    const r=await fetch('https://api.coincap.io/v2/assets/bitcoin');
    if(r.ok){const j=await r.json();const p=parseFloat(j?.data?.priceUsd);if(Number.isFinite(p)){onQuote(p,1);status.textContent='Live: CoinCap · '+APP_VERSION;return;}}
  }catch{}
  status.textContent='Live: mock · '+APP_VERSION;
  onQuote(lastPrice+(Math.random()-0.5)*20,Math.random()*2);
}

// history
function timeout(p,ms){return Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej()),ms)]);}
async function fetchBitstamp(tf){
  const step=tf.bitstampStep;
  const limit=Math.min(1000,Math.ceil(tf.win/(step*1000))+2);
  const url='https://www.bitstamp.net/api/v2/ohlc/btcusd/?step='+step+'&limit='+limit;
  const r=await timeout(fetch(url),7000);
  if(!r.ok)throw 0;
  const j=await r.json();
  const rows=j?.data?.ohlc;
  if(!rows)return [];
  return rows.map(c=>({t:+c.timestamp*1000+step*1000,price:+c.close,vol:+c.volume||0})).sort((a,b)=>a.t-b.t);
}
async function fetchCoinbase(tf){
  const end=Math.floor(Date.now()/1000),start=end-Math.ceil(tf.win/1000);
  const url='https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity='+tf.granEX+'&start='+start+'&end='+end;
  const r=await timeout(fetch(url),7000);
  if(!r.ok)throw 0;
  const rows=await r.json();
  if(!Array.isArray(rows))return [];
  rows.sort((a,b)=>a[0]-b[0]);
  return rows.map(([ts,,,,close,vol])=>({t:ts*1000+tf.granEX*1000,price:+close,vol:+vol||0}));
}
async function preload(){
  const status=document.getElementById('status');
  let source='mock';
  for(const tf of TF){
    let arr=null;
    try{arr=await fetchBitstamp(tf);source='Bitstamp';}
    catch{try{arr=await fetchCoinbase(tf);source='Coinbase';}catch{}}
    if(arr&&arr.length){
      const b=state[tf.key];b.arr=arr;b.tLast=b.arr[b.arr.length-1].t;redraw(tf.key);
    }else{
      const now=Date.now();const b=state[tf.key];let p=lastPrice;b.arr=[];
      for(let t=now-tf.win;t<=now;t+=Math.max(2000,tf.win/60)){p+=(Math.random()-0.5)*15;b.arr.push({t,price:p,vol:Math.random()*2});}
      redraw(tf.key);
    }
  }
  status.textContent='History: '+source+' · '+APP_VERSION;
}

// boot
(async function(){
  const timeoutFail=setTimeout(()=>{
    console.warn('Fallback to mock');
    const now=Date.now();
    TF.forEach(tf=>{
      const b=state[tf.key];let p=lastPrice;b.arr=[];
      for(let t=now-tf.win;t<=now;t+=Math.max(2000,tf.win/60)){p+=(Math.random()-0.5)*15;b.arr.push({t,price:p,vol:Math.random()*2});}
      redraw(tf.key);
    });
    document.getElementById('status').textContent='History: mock · '+APP_VERSION;
  },5000);

  try{await preload();}finally{clearTimeout(timeoutFail);}
  await pollLive();
  setInterval(pollLive,2000);
})();
</script>
</body>
</html>
