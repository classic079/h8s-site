<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coinbase Stalker — Desktop Multi-Range</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.12); --grid-2:rgba(255,255,255,.10);
    --pill-bg:rgba(0,0,0,.80); --pill-bd:rgba(255,255,255,.25);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

  /* Tiny outer margins; full width */
  .wrap{padding:8px 10px 40px; max-width:100%; margin:0 auto;}
  h1{margin:6px 4px 12px; font-size:22px; letter-spacing:.3px; opacity:.95}

  /* 4-up grid, collapses if screen is small */
  .grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(280px, 1fr));
    gap:10px;
  }

  .card{
    background:var(--panel);
    border-radius:14px;
    box-shadow:var(--glow);
    padding:10px;
    display:flex;
    flex-direction:column;
    min-height: 640px;
  }

  .titleRow{display:flex; align-items:center; gap:8px; margin-bottom:6px}
  .ttl{font-weight:800; font-size:12px; letter-spacing:.6px; text-transform:uppercase; opacity:.9}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:5px 9px;
        border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd);
        font-size:11px; white-space:nowrap; color:#fff;}

  .chart{height:240px; border-radius:12px; background:var(--panel-2); margin-bottom:8px}
  .gaugeRow{display:flex; align-items:center; gap:10px; margin:4px 0}
  .gauge{height:24px; border-radius:999px; background:transparent; box-shadow:inset 0 0 0 1px rgba(255,255,255,.14); flex:1}
  .gLbl{font-size:12px; opacity:.9}
  .gLbl.buy{color:var(--up)} .gLbl.sell{color:var(--down)}
  .needle{position:relative; top:3px; width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-top:10px solid #fff; filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  .needleWrap{position:relative}
  .needleAbs{position:absolute; top:0; left:0}

  .vol{height:170px; border-radius:12px; background:var(--panel-2); margin-top:6px}
  .pillRow{display:flex; align-items:center; gap:8px; margin:6px 2px 0}
  .spacer{flex:1}

  .tops{flex:1; border-radius:12px; background:var(--panel-2); margin-top:8px; padding:8px}
  .topsGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; height:100%}
  .topsCol{overflow:auto; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:6px}
  .topsCol.buy{background:color-mix(in oklab, var(--up) 12%, transparent)}
  .topsCol.sell{background:color-mix(in oklab, var(--down) 12%, transparent)}
  .topsCol h4{margin:2px 2px 6px; font-size:11px; letter-spacing:.5px; text-transform:uppercase}
  .item{display:flex; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,.18); margin:4px 0; font-variant-numeric:tabular-nums}
  .usd{font-weight:800}
  .btc,.tm{opacity:.85}

  .conn{position:fixed; left:10px; bottom:10px; z-index:40}
  canvas{display:block; width:100%; height:100%}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Coinbase Stalker — Desktop Multi-Range</h1>

    <div class="grid" id="grid">
      <!-- Cards created by JS -->
    </div>

    <div class="pill conn" id="connPill">Live</div>
  </div>

<script>
/* ========= Utilities ========= */
const fmtUSD = (v,fd=0)=> new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v);
function sizeCanvas(c){
  const dpr = Math.min(3, window.devicePixelRatio||1);
  c.width = Math.max(1, c.clientWidth*dpr);
  c.height = Math.max(1, c.clientHeight*dpr);
  const ctx = c.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}
function roundRect(ctx,x,y,w,h,r,fill=true,stroke=false){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

/* ========= Shared trade stream ========= */
const MS = { M10:600000, H1:3600000, H8:8*3600000, D1:24*3600000 };
let trades = []; // {t, price, size, side:'buy'|'sell'}

/* ========= Panel class ========= */
class RangePanel {
  constructor(parent, label, spanMs){
    this.label = label;
    this.span = spanMs;

    // DOM
    this.el = document.createElement('section');
    this.el.className = 'card';
    this.el.innerHTML = `
      <div class="titleRow">
        <div class="ttl">${label}</div>
        <div class="spacer"></div>
        <div class="pill" data-role="max">max ₿—</div>
      </div>
      <div class="chart"><canvas></canvas></div>
      <div class="gaugeRow">
        <span class="gLbl buy">Buys</span>
        <div class="needleWrap" style="flex:1">
          <canvas class="gauge"></canvas>
          <div class="needleAbs" style="width:100%; height:0">
            <div class="needle" data-role="needle" style="left:50%"></div>
          </div>
        </div>
        <span class="gLbl sell">Sells</span>
      </div>
      <div class="vol"><canvas></canvas></div>

      <div class="tops">
        <div class="topsGrid">
          <div class="topsCol buy">
            <h4>Top Buys</h4>
            <div data-role="buys"></div>
          </div>
          <div class="topsCol sell">
            <h4>Top Sells</h4>
            <div data-role="sells"></div>
          </div>
        </div>
      </div>
    `;
    parent.appendChild(this.el);

    // Refs
    this.priceCanvas = this.el.querySelector('.chart canvas');
    this.volCanvas = this.el.querySelector('.vol canvas');
    this.gaugeCanvas = this.el.querySelector('.gauge');
    this.maxPill = this.el.querySelector('[data-role="max]');
    this.needle = this.el.querySelector('[data-role="needle"]');
    this.buysBox = this.el.querySelector('[data-role="buys"]');
    this.sellsBox = this.el.querySelector('[data-role="sells"]');

    this._needlePos = 0.5; // eased 0..1
  }

  windowTrades(){
    const now = Date.now(), from = now - this.span;
    return trades.filter(t=> t.t >= from);
  }

  drawPrice(){
    const ctx = sizeCanvas(this.priceCanvas);
    const w = this.priceCanvas.clientWidth, h = this.priceCanvas.clientHeight;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle=getComputedStyle(document.document