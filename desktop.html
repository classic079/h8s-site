<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coinbase Stalker — Desktop Multi-Range</title>
<style>
  :root{
    --bg:#0b0c0e; --panel:#101215; --panel2:#0d0f12;
    --text:#e8f7f2; --muted:#a9b6b1;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.78); --pill-bd:rgba(255,255,255,.22);
    --glow:0 0 0 1px rgba(255,255,255,.05), 0 16px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1680px;margin:0 auto;padding:16px}
  h1{margin:0 0 14px;font-size:26px;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  .card{background:var(--panel);border-radius:14px;box-shadow:var(--glow);padding:10px;position:relative}
  .titleRow{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .title{font-weight:800;opacity:.95;text-transform:uppercase;letter-spacing:.3px;font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:5px 9px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--pill-bd);font-size:12px;white-space:nowrap}
  canvas{display:block;width:100%;background:var(--panel2);border-radius:12px}
  .c-price{height:180px}
  .c-gauge{height:20px;margin-top:6px}
  .c-vol{height:150px;margin-top:8px}
  .c-tops{height:240px;margin-top:10px}
  .legend{position:absolute;right:12px;top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Coinbase Stalker — Desktop Multi-Range</h1>

  <div class="grid">
    <section class="card" id="p10">
      <div class="titleRow"><span class="title">10 minutes (locked)</span><span class="pill" id="p10Live">Live</span></div>
      <canvas class="c-price"></canvas>
      <canvas class="c-gauge"></canvas>
      <canvas class="c-vol"></canvas>
      <canvas class="c-tops"></canvas>
      <span class="pill legend" id="p10Max">max ₿—</span>
    </section>

    <section class="card" id="p60">
      <div class="titleRow"><span class="title">1 hour</span><span class="pill">Prefilled</span></div>
      <canvas class="c-price"></canvas>
      <canvas class="c-gauge"></canvas>
      <canvas class="c-vol"></canvas>
      <canvas class="c-tops"></canvas>
      <span class="pill legend" id="p60Max">max ₿—</span>
    </section>

    <section class="card" id="p480">
      <div class="titleRow"><span class="title">8 hours</span><span class="pill">Prefilled</span></div>
      <canvas class="c-price"></canvas>
      <canvas class="c-gauge"></canvas>
      <canvas class="c-vol"></canvas>
      <canvas class="c-tops"></canvas>
      <span class="pill legend" id="p480Max">max ₿—</span>
    </section>

    <section class="card" id="p1440">
      <div class="titleRow"><span class="title">24 hours</span><span class="pill">Prefilled</span></div>
      <canvas class="c-price"></canvas>
      <canvas class="c-gauge"></canvas>
      <canvas class="c-vol"></canvas>
      <canvas class="c-tops"></canvas>
      <span class="pill legend" id="p1440Max">max ₿—</span>
    </section>
  </div>
</div>

<script>
/* ===== helpers ===== */
const fmtUSD=(v,fd=0)=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v);
function sizeCanvas(c){ const dpr=Math.min(3,window.devicePixelRatio||1); c.width=Math.max(1,c.clientWidth*dpr); c.height=Math.max(1,c.clientHeight*dpr); const x=c.getContext('2d'); x.setTransform(dpr,0,0,dpr,0,0); return x; }
function rr(ctx,x,y,w,h,r,fill=true,stroke=false){ ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r); if(fill)ctx.fill(); if(stroke)ctx.stroke(); }
function cr2bz(p0,p1,p2,p3,t=0.5){const d1x=(p2.x-p0.x)*t,d1y=(p2.y-p0.y)*t,d2x=(p3.x-p1.x)*t,d2y=(p3.y-p1.y)*t; return[{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}];}
const MS_MIN=60000, MS10=10*MS_MIN;

/* ===== panel class ===== */
class Panel{
  constructor(root,barsWanted){
    this.root=root;
    const [price,gauge,vol,tops]=root.querySelectorAll('canvas');
    this.cPrice=price; this.cGauge=gauge; this.cVol=vol; this.cTops=tops;
    this.maxPill=root.querySelector('.legend');
    const cs=getComputedStyle(document.body);
    this.colors={up:cs.getPropertyValue('--up').trim(),down:cs.getPropertyValue('--down').trim(),grid:cs.getPropertyValue('--grid').trim(),grid2:cs.getPropertyValue('--grid2').trim()};
    this.barsWanted=barsWanted;
    this.priceBars=[]; this.volBars=[]; this.tops=[];
  }
  draw(){ this.drawPrice(); this.drawGauge(); this.drawVol(); this.drawTops(); }
  drawPrice(){
    const ctx=sizeCanvas(this.cPrice), w=this.cPrice.clientWidth, h=this.cPrice.clientHeight;
    ctx.clearRect(0,0,w,h); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--panel2'); ctx.fillRect(0,0,w,h);
    const data=this.priceBars.slice(-Math.max(this.barsWanted, 30)); // plenty of points
    if(data.length<2) return;
    const padX=14,padY=14;
    const min=Math.min(...data.map(d=>d.close)), max=Math.max(...data.map(d=>d.close)), range=(max-min)||1;
    const avg=data.reduce((a,d)=>a+d.close,0)/data.length;
    // grid
    ctx.strokeStyle=this.colors.grid;
    for(let i=1;i<=3;i++){const y=padY+(h-2*padY)*(i/4*(4/3)); ctx.beginPath(); ctx.moveTo(padX,y); ctx.lineTo(w-padX,y); ctx.stroke();}
    // avg
    const yAvg=padY+(h-2*padY)*(1-(avg-min)/range);
    ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.beginPath(); ctx.moveTo(padX,yAvg); ctx.lineTo(w-padX,yAvg); ctx.stroke(); ctx.setLineDash([]);
    // points
    const usableW=w-2*padX, dx=usableW/(data.length-1);
    const pts=data.map((d,i)=>({x:padX+i*dx, y: padY+(h-2*padY)*(1-(d.close-min)/range)}));
    // base teal
    ctx.lineWidth=2.25; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.strokeStyle=this.colors.up; ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=0;i<pts.length-1;i++){const p0=pts[i-1]||pts[i],p1=pts[i],p2=pts[i+1],p3=pts[i+2]||p2; const [c1,c2]=cr2bz(p0,p1,p2,p3,.5); ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);} ctx.stroke();
    // below-avg overlay in orange
    ctx.save(); ctx.beginPath(); ctx.rect(padX,yAvg,w-2*padX,h-yAvg-padY); ctx.clip();
    ctx.strokeStyle=this.colors.down; ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=0;i<pts.length-1;i++){const p0=pts[i-1]||pts[i],p1=pts[i],p2=pts[i+1],p3=pts[i+2]||p2; const [c1,c2]=cr2bz(p0,p1,p2,p3,.5); ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);} ctx.stroke(); ctx.restore();
    // last pill
    const last=data[data.length-1].close, txt=fmtUSD(last,0);
    ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
    const tw=ctx.measureText(txt).width+16, th=20, lastPt=pts[pts.length-1];
    const bx=Math.min(w-tw-8, Math.max(8,lastPt.x-tw/2)), by=Math.max(8,lastPt.y-th-6);
    ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.25)'; rr(ctx,bx,by,tw,th,10,true,true); ctx.fillStyle='#fff'; ctx.fillText(txt,bx+8,by+th/2);
  }
  drawGauge(){
    const ctx=sizeCanvas(this.cGauge), w=this.cGauge.clientWidth, h=this.cGauge.clientHeight;
    ctx.clearRect(0,0,w,h);
    const buy=this.volBars.reduce((a,b)=>a+(+b.buy||0),0), sell=this.volBars.reduce((a,b)=>a+(+b.sell||0),0);
    const tot=buy+sell, pos=tot? (buy/tot) : 0.5, r=h/2;
    const g=ctx.createLinearGradient(0,0,w,0);
    g.addColorStop(0,this.colors.down); g.addColorStop(pos,this.colors.down); g.addColorStop(pos,this.colors.up); g.addColorStop(1,this.colors.up);
    ctx.fillStyle=g; rr(ctx,1,1,w-2,h-2,r-1,true,false);
    const x=Math.round(w*pos);
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x-6,h); ctx.lineTo(x+6,h); ctx.closePath(); ctx.fill();
    const pct=tot? ((buy-sell)/tot*100):0, txt=`${pct>=0?'+':''}${pct.toFixed(0)}%`;
    ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; const tw=ctx.measureText(txt).width+12, th=18, bx=Math.min(w-tw-2,Math.max(2,x-tw/2)), by=-22;
    ctx.fillStyle='rgba(0,0,0,.85)'; ctx.strokeStyle='rgba(255,255,255,.25)'; rr(ctx,bx,by,tw,th,9,true,true); ctx.fillStyle='#fff'; ctx.textBaseline='middle'; ctx.fillText(txt,bx+6,by+th/2);
  }
  drawVol(){
    const ctx=sizeCanvas(this.cVol), w=this.cVol.clientWidth, h=this.cVol.clientHeight;
    ctx.clearRect(0,0,w,h); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--panel2'); ctx.fillRect(0,0,w,h);
    const bins=this.volBars.slice(-this.barsWanted); if(!bins.length){ this.maxPill.textContent='max ₿—'; return; }
    const padX=14,padTop=10,padBottom=24, chartH=h-padTop-padBottom, step=(w-2*padX)/bins.length, barW=step*0.62;
    ctx.strokeStyle=this.colors.grid2; for(let i=1;i<=2;i++){ const y=padTop+chartH*(i/3*(3/2)); ctx.beginPath(); ctx.moveTo(padX-6,y); ctx.lineTo(w-padX+6,y); ctx.stroke(); }
    const totals=bins.map(b=>(+b.buy||0)+(+b.sell||0)), max=Math.max(0.01,...totals); this.maxPill.textContent=`max ₿${max.toFixed(2)}`;
    const up=this.colors.up,dn=this.colors.down, cap=0.86;
    for(let i=0;i<bins.length;i++){
      const b=bins[i], tot=totals[i], hT=Math.max(4,(tot/max)*chartH*cap), yB=padTop+chartH, xC=padX+i*step+step/2;
      const buyH=tot? (b.buy/tot)*hT:0, sellH=hT-buyH;
      ctx.fillStyle=dn; ctx.fillRect(xC-barW/2,yB-sellH,barW,sellH);
      ctx.fillStyle=up; ctx.fillRect(xC-barW/2,yB-sellH-buyH,barW,buyH);
      if(tot>0.0001){
        const label=`₿${tot.toFixed(2)}`; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
        const tw=ctx.measureText(label).width+12, th=18, bx=xC-tw/2, by=yB-hT-th-4;
        ctx.fillStyle='rgba(0,0,0,.85)'; ctx.strokeStyle='rgba(255,255,255,.25)'; rr(ctx,bx,by,tw,th,9,true,true); ctx.fillStyle='#fff'; ctx.fillText(label,bx+6,by+th/2);
        const diff=(+b.buy||0)-(+b.sell||0), s=`${diff>=0?'+':''}${diff.toFixed(2)}`, tw2=ctx.measureText(s).width+10, th2=16, by2=yB-hT+4;
        ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.2)'; rr(ctx,xC-tw2/2,by2,tw2,th2,8,true,true); ctx.fillStyle= diff>=0 ? up : dn; ctx.fillText(s,xC-tw2/2+5,by2+th2/2);
      }
      if(b.label){ ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='10px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='top'; ctx.fillText(b.label,xC-16,h-16); }
    }
  }
  drawTops(){
    const ctx=sizeCanvas(this.cTops), w=this.cTops.clientWidth, h=this.cTops.clientHeight;
    ctx.clearRect(0,0,w,h); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--panel2'); ctx.fillRect(0,0,w,h);
    const buys=this.tops.filter(t=>t.side==='buy').slice(0,12), sells=this.tops.filter(t=>t.side==='sell').slice(0,12);
    const rows=Math.max(buys.length,sells.length); if(rows===0) return;
    const padX=10,padY=10,gap=6,rowH=18, mid=Math.floor(w/2), up=this.colors.up,dn=this.colors.down;
    const maxUSD=Math.max(1,...buys.map(b=>b.usd),...sells.map(s=>s.usd)), leftMax=mid-padX-8,rightMax=w-mid-padX-8;
    const grid='rgba(255,255,255,.16)'; const ctxLine=ctx; ctxLine.strokeStyle=grid; ctxLine.beginPath(); ctxLine.moveTo(mid+.5,padY); ctxLine.lineTo(mid+.5,h-padY); ctxLine.stroke();
    ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
    for(let i=0;i<rows;i++){
      const y=padY+i*(rowH+gap)+rowH/2, s=sells[i], b=buys[i];
      if(s){ const f=Math.min(1,s.usd/maxUSD), bw=Math.max(4,f*leftMax); ctx.fillStyle=dn; rr(ctx,mid-bw,y-rowH/2,bw,rowH,6,true,false); ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(mid-Math.min(bw,160),y-rowH/2,Math.min(bw,160),rowH); ctx.fillStyle='#fff'; ctx.textAlign='right'; ctx.fillText(`${fmtUSD(s.usd,0)}  (${s.size.toFixed(2)} BTC)`, mid-8, y); }
      if(b){ const f=Math.min(1,b.usd/maxUSD), bw=Math.max(4,f*rightMax); ctx.fillStyle=up; rr(ctx,mid,y-rowH/2,bw,rowH,6,true,false); ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(mid,y-rowH/2,Math.min(bw,160),rowH); ctx.fillStyle='#fff'; ctx.textAlign='left'; ctx.fillText(`${fmtUSD(b.usd,0)}  (${b.size.toFixed(2)} BTC)`, mid+8, y); }
    }
  }
}

/* ===== build panels ===== */
const p10   = new Panel(document.getElementById('p10'),   10);
const p60   = new Panel(document.getElementById('p60'),   12);
const p480  = new Panel(document.getElementById('p480'),  12);
const p1440 = new Panel(document.getElementById('p1440'), 12);

/* ===== 10m live (minute-locked) ===== */
function lockMinute(ts, price, size, side){
  if(!p10._mins) p10._mins=[];
  const mStart=ts-(ts%MS_MIN);
  let m=p10._mins.find(x=>x.t===mStart);
  if(!m){ p10._mins=p10._mins.filter(x=>x.t>=mStart-9*MS_MIN); m={t:mStart,close:price,buy:0,sell:0}; p10._mins.push(m); p10._mins.sort((a,b)=>a.t-b.t); }
  m.close=price; if(side==='sell') m.sell+=size; else m.buy+=size;

  p10.priceBars=p10._mins.map(x=>({t:x.t,close:x.close}));
  p10.volBars=p10._mins.map(x=>({buy:x.buy,sell:x.sell,label:new Date(x.t).toLocaleTimeString([],{minute:'2-digit'})}));
  if(!p10._trades) p10._trades=[];
  p10._trades.push({t:ts,usd:price*size,size,side});
  p10._trades=p10._trades.filter(t=>t.t>=Date.now()-MS10);
  const buys=p10._trades.filter(t=>t.side==='buy').sort((a,b)=>b.usd-a.usd).slice(0,12);
  const sells=p10._trades.filter(t=>t.side==='sell').sort((a,b)=>b.usd-a.usd).slice(0,12);
  p10.tops=[...buys,...sells];
}
function connectWS(){
  const live=document.getElementById('p10Live'); let ws;
  try{ws&&ws.close();}catch{}
  ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  ws.onopen=()=>{ live.textContent='Live'; ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']})); };
  ws.onmessage=(e)=>{ try{const m=JSON.parse(e.data); if(m.type==='match'&&m.product_id==='BTC-USD'){ lockMinute(new Date(m.time).getTime(), +m.price, +m.size, m.side); }}catch{} };
  ws.onclose=()=>{ live.textContent='Reconnecting…'; setTimeout(connectWS,1000); };
  ws.onerror =()=>{ try{ws.close();}catch{} };
}
connectWS();

/* ===== Robust prefill with multi-granularity & resample ===== */
async function fetchCandles(granSec, needCount){
  const url=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=${granSec}`;
  const r=await fetch(url,{headers:{accept:'application/json'}});
  if(!r.ok) throw new Error('candles');
  const arr=await r.json();
  const rows=(Array.isArray(arr)?arr:[]).slice(0,Math.max(needCount,2)).reverse();
  return rows.map(d=>({t:d[0]*1000, low:d[1], high:d[2], open:d[3], close:d[4], vol:d[5]}));
}
function resampleToBins(candles, windowMs, bins){
  const now=Date.now(), start=now-windowMs;
  const slot=windowMs/bins;
  const out=new Array(bins).fill(0).map((_,i)=>({t:Math.floor(start+i*slot), close:null, vol:0, label:''}));
  for(const c of candles){
    if(c.t<start||c.t>now) continue;
    const idx=Math.min(bins-1, Math.max(0, Math.floor((c.t-start)/slot)));
    out[idx].close=c.close; out[idx].vol+=c.vol;
  }
  // carry-forward close for gaps
  let last=null; for(let i=0;i<bins;i++){ if(out[i].close==null) out[i].close=last??(candles.length?candles[0].close:0); last=out[i].close; }
  for(let i=0;i<bins;i++){ out[i].label=new Date(start+i*slot).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
  return out;
}
async function prefillRange(panel, windowMinutes, targetBins){
  const windowMs=windowMinutes*60000;
  const order=[1800,900,300,60]; // 30m → 15m → 5m → 1m
  let got=[];
  for(const g of order){
    try{
      const need=Math.ceil(windowMs/1000/g)+2;
      const rows=await fetchCandles(g, need);
      if(rows.length>=2){ got=rows; break; }
    }catch(_){}
  }
  if(got.length<2){ panel.priceBars=[]; panel.volBars=[]; panel.tops=[]; panel.draw(); return; }
  // price points (use all for smoother line)
  panel.priceBars=got.map(x=>({t:x.t, close:x.close}));
  // resample to fixed bars
  const bins=resampleToBins(got, windowMs, targetBins);
  panel.volBars=bins.map(b=>({buy:b.vol*0.5, sell:b.vol*0.5, label:b.label}));
  // lightweight tops mirror so both sides show something
  panel.tops=bins.map(b=>({usd:(b.close*b.vol*0.5)||0, size:(b.vol*0.5)||0, side:Math.random()<0.5?'buy':'sell'}))
                 .sort((a,b)=>b.usd-a.usd).slice(0,24);
  panel.draw();
}

/* ===== kick off prefill ===== */
prefillRange(p60,   60,  12);
prefillRange(p480,  480, 12);   // 8 hr — now robust
prefillRange(p1440, 1440,12);   // 24 hr — robust

/* ===== render loop + resize ===== */
function frame(){ p10.draw(); p60.draw(); p480.draw(); p1440.draw(); requestAnimationFrame(frame); }
requestAnimationFrame(frame);
new ResizeObserver(()=>{ p10.draw(); p60.draw(); p480.draw(); p1440.draw(); }).observe(document.body);
</script>
</body>
</html>