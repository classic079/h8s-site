<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coinbase Stalker — Desktop (10m / 1h / 8h / 24h)</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.75); --pill-bd:rgba(255,255,255,.22);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{padding:14px;max-width:1900px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 0 0 1px rgba(255,255,255,.06),0 18px 40px rgba(0,0,0,.45);display:flex;flex-direction:column}
  .head{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  .ttl{font-weight:800;letter-spacing:.3px;font-size:14px}
  .pill{margin-left:auto;display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--pill-bd);font-size:11px;white-space:nowrap}
  .box{padding:8px;display:flex;flex-direction:column;gap:8px}
  canvas{display:block;width:100%;height:160px;border-radius:10px;background:var(--panel-2)}
  .vol{height:140px}
  .tops{height:220px}
  .conn{position:fixed;left:12px;bottom:12px;z-index:50}
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:700px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <main class="wrap">
    <div class="grid">
      <section class="card" id="p10">
        <div class="head"><span class="ttl">10 minutes (locked)</span><span class="pill" id="p10Live">Live</span></div>
        <div class="box">
          <canvas class="price"></canvas>
          <canvas class="vol vol10"></canvas>
          <canvas class="tops"></canvas>
        </div>
      </section>
      <section class="card" id="p60">
        <div class="head"><span class="ttl">1 hour</span><span class="pill" id="p60Info">Prefilled</span></div>
        <div class="box">
          <canvas class="price"></canvas>
          <canvas class="vol"></canvas>
          <canvas class="tops"></canvas>
        </div>
      </section>
      <section class="card" id="p480">
        <div class="head"><span class="ttl">8 hours</span><span class="pill" id="p480Info">Prefilled</span></div>
        <div class="box">
          <canvas class="price"></canvas>
          <canvas class="vol"></canvas>
          <canvas class="tops"></canvas>
        </div>
      </section>
      <section class="card" id="p1440">
        <div class="head"><span class="ttl">24 hours</span><span class="pill" id="p1440Info">Prefilled</span></div>
        <div class="box">
          <canvas class="price"></canvas>
          <canvas class="vol"></canvas>
          <canvas class="tops"></canvas>
        </div>
      </section>
    </div>
    <span class="pill conn" id="connPill">Connecting…</span>
  </main>

<script>
const fmtUSD=(v,d=0)=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:d}).format(v);
function sizeCanvas(c){
  const dpr=Math.min(3,window.devicePixelRatio||1);
  c.width=Math.max(1,c.clientWidth*dpr);
  c.height=Math.max(1,c.clientHeight*dpr);
  const ctx=c.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}
function rr(ctx,x,y,w,h,r,fill=true,stroke=false){
  ctx.beginPath();ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);
  if(fill)ctx.fill();if(stroke)ctx.stroke();
}
const upCol=()=>getComputedStyle(document.body).getPropertyValue('--up').trim();
const dnCol=()=>getComputedStyle(document.body).getPropertyValue('--down').trim();
const panelBg=()=>getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();

/* -------- draw price line -------- */
function drawPriceLine(ctx,w,h,vals){
  if(!vals.length)return;
  const prices=vals.map(v=>v.v).filter(v=>v!=null);
  if(prices.length<2)return;
  const min=Math.min(...prices),max=Math.max(...prices),range=(max-min)||1;
  const padX=36,padY=14,plotW=w-2*padX,plotH=h-2*padY;
  ctx.clearRect(0,0,w,h);ctx.fillStyle=panelBg();ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='rgba(255,255,255,.08)';
  for(let i=1;i<=3;i++){const y=padY+plotH*(i/4*(4/3));ctx.beginPath();ctx.moveTo(padX,y);ctx.lineTo(w-padX,y);ctx.stroke();}
  const avg=prices.reduce((a,b)=>a+b,0)/prices.length;
  const yAvg=padY+plotH*(1-(avg-min)/range);
  ctx.setLineDash([6,6]);ctx.strokeStyle='rgba(255,255,255,.3)';ctx.beginPath();
  ctx.moveTo(padX,yAvg);ctx.lineTo(w-padX,yAvg);ctx.stroke();ctx.setLineDash([]);
  const pts=vals.map((v,i)=>{
    const x=padX+(i+0.5)*(plotW/vals.length);
    const y=padY+plotH*(1-(v.v-min)/range);
    return {x,y,val:v.v};
  });
  const up=upCol(),dn=dnCol();
  ctx.lineWidth=2.2;ctx.lineJoin='round';ctx.lineCap='round';
  for(let i=0;i<pts.length-1;i++){
    const p1=pts[i],p2=pts[i+1];
    const col=((p1.val+p2.val)/2)>=avg?up:dn;
    ctx.strokeStyle=col;ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();
  }
  ctx.fillStyle='rgba(255,255,255,.9)';ctx.font='11px system-ui';ctx.textBaseline='middle';
  ctx.fillText(fmtUSD(max,0),8,padY+4);
  ctx.fillText(fmtUSD(avg,0),8,Math.max(padY+12,Math.min(h-padY-12,yAvg)));
  ctx.fillText(fmtUSD(min,0),8,h-padY-4);
}

/* -------- draw stacked volume -------- */
function drawVolume(ctx,w,h,bars){
  ctx.clearRect(0,0,w,h);ctx.fillStyle=panelBg();ctx.fillRect(0,0,w,h);
  const padX=28,padTop=10,padBottom=24,plotW=w-2*padX,plotH=h-padTop-padBottom;
  const step=plotW/bars.length,barW=step*0.62;
  const up=upCol(),dn=dnCol();
  const totals=bars.map(b=>(b.buy||0)+(b.sell||0));
  const max=Math.max(0.01,...totals);
  ctx.strokeStyle='rgba(255,255,255,.06)';
  for(let i=1;i<=2;i++){const y=padTop+plotH*(i/3*(3/2));ctx.beginPath();ctx.moveTo(padX-6,y);ctx.lineTo(w-padX+6,y);ctx.stroke();}
  ctx.font='10px system-ui';
  for(let i=0;i<bars.length;i++){
    const b=bars[i],xC=padX+i*step+step/2,tot=(b.buy||0)+(b.sell||0);
    const hT=Math.max(4,(tot/max)*plotH),yB=padTop+plotH;
    const hBuy=tot?(b.buy/tot)*hT:0,hSell=hT-hBuy;
    ctx.fillStyle=dn;ctx.fillRect(xC-barW/2,yB-hSell,barW,hSell);
    ctx.fillStyle=up;ctx.fillRect(xC-barW/2,yB-hSell-hBuy,barW,hBuy);
    if(tot>0){
      const lab=`₿${tot.toFixed(2)}`,tw=ctx.measureText(lab).width+12,th=16;
      let bx=xC-tw/2,by=yB-hT-th-4;if(by<4)by=4;
      ctx.fillStyle='rgba(0,0,0,.85)';ctx.strokeStyle='rgba(255,255,255,.25)';
      rr(ctx,bx,by,tw,th,9,true,true);ctx.fillStyle='#fff';ctx.textBaseline='middle';ctx.textAlign='center';
      ctx.fillText(lab,xC,by+th/2);
    }
    if(hT>28){
      const diff=(b.buy||0)-(b.sell||0),txt=`${diff>=0?'+':''}${diff.toFixed(2)}`;
      const tw=ctx.measureText(txt).width+12,th=16,bx=xC-tw/2,by=yB-hT+4;
      ctx.fillStyle='rgba(0,0,0,.85)';ctx.strokeStyle='rgba(255,255,255,.25)';
      rr(ctx,bx,by,tw,th,9,true,true);
      ctx.fillStyle=diff>=0?up:dn;ctx.fillText(txt,xC,by+th/2);
    }
    if(b.label&&i%2===0){ctx.fillStyle='rgba(255,255,255,.85)';ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText(b.label,xC,h-14);}
  }
}

/* -------- mirrored top lists -------- */
function drawTopsCanvas(ctx,w,h,left,right){
  ctx.clearRect(0,0,w,h);ctx.fillStyle=panelBg();ctx.fillRect(0,0,w,h);
  const padX=10,padY=10,gap=6,rowH=20,mid=w/2;
  const up=upCol(),dn=dnCol();
  ctx.strokeStyle='rgba(255,255,255,.18)';ctx.beginPath();ctx.moveTo(mid+.5,padY);ctx.lineTo(mid+.5,h-padY);ctx.stroke();
  const rows=Math.max(left.length,right.length);
  const maxUSD=Math.max(1,...left.map(x=>x.usd),...right.map(x=>x.usd));
  const leftW=mid-padX-8,rightW=w-mid-padX-8;
  ctx.font='11px system-ui';ctx.textBaseline='middle';
  for(let i=0;i<rows;i++){
    const y=padY+i*(rowH+gap)+rowH/2;
    const s=left[i];if(s){const frac=s.usd/maxUSD,bw=frac*leftW;
      ctx.fillStyle=dn;rr(ctx,mid-bw,y-rowH/2,bw,rowH,6,true,false);
      const lab=`${fmtUSD(s.usd,0)} (${s.size.toFixed(2)} BTC)`;ctx.fillStyle='rgba(0,0,0,.55)';
      ctx.fillRect(mid-Math.min(bw,160),y-rowH/2,Math.min(bw,160),rowH);
      ctx.fillStyle='#fff';ctx.textAlign='right';ctx.fillText(lab,mid-8,y);}
    const b=right[i];if(b){const frac=b.usd/maxUSD,bw=frac*rightW;
      ctx.fillStyle=up;rr(ctx,mid,y-rowH/2,bw,rowH,6,true,false);
      const lab=`${fmtUSD(b.usd,0)} (${b.size.toFixed(2)} BTC)`;ctx.fillStyle='rgba(0,0,0,.55)';
      ctx.fillRect(mid,y-rowH/2,Math.min(bw,160),rowH);
      ctx.fillStyle='#fff';ctx.textAlign='left';ctx.fillText(lab,mid+8,y);}
  }
}

/* -------- panel creation -------- */
function makePanel(id){const el=document.getElementById(id);return{
  el,
  price:el.querySelector('.price'),
  vol:el.querySelector('.vol'),
  tops:el.querySelector('.tops'),
  state:{priceBars:[],volBars:[],buys:[],sells:[]},
  draw(){const p=sizeCanvas(this.price),v=sizeCanvas(this.vol),t=sizeCanvas(this.tops);
    drawPriceLine(p,this.price.clientWidth,this.price.clientHeight,this.state.priceBars);
    drawVolume(v,this.vol.clientWidth,this.vol.clientHeight,this.state.volBars);
    drawTopsCanvas(t,this.tops.clientWidth,this.tops.clientHeight,this.state.sells.slice(0,12),this.state.buys.slice(0,12));}
};}

/* -------- Coinbase REST candles -------- */
async function loadCandles(gran,pts){
  const r=await fetch(`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=${gran}`);
  const d=await r.json();return Array.isArray(d)?d.reverse().slice(-pts).map(a=>({t:a[0]*1000,close:a[4],vol:a[5]})):[];
}

/* -------- panels -------- */
const p10=makePanel('p10'),p60=makePanel('p60'),p480=makePanel('p480'),p1440=makePanel('p1440');
const connPill=document.getElementById('connPill');
let trades10m=[];const MS_MIN=60000;

/* -------- 10m live locked -------- */
let buckets=[];
function floorMin(t){return t-t%MS_MIN;}
function ensureBuckets(ts){
  const start=floorMin(ts)-9*MS_MIN;
  if(!buckets.length){for(let i=0;i<10;i++)buckets.push({start:start+i*MS_MIN,open:null,close:null,buy:0,sell:0,locked:false});return;}
  while(buckets[buckets.length-1].start<floorMin(ts)){buckets[buckets.length-1].locked=true;buckets.shift();
    const last=buckets[buckets.length-1].start;buckets.push({start:last+MS_MIN,open:null,close:null,buy:0,sell:0,locked:false});}
}
function onTrade(p,size,side,ts){
  ensureBuckets(ts);
  const b=buckets.find(x=>x.start===floorMin(ts));if(!b||b.locked)return;
  if(b.open==null)b.open=p;b.close=p;if(side==='sell')b.sell+=size;else b.buy+=size;
  trades10m.push({t:ts,price:p,size,side});
  const cutoff=Date.now()-10*MS_MIN;trades10m=trades10m.filter(x=>x.t>=cutoff);
}
function export10m(){
  p10.state.priceBars=buckets.map(b=>({v:b.close??b.open??null}));
  p10.state.volBars=buckets.map(b=>({buy:b.buy||0,sell:b.sell||0,label:new Date(b.start).toLocaleTimeString([],{minute:'2-digit'})}));
  const items=trades10m.map(t=>({usd:t.price*t.size,size:t.size,side:t.side}));
  p10.state.buys=items.filter(i=>i.side==='buy').sort((a,b)=>b.usd-a.usd);
  p10.state.sells=items.filter(i=>i.side==='sell').sort((a,b)=>b.usd-a.usd);
}
setInterval(()=>{ensureBuckets(Date.now());export10m();},1500);

/* -------- WebSocket -------- */
let ws;function connectWS(){
  try{ws&&ws.close();}catch{}
  ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  connPill.textContent='Connecting…';
  ws.onopen=()=>{ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));connPill.textContent='Live';};
  ws.onmessage=e=>{try{const m=JSON.parse(e.data);
    if(m.type==='match'&&m.product_id==='BTC-USD'){
          const t = new Date(m.time).getTime();
      const price = +m.price, size = +m.size, side = m.side;
      onTrade(price, size, side, t);
      export10m();
    }
  }catch{}
 };
 ws.onclose=()=>{connPill.textContent='Reconnecting…';setTimeout(connectWS,1000);};
 ws.onerror =()=>{try{ws.close();}catch{}};
}
connectWS();

/* -------- Prefill other panels -------- */
(async()=>{
  try{
    const c1=await loadCandles(300,12);     // 5m for 1h
    p60.state.priceBars=c1.map(x=>({v:x.close}));
    p60.state.volBars=c1.map(x=>({buy:x.vol/2,sell:x.vol/2,label:new Date(x.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}));
    const arr=c1.map(v=>({usd:v.close*v.vol/2,size:v.vol/2,side:'buy'}));
    p60.state.buys=arr;p60.state.sells=arr;p60.draw();
  }catch{}
  try{
    const c8=await loadCandles(2400,12);    // 40m for 8h
    p480.state.priceBars=c8.map(x=>({v:x.close}));
    p480.state.volBars=c8.map(x=>({buy:x.vol/2,sell:x.vol/2,label:new Date(x.t).toLocaleTimeString([],{hour:'2-digit'})}));
    const arr=c8.map(v=>({usd:v.close*v.vol/2,size:v.vol/2,side:'buy'}));
    p480.state.buys=arr;p480.state.sells=arr;p480.draw();
  }catch{}
  try{
    const c24=await loadCandles(7200,12);   // 2h for 24h
    p1440.state.priceBars=c24.map(x=>({v:x.close}));
    p1440.state.volBars=c24.map(x=>({buy:x.vol/2,sell:x.vol/2,label:new Date(x.t).toLocaleTimeString([],{hour:'2-digit'})}));
    const arr=c24.map(v=>({usd:v.close*v.vol/2,size:v.vol/2,side:'buy'}));
    p1440.state.buys=arr;p1440.state.sells=arr;p1440.draw();
  }catch{}
})();

/* -------- Animation -------- */
function frame(){
  export10m();
  p10.draw();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

/* -------- Resize -------- */
new ResizeObserver(()=>{
  p10.draw();p60.draw();p480.draw();p1440.draw();
}).observe(document.body);
</script>
</body>
</html>