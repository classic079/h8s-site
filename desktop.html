<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>h8s — desktop (4-up, fixed bias gauge + 10m bars)</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.8); --pill-bd:rgba(255,255,255,.25);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{padding:16px;max-width:1900px;margin:0 auto}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(4,minmax(320px,1fr))}
  @media (max-width:1600px){ .grid{grid-template-columns:repeat(3,minmax(320px,1fr));} }
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(2,minmax(320px,1fr));} }
  @media (max-width:800px){  .grid{grid-template-columns:1fr;} }

  .card{background:var(--panel);border-radius:14px;box-shadow:var(--glow);overflow:hidden}
  .hdr{display:flex;align-items:center;gap:10px;padding:10px 12px 6px}
  .title{font-weight:800;letter-spacing:.4px}
  .sub{opacity:.85;font-size:12px;margin-left:auto}
  canvas{display:block;width:100%;border-radius:12px;background:var(--panel-2)}
  .priceCanvas{height:220px;margin:8px 10px}
  .volCanvas{height:160px;margin:6px 10px 10px}
  .gaugeRow{display:flex;align-items:center;gap:10px;padding:0 12px 8px}
  #connPill{position:fixed;left:14px;bottom:14px;z-index:40}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
        background:var(--pill-bg);border:1px solid var(--pill-bd);font-size:12px;color:#fff;white-space:nowrap}
  .topsCanvas{height:240px;margin:0 10px 10px}
  .legend{display:flex;align-items:center;gap:10px;padding:0 12px 4px}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid" id="panelGrid"></div>
    <span id="connPill" class="pill">Connecting…</span>
  </div>

<script>
const fmtUSD=(v,fd=0)=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v);
function sizeCanvas(c){
  const dpr=Math.min(3,window.devicePixelRatio||1);
  c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr;
  const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); return ctx;
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath();ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);
  if(fill)ctx.fill(); if(stroke)ctx.stroke();
}
const MS={M1:6e4,M2:12e4,M5:3e5,M10:6e5,H1:36e5,H8:288e5,D1:864e5};
let trades=[];
const PANEL_SPECS=[
  {label:'10 MIN',span:MS.M10,binMs:MS.M1,volScale:'linear',topN:10,classic:true, preload:false,granSec:60},
  {label:'1 HOUR',span:MS.H1, binMs:MS.M5,volScale:'linear',topN:12,classic:false,preload:true,granSec:60},
  {label:'8 HOURS',span:MS.H8, binMs:MS.H8/12,volScale:'sqrt',topN:10,classic:false,preload:true,granSec:300},
  {label:'24 HOURS',span:MS.D1,binMs:MS.D1/12,volScale:'sqrt',topN:10,classic:false,preload:true,granSec:900},
];

async function preloadCandles(spanMs,granSec){
  const end=Math.floor(Date.now()/1000),start=end-Math.ceil(spanMs/1000);
  const url=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=${granSec}&start=${start}&end=${end}`;
  try{
    const res=await fetch(url,{headers:{Accept:'application/json'}});
    if(!res.ok)return;
    const arr=await res.json(); const synth=[];
    for(const [ts,low,high,open,close,vol] of arr){
      const t=ts*1000; if(!isFinite(close)||!isFinite(vol))continue;
      const half=vol/2; synth.push({t,price:close,size:half,side:'buy'},{t,price:close,size:half,side:'sell'});
    }
    synth.sort((a,b)=>a.t-b.t);
    const cutoff=Date.now()-spanMs-MS.M10;
    trades=trades.filter(tr=>tr.t>cutoff); trades=[...synth,...trades];
  }catch(e){console.warn('preload',e);}
}

class Panel{
  constructor(parent,spec){
    this.s=spec;
    this.root=document.createElement('section');this.root.className='card';
    this.root.innerHTML=`
      <div class="hdr"><div class="title">${spec.label}</div><div class="sub" data-max>max ₿—</div></div>
      <canvas class="priceCanvas" data-price></canvas>
      <div class="gaugeRow"><span style="color:var(--up);font-size:12px">Buys</span>
        <canvas data-gauge style="height:22px;border-radius:999px;flex:1;box-shadow:inset 0 0 0 1px rgba(255,255,255,.12)"></canvas>
        <span style="color:var(--down);font-size:12px">Sells</span></div>
      <div class="legend"><span class="dot up"></span><span style="opacity:.85">Buys</span><span class="dot down"></span><span style="opacity:.85">Sells</span></div>
      <canvas class="volCanvas" data-vol></canvas><canvas class="topsCanvas" data-tops></canvas>`;
    parent.appendChild(this.root);
    this.price=this.root.querySelector('[data-price]');
    this.vol=this.root.querySelector('[data-vol]');
    this.gauge=this.root.querySelector('[data-gauge]');
    this.tops=this.root.querySelector('[data-tops]');
    this.max=this.root.querySelector('[data-max]');
    this._needle=0.5;
  }
  rebuild(now){
    const {span,binMs}=this.s;
    const bins=Math.ceil(span/binMs);
    const start=now-span; this.bins=Array.from({length:bins},(_,i)=>({ts:start+i*binMs,buy:0,sell:0}));
    for(const t of trades){
      if(t.t<start||t.t>now)continue;
      const i=Math.floor((t.t-start)/binMs);
      if(i<0||i>=bins)continue;
      if(t.side==='sell')this.bins[i].sell+=t.size;else this.bins[i].buy+=t.size;
    }
  }
  _sample(now){
    const span=this.s.span,start=now-span,end=now;
    const pts=trades.filter(t=>t.t>=start&&t.t<=end).map(t=>({t:t.t,p:t.price}));
    if(pts.length<2)return null; return{start,end,pts};
  }
  drawPrice(now){
    const ctx=sizeCanvas(this.price),w=this.price.clientWidth,h=this.price.clientHeight;
    ctx.clearRect(0,0,w,h);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--panel-2');ctx.fillRect(0,0,w,h);
    const s=this._sample(now);if(!s)return;
    const {start,end,pts}=s;const padX=14,padY=18,usable=w-2*padX;
    const min=Math.min(...pts.map(p=>p.p)),max=Math.max(...pts.map(p=>p.p)),range=(max-min)||1;
    const arr=[];let lx=-1;for(const d of pts){const x=padX+((d.t-start)/(end-start))*usable,y=padY+(h-2*padY)*(1-(d.p-min)/range);if(x<=lx)continue;lx=x;arr.push({x,y,p:d.p});}
    if(arr.length<2)return;
    ctx.strokeStyle='var(--grid)';for(let i=1;i<=3;i++){const y=padY+(h-2*padY)*(i/4*(4/3));ctx.beginPath();ctx.moveTo(padX,y);ctx.lineTo(w-padX,y);ctx.stroke();}
    const avg=pts.reduce((a,b)=>a+b.p,0)/pts.length,yA=padY+(h-2*padY)*(1-(avg-min)/range);
    ctx.setLineDash([6,6]);ctx.strokeStyle='rgba(255,255,255,.35)';ctx.beginPath();ctx.moveTo(padX,yA);ctx.lineTo(w-padX,yA);ctx.stroke();ctx.setLineDash([]);
    const up=getComputedStyle(document.body).getPropertyValue('--up');const cr=(p0,p1,p2,p3,t=.5)=>{const d1x=(p2.x-p0.x)*t,d1y=(p2.y-p0.y)*t,d2x=(p3.x-p1.x)*t,d2y=(p3.y-p1.y)*t;return[{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}]};
    ctx.strokeStyle=up;ctx.lineWidth=2.25;ctx.lineJoin='round';ctx.lineCap='round';ctx.beginPath();ctx.moveTo(arr[0].x,arr[0].y);
    for(let i=0;i<arr.length-1;i++){const p0=arr[i-1]||arr[i],p1=arr[i],p2=arr[i+1],p3=arr[i+2]||p2;const[c1,c2]=cr(p0,p1,p2,p3,.5);ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);}ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.9)';ctx.font='12px system-ui';ctx.fillText(fmtUSD(max,0),padX,padY+4);ctx.fillText(fmtUSD(min,0),padX,h-padY-4);
  }
  drawGauge(){
    const ctx=sizeCanvas(this.gauge),w=this.gauge.clientWidth,h=this.gauge.clientHeight;
    ctx.clearRect(0,0,w,h);let buy=0,sell=0;for(const b of this.bins){buy+=b.buy;sell+=b.sell;}
    const tot=buy+sell,target=tot?buy/tot:.5;this._needle+=(target-this._needle)*.25;
    const up=getComputedStyle(document.body).getPropertyValue('--up'),dn=getComputedStyle(document.body).getPropertyValue('--down');
    const g=ctx.createLinearGradient(0,0,w,0);const s=this._needle;
    g.addColorStop(0,dn);g.addColorStop(Math.max(0,s-.001),dn);g.addColorStop(Math.min(1,s+.001),up);g.addColorStop(1,up);
    const r=h/2;ctx.fillStyle=g;roundRect(ctx,1,1,w-2,h-2,r-1,true,false);
    ctx.globalAlpha=.18;ctx.fillStyle=(this._needle>=.5)?up:dn;
    const domW=(this._needle>=.5)?w*this._needle:w*(1-this._needle),domX=(this._needle>=.5)?0:w*this._needle;
    roundRect(ctx,domX,1,domW,h-2,r-1,true,false);ctx.globalAlpha=1;
  }
  drawVol(){
    const ctx=sizeCanvas(this.vol),w=this.vol.clientWidth,h=this.vol.clientHeight;
    ctx.clearRect(0,0,w,h);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--panel-2');ctx.fillRect(0,0,w,h);
    const totals=this.bins.map(b=>b.buy+b.sell),max=Math.max(...totals,0.01)/.84;
    this.max.textContent=`max ₿${(max*.84).toFixed(2)}`;
    const padX=16,padTop=12,padBottom=26,chartH=h-padTop-padBottom,step=(w-padX*2)/this.bins.length,barW=step*.62;
    const up=getComputedStyle(document.body).getPropertyValue('--up'),dn=getComputedStyle(document.body).getPropertyValue('--down');
    for(let i=0;i<this.bins.length;i++){
      const b=this.bins[i],xC=padX+i*step+step/2,tot=b.buy+b.sell,frac=Math.min(1,tot/max),hT=frac*chartH*.84,hB=tot?(b.buy/tot)*hT:0,hS=hT-hB,yB=padTop+chartH;
      ctx.fillStyle=dn;ctx.fillRect(xC-barW/2,yB-hS,barW,hS);ctx.fillStyle=up;ctx.fillRect(xC-barW/2,yB-hS-hB,barW,hB);
    }
  }
  render(now){this.rebuild(now);this.drawPrice(now);this.drawGauge();this.drawVol();}
}
const grid=document.getElementById('panelGrid');const panels=PANEL_SPECS.map(s=>new Panel(grid,s));
(async()=>{for(const s of PANEL_SPECS)if(s.preload)await preloadCandles(s.span,s.granSec);})();
const conn=document.getElementById('connPill');let ws;
function startWS(){try{ws&&ws.close();}catch{};ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
conn.textContent='Connecting…';ws.onopen=()=>{ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));conn.textContent='Live';};
ws.onmessage=e=>{const m=JSON.parse(e.data);if(m.type==='match'){trades.push({t:new Date(m.time).getTime(),price:+m.price,size:+m.size,side:m.side});}};
ws.onclose=()=>{conn.textContent='Reconnecting…';setTimeout(startWS,1200);};}
startWS();
function frame(){const n=Date.now();for(const p of panels)p.render(n);requestAnimationFrame(frame);}
new ResizeObserver(()=>{for(const p of panels)p.render(Date.now());}).observe(document.body);
requestAnimationFrame(frame);
</script>
</body>
</html>