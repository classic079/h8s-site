<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Traffic Monitor - Full Tracking</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Main Stats Row */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 3px;
        }
        .stat-card.highlight .stat-value { color: #2ecc71; }

        /* Object Detection Grid - ALL 11 TYPES */
        .detection-section {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .detection-section h2 {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .detection-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        @media (max-width: 900px) {
            .detection-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 600px) {
            .detection-grid { grid-template-columns: repeat(3, 1fr); }
        }
        .det-box {
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            border-left: 3px solid #3498db;
            transition: transform 0.2s, background 0.2s;
        }
        .det-box:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.12);
        }
        /* Vehicle colors */
        .det-box.car { border-color: #3498db; }
        .det-box.bus { border-color: #e74c3c; }
        .det-box.motorcycle { border-color: #f39c12; }
        .det-box.bicycle { border-color: #9b59b6; }
        /* Person color */
        .det-box.person { border-color: #2ecc71; }
        /* Animal colors */
        .det-box.dog { border-color: #e67e22; }
        .det-box.cat { border-color: #fd79a8; }
        .det-box.bird { border-color: #00cec9; }
        .det-box.cow { border-color: #6c5ce7; }
        .det-box.horse { border-color: #a29bfe; }
        .det-box.sheep { border-color: #dfe6e9; }

        .det-icon { font-size: 1.6rem; margin-bottom: 4px; }
        .det-num { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .det-label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; margin-top: 2px; }

        /* Panels */
        .panel {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        .panel h2 {
            font-size: 1rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Hourly Chart */
        .hourly-chart {
            display: flex;
            align-items: flex-end;
            height: 120px;
            gap: 2px;
            padding: 8px 0;
        }
        .hour-bar {
            flex: 1;
            background: rgba(52, 152, 219, 0.3);
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .hour-bar:hover { background: rgba(52, 152, 219, 0.6); }
        .hour-bar.current { background: rgba(46, 204, 113, 0.5); }
        .hour-bar .tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
        }
        .hour-bar:hover .tooltip { display: block; }
        .hour-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #666;
            margin-top: 4px;
        }

        /* Two Column Layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Week Chart */
        .week-chart {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }
        .day-bar { flex: 1; text-align: center; }
        .day-bar-fill {
            height: 80px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            margin-bottom: 4px;
        }
        .day-bar-inner {
            width: 100%;
            background: linear-gradient(to top, #3498db, #2ecc71);
            border-radius: 4px;
            min-height: 2px;
        }
        .day-label { font-size: 0.7rem; color: #aaa; }
        .day-count { font-size: 0.8rem; font-weight: bold; margin-top: 2px; }

        /* Snapshot */
        .snapshot-container { text-align: center; }
        .snapshot-img {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            display: none;
        }
        .snapshot-img.loaded { display: inline-block; }
        .snapshot-time { font-size: 0.75rem; color: #888; margin-top: 8px; }

        /* Recent Activity */
        .recent-list { max-height: 150px; overflow-y: auto; }
        .recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .recent-item .obj-type { color: #3498db; }
        .recent-item .speed { color: #2ecc71; font-weight: bold; }
        .recent-item .speed.fast { color: #e74c3c; }
        .recent-item .time { color: #888; }

        /* Status */
        .status {
            text-align: center;
            padding: 8px;
            background: rgba(46, 204, 113, 0.2);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .status.offline { background: rgba(231, 76, 60, 0.2); }

        /* Sound Level Meter */
        .sound-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .sound-panel h2 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sound-meter-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sound-icon { font-size: 1.8rem; }
        .sound-meter {
            flex: 1;
            height: 24px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .sound-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
            border-radius: 12px;
            transition: width 0.3s ease;
        }
        .sound-meter-peak {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #fff;
            border-radius: 2px;
            transition: left 0.3s ease;
        }
        .sound-meter-refs {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.65rem;
            color: #888;
            position: relative;
        }
        .sound-ref {
            text-align: center;
            position: absolute;
            transform: translateX(-50%);
        }
        .sound-ref-line {
            position: absolute;
            top: -4px;
            left: 50%;
            width: 1px;
            height: 4px;
            background: rgba(255,255,255,0.3);
        }
        .sound-values {
            display: flex;
            gap: 20px;
            text-align: center;
        }
        .sound-value-box {
            background: rgba(255,255,255,0.08);
            padding: 8px 15px;
            border-radius: 8px;
            min-width: 80px;
        }
        .sound-db {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2ecc71;
        }
        .sound-db.loud { color: #f1c40f; }
        .sound-db.very-loud { color: #e74c3c; }
        .sound-label { font-size: 0.7rem; color: #888; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Street Traffic Monitor</h1>

        <!-- Main Stats -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-value" id="total-today">--</div>
                <div class="stat-label">Total Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="current-hour">--</div>
                <div class="stat-label">This Hour</div>
            </div>
        </div>

        <!-- Sound Level Meter -->
        <div class="sound-panel">
            <h2>Street Sound Level</h2>
            <div class="sound-meter-container">
                <div class="sound-icon">&#128266;</div>
                <div style="flex: 1;">
                    <div class="sound-meter">
                        <div class="sound-meter-fill" id="sound-meter-fill" style="width: 0%"></div>
                        <div class="sound-meter-peak" id="sound-meter-peak" style="left: 0%"></div>
                    </div>
                    <div class="sound-meter-refs">
                        <div class="sound-ref" style="left: 0%"><div class="sound-ref-line"></div>0 Quiet</div>
                        <div class="sound-ref" style="left: 25%"><div class="sound-ref-line"></div>15 Whisper</div>
                        <div class="sound-ref" style="left: 50%"><div class="sound-ref-line"></div>30 Library</div>
                        <div class="sound-ref" style="left: 75%"><div class="sound-ref-line"></div>45 Talking</div>
                        <div class="sound-ref" style="left: 100%"><div class="sound-ref-line"></div>60 Traffic</div>
                    </div>
                </div>
                <div class="sound-values">
                    <div class="sound-value-box">
                        <div class="sound-db" id="current-db">--</div>
                        <div class="sound-label">Current</div>
                    </div>
                    <div class="sound-value-box">
                        <div class="sound-db" id="peak-db">--</div>
                        <div class="sound-label">Peak Today</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALL 11 Object Types -->
        <div class="detection-section">
            <h2>AI Object Detection - Today's Counts</h2>
            <div class="detection-grid">
                <!-- Vehicles -->
                <div class="det-box car">
                    <div class="det-icon">&#128663;</div>
                    <div class="det-num" id="count-car">--</div>
                    <div class="det-label">Car</div>
                </div>
                <div class="det-box bus">
                    <div class="det-icon">&#128652;</div>
                    <div class="det-num" id="count-bus">--</div>
                    <div class="det-label">Bus</div>
                </div>
                <div class="det-box motorcycle">
                    <div class="det-icon">&#127949;</div>
                    <div class="det-num" id="count-motorbike">--</div>
                    <div class="det-label">Motorcycle</div>
                </div>
                <div class="det-box bicycle">
                    <div class="det-icon">&#128690;</div>
                    <div class="det-num" id="count-bicycle">--</div>
                    <div class="det-label">Bicycle</div>
                </div>
                <!-- Person -->
                <div class="det-box person">
                    <div class="det-icon">&#128694;</div>
                    <div class="det-num" id="count-person">--</div>
                    <div class="det-label">Person</div>
                </div>
                <!-- Animals -->
                <div class="det-box dog">
                    <div class="det-icon">&#128021;</div>
                    <div class="det-num" id="count-dog">--</div>
                    <div class="det-label">Dog</div>
                </div>
                <div class="det-box cat">
                    <div class="det-icon">&#128008;</div>
                    <div class="det-num" id="count-cat">--</div>
                    <div class="det-label">Cat</div>
                </div>
                <div class="det-box bird">
                    <div class="det-icon">&#128038;</div>
                    <div class="det-num" id="count-bird">--</div>
                    <div class="det-label">Bird</div>
                </div>
                <div class="det-box cow">
                    <div class="det-icon">&#128004;</div>
                    <div class="det-num" id="count-cow">--</div>
                    <div class="det-label">Cow</div>
                </div>
                <div class="det-box horse">
                    <div class="det-icon">&#128014;</div>
                    <div class="det-num" id="count-horse">--</div>
                    <div class="det-label">Horse</div>
                </div>
                <div class="det-box sheep">
                    <div class="det-icon">&#128017;</div>
                    <div class="det-num" id="count-sheep">--</div>
                    <div class="det-label">Sheep</div>
                </div>
            </div>
        </div>

        <!-- Hourly Chart -->
        <div class="panel">
            <h2>Traffic by Hour</h2>
            <div class="hourly-chart" id="hourly-chart"></div>
            <div class="hour-labels">
                <span>12AM</span>
                <span>6AM</span>
                <span>12PM</span>
                <span>6PM</span>
                <span>11PM</span>
            </div>
        </div>

        <div class="two-col">
            <!-- Week Chart -->
            <div class="panel">
                <h2>Last 7 Days</h2>
                <div class="week-chart" id="week-chart"></div>
            </div>

            <!-- Last Detection -->
            <div class="panel">
                <h2>Last Detection</h2>
                <div class="snapshot-container">
                    <img id="snapshot" class="snapshot-img" alt="Last detection">
                    <div class="snapshot-time" id="snapshot-time">--</div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="panel">
            <h2>Recent Detections</h2>
            <div class="recent-list" id="recent-list"></div>
        </div>

        <div class="status" id="status">
            <span id="status-text">Connecting...</span>
        </div>
    </div>

    <script>
        let API_BASE = 'https://speedcam.h8s.us';
        let lastHourlyHash = '';

        // Load config
        async function loadConfig() {
            try {
                const res = await fetch('speedcam-config.json?t=' + Date.now());
                const config = await res.json();
                if (config.apiUrl) {
                    API_BASE = config.apiUrl;
                    console.log('API URL:', API_BASE);
                }
            } catch (e) {
                console.log('Using default API URL');
            }
        }

        // Update sound level meter
        function updateSoundLevel(currentDb, peakDb) {
            const currentEl = document.getElementById('current-db');
            const peakEl = document.getElementById('peak-db');
            const fillEl = document.getElementById('sound-meter-fill');
            const peakMarker = document.getElementById('sound-meter-peak');

            if (currentDb === null || currentDb === undefined) {
                currentEl.textContent = '--';
                peakEl.textContent = '--';
                fillEl.style.width = '0%';
                return;
            }

            // Convert negative dB to positive display scale
            // -60 dB (quiet) → 0, -40 dB → 20, -20 dB → 40, 0 dB (loud) → 60
            // Higher displayed number = louder
            const currentPositive = Math.max(0, 60 + currentDb);
            const peakPositive = peakDb !== null ? Math.max(0, 60 + peakDb) : null;

            currentEl.textContent = currentPositive.toFixed(0);
            peakEl.textContent = peakPositive !== null ? peakPositive.toFixed(0) : '--';

            // Convert dB to percentage for meter (-60 to 0 dB range)
            // -60 dB = 0%, 0 dB = 100%
            const minDb = -60;
            const maxDb = 0;
            const currentPct = Math.max(0, Math.min(100, ((currentDb - minDb) / (maxDb - minDb)) * 100));
            const peakPct = peakDb !== null ? Math.max(0, Math.min(100, ((peakDb - minDb) / (maxDb - minDb)) * 100)) : 0;

            fillEl.style.width = currentPct + '%';
            peakMarker.style.left = peakPct + '%';

            // Color based on loudness (using original negative scale)
            currentEl.className = 'sound-db';
            if (currentDb > -10) {
                currentEl.classList.add('very-loud');
            } else if (currentDb > -25) {
                currentEl.classList.add('loud');
            }
        }

        // Object type icons for recent list
        const typeIcons = {
            'car': '&#128663;', 'bus': '&#128652;', 'motorbike': '&#127949;',
            'bicycle': '&#128690;', 'person': '&#128694;',
            'dog': '&#128021;', 'cat': '&#128008;', 'bird': '&#128038;',
            'cow': '&#128004;', 'horse': '&#128014;', 'sheep': '&#128017;'
        };

        async function updateStats() {
            try {
                // Get stats with per-object-type counts from API
                const res = await fetch(`${API_BASE}/api/traffic/stats`);
                const data = await res.json();

                // Total and current hour
                document.getElementById('total-today').textContent = data.total_count || 0;
                document.getElementById('current-hour').textContent = data.current_hour_count || 0;

                // Per-object-type counts from MobileNet AI detector
                const counts = data.counts || {};
                document.getElementById('count-car').textContent = counts.car || 0;
                document.getElementById('count-bus').textContent = counts.bus || 0;
                document.getElementById('count-motorbike').textContent = counts.motorbike || 0;
                document.getElementById('count-bicycle').textContent = counts.bicycle || 0;
                document.getElementById('count-person').textContent = counts.person || 0;
                document.getElementById('count-dog').textContent = counts.dog || 0;
                document.getElementById('count-cat').textContent = counts.cat || 0;
                document.getElementById('count-bird').textContent = counts.bird || 0;
                document.getElementById('count-cow').textContent = counts.cow || 0;
                document.getElementById('count-horse').textContent = counts.horse || 0;
                document.getElementById('count-sheep').textContent = counts.sheep || 0;

                // Sound level display (dB values typically range from -60 to 0)
                updateSoundLevel(data.current_db, data.peak_db);

                document.getElementById('status').className = 'status';
                document.getElementById('status-text').textContent = 'Live';

            } catch (err) {
                console.error('Stats error:', err);
                document.getElementById('status').className = 'status offline';
                document.getElementById('status-text').textContent = 'Connection Lost';
            }
        }

        async function updateTrafficStats() {
            // Now handled in updateStats()
        }

        async function updateHourlyChart() {
            try {
                const res = await fetch(`${API_BASE}/api/traffic/hourly`);
                const data = await res.json();

                const hash = JSON.stringify(data.hourly);
                if (hash === lastHourlyHash) return;
                lastHourlyHash = hash;

                const chart = document.getElementById('hourly-chart');
                const currentHour = new Date().getHours();
                const maxCount = Math.max(...data.hourly.map(h => h.count), 1);

                chart.innerHTML = data.hourly.map(h => {
                    const height = (h.count / maxCount) * 100;
                    const isCurrent = h.hour === currentHour;
                    return `
                        <div class="hour-bar ${isCurrent ? 'current' : ''}" style="height: ${Math.max(height, 2)}%">
                            <div class="tooltip">${h.label}: ${h.count}</div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Hourly error:', err);
            }
        }

        async function updateWeekChart() {
            try {
                const res = await fetch(`${API_BASE}/api/traffic/week`);
                const data = await res.json();

                const chart = document.getElementById('week-chart');
                const maxCount = Math.max(...data.week.map(d => d.count), 1);

                chart.innerHTML = data.week.map(d => {
                    const height = (d.count / maxCount) * 100;
                    return `
                        <div class="day-bar">
                            <div class="day-bar-fill">
                                <div class="day-bar-inner" style="height: ${Math.max(height, 2)}%"></div>
                            </div>
                            <div class="day-label">${d.day}</div>
                            <div class="day-count">${d.count}</div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Week error:', err);
            }
        }

        async function updateRecent() {
            try {
                const res = await fetch(`${API_BASE}/api/speed/all`);
                const data = await res.json();

                const list = document.getElementById('recent-list');
                const speeds = (data.speeds || []).slice(-15).reverse();

                list.innerHTML = speeds.map(item => {
                    const time = item.timestamp ? item.timestamp.split(' ')[1] : '--';
                    const icon = typeIcons[item.object_type] || '&#10067;';
                    const speedClass = item.speed > 30 ? 'fast' : '';
                    return `
                        <div class="recent-item">
                            <span class="obj-type">${icon} ${item.object_type || 'unknown'}</span>
                            <span class="speed ${speedClass}">${item.speed ? item.speed.toFixed(0) + ' mph' : '--'}</span>
                            <span class="time">${time}</span>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Recent error:', err);
            }
        }

        function updateSnapshot() {
            const img = document.getElementById('snapshot');
            const newImg = new Image();
            newImg.onload = function() {
                img.src = this.src;
                img.classList.add('loaded');
            };
            newImg.src = `${API_BASE}/api/camera/snapshot?t=${Date.now()}`;
        }

        async function init() {
            await loadConfig();

            // Initial load
            updateStats();
            updateTrafficStats();
            updateHourlyChart();
            updateWeekChart();
            updateRecent();
            updateSnapshot();

            // Refresh intervals
            setInterval(updateStats, 3000);
            setInterval(updateTrafficStats, 3000);
            setInterval(updateHourlyChart, 10000);
            setInterval(updateWeekChart, 60000);
            setInterval(updateRecent, 5000);
            setInterval(updateSnapshot, 10000);
        }

        init();
    </script>
</body>
</html>
