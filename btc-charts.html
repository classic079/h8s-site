<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Charts - Misty Cam</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a1628;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            padding: 6px;
            height: 100vh;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: auto;
        }

        .chart-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(34, 197, 94, 0.2);
            min-height: 0;
            overflow: hidden;
        }

        .panel-left {
            height: 280px;
            flex-shrink: 0;
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .timeframe-selector { display: flex; gap: 4px; flex-wrap: wrap; }

        .tf-btn {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #94a3b8;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .tf-btn:hover { background: rgba(34, 197, 94, 0.3); color: #e2e8f0; }
        .tf-btn.active { background: rgba(34, 197, 94, 0.5); color: #22c55e; border-color: #22c55e; font-weight: bold; }

        .price-display {
            font-size: 22px;
            margin-left: auto;
            color: #f7931a;
            background: rgba(247, 147, 26, 0.15);
            padding: 4px 10px;
            border-radius: 8px;
            border: 1px solid rgba(247, 147, 26, 0.3);
        }

        .change-badge {
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .change-badge.up { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .change-badge.down { background: rgba(220, 38, 38, 0.2); color: #dc2626; }

        .panel-left .chart-container { flex: 1; }
        .chart-container { flex: 0.25; position: relative; min-height: 0; }
        canvas { width: 100% !important; height: 100% !important; }

        .stats { display: flex; justify-content: space-around; margin-top: 6px; }
        .stat { text-align: center; }
        .stat-label { color: #94a3b8; font-size: 12px; font-weight: bold; }
        .stat-value { color: #e2e8f0; font-weight: bold; font-size: 16px; }
        .stat-value.up { color: #22c55e; }
        .stat-value.down { color: #dc2626; }

        .gauge-container { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
        .gauge-label { font-size: 14px; font-weight: bold; }
        .gauge-bar { flex: 1; position: relative; height: 8px; }
        #biasGauge { width: 100%; height: 100%; border-radius: 4px; }
        .needle { position: absolute; top: -3px; width: 3px; height: 14px; background: white; box-shadow: 0 0 4px rgba(0,0,0,0.5); transition: left 0.2s; }

        .panel-right {
            height: 280px;
        }
        .panel-right .chart-container { flex: 1; }
        .panel-right .tf-btn.active { background: rgba(247, 147, 26, 0.5); border-color: #f7931a; color: #f7931a; }
        .panel-right .tf-btn { border-color: rgba(247, 147, 26, 0.3); background: rgba(247, 147, 26, 0.15); }
        .panel-right .tf-btn:hover { background: rgba(247, 147, 26, 0.3); }

        /* Energy Panel */
        .energy-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(250, 204, 21, 0.3);
            flex-shrink: 0;
        }

        .energy-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 4px;
        }

        .energy-title {
            font-size: 12px;
            color: #facc15;
            font-weight: bold;
        }

        .energy-live {
            font-size: 42px;
            font-weight: bold;
            color: #22c55e;
        }

        .energy-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 4px;
        }

        .energy-stat {
            text-align: center;
        }

        .energy-stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .energy-stat-value {
            font-size: 26px;
            font-weight: bold;
        }

        .energy-stat-value.solar { color: #facc15; }
        .energy-stat-value.cost { color: #22c55e; }
        .energy-stat-value.usage { color: #3b82f6; }

        .top-users-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            padding-top: 3px;
        }

        .top-users-col {
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

        .top-col-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .top-col-header.live { color: #f97316; }
        .top-col-header.day { color: #22c55e; }
        .top-col-header.month { color: #3b82f6; }

        .top-item {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            gap: 4px;
            line-height: 1.2;
        }
        .top-item-name { color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .top-item-val { font-weight: bold; white-space: nowrap; }
        .top-item-val.live { color: #f97316; }
        .top-item-val.day { color: #22c55e; }
        .top-item-val.month { color: #3b82f6; }

        /* Misty Camera Panel */
        .camera-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(139, 92, 246, 0.4);
            overflow: hidden;
            position: relative;
            height: 280px;
            flex-shrink: 0;
        }

        /* News Panel */
        .news-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .news-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .news-title {
            font-size: 14px;
            color: #3b82f6;
            font-weight: bold;
        }

        .news-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .news-loading {
            color: #94a3b8;
            text-align: center;
            padding: 20px;
        }

        .news-item {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            padding: 8px;
            border-left: 3px solid #3b82f6;
        }

        .news-item-title {
            font-size: 13px;
            color: #e2e8f0;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .news-item-meta {
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            gap: 8px;
        }

        .news-item-source {
            color: #3b82f6;
        }

        .news-item-time {
            color: #64748b;
        }

        /* Middle column layout */
        .middle-column {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: auto;
        }

        /* Utilities Panel */
        .utilities-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(168, 85, 247, 0.4);
            flex-shrink: 0;
            height: 200px;
            overflow: auto;
        }

        /* Alarm Panel */
        .alarm-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(239, 68, 68, 0.4);
            flex-shrink: 0;
            flex: 1;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .alarm-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .alarm-title {
            font-size: 12px;
            color: #ef4444;
            font-weight: bold;
        }

        .alarm-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: auto;
        }

        .alarm-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
            font-size: 14px;
        }

        .alarm-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
        }

        .alarm-indicator.alert {
            background: #ef4444;
            animation: pulse-alert 1s infinite;
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px rgba(239, 68, 68, 0.8); }
            50% { opacity: 0.5; box-shadow: none; }
        }

        .alarm-name {
            flex: 1;
            color: #94a3b8;
        }

        .alarm-status {
            font-weight: bold;
            color: #22c55e;
        }

        .alarm-status.alert {
            color: #ef4444;
        }

        .utilities-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .utilities-title {
            font-size: 12px;
            color: #a855f7;
            font-weight: bold;
        }

        .utilities-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .utility-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .utility-header {
            font-size: 16px;
            color: #94a3b8;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: bold;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .utility-icon {
            font-size: 18px;
        }

        .utility-row {
            display: flex;
            justify-content: space-between;
            font-size: 17px;
            line-height: 1.5;
        }

        .utility-label {
            color: #94a3b8;
        }

        .utility-value {
            font-weight: bold;
        }

        .utility-value.gas { color: #f97316; }
        .utility-value.internet { color: #3b82f6; }
        .utility-value.water { color: #06b6d4; }

        .utility-placeholder {
            color: #4b5563;
            font-size: 11px;
            font-style: italic;
        }

        .utility-divider {
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            margin: 4px 0;
        }

        .camera-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        .camera-title {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #a78bfa;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.7);
            z-index: 10;
            background: rgba(0,0,0,0.6);
            padding: 2px 10px;
            border-radius: 4px;
            border: 1px solid rgba(139, 92, 246, 0.4);
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Overlay Stats */
        .overlay-stats {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            padding: 20px 8px 8px 8px;
            z-index: 10;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item-label {
            font-size: 13px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .stat-item-value {
            font-size: 26px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0,0,0,0.9);
        }

        .stat-item.hot .stat-item-value { color: #ef4444; }
        .stat-item.cool .stat-item-value { color: #3b82f6; }
        .stat-item.humid .stat-item-value { color: #22d3ee; }
        .stat-item.power .stat-item-value { color: #fbbf24; }

        /* Device Status Row */
        .device-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 6px;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
        }

        .device-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4b5563;
        }

        .device-indicator.on {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
        }

        .device-indicator.off {
            background: #6b7280;
        }

        .device-name {
            color: #94a3b8;
        }

        .device-name.on {
            color: #22c55e;
        }

        .version-tag {
            position: fixed;
            bottom: 4px;
            right: 8px;
            font-size: 12px;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Loading state */
        .camera-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #a78bfa;
            font-size: 16px;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="version-tag" onclick="location.reload()">v12.0</div>

    <div class="container">
        <div class="left-column">
            <div class="chart-panel panel-left">
                <div class="chart-header">
                    <div class="timeframe-selector" id="tf-left">
                        <button class="tf-btn" data-tf="30d">30D</button>
                        <button class="tf-btn active" data-tf="24h">24H</button>
                        <button class="tf-btn" data-tf="8h">8H</button>
                        <button class="tf-btn" data-tf="1h">1H</button>
                        <button class="tf-btn" data-tf="5m">5M</button>
                        <button class="tf-btn" data-tf="1m">1M</button>
                    </div>
                    <span class="change-badge" id="change-left">--</span>
                </div>
                <div class="chart-container"><canvas id="chart-left"></canvas></div>
                <div class="stats">
                    <div class="stat"><div class="stat-label">HIGH</div><div class="stat-value" id="high-left">-</div></div>
                    <div class="stat"><div class="stat-label">LOW</div><div class="stat-value" id="low-left">-</div></div>
                    <div class="stat"><div class="stat-label">RANGE</div><div class="stat-value" id="range-left">-</div></div>
                </div>
            </div>

            <div class="energy-panel">
                <div class="energy-header">
                    <span class="energy-title">POWER</span>
                    <span class="energy-live" id="live-usage">-- W</span>
                </div>
                <div class="energy-grid">
                    <div class="energy-stat">
                        <div class="energy-stat-label">Solar Now</div>
                        <div class="energy-stat-value solar" id="solar-now">-- W</div>
                    </div>
                    <div class="energy-stat">
                        <div class="energy-stat-label">Solar Mth</div>
                        <div class="energy-stat-value solar" id="solar-month">$--</div>
                    </div>
                    <div class="energy-stat">
                        <div class="energy-stat-label">Today</div>
                        <div class="energy-stat-value cost" id="cost-today">$--</div>
                    </div>
                    <div class="energy-stat">
                        <div class="energy-stat-label">Month</div>
                        <div class="energy-stat-value usage" id="month-cost">$--</div>
                    </div>
                </div>
                <div class="top-users-grid">
                    <div class="top-users-col">
                        <div class="top-col-header live">LIVE</div>
                        <div class="top-item" id="live1"></div>
                        <div class="top-item" id="live2"></div>
                        <div class="top-item" id="live3"></div>
                        <div class="top-item" id="live4"></div>
                        <div class="top-item" id="live5"></div>
                    </div>
                    <div class="top-users-col">
                        <div class="top-col-header day">DAY</div>
                        <div class="top-item" id="day1"></div>
                        <div class="top-item" id="day2"></div>
                        <div class="top-item" id="day3"></div>
                        <div class="top-item" id="day4"></div>
                        <div class="top-item" id="day5"></div>
                    </div>
                    <div class="top-users-col">
                        <div class="top-col-header month">MONTH</div>
                        <div class="top-item" id="month1"></div>
                        <div class="top-item" id="month2"></div>
                        <div class="top-item" id="month3"></div>
                        <div class="top-item" id="month4"></div>
                        <div class="top-item" id="month5"></div>
                    </div>
                </div>
            </div>

            <!-- Misty Camera Panel -->
            <div class="camera-panel">
                <div class="camera-container">
                    <div class="camera-title">Misty</div>
                    <div class="camera-loading" id="camera-loading">Loading camera...</div>
                    <img id="camera-feed" class="camera-feed" alt="Misty Cam" style="display:none;">

                    <div class="overlay-stats">
                        <div class="stats-row">
                            <div class="stat-item hot">
                                <div class="stat-item-label">Hot</div>
                                <div class="stat-item-value" id="hot-temp">--Â°</div>
                            </div>
                            <div class="stat-item cool">
                                <div class="stat-item-label">Cool</div>
                                <div class="stat-item-value" id="cool-temp">--Â°</div>
                            </div>
                            <div class="stat-item humid">
                                <div class="stat-item-label">Humid</div>
                                <div class="stat-item-value" id="humidity">--%</div>
                            </div>
                            <div class="stat-item power">
                                <div class="stat-item-label">Miner</div>
                                <div class="stat-item-value" id="miner-watts">--W</div>
                            </div>
                        </div>
                        <div class="device-row">
                            <div class="device-status">
                                <div class="device-indicator" id="ceramic-ind"></div>
                                <span class="device-name" id="ceramic-label">Ceramic</span>
                            </div>
                            <div class="device-status">
                                <div class="device-indicator" id="lamp-ind"></div>
                                <span class="device-name" id="lamp-label">Heat Lamp</span>
                            </div>
                            <div class="device-status">
                                <div class="device-indicator" id="light-ind"></div>
                                <span class="device-name" id="light-label">Light</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="middle-column">
            <div class="chart-panel panel-right">
                <div class="chart-header">
                    <div class="timeframe-selector" id="tf-right">
                        <button class="tf-btn" data-tf="30d">30D</button>
                        <button class="tf-btn" data-tf="24h">24H</button>
                        <button class="tf-btn" data-tf="8h">8H</button>
                        <button class="tf-btn" data-tf="1h">1H</button>
                        <button class="tf-btn active" data-tf="5m">5M</button>
                        <button class="tf-btn" data-tf="1m">1M</button>
                    </div>
                    <span class="change-badge" id="change-right">--</span>
                    <span class="price-display" id="current-price">$--,---</span>
                </div>
                <div class="chart-container"><canvas id="chart-right"></canvas></div>
                <div class="gauge-container">
                    <span class="gauge-label" style="color:#22c55e;">BUY</span>
                    <div class="gauge-bar">
                        <canvas id="biasGauge"></canvas>
                        <div id="needle" class="needle" style="left:50%;"></div>
                    </div>
                    <span class="gauge-label" style="color:#dc2626;">SELL</span>
                </div>
                <div class="stats">
                    <div class="stat"><div class="stat-label">HIGH</div><div class="stat-value" id="high-right">-</div></div>
                    <div class="stat"><div class="stat-label">LOW</div><div class="stat-value" id="low-right">-</div></div>
                    <div class="stat"><div class="stat-label">RANGE</div><div class="stat-value" id="range-right">-</div></div>
                </div>
            </div>

            <!-- Utilities Panel -->
            <div class="utilities-panel">
                <div class="utilities-grid">
                    <div class="utility-section">
                        <div class="utility-header">
                            <span class="utility-icon">ðŸ”¥</span>
                            <span>Natural Gas</span>
                        </div>
                        <div class="utility-row">
                            <span class="utility-label">Today:</span>
                            <span class="utility-value gas" id="gas-today">--</span>
                        </div>
                        <div class="utility-row">
                            <span class="utility-label">Week:</span>
                            <span class="utility-value gas" id="gas-week">--</span>
                        </div>
                        <div class="utility-row">
                            <span class="utility-label">Month:</span>
                            <span class="utility-value gas" id="gas-month">--</span>
                        </div>
                    </div>
                    <div class="utility-section">
                        <div class="utility-header">
                            <span class="utility-icon">ðŸ“¶</span>
                            <span>Internet</span>
                        </div>
                        <div class="utility-row">
                            <span class="utility-label">â†‘ Up:</span>
                            <span class="utility-value internet" id="internet-up">--</span>
                        </div>
                        <div class="utility-row">
                            <span class="utility-label">â†“ Down:</span>
                            <span class="utility-value internet" id="internet-down">--</span>
                        </div>
                    </div>
                    <div class="utility-section">
                        <div class="utility-header">
                            <span class="utility-icon">ðŸ’§</span>
                            <span>Water</span>
                        </div>
                        <div class="utility-placeholder">Coming soon</div>
                    </div>
                </div>
            </div>

            <!-- Alarm Panel -->
            <div class="alarm-panel">
                <div class="alarm-header">
                    <span class="alarm-title">ALERTS</span>
                </div>
                <div class="alarm-content" id="alarm-content">
                    <div class="alarm-item">
                        <div class="alarm-indicator" id="alarm-sewer-ind"></div>
                        <span class="alarm-name">Basement Sewer</span>
                        <span class="alarm-status" id="alarm-sewer-status">OK</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Panel -->
        <div class="news-panel">
            <div class="news-header">
                <span class="news-title">NEWS</span>
            </div>
            <div class="news-content" id="news-content">
                <div class="news-loading">Loading news...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const HA_URL = 'http://192.168.86.58:8123';
        const HA_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI5NmNmOGIxMTM5ZWI0ZTlmYmQ0MGZhYjRjZDgwNGY1YSIsImlhdCI6MTc2MzQ5Njg4OSwiZXhwIjoyMDc4ODU2ODg5fQ.uAPxDAuNGOSooPLcSnqzSFYGHEtjmkfzDVjGvzhiwnc';

        // Misty entities
        const ENTITIES = {
            hotSide: 'sensor.snake_temp_sensor_snake_cage_hot_side_temp_f',
            coolSide: 'sensor.snake_temp_sensor_snake_cage_cool_side_temp_f',
            humidity: 'sensor.snek_cage_govee_sensor_humidity',
            minerWatts: 'sensor.mistyminer_miner_consumption',
            ceramicHeater: 'switch.tp_link_power_strip_06b5_snek_ceramic_heater',
            heatLamp: 'switch.tp_link_power_strip_06b5_snek_heat_lamp',
            light: 'light.misty_daybulb',
            camera: 'camera.mistycam'
        };

        // BTC Chart setup
        const tfConfigs = {
            '30d': { granularity: 86400, seconds: 30*24*3600, liveUpdate: false },
            '24h': { granularity: 900, seconds: 24*3600, liveUpdate: false },
            '8h':  { granularity: 300, seconds: 8*3600, liveUpdate: false },
            '1h':  { granularity: 60, seconds: 3600, liveUpdate: false },
            '5m':  { granularity: 60, seconds: 300, liveUpdate: true },
            '1m':  { granularity: 60, seconds: 60, liveUpdate: true }
        };
        const panels = { left: { tf: '24h', chart: null, data: { timestamps: [], prices: [] } }, right: { tf: '5m', chart: null, data: { timestamps: [], prices: [] } } };
        let currentPrice = 0, buyVol = 0, sellVol = 0, needlePos = 0.5;

        function initChart(panelId, color) {
            const ctx = document.getElementById(`chart-${panelId}`).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: color, backgroundColor: color.replace(')',', 0.1)').replace('rgb','rgba'), borderWidth: 2, pointRadius: 0, tension: 0.2, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true, grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: color, font: { size: 14 }, maxTicksLimit: 4 } } } }
            });
        }
        panels.left.chart = initChart('left', 'rgb(34, 197, 94)');
        panels.right.chart = initChart('right', 'rgb(247, 147, 26)');

        async function fetchData(panelId) {
            const panel = panels[panelId], config = tfConfigs[panel.tf];
            const end = Math.floor(Date.now()/1000), start = end - config.seconds;
            try {
                const response = await fetch(`https://api.exchange.coinbase.com/products/BTC-USD/candles?start=${start}&end=${end}&granularity=${config.liveUpdate ? 60 : config.granularity}`);
                const data = await response.json();
                panel.data.timestamps = []; panel.data.prices = [];
                data.reverse().forEach(c => { panel.data.timestamps.push(c[0]); panel.data.prices.push(c[4]); });
                updateChart(panelId); updateStats(panelId);
            } catch (e) { console.error(e); }
        }

        function updateChart(panelId) {
            const panel = panels[panelId], config = tfConfigs[panel.tf];
            panel.chart.data.labels = panel.data.timestamps.map(t => config.seconds >= 86400 ? new Date(t*1000).toLocaleDateString([],{month:'short',day:'numeric'}) : new Date(t*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
            panel.chart.data.datasets[0].data = panel.data.prices;
            const prices = panel.data.prices;
            if (prices.length > 1) {
                const isUp = prices[prices.length-1] >= prices[0];
                const color = isUp ? 'rgb(34, 197, 94)' : 'rgb(220, 38, 38)';
                panel.chart.data.datasets[0].borderColor = color;
                panel.chart.data.datasets[0].backgroundColor = color.replace(')',', 0.1)').replace('rgb','rgba');
                panel.chart.options.scales.y.ticks.color = color;
            }
            panel.chart.update('none');
        }

        function updateStats(panelId) {
            const panel = panels[panelId], prices = panel.data.prices;
            if (!prices.length) return;
            const curr = prices[prices.length-1], start = prices[0], high = Math.max(...prices), low = Math.min(...prices), range = high - low;
            const changePct = ((curr - start) / start) * 100, isUp = changePct >= 0, rangePct = (range / start) * 100;
            document.getElementById(`high-${panelId}`).textContent = `$${high.toLocaleString('en-US',{maximumFractionDigits:0})}`;
            document.getElementById(`low-${panelId}`).textContent = `$${low.toLocaleString('en-US',{maximumFractionDigits:0})}`;
            const rangeEl = document.getElementById(`range-${panelId}`);
            rangeEl.innerHTML = `$${range.toLocaleString('en-US',{maximumFractionDigits:0})} <span style="font-size:12px;">(${rangePct.toFixed(2)}%)</span>`;
            rangeEl.className = 'stat-value';
            document.getElementById(`change-${panelId}`).textContent = `${isUp?'+':''}${changePct.toFixed(2)}%`;
            document.getElementById(`change-${panelId}`).className = `change-badge ${isUp ? 'up' : 'down'}`;
        }

        document.querySelectorAll('.timeframe-selector').forEach(sel => {
            const panelId = sel.id.replace('tf-', '');
            sel.querySelectorAll('.tf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    sel.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    panels[panelId].tf = btn.dataset.tf;
                    fetchData(panelId);
                });
            });
        });

        function drawGauge() {
            const canvas = document.getElementById('biasGauge');
            if (!canvas) return;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            const ctx = canvas.getContext('2d'), w = canvas.width, h = canvas.height;
            ctx.clearRect(0,0,w,h);
            const total = buyVol + sellVol, target = total ? (buyVol/total) : 0.5;
            needlePos += (target - needlePos) * 0.25;
            const g = ctx.createLinearGradient(0,0,w,0);
            g.addColorStop(0,'#22c55e'); g.addColorStop(Math.max(0,needlePos-0.001),'#22c55e');
            g.addColorStop(Math.min(1,needlePos+0.001),'#dc2626'); g.addColorStop(1,'#dc2626');
            ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
            document.getElementById('needle').style.left = (needlePos*100)+'%';
        }

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type:'subscribe', product_ids:['BTC-USD'], channels:['ticker','matches'] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker' && data.price) {
                currentPrice = parseFloat(data.price);
                document.getElementById('current-price').textContent = `$${currentPrice.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
                ['left','right'].forEach(panelId => {
                    const panel = panels[panelId], config = tfConfigs[panel.tf];
                    if (config.liveUpdate) {
                        const now = Math.floor(Date.now()/1000);
                        panel.data.timestamps.push(now); panel.data.prices.push(currentPrice);
                        const cutoff = now - config.seconds;
                        while (panel.data.timestamps.length && panel.data.timestamps[0] < cutoff) { panel.data.timestamps.shift(); panel.data.prices.shift(); }
                        updateChart(panelId); updateStats(panelId);
                    }
                });
            }
            if (data.type === 'match') { const size = parseFloat(data.size); if (data.side === 'buy') buyVol += size; else sellVol += size; drawGauge(); }
        };

        // HA API functions
        async function fetchHAState(entityId) {
            try {
                const response = await fetch(`${HA_URL}/api/states/${entityId}`, {
                    headers: { 'Authorization': `Bearer ${HA_TOKEN}` }
                });
                const data = await response.json();
                return data;
            } catch (e) {
                console.error('Error fetching', entityId, e);
                return null;
            }
        }

        async function updateMistyStats() {
            // Fetch all states
            const [hotSide, coolSide, humidity, minerWatts, ceramic, lamp, light] = await Promise.all([
                fetchHAState(ENTITIES.hotSide),
                fetchHAState(ENTITIES.coolSide),
                fetchHAState(ENTITIES.humidity),
                fetchHAState(ENTITIES.minerWatts),
                fetchHAState(ENTITIES.ceramicHeater),
                fetchHAState(ENTITIES.heatLamp),
                fetchHAState(ENTITIES.light)
            ]);

            // Update temperatures
            if (hotSide && hotSide.state !== 'unavailable') {
                document.getElementById('hot-temp').textContent = `${parseFloat(hotSide.state).toFixed(0)}Â°`;
            }
            if (coolSide && coolSide.state !== 'unavailable') {
                document.getElementById('cool-temp').textContent = `${parseFloat(coolSide.state).toFixed(0)}Â°`;
            }
            if (humidity && humidity.state !== 'unavailable') {
                document.getElementById('humidity').textContent = `${parseFloat(humidity.state).toFixed(0)}%`;
            }
            if (minerWatts && minerWatts.state !== 'unavailable') {
                document.getElementById('miner-watts').textContent = `${parseFloat(minerWatts.state).toFixed(0)}W`;
            }

            // Update device status indicators
            const updateDevice = (indicator, label, state) => {
                const isOn = state && state.state === 'on';
                indicator.classList.toggle('on', isOn);
                indicator.classList.toggle('off', !isOn);
                label.classList.toggle('on', isOn);
            };

            updateDevice(
                document.getElementById('ceramic-ind'),
                document.getElementById('ceramic-label'),
                ceramic
            );
            updateDevice(
                document.getElementById('lamp-ind'),
                document.getElementById('lamp-label'),
                lamp
            );
            updateDevice(
                document.getElementById('light-ind'),
                document.getElementById('light-label'),
                light
            );
        }

        // Energy monitoring entities
        const ENERGY_ENTITIES = {
            liveUsage: 'sensor.horns_house_power_minute_average',
            solarNow: 'sensor.solar_power_minute_average',
            costToday: 'sensor.daily_energy_cost',
            monthKwh: 'sensor.horns_house_energy_this_month',
            solarMonth: 'sensor.solar_energy_this_month',
            // Power users to check (base name without suffix)
            powerUsers: [
                { base: 'bitcoin_miner', name: 'Bitcoin Miner' },
                { base: 'bedroom_miner', name: 'Bedroom Miner' },
                { base: 'a_c_condenser', name: 'A/C' },
                { base: 'dryer', name: 'Dryer' },
                { base: 'ev_charger', name: 'EV Charger' },
                { base: 'pool_pump', name: 'Pool Pump' },
                { base: 'side_door_server_rack', name: 'Server Rack' },
                { base: 'john_s_computer', name: "John's PC" },
                { base: 'stove', name: 'Stove' },
                { base: 'dishwasher', name: 'Dishwasher' },
                { base: 'furnace', name: 'Furnace' },
                { base: 'split_unit', name: 'Split Unit' },
                { base: 'split_units', name: 'Split Units' },
                { base: 'garage_charger', name: 'Garage Charger' },
                { base: 'kitchen_fridge', name: 'Fridge' },
                { base: 'tv_area', name: 'TV Area' }
            ]
        };

        async function updateEnergyStats() {
            try {
                // Fetch all states at once
                const response = await fetch(`${HA_URL}/api/states`, {
                    headers: { 'Authorization': `Bearer ${HA_TOKEN}` }
                });
                const allStates = await response.json();

                // Create a map for quick lookup
                const stateMap = {};
                allStates.forEach(s => stateMap[s.entity_id] = s);

                // Update main stats
                const liveUsage = stateMap[ENERGY_ENTITIES.liveUsage];
                if (liveUsage && liveUsage.state !== 'unavailable') {
                    const watts = parseFloat(liveUsage.state);
                    const formatted = watts.toLocaleString('en-US', {maximumFractionDigits: 0});
                    document.getElementById('live-usage').textContent = `${formatted} W`;
                    document.getElementById('live-usage').style.color = watts < 0 ? '#22c55e' : '#f97316';
                }

                const solarNow = stateMap[ENERGY_ENTITIES.solarNow];
                if (solarNow && solarNow.state !== 'unavailable') {
                    document.getElementById('solar-now').textContent = `${parseFloat(solarNow.state).toFixed(0)} W`;
                }

                const costToday = stateMap[ENERGY_ENTITIES.costToday];
                if (costToday && costToday.state !== 'unavailable') {
                    document.getElementById('cost-today').textContent = `$${parseFloat(costToday.state).toFixed(2)}`;
                }

                const monthKwh = stateMap[ENERGY_ENTITIES.monthKwh];
                if (monthKwh && monthKwh.state !== 'unavailable') {
                    // Calculate cost at $0.15/kWh rate
                    const kwh = parseFloat(monthKwh.state);
                    const cost = kwh * 0.15;
                    document.getElementById('month-cost').textContent = `$${cost.toFixed(0)}`;
                }

                const solarMonth = stateMap[ENERGY_ENTITIES.solarMonth];
                if (solarMonth && solarMonth.state !== 'unavailable') {
                    // Calculate solar savings at $0.15/kWh rate
                    const kwh = parseFloat(solarMonth.state);
                    const savings = kwh * 0.15;
                    document.getElementById('solar-month').textContent = `$${savings.toFixed(0)}`;
                }

                // Collect power data for all users
                const RATE = 0.15;
                const liveData = [];
                const dayData = [];
                const monthData = [];

                ENERGY_ENTITIES.powerUsers.forEach(user => {
                    const liveEntity = `sensor.${user.base}_power_minute_average`;
                    const dayEntity = `sensor.${user.base}_energy_today`;
                    const monthEntity = `sensor.${user.base}_energy_this_month`;

                    const liveState = stateMap[liveEntity];
                    const dayState = stateMap[dayEntity];
                    const monthState = stateMap[monthEntity];

                    if (liveState && liveState.state !== 'unavailable' && liveState.state !== 'unknown') {
                        const watts = parseFloat(liveState.state);
                        if (watts > 1) liveData.push({ name: user.name, value: watts });
                    }
                    if (dayState && dayState.state !== 'unavailable' && dayState.state !== 'unknown') {
                        const kwh = parseFloat(dayState.state);
                        if (kwh > 0.01) dayData.push({ name: user.name, value: kwh * RATE });
                    }
                    if (monthState && monthState.state !== 'unavailable' && monthState.state !== 'unknown') {
                        const kwh = parseFloat(monthState.state);
                        if (kwh > 0.1) monthData.push({ name: user.name, value: kwh * RATE });
                    }
                });

                // Sort each list independently
                liveData.sort((a, b) => b.value - a.value);
                dayData.sort((a, b) => b.value - a.value);
                monthData.sort((a, b) => b.value - a.value);

                // Update top 5 for each column
                for (let i = 0; i < 5; i++) {
                    const liveEl = document.getElementById(`live${i+1}`);
                    const dayEl = document.getElementById(`day${i+1}`);
                    const monthEl = document.getElementById(`month${i+1}`);

                    if (liveData[i]) {
                        const watts = liveData[i].value.toLocaleString('en-US', {maximumFractionDigits: 0});
                        liveEl.innerHTML = `<span class="top-item-name">${liveData[i].name}</span><span class="top-item-val live">${watts}W</span>`;
                    } else {
                        liveEl.innerHTML = '';
                    }
                    if (dayData[i]) {
                        dayEl.innerHTML = `<span class="top-item-name">${dayData[i].name}</span><span class="top-item-val day">$${dayData[i].value.toFixed(2)}</span>`;
                    } else {
                        dayEl.innerHTML = '';
                    }
                    if (monthData[i]) {
                        monthEl.innerHTML = `<span class="top-item-name">${monthData[i].name}</span><span class="top-item-val month">$${monthData[i].value.toFixed(0)}</span>`;
                    } else {
                        monthEl.innerHTML = '';
                    }
                }

            } catch (e) {
                console.error('Energy update error:', e);
            }
        }

        // Camera snapshot refresh
        async function initCamera() {
            const img = document.getElementById('camera-feed');
            const loading = document.getElementById('camera-loading');

            try {
                const response = await fetch(`${HA_URL}/api/states/${ENTITIES.camera}`, {
                    headers: { 'Authorization': `Bearer ${HA_TOKEN}` }
                });
                const data = await response.json();
                const accessToken = data.attributes?.access_token;

                if (!accessToken) {
                    loading.textContent = 'No camera token';
                    return;
                }

                const refreshSnapshot = () => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        img.src = tempImg.src;
                        loading.style.display = 'none';
                        img.style.display = 'block';
                    };
                    tempImg.src = `${HA_URL}/api/camera_proxy/${ENTITIES.camera}?token=${accessToken}&_t=${Date.now()}`;
                };

                refreshSnapshot();
                setInterval(refreshSnapshot, 100);

            } catch (e) {
                console.error('Camera init error:', e);
                loading.textContent = 'Camera error';
            }
        }

        // Utilities panel - fetch gas and internet usage from HA
        async function updateUtilities() {
            try {
                // Fetch gas usage sensors (calculated from furnace energy)
                const [gasCostToday, gasCostMonth, totalDown, totalUp] = await Promise.all([
                    fetchHAState('sensor.furnace_gas_cost_today'),
                    fetchHAState('sensor.furnace_gas_cost_this_month'),
                    fetchHAState('sensor.total_down'),
                    fetchHAState('sensor.total_up')
                ]);

                // Gas usage
                if (gasCostToday && gasCostToday.state !== 'unavailable' && gasCostToday.state !== 'unknown') {
                    document.getElementById('gas-today').textContent = `$${parseFloat(gasCostToday.state).toFixed(2)}`;
                } else {
                    const furnaceToday = await fetchHAState('sensor.furnace_energy_today');
                    if (furnaceToday && furnaceToday.state !== 'unavailable') {
                        const kWh = parseFloat(furnaceToday.state);
                        const therms = kWh * 0.15;
                        const cost = therms * 1.11;
                        document.getElementById('gas-today').textContent = `$${cost.toFixed(2)}`;
                    }
                }

                if (gasCostMonth && gasCostMonth.state !== 'unavailable' && gasCostMonth.state !== 'unknown') {
                    document.getElementById('gas-month').textContent = `$${parseFloat(gasCostMonth.state).toFixed(2)}`;
                } else {
                    const furnaceMonth = await fetchHAState('sensor.furnace_energy_this_month');
                    if (furnaceMonth && furnaceMonth.state !== 'unavailable') {
                        const kWh = parseFloat(furnaceMonth.state);
                        const therms = kWh * 0.15;
                        const cost = therms * 1.11;
                        document.getElementById('gas-month').textContent = `$${cost.toFixed(2)}`;
                    }
                }

                // Gas week (placeholder until sensor created)
                const gasWeek = await fetchHAState('sensor.furnace_gas_cost_this_week');
                if (gasWeek && gasWeek.state !== 'unavailable' && gasWeek.state !== 'unknown') {
                    document.getElementById('gas-week').textContent = `$${parseFloat(gasWeek.state).toFixed(2)}`;
                } else {
                    document.getElementById('gas-week').textContent = '--';
                }

                // Internet usage (from Deco)
                if (totalDown && totalUp && totalDown.state !== 'unavailable' && totalUp.state !== 'unavailable') {
                    const down = parseFloat(totalDown.state);
                    const up = parseFloat(totalUp.state);
                    // Convert kB/s to Mbps for display (kB/s * 8 / 1000 = Mbps)
                    const downMbps = (down * 8 / 1000).toFixed(1);
                    const upMbps = (up * 8 / 1000).toFixed(1);
                    document.getElementById('internet-up').textContent = `${upMbps} Mbps`;
                    document.getElementById('internet-down').textContent = `${downMbps} Mbps`;
                }

            } catch (e) {
                console.error('Utilities update error:', e);
            }
        }

        // Alarm panel - water leak sensors
        async function updateAlarms() {
            try {
                const sewerSensor = await fetchHAState('binary_sensor.lumi_lumi_sensor_wleak_aq1');

                const sewerInd = document.getElementById('alarm-sewer-ind');
                const sewerStatus = document.getElementById('alarm-sewer-status');

                if (sewerSensor && sewerSensor.state !== 'unavailable') {
                    const isWet = sewerSensor.state === 'on';
                    sewerInd.classList.toggle('alert', isWet);
                    sewerStatus.classList.toggle('alert', isWet);
                    sewerStatus.textContent = isWet ? 'WATER!' : 'OK';
                } else {
                    sewerStatus.textContent = '--';
                }
            } catch (e) {
                console.error('Alarm update error:', e);
            }
        }

        // News panel - placeholder for now
        function updateNews() {
            const newsContent = document.getElementById('news-content');
            // Placeholder news items - replace with real API later
            const placeholderNews = [
                { title: 'Bitcoin Surges Past $90K Amid Strong Institutional Demand', source: 'CoinDesk', time: '2h ago' },
                { title: 'Fed Signals Potential Rate Cuts in 2025', source: 'Reuters', time: '3h ago' },
                { title: 'Ethereum Layer 2 Solutions See Record Activity', source: 'The Block', time: '4h ago' },
                { title: 'Major Tech Firms Report Strong Q4 Earnings', source: 'Bloomberg', time: '5h ago' },
                { title: 'Crypto Adoption Grows in Emerging Markets', source: 'CoinTelegraph', time: '6h ago' },
                { title: 'SEC Approves New Bitcoin ETF Applications', source: 'WSJ', time: '7h ago' },
                { title: 'Mining Difficulty Reaches All-Time High', source: 'Bitcoin Magazine', time: '8h ago' },
                { title: 'DeFi Total Value Locked Exceeds $100B', source: 'DeFi Pulse', time: '9h ago' }
            ];

            newsContent.innerHTML = placeholderNews.map(item => `
                <div class="news-item">
                    <div class="news-item-title">${item.title}</div>
                    <div class="news-item-meta">
                        <span class="news-item-source">${item.source}</span>
                        <span class="news-item-time">${item.time}</span>
                    </div>
                </div>
            `).join('');
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                panels.left.chart.resize();
                panels.right.chart.resize();
                fetchData('left');
                fetchData('right');
            }, 300);

            // Initialize camera
            initCamera();

            // Initial stats update
            updateMistyStats();
            updateEnergyStats();
            updateUtilities();
            updateAlarms();
            updateNews();

            // Update stats every 5 seconds
            setInterval(updateMistyStats, 5000);
            setInterval(updateEnergyStats, 5000);
            setInterval(updateUtilities, 5000);  // Utilities every 5s for live internet
            setInterval(updateAlarms, 5000);     // Alarms every 5s
        });

        setInterval(() => { ['left','right'].forEach(p => { if (!tfConfigs[panels[p].tf].liveUpdate) fetchData(p); }); }, 60000);
        setInterval(() => { buyVol *= 0.8; sellVol *= 0.8; drawGauge(); }, 5000);
    </script>
</body>
</html>
