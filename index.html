<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>h8s — Live (Safe Mode)</title>
    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body { margin:0; background:#0b0d12; color:#eaf2ff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; }
      #app { min-height: 100svh; padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); display:grid; grid-template-rows: auto 1fr; gap:12px; }
      #price-section { display:grid; place-items:center; text-align:center; padding:8px 0; }
      .live-price { line-height:1.05; font-size: clamp(40px, 11vw, 72px); font-weight:700; letter-spacing:-0.02em; }
      .subline { margin-top:6px; opacity:.7; font-size: clamp(12px, 3.2vw, 14px); }
      #tape { background:#0e121a; border-radius:16px; padding:8px; overflow:hidden; display:grid; grid-template-rows:auto 1fr; }
      .tape-header { display:flex; align-items:center; justify-content:space-between; padding:4px 6px 8px; font-size:12px; opacity:.7 }
      .tape-list { list-style:none; margin:0; padding:0; overflow:auto; -webkit-overflow-scrolling:touch; }
      .tape-item { display:grid; grid-template-columns:70px 1fr 86px; gap:8px; align-items:baseline; padding:6px 8px; font-variant-numeric: tabular-nums; }
      .t{opacity:.7; font-size:12px} .p{justify-self:start; font-weight:600} .q{justify-self:end; opacity:.85}
      .buy{color:#7ee787} .sell{color:#ff7b72}
      #debug{position:fixed; top:8px; left:8px; padding:6px 8px; background:#222a; color:#fff; font:12px/1.2 monospace; border-radius:8px; display:none; z-index:9999}
    </style>
  </head>
  <body>
    <main id="app">
      <section id="price-section" aria-label="Live price">
        <div id="live-price" class="live-price" role="status" aria-live="polite">Loading…</div>
        <div class="subline" id="subline">Updated • —</div>
      </section>
      <section id="tape" aria-label="Live trades">
        <div class="tape-header">
          <div>BTC-USD trades</div>
          <div id="rate" class="t">— tps</div>
        </div>
        <ul id="tapeList" class="tape-list" aria-live="polite"></ul>
      </section>
      <div id="debug"></div>
    </main>

    <script>
      // Global error catcher -> shows in debug overlay
      (function(){
        const debug = document.getElementById('debug');
        const show = location.hash.includes('debug');
        if (show) debug.style.display='block';
        window.addEventListener('error', e=>{ if(show) debug.textContent = 'ERR: ' + (e.message||'unknown'); });
        window.addEventListener('unhandledrejection', e=>{ if(show) debug.textContent = 'REJ: ' + (e.reason&&e.reason.message||'unknown'); });
      })();
    </script>

    <script>
      // ===== price display =====
      const priceEl = document.getElementById('live-price');
      const sublineEl = document.getElementById('subline');
      function setPriceDisplay(value){
        try{
          const s = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}).format(value);
          priceEl.textContent = s; sublineEl.textContent = 'Updated • ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }catch{}
      }
      window.updatePrice = setPriceDisplay;
    </script>

    <script>
      // ===== Coinbase Pro trade tape (ticker + matches) =====
      (function(){
        const list = document.getElementById('tapeList');
        const rateEl = document.getElementById('rate');
        const debug = document.getElementById('debug');
        const showDebug = location.hash.includes('debug');
        const log = (m)=>{ if(showDebug){ debug.style.display='block'; debug.textContent = m; } };

        let ws, reconnectDelay=1000, maxDelay=30000, lastPaint=0, tradesInWindow=0;
        const maxItems = 100;

        function addRow(side, price, size, time){
          const now = performance.now();
          if (now - lastPaint < 80) return; // throttle
          lastPaint = now;
          const li = document.createElement('li');
          li.className = 'tape-item ' + (side==='buy'?'buy':'sell');
          li.innerHTML = '<span class="t">'+ time.slice(11,19) +'</span>'+
                         '<span class="p">'+ Number(price).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) +'</span>'+
                         '<span class="q">'+ Number(size).toLocaleString(undefined,{maximumFractionDigits:6}) +'</span>';
          list.insertBefore(li, list.firstChild);
          while (list.children.length > maxItems) list.removeChild(list.lastChild);
        }

        setInterval(()=>{ rateEl.textContent = tradesInWindow + ' tps'; tradesInWindow = 0; }, 1000);

        function connect(){
          try{
            ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            ws.onopen = ()=>{ log('CB Pro: open'); reconnectDelay=1000; ws.send(JSON.stringify({type:'subscribe', channels:[{name:'matches', product_ids:['BTC-USD']}, {name:'ticker', product_ids:['BTC-USD']}]})); };
            ws.onmessage = (e)=>{
              try{
                const msg = JSON.parse(e.data);
                if (msg.type==='ticker' && msg.price){ const p = parseFloat(msg.price); if(!Number.isNaN(p)) setPriceDisplay(p); }
                else if (msg.type==='match'){ tradesInWindow++; addRow(msg.side, msg.price, msg.size, msg.time); }
              }catch(err){ log('parse error'); }
            };
            ws.onerror = ()=> log('CB Pro: error');
            ws.onclose = ()=>{ log('CB Pro: close'); if(document.visibilityState==='visible'){ setTimeout(connect, reconnectDelay); reconnectDelay = Math.min(reconnectDelay*2, maxDelay);} };
          }catch(err){ log('CB Pro: exception'); }
        }
        document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ if(!ws || ws.readyState===WebSocket.CLOSED) connect(); } else { try{ ws&&ws.close(); }catch{} } });
        connect();
      })();
    </script>
  </body>
</html>
