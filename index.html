<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>h8s — Live</title>
    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; background: #0b0d12; color: #eaf2ff;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      /* Layout tuned for iPhone */
      #app { min-height: 100svh; padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); display: grid; grid-template-rows: auto 1fr; gap: 12px; }
      #price-section { position: relative; display: grid; place-items: center; text-align: center; padding: 8px 0; }
      .live-price { line-height: 1.05; font-size: clamp(40px, 11vw, 72px); font-weight: 700; letter-spacing: -0.02em; }
      .subline { margin-top: 6px; opacity:.7; font-size: clamp(12px, 3.2vw, 14px); }
      /* Sparkline canvas behind the price */
      #spark { position:absolute; inset:0; z-index:0; opacity:.25; }
      #price-section > * { position: relative; z-index: 1; }

      /* TAPE */
      #tape { background: #0e121a; border-radius: 16px; padding: 8px; overflow: hidden; display: grid; grid-template-rows: auto 1fr; }
      .tape-header { display:flex; align-items:center; justify-content:space-between; padding: 4px 6px 8px; font-size: 12px; opacity:.7 }
      .tape-list { list-style: none; margin: 0; padding: 0; overflow: auto; -webkit-overflow-scrolling: touch; }
      .tape-item { display: grid; grid-template-columns: 70px 1fr 86px; gap: 8px; align-items: baseline; padding: 6px 8px; font-variant-numeric: tabular-nums; }
      .t { opacity:.7; font-size: 12px; }
      .p { justify-self: start; font-weight: 600; }
      .q { justify-self: end; opacity:.85; }
      .buy  { color: #7ee787; }
      .sell { color: #ff7b72; }
      .sep { height:1px; background: rgba(255,255,255,.06); margin: 0 8px; }

      /* Debug badge (hidden by default) */
      #debug { position: fixed; top: 8px; left: 8px; padding: 6px 8px; background:#222a; color:#fff; font:12px/1.2 monospace; border-radius:8px; display:none; z-index:9999 }
    </style>
  </head>
  <body>
    <main id="app">
      <section id="price-section" aria-label="Live price">
        <canvas id="spark" aria-hidden="true"></canvas>
        <div id="live-price" class="live-price" role="status" aria-live="polite">Loading…</div>
        <div class="subline" id="subline">Updated • —</div>
      </section>

      <!-- Real-time Coinbase trade tape (no chart) -->
      <section id="tape" aria-label="Live trades">
        <div class="tape-header">
          <div>BTC‑USD trades</div>
          <div id="rate" class="t">— tps</div>
        </div>
        <ul id="tapeList" class="tape-list" aria-live="polite"></ul>
      </section>

      <div id="debug"></div>
    </main>

    <script>
      // ===== price display helpers =====
      const priceEl = document.getElementById('live-price');
      const sublineEl = document.getElementById('subline');
      function setPriceDisplay(value) {
        const s = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(value);
        priceEl.textContent = s;
        sublineEl.textContent = 'Updated • ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        addPriceSample(value);
      }).format(value);
        priceEl.textContent = s;
        sublineEl.textContent = 'Updated • ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      window.updatePrice = setPriceDisplay;
      // ===== Sparkline state & rendering =====
      const spark = document.getElementById('spark');
      const history = []; // {t, p}
      const HORIZON_MS = 10 * 60 * 1000; // 10 minutes
      let lastSampleTs = 0;
      let lastSparkPaint = 0;

      function addPriceSample(p) {
        const now = Date.now();
        // sample at most every 2s
        if (now - lastSampleTs < 2000) return;
        lastSampleTs = now;
        history.push({ t: now, p: Number(p) });
        // prune old
        const cutoff = now - HORIZON_MS;
        while (history.length && history[0].t < cutoff) history.shift();
        requestAnimationFrame(paintSpark);
      }

      function sizeSpark() {
        const dpr = window.devicePixelRatio || 1;
        const rect = spark.getBoundingClientRect();
        spark.width = Math.max(1, Math.floor(rect.width * dpr));
        spark.height = Math.max(1, Math.floor(rect.height * dpr));
      }

      function paintSpark() {
        const now = performance.now();
        if (now - lastSparkPaint < 120) return; // ~8 fps cap
        lastSparkPaint = now;
        const ctx = spark.getContext('2d');
        const w = spark.width, h = spark.height;
        if (!w || !h) return;
        ctx.clearRect(0,0,w,h);
        if (history.length < 2) return;
        const t0 = history[0].t;
        const t1 = history[history.length - 1].t;
        const minP = Math.min(...history.map(x=>x.p));
        const maxP = Math.max(...history.map(x=>x.p));
        const range = Math.max(1e-6, maxP - minP);
        // margins
        const mx = Math.floor(w*0.04), my = Math.floor(h*0.18);
        const iw = w - mx*2, ih = h - my*2;
        ctx.lineWidth = Math.max(1, Math.floor(w/300));
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'rgba(255,255,255,0.7)';
        ctx.beginPath();
        for (let i=0;i<history.length;i++){
          const x = mx + ((history[i].t - t0) / Math.max(1, (t1 - t0))) * iw;
          const y = my + (1 - (history[i].p - minP)/range) * ih;
          if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();
        // subtle baseline
        ctx.strokeStyle = 'rgba(255,255,255,0.18)';
        ctx.beginPath();
        ctx.moveTo(mx, my + ih);
        ctx.lineTo(mx+iw, my+ih);
        ctx.stroke();
      }

      function initSpark() { sizeSpark(); paintSpark(); }
      window.addEventListener('load', initSpark);
      window.addEventListener('orientationchange', () => setTimeout(initSpark, 250));

      // ===== Coinbase Pro trade tape =====
      (function(){
        const debug = document.getElementById('debug');
        const showDebug = location.hash.includes('debug');
        if (showDebug) debug.style.display = 'block';
        const log = (m)=>{ if(showDebug) debug.textContent = m; };

        const list = document.getElementById('tapeList');
        const rateEl = document.getElementById('rate');

        let ws, reconnectDelay=1000, maxDelay=30000, lastPaint=0;
        let tradesInWindow=0; // for TPS
        const maxItems = 100; // keep last N prints

        function paintTrade(t){
          // throttle DOM writes
          const now = performance.now();
          if (now - lastPaint < 80) return; // ~12 fps
          lastPaint = now;

          const li = document.createElement('li');
          li.className = 'tape-item ' + (t.side === 'buy' ? 'buy' : 'sell');
          li.innerHTML = `
            <span class="t">${t.time.slice(11,19)}</span>
            <span class="p">${Number(t.price).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</span>
            <span class="q">${Number(t.size).toLocaleString(undefined,{maximumFractionDigits:6})}</span>
          `;
          list.insertBefore(li, list.firstChild);
          while (list.children.length > maxItems) list.removeChild(list.lastChild);
        }

        // TPS meter (simple moving count per second)
        setInterval(()=>{ rateEl.textContent = tradesInWindow + ' tps'; tradesInWindow = 0; }, 1000);

        function connect(){
          try {
            ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            ws.onopen = () => {
              log('CB Pro: open');
              reconnectDelay = 1000;
              ws.send(JSON.stringify({ type:'subscribe', channels:[{ name:'matches', product_ids:['BTC-USD'] }, { name:'ticker', product_ids:['BTC-USD'] }] }));
            };
            ws.onmessage = (e) => {
              try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'match') {
                  // match carries side, price, size, time
                  tradesInWindow++;
                  paintTrade({ side: msg.side, price: msg.price, size: msg.size, time: msg.time });
                } else if (msg.type === 'ticker' && msg.price) {
                  const p = parseFloat(msg.price); if (!Number.isNaN(p)) setPriceDisplay(p);
                }
              } catch(_){}
            };
            ws.onerror = () => log('CB Pro: error');
            ws.onclose = () => {
              log('CB Pro: close');
              if (document.visibilityState === 'visible') {
                setTimeout(connect, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay*2, maxDelay);
              }
            };
          } catch (err) { log('CB Pro: exception'); }
        }

        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') { if (!ws || ws.readyState === WebSocket.CLOSED) connect(); }
          else { try { ws && ws.close(); } catch(_){} }
        });
        connect();
      })();
    </script>
  </body>
</html>
