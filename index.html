<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Live BTC/USD</title>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#101010; --text:#e9fef7; --muted:#c8d6cf;
      /* default/boot glow until we get data */
      --glow: rgba(0,200,255,0.22);
      --up:#00ffb3; --down:#ff3c3c;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{min-height:100%;padding-bottom:env(safe-area-inset-bottom);display:flex;flex-direction:column;align-items:center;}

    /* Top bar */
    .topbar{
      position:sticky;top:0;z-index:10;width:100%;
      background:linear-gradient(180deg,rgba(10,10,10,.95),rgba(10,10,10,.7));
      backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
      padding:calc(8px + env(safe-area-inset-top)) 14px 8px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex;justify-content:center;gap:12px;align-items:baseline;
      font-variant-numeric:tabular-nums;
    }
    .topbar .meta{display:flex;gap:10px;align-items:baseline}
    .price{font-size:clamp(22px,7vw,40px);font-weight:800;line-height:1;transition:color .25s ease;color:#fff;text-shadow:0 0 18px rgba(0,0,0,.35);}
    .price.up{color:var(--up)} .price.down{color:var(--down)}
    .change{font-size:clamp(12px,3.2vw,16px);font-weight:700;opacity:.9;transition:color .25s ease;}
    .change.up{color:var(--up)} .change.down{color:var(--down)} .change.flat{color:var(--muted)}
    @keyframes changeFlash{0%{opacity:.4;transform:scale(.985)}60%{opacity:1;transform:scale(1)}100%{opacity:.95;transform:scale(1)}}
    .change.flash{animation:changeFlash 450ms ease-out;}
    .avgBadge{
      font-size:12px;opacity:.8;border:1px solid rgba(255,255,255,.08);
      padding:3px 6px;border-radius:8px;background:rgba(255,255,255,.02)
    }

    /* Chart */
    #chartContainer{
      position:relative;width:min(920px,96vw);
      height:clamp(130px,26vh,220px);margin:8px auto 10px;
      filter: drop-shadow(0 0 18px var(--glow));
    }
    #chartCanvas{
      position:absolute;inset:0;width:100%;height:100%;background:var(--panel);border-radius:12px;
      box-shadow:0 0 0 1px rgba(255,255,255,.04), 0 0 30px var(--glow), 0 14px 34px rgba(0,0,0,.35);
    }

    /* Feed container */
    #feedContainer{
      width:min(920px,96vw);height:56vh;background:var(--panel);border-radius:12px;padding:6px;
      overflow-y:auto;-webkit-overflow-scrolling:touch;
      box-shadow:0 0 0 1px rgba(255,255,255,.04), 0 0 30px var(--glow), 0 10px 30px rgba(0,0,0,.35);
    }
    .feedRow{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;font-size:14px;font-variant-numeric:tabular-nums;}
    .feedRow:nth-child(even){background:rgba(255,255,255,0.02);}
    .feedRow.buy{color:var(--up)} .feedRow.sell{color:var(--down)}
    .feedTime{opacity:.6;font-size:12px;}
    .feedQty{opacity:.8;font-weight:600;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="meta">
        <div class="price" id="price">–</div>
        <div class="change flat" id="change">0.00%</div>
        <div class="avgBadge" id="avgBadge">10m avg: —</div>
      </div>
    </div>

    <div id="chartContainer">
      <canvas id="chartCanvas"></canvas>
    </div>

    <div id="feedContainer"></div>
  </div>

  <script>
    // --- DOM refs
    const priceEl = document.getElementById('price');
    const changeEl = document.getElementById('change');
    const feedEl  = document.getElementById('feedContainer');
    const avgBadge = document.getElementById('avgBadge');
    const rootStyle = document.documentElement.style;

    // --- Price + AVG tracking
    let lastPrice = null;
    const TEN_MIN_MS = 10 * 60 * 1000;
    /** store recent prices as {t:number, p:number} */
    const ring = [];

    function pruneOld(now){
      // drop anything older than 10 minutes
      for (let i = ring.length - 1; i >= 0; i--) {
        if (now - ring[i].t > TEN_MIN_MS) ring.splice(i, 1);
      }
    }
    function avg10m(now){
      pruneOld(now);
      if (ring.length === 0) return NaN;
      let sum = 0;
      for (const r of ring) sum += r.p;
      return sum / ring.length;
    }

    // --- Glow controller
    function setGlowByRelation(price, avg){
      // Neutral if no avg yet
      if (!isFinite(avg)) {
        rootStyle.setProperty('--glow', 'rgba(0,200,255,0.22)'); // teal while warming up
        return;
      }
      if (price >= avg) {
        rootStyle.setProperty('--glow', 'rgba(0,255,179,0.35)'); // green
      } else {
        rootStyle.setProperty('--glow', 'rgba(255,60,60,0.35)'); // red
      }
    }

    // --- UI updates
    function setPrice(p) {
      const now = Date.now();
      ring.push({ t: now, p });

      // Show price
      if (lastPrice !== null) {
        const diff = p - lastPrice;
        const pct = (diff / lastPrice * 100);
        changeEl.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
        changeEl.className = 'change ' + (pct > 0 ? 'up' : pct < 0 ? 'down' : 'flat') + ' flash';
        priceEl.className = 'price ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : '');
      }
      priceEl.textContent = p.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
      lastPrice = p;

      // Compute 10m avg and set glow
      const a = avg10m(now);
      avgBadge.textContent = '10m avg: ' + (isFinite(a) ? a.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }) : '—');
      setGlowByRelation(p, a);

      // keep buffer size sane (not strictly needed but tidy)
      if (ring.length > 36000) ring.shift(); // ~10 updates/sec cap safety
    }

    // --- Feed rendering
    function addTrade({side, price, size, time}) {
      const row = document.createElement('div');
      row.className = `feedRow ${side}`;
      row.innerHTML = `
        <div class="feedTime">${new Date(time).toLocaleTimeString()}</div>
        <div class="feedQty">${parseFloat(size).toFixed(4)} BTC</div>
        <div>${parseFloat(price).toLocaleString('en-US',{style:'currency',currency:'USD'})}</div>
      `;
      feedEl.prepend(row);
      if (feedEl.children.length > 120) feedEl.removeChild(feedEl.lastChild);
    }

    // --- Simple canvas sparkline (optional lightweight viz)
    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){
      const r = canvas.getBoundingClientRect();
      canvas.width = Math.floor(r.width * devicePixelRatio);
      canvas.height = Math.floor(r.height * devicePixelRatio);
    }
    window.addEventListener('load', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 250));
    window.addEventListener('resize', () => requestAnimationFrame(resizeCanvas));
    resizeCanvas();

    function renderChart(){
      const now = Date.now();
      pruneOld(now);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (ring.length < 2) { requestAnimationFrame(renderChart); return; }

      // Determine window & scale
      const t0 = now - TEN_MIN_MS;
      let min = Infinity, max = -Infinity;
      for (const r of ring){ if (r.p < min) min = r.p; if (r.p > max) max = r.p; }
      if (min === max) { min -= 1; max += 1; }

      const w = canvas.width, h = canvas.height;
      const x = t => ( (t - t0) / TEN_MIN_MS ) * w;
      const y = p => h - ( (p - min) / (max - min) ) * h;

      // Price line
      ctx.lineWidth = Math.max(1, devicePixelRatio);
      ctx.strokeStyle = 'rgba(255,255,255,0.9)';
      ctx.beginPath();
      ctx.moveTo(x(ring[0].t), y(ring[0].p));
      for (let i=1;i<ring.length;i++){
        ctx.lineTo(x(ring[i].t), y(ring[i].p));
      }
      ctx.stroke();

      // 10m average line (flat reference at current avg)
      const avg = avg10m(now);
      if (isFinite(avg)) {
        ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.moveTo(0, y(avg));
        ctx.lineTo(w, y(avg));
        ctx.stroke();
        ctx.setLineDash([]);
      }

      requestAnimationFrame(renderChart);
    }
    requestAnimationFrame(renderChart);

    // --- Coinbase WebSocket (public)
    const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: 'subscribe',
        channels: [{ name: 'ticker', product_ids: ['BTC-USD'] }]
      }));
    };
    ws.onmessage = e => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'ticker' && msg.price) {
          const p = parseFloat(msg.price);
          if (!isNaN(p)) setPrice(p);
        }
        if (msg.type === 'ticker' && msg.price && msg.side && msg.time) {
          addTrade(msg);
        }
      } catch {}
    };
  </script>
</body>
</html>
