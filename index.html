<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>h8s — Live</title>
    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; background: #0b0d12; color: #eaf2ff;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      #app {
        min-height: 100svh;
        padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
        display: grid; grid-template-rows: 1fr auto; gap: 16px;
      }
      #price-section { display: grid; place-items: center; text-align: center; padding: 8px 0; }
      .live-price { line-height: 1.05; font-size: clamp(40px, 11vw, 72px); font-weight: 700; letter-spacing: -0.02em; }
      .subline { margin-top: 6px; opacity: .7; font-size: clamp(12px, 3.2vw, 14px); }
      #chart-section { background: #0e121a; border-radius: 16px; padding: 8px; min-height: 36svh; height: clamp(220px, 36svh, 48svh); display: grid; overflow: hidden; }
      #price-chart { width: 100%; height: 100%; display: block; }
      :focus-visible { outline: 2px solid #7aa2ff; outline-offset: 2px; }
      /* Temporary debug helper (toggle with #debug in URL) */
      #debug { position: fixed; top: 8px; left: 8px; padding: 6px 8px; background:#222a; color:#fff; font:12px/1.2 monospace; border-radius:8px; display:none; z-index:9999 }
    </style>
  </head>
  <body>
    <main id="app">
      <section id="price-section" aria-label="Live price">
        <div id="live-price" class="live-price" role="status" aria-live="polite">—</div>
        <div class="subline" id="subline">Updated • —</div>
      </section>
      <section id="chart-section" aria-label="History">
        <canvas id="price-chart"></canvas>
      </section>
          <div id="debug"></div>
    </main>

    <script>
      // ===== Core UI helpers (no external libs) =====
      const priceEl = document.getElementById('live-price');
      const sublineEl = document.getElementById('subline');
      function setPriceDisplay(value) {
        try {
          const s = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(value);
          priceEl.textContent = s;
          sublineEl.textContent = 'Updated • ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } catch (_) {}
      }
      window.updatePrice = setPriceDisplay;
      // Show something immediately so you know rendering works
      priceEl.textContent = 'Loading…';

      // Size the chart canvas to its container
      const chartCanvas = document.getElementById('price-chart');
      function resizeCanvasToContainer(canvas) {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = Math.floor(rect.width);
        canvas.height = Math.floor(rect.height);
      }
      function initOrResizeChart() { resizeCanvasToContainer(chartCanvas); }
      // Remove ResizeObserver to prevent layout feedback loops on mobile toolbars
      window.addEventListener('load', initOrResizeChart);
      window.addEventListener('orientationchange', () => setTimeout(initOrResizeChart, 250));
      initOrResizeChart();

      // ===== Live price via Coinbase WebSocket (public) with HTTP fallback =====
      (function () {
        const debug = document.getElementById('debug');
        if (location.hash.includes('debug')) debug.style.display = 'block';
        function log(m){ if (debug && debug.style.display==='block') debug.textContent = m; }

        let updatedFromWS = false;

        // Try Advanced Trade WS first
        function connectAdvancedTrade(){
          try {
            const ws = new WebSocket('wss://advanced-trade-ws.coinbase.com');
            ws.onopen = () => {
              log('CB AT: open');
              // Two possible subscribe formats; try simplest first
              try { ws.send(JSON.stringify({ type:'subscribe', channel:'ticker', product_ids:['BTC-USD'] })); }
              catch(_){}
              // Also try legacy-style payload in case proxy expects it
              try { ws.send(JSON.stringify({ type:'subscribe', channels:[{ name:'ticker', product_ids:['BTC-USD'] }] })); }
              catch(_){}
            };
            ws.onmessage = (e) => {
              try {
                const msg = JSON.parse(e.data);
                // Extract price from multiple possible shapes
                let price = NaN;
                if (msg.price) price = parseFloat(msg.price);
                else if (msg.events && msg.events[0]) {
                  const ev = msg.events[0];
                  if (ev.tickers && ev.tickers[0] && ev.tickers[0].price) price = parseFloat(ev.tickers[0].price);
                  else if (ev.trades && ev.trades[0] && ev.trades[0].price) price = parseFloat(ev.trades[0].price);
                }
                if (!Number.isNaN(price)) { setPriceDisplay(price); updatedFromWS = true; }
              } catch(_){}
            };
            ws.onerror = () => log('CB AT: error');
            ws.onclose = () => log('CB AT: close');
          } catch (err) { log('CB AT: exception'); }
        }

        // Legacy Pro feed fallback
        function connectLegacy(){
          try {
            const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            ws.onopen = () => {
              log('CB Pro: open');
              ws.send(JSON.stringify({ type:'subscribe', channels:[{ name:'ticker', product_ids:['BTC-USD'] }] }));
            };
            ws.onmessage = (e) => {
              try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'ticker' && msg.price) {
                  const price = parseFloat(msg.price);
                  if (!Number.isNaN(price)) { setPriceDisplay(price); updatedFromWS = true; }
                }
              } catch(_){}
            };
            ws.onerror = () => log('CB Pro: error');
            ws.onclose = () => log('CB Pro: close');
          } catch (err) { log('CB Pro: exception'); }
        }

        connectAdvancedTrade();
        // Also attempt legacy in parallel after a short delay
        setTimeout(connectLegacy, 1000);

        // HTTP fallback (CoinGecko) if WS delivers nothing after 5s
        async function pollCG(){
          try {
            const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd', { cache: 'no-store' });
            const j = await r.json();
            if (j && j.bitcoin && j.bitcoin.usd) setPriceDisplay(j.bitcoin.usd);
            log('CG: ok');
          } catch(e){ log('CG: error'); }
        }
        setTimeout(() => { if (!updatedFromWS) { log('WS: no data, using CoinGecko'); pollCG(); setInterval(pollCG, 15000); } }, 5000);
      })();
    </script>
  </body>
</html>
