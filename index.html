<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Live BTC/USD</title>
  <style>
    :root {
      --bg:#0a0a0a; --panel:#101010; --text:#e9fef7;
      --up:#00ffb3; --down:#ff3c3c; --glow: rgba(0,255,179,0.25); --muted:#c8d6cf;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .wrap{min-height:100%;padding-bottom:env(safe-area-inset-bottom);display:flex;flex-direction:column;align-items:center;}

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:10;width:100%;background:linear-gradient(180deg,rgba(10,10,10,.95),rgba(10,10,10,.7));
      backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);padding:calc(8px + env(safe-area-inset-top)) 14px 8px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);display:flex;justify-content:center;gap:12px;align-items:baseline;font-variant-numeric:tabular-nums;}
    .price{font-size:clamp(22px,7vw,40px);font-weight:800;line-height:1;transition:color .25s ease;color:#fff;text-shadow:0 0 18px rgba(0,0,0,.35);}
    .price.up{color:var(--up)} .price.down{color:var(--down)}
    .change{font-size:clamp(12px,3.2vw,16px);font-weight:700;opacity:.9;transition:color .25s ease;will-change:transform,opacity;}
    .change.up{color:var(--up)} .change.down{color:var(--down)} .change.flat{color:var(--muted)}
    @keyframes changeFlash{0%{opacity:.4;transform:scale(.985)}60%{opacity:1;transform:scale(1)}100%{opacity:.95;transform:scale(1)}}
    .change.flash{animation:changeFlash 450ms ease-out;}

    /* Chart */
    #chartContainer{position:relative;width:min(920px,96vw);height:clamp(130px,26vh,220px);margin:8px auto 10px;}
    #chartCanvas{position:absolute;inset:0;width:100%;height:100%;background:var(--panel);border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35);}

    /* Feed shell */
    #feedContainer{width:min(920px,96vw);height:56vh;background:var(--panel);border-radius:12px;padding:6px;overflow-y:auto;-webkit-overflow-scrolling:touch;box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35),0 0 18px var(--glow);}

    /* Tops (desktop full; mobile collapsible) */
    .tops{margin:2px 6px 6px;}
    .tops-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .tops h4{margin:4px 0 4px;font-size:.9em;font-weight:700;letter-spacing:.3px;color:#fff;}
    .tops ul{list-style:none;margin:0;padding:0;}
    .tops li{padding:3px 0;border-bottom:1px dashed rgba(255,255,255,.07);font-variant-numeric:tabular-nums;}
    .tops .buy {color:var(--up)}
    .tops .sell{color:var(--down)}
    .tops .muted{color:var(--muted);opacity:.9}

    /* Summary bar (mobile) */
    .tops-summary{display:none;width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:6px 10px;
      font-size:.95em;font-weight:600;color:#fff;text-align:left;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .tops-summary .label{opacity:.85}
    .tops-summary .vals{font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .tops-summary .vals .buy{color:var(--up)} .tops-summary .vals .sell{color:var(--down)}
    .tops-summary .chev{opacity:.8}

    @media (max-width:600px){
      .tops-grid{display:none;}
      .tops-summary{display:flex;}
      .tops.expanded .tops-grid{display:grid;}
    }

    /* Ticker rows — color by SIDE (buy=green, sell=red) */
    .row{display:grid;grid-template-columns:92px 1fr auto;column-gap:10px;align-items:center;padding:4px 6px;border-radius:8px;font-size:clamp(12px,3.2vw,14px);line-height:1.15;font-variant-numeric:tabular-nums;text-align:left;}
    .row.buy {color:var(--up)}
    .row.sell{color:var(--down)}
    .time{white-space:nowrap;opacity:.85}
    .priceCell{white-space:nowrap}
    .amountCell{white-space:nowrap;opacity:.95;cursor:pointer;}
    .dir{opacity:.8;margin-left:6px} /* tiny arrow after price */

    .headerRow{font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-size:.85em;opacity:.7;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:4px;padding-bottom:4px;display:grid;grid-template-columns:92px 1fr auto;column-gap:10px;text-align:left;}

    @media (prefers-reduced-motion:reduce){#chartCanvas{transition:none}.change.flash{animation:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div id="livePrice" class="price">$—</div>
      <div id="liveChange" class="change flat">—</div>
    </header>

    <section id="chartContainer"><canvas id="chartCanvas"></canvas></section>

    <section id="feedContainer" aria-label="Recent Trades">
      <!-- Collapsible Tops -->
      <div class="tops" id="topsPanel">
        <button id="topsToggle" class="tops-summary" aria-expanded="false">
          <span class="label">Top Buys/Sells</span>
          <span class="vals" id="topsSummaryVals"><span class="buy">—</span> | <span class="sell">—</span></span>
          <span class="chev" id="topsChev">▼</span>
        </button>
        <div class="tops-grid" id="topsLists">
          <div>
            <h4>Top Buys (10m)</h4>
            <ul id="topBuys"><li class="muted">—</li></ul>
          </div>
          <div>
            <h4>Top Sells (10m)</h4>
            <ul id="topSells"><li class="muted">—</li></ul>
          </div>
        </div>
      </div>

      <div class="headerRow">
        <div>Time</div>
        <div>Price</div>
        <div id="amountHeader" style="cursor:pointer;">Amount (USD)</div>
      </div>
    </section>

    <!-- Ticker rows will render inside #feedContainer after the header -->
  </div>

  <script>
    // --- DOM & ctx ---
    const $ = s=>document.querySelector(s);
    const feedEl=$('#feedContainer');
    const priceEl=$('#livePrice');
    const changeEl=$('#liveChange');
    const amountHeader=$('#amountHeader');
    const topBuysEl=$('#topBuys'), topSellsEl=$('#topSells');
    const topsPanel=$('#topsPanel'), topsToggle=$('#topsToggle'), topsChev=$('#topsChev'), topsSummaryVals=$('#topsSummaryVals');
    const chartCanvas=$('#chartCanvas');
    const ctx=chartCanvas.getContext('2d',{desynchronized:true});

    // --- Formatters ---
    const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const fmtUSDChange=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2,signDisplay:'always'});
    const fmtBTC=new Intl.NumberFormat(undefined,{minimumFractionDigits:0,maximumFractionDigits:5});
    const fmtPct=new Intl.NumberFormat(undefined,{minimumFractionDigits:3,maximumFractionDigits:3,signDisplay:'always'});

    // --- State ---
    const MAX_TRADES=50, WINDOW_MS=10*60*1000;
    let trades=[];           // for ticker (latest 50)
    let windowTrades=[];     // last 10 mins (for tops)
    let series=[];           // chart & change
    let lastPrice=null;
    let showUSD=true;        // default Amount column in USD

    // --- Canvas scaling ---
    function resizeCanvas(){
      const dpr=Math.max(1,Math.min(window.devicePixelRatio||1,3));
      const cssW=chartCanvas.clientWidth, cssH=chartCanvas.clientHeight;
      chartCanvas.width=Math.round(cssW*dpr); chartCanvas.height=Math.round(cssH*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawChart(true);
    }
    new ResizeObserver(resizeCanvas).observe(chartCanvas);
    window.addEventListener('orientationchange',resizeCanvas,{passive:true});

    // --- WebSocket ---
    let ws, reconnectTimer;
    const SUB_MSG={type:'subscribe',product_ids:['BTC-USD'],channels:['matches']};
    function connect(){
      clearTimeout(reconnectTimer);
      ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
      ws.addEventListener('open',()=>ws.send(JSON.stringify(SUB_MSG)));
      ws.addEventListener('message',onMessage);
      ws.addEventListener('close',()=>{reconnectTimer=setTimeout(connect,1000)},{once:true});
      ws.addEventListener('error',()=>ws.close(),{once:true});
    }

    // --- Batching ---
    let needsFeedRender=false, pendingPriceForSeries=null;

    function onMessage(evt){
      const msg=JSON.parse(evt.data);
      if(msg.type!=='match') return;

      const price=parseFloat(msg.price);
      const size =parseFloat(msg.size);
      const side =msg.side; // 'buy' | 'sell'
      const time =new Date(msg.time);

      // Direction vs previous (for arrow only)
      const prevPrice=trades.length?trades[trades.length-1].price:lastPrice;
      let dirArrow=''; if(prevPrice!=null){ dirArrow = price>prevPrice ? '▲' : (price<prevPrice ? '▼' : '•'); }

      // Header color tick by last price
      if(lastPrice!==null){ priceEl.classList.remove('up','down'); if(price>lastPrice)priceEl.classList.add('up'); else if(price<lastPrice)priceEl.classList.add('down'); }
      lastPrice=price; priceEl.textContent=fmtUSD.format(price);

      // Buffers (store side & arrow)
      trades.push({price,size,time,side,dirArrow});
      if(trades.length>MAX_TRADES) trades.shift();

      windowTrades.push({price,size,side,time:time.getTime()});
      pendingPriceForSeries=price;

      needsFeedRender=true;
    }

    // --- Feed render ---
    function renderFeed(){
      // Keep tops & header (first two children)
      const headerNodes=Array.from(feedEl.children).slice(0,2);
      const frag=document.createDocumentFragment();
      headerNodes.forEach(n=>frag.appendChild(n));

      // Ticker rows (newest first)
      for(let i=trades.length-1;i>=0;i--){
        const t=trades[i];
        const row=document.createElement('div');
        row.className=`row ${t.side}`; // color by SIDE
        const timeStr=t.time.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const amountDisplay=showUSD ? fmtUSD.format(t.price*t.size) : `${fmtBTC.format(t.size)} BTC`;
        row.innerHTML=`
          <div class="time">${timeStr}</div>
          <div class="priceCell">${fmtUSD.format(t.price)} <span class="dir">${t.dirArrow}</span></div>
          <div class="amountCell">${amountDisplay}</div>`;
        row.querySelector('.amountCell').addEventListener('click',toggleAmountView);
        frag.appendChild(row);
      }

      feedEl.innerHTML='';
      feedEl.appendChild(frag);
    }

    // --- Render Tops (lists + summary) ---
    function renderTops(){
      const cutoff=Date.now()-WINDOW_MS;
      windowTrades=windowTrades.filter(t=>t.time>=cutoff);

      const buys = windowTrades.filter(t=>t.side==='buy').map(t=>({...t, usd:t.price*t.size})).sort((a,b)=>b.usd-a.usd).slice(0,3);
      const sells= windowTrades.filter(t=>t.side==='sell').map(t=>({...t, usd:t.price*t.size})).sort((a,b)=>b.usd-a.usd).slice(0,3);

      const fmtAmt = t => showUSD ? fmtUSD.format(t.usd) : `${fmtBTC.format(t.size)} BTC`;

      // Lists (desktop & expanded mobile) with side colors
      topBuysEl.innerHTML = buys.length ? buys.map(t=>`<li class="buy">${fmtAmt(t)}</li>`).join('') : `<li class="muted">—</li>`;
      topSellsEl.innerHTML= sells.length ? sells.map(t=>`<li class="sell">${fmtAmt(t)}</li>`).join('') : `<li class="muted">—</li>`;

      // Summary (mobile collapsed) with colored spans
      const topBuy  = buys[0]  ? `<span class="buy">${fmtAmt(buys[0])}</span>`  : '<span class="buy">—</span>';
      const topSell = sells[0] ? `<span class="sell">${fmtAmt(sells[0])}</span>` : '<span class="sell">—</span>';
      topsSummaryVals.innerHTML = `Top Buy: ${topBuy} | Top Sell: ${topSell}`;
    }

    // --- Chart (segment color vs 10m avg + dashed avg line) ---
    function drawChart(){
      const w=chartCanvas.clientWidth, h=chartCanvas.clientHeight;
      ctx.clearRect(0,0,w,h); ctx.fillStyle='#101010'; ctx.fillRect(0,0,w,h);
      if(series.length<2) return;

      let min=Infinity, max=-Infinity, sum=0;
      for(const s of series){ const p=s.p; if(p<min)min=p; if(p>max)max=p; sum+=p; }
      const range=(max-min)||1, avg=sum/series.length;

      // grid
      ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
      for(let i=1;i<6;i++){ const gy=(h/6)*i; ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(w,gy); ctx.stroke(); }

      // avg dashed
      const yAvg = h - ((avg - min)/range)*h;
      ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,0.6)';
      ctx.beginPath(); ctx.moveTo(0,yAvg); ctx.lineTo(w,yAvg); ctx.stroke(); ctx.restore();

      // colored segments
      ctx.lineWidth=2;
      for(let i=1;i<series.length;i++){
        const p0=series[i-1].p, p1=series[i].p;
        const x0=((i-1)/(series.length-1))*w, x1=(i/(series.length-1))*w;
        const y0=h-((p0-min)/range)*h, y1=h-((p1-min)/range)*h;
        ctx.strokeStyle=(p1>=avg)?'#00ffb3':'#ff3c3c';
        ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
      }
    }

    // --- 10m change badge ---
    function updateTenMinuteChange(){
      const cutoff=Date.now()-WINDOW_MS;
      while(series.length && series[0].t < cutoff) series.shift();
      if(series.length<2){ changeEl.textContent='—'; changeEl.className='change flat'; return; }
      const start=series[0].p, now=series[series.length-1].p, diff=now-start, pct=((now-start)/start)*100;
      const cls=diff>0?'up':(diff<0?'down':'flat');
      changeEl.textContent = `${fmtUSDChange.format(diff)} (${fmtPct.format(pct)}%)`;
      changeEl.className = `change ${cls}`;
      void changeEl.offsetWidth; changeEl.classList.add('flash');
    }

    // --- Loop ---
    function loop(){
      if(pendingPriceForSeries!=null){
        series.push({t:Date.now(), p:pendingPriceForSeries});
        pendingPriceForSeries=null;
      }
      const cutoff=Date.now()-WINDOW_MS;
      while(series.length && series[0].t < cutoff) series.shift();
      windowTrades = windowTrades.filter(t=>t.time>=cutoff);

      drawChart();
      updateTenMinuteChange();
      renderTops();

      if(needsFeedRender){ needsFeedRender=false; renderFeed(); }
      requestAnimationFrame(loop);
    }

    // --- Interactions ---
    function toggleAmountView(){
      showUSD=!showUSD;
      amountHeader.textContent = showUSD ? 'Amount (USD)' : 'Amount (BTC)';
      renderFeed(); renderTops();
    }
    amountHeader.addEventListener('click', toggleAmountView);

    // Collapsible tops (mobile)
    topsToggle.addEventListener('click', ()=>{
      const expanded = topsPanel.classList.toggle('expanded');
      topsToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      topsChev.textContent = expanded ? '▲' : '▼';
    });

    // Visibility
    document.addEventListener('visibilitychange',()=>{
      if(!document.hidden){ drawChart(); updateTenMinuteChange(); renderTops(); }
    },{passive:true});

    // Init
    resizeCanvas();
    connect();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
