<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Live BTC/USD</title>
<style>
  :root{--bg:#0a0a0a;--panel:#101010;--text:#e9fef7;--up:#00ffb3;--down:#ff3c3c;--glow:rgba(0,255,179,.25);--muted:#c8d6cf;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

  .site{display:block;padding:10px;}
  .desktop-only{display:none}.mobile-only{display:block}

  /* 4 columns on desktop: Charts | Stats | Top Tx | Ticker */
  @media (min-width:1024px){
    .site{
      display:grid!important;
      grid-template-columns:1.45fr 1.15fr 1.1fr 0.8fr;
      gap:16px;padding:16px;align-items:start
    }
    #leftCol{grid-column:1/2}
    #centerCol{grid-column:2/3}
    #rightCol{grid-column:3/4}
    #tickerCol{grid-column:4/5}
    .desktop-only{display:block!important}.mobile-only{display:none!important}
  }
  .card{background:var(--panel);border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35)}

  /* Live header embedded in 10m stats */
  .liveWrap{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;margin-bottom:8px}
  .liveLeft{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .pill{border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:2px 8px;font-size:12px;opacity:.9;white-space:nowrap}
  .liveCenter{display:flex;justify-content:center;align-items:baseline;gap:10px}
  .livePrice{font-size:clamp(22px,4.6vw,40px);font-weight:800;line-height:1;text-shadow:0 0 18px rgba(0,0,0,.35)}
  .livePrice.up{color:var(--up)}.livePrice.down{color:var(--down)}
  .liveChange{font-size:clamp(12px,2.2vw,16px);font-weight:700;opacity:.9}
  .liveChange.up{color:var(--up)}.liveChange.down{color:var(--down)}.liveChange.flat{color:var(--muted)}
  @keyframes changeFlash{0%{opacity:.4;transform:scale(.985)}60%{opacity:1;transform:scale(1)}100%{opacity:.95;transform:scale(1)}}
  .liveChange.flash{animation:changeFlash 450ms ease-out}

  /* Left: charts */
  #leftCol .card{margin-bottom:12px}
  #chartContainer{position:relative;width:min(920px,96vw);height:clamp(130px,26vh,220px);margin:0 auto}
  #chartCanvas{position:absolute;inset:0;width:100%;height:100%;border-radius:12px}
  .chartTitle{position:absolute;left:10px;top:8px;font-size:12px;opacity:.8}
  @media (min-width:1024px){#chartContainer{width:auto}}
  .volBoxTop{padding:12px}
  .volTitle{font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  #volCanvas{width:100%;height:160px;display:block;border-radius:8px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;vertical-align:middle}
  .dot.up{background:var(--up)}.dot.down{background:var(--down)}
  .subchart{padding:10px}
  .subchart .title{font-weight:700;margin:0 0 6px 2px;opacity:.9}
  .subchart canvas{width:100%;height:160px;display:block;border-radius:8px}

  /* Center: stats */
  .statsBox{padding:12px}
  .statsTitle{font-weight:700;margin:8px 0}
  .statRow{display:flex;justify-content:space-between;margin:6px 0;font-variant-numeric:tabular-nums}
  .histBox{padding:12px;margin-top:16px}
  #histCanvas{width:100%;height:160px;display:block;border-radius:8px}

  /* Right: Top Tx */
  #rightCol .card{margin-bottom:12px}
  .topTx{padding:10px}
  .topTx h3{margin:0 0 6px;font-size:13px;opacity:.9}
  .txGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .txCol{border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:6px 6px 4px}
  .txCol h4{margin:2px 4px 6px;font-size:11px;letter-spacing:.4px;text-transform:uppercase}
  .buyCol{background:rgba(0,255,179,.05);border-color:rgba(0,255,179,.25)}
  .buyCol h4{color:var(--up)}
  .sellCol{background:rgba(255,60,60,.05);border-color:rgba(255,60,60,.25)}
  .sellCol h4{color:var(--down)}
  .txList{list-style:none;margin:0;padding:0;font-variant-numeric:tabular-nums}
  .txItem{padding:6px 6px;border-radius:8px}
  .txItem.buy{color:var(--up)} .txItem.sell{color:var(--down)}
  .txMeta{display:flex;gap:8px;align-items:baseline;font-size:12px;color:rgba(233,254,247,.85)}
  .txMeta .usd{font-weight:800;color:#fff}
  .txMeta .btc{opacity:.85}.txMeta .t{opacity:.65}

  /* Far Right: Ticker Column */
  #tickerCol .card{margin-bottom:12px}
  #feedContainer{border-radius:12px;background:var(--panel);
    box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35),0 0 18px var(--glow)}
  @media (min-width:1024px){
    #feedContainer{position:sticky;top:0;display:flex;flex-direction:column;max-height:calc(100vh - 24px)}
    #tickerHead{position:sticky;top:0;background:linear-gradient(180deg,rgba(16,16,16,1),rgba(16,16,16,.6));padding:6px 6px 4px;z-index:1}
    #tickerScroll{overflow:auto;padding:0 6px 6px}
  }
  .headerRow{font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-size:.8em;opacity:.7;
    border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:4px;padding-bottom:4px;
    display:grid;grid-template-columns:70px 1fr 92px;column-gap:8px;text-align:left}
  .row{display:grid;grid-template-columns:70px 1fr 92px;column-gap:8px;align-items:center;
    padding:2px 4px;border-radius:6px;font-variant-numeric:tabular-nums;font-size:12px;line-height:1.15}
  .row.buy{color:var(--up)}.row.sell{color:var(--down)}
  .time{white-space:nowrap;opacity:.75}
  .priceCell{white-space:nowrap}.amountCell{white-space:nowrap;opacity:.95;cursor:pointer}
  .dir{opacity:.7;margin-left:6px}
  @media (max-width:1023.98px){
    #feedContainer{width:min(920px,96vw);margin:12px auto 0;padding:6px}
    .row,.headerRow{grid-template-columns:1fr 92px}.time,.headerRow>div:first-child{display:none}
  }
  /* Mobile tops (unchanged) */
  .tops{margin:2px 6px 6px}.tops-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tops h4{margin:4px 0 4px;font-size:.9em;font-weight:700;color:#fff}.tops ul{list-style:none;margin:0;padding:0}
  .tops li{padding:3px 0;border-bottom:1px dashed rgba(255,255,255,.07)}.tops .buy{color:var(--up)}.tops .sell{color:var(--down)}
  .tops .muted{color:var(--muted);opacity:.9}
  .tops-summary{display:flex;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 10px;font-size:.95em;font-weight:600;cursor:pointer;align-items:center;justify-content:space-between;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tops-summary .vals{font-variant-numeric:tabular-nums}.tops-summary .chev{opacity:.8;flex-shrink:0}
  @media (max-width:600px){.tops-grid{display:none}.tops.expanded .tops-grid{display:grid}}
  @media (min-width:1024px){.tops-summary{display:none!important}}
</style>
</head>
<body>
<div class="site">
  <!-- LEFT: charts -->
  <div id="leftCol">
    <section id="chartContainer" class="card">
      <div class="chartTitle">BTC-USD • Last 10 minutes</div>
      <canvas id="chartCanvas"></canvas>
    </section>
    <div class="card volBoxTop desktop-only">
      <div class="volTitle">
        <span>Per-minute volume (10m, <strong>₿</strong>)</span>
        <span class="pill"><span class="dot up"></span> Buys &nbsp; <span class="dot down"></span> Sells</span>
      </div>
      <canvas id="volCanvas" width="400" height="160"></canvas>
    </div>
    <section class="card subchart desktop-only"><div class="title">1 hour (1-min candles)</div><canvas id="chart1h"></canvas></section>
    <section id="oneDayCard" class="card subchart desktop-only"><div class="title">1 day (5-min candles)</div><canvas id="chart1d"></canvas></section>
  </div>

  <!-- CENTER: stats -->
  <section id="centerCol">
    <div class="card statsBox" style="margin:12px 0;">
      <div class="liveWrap">
        <div class="liveLeft">
          <span id="d24Change" class="pill">24h Δ —</span>
          <span id="d24HiLo" class="pill">H/L —</span>
          <span id="d24Vol"  class="pill">Vol —</span>
        </div>
        <div class="liveCenter">
          <div id="livePrice" class="livePrice">$—</div>
          <div id="liveChange" class="liveChange flat">—</div>
        </div>
      </div>

      <div class="statsTitle">Last 10 minutes <span class="pill" id="statCount">—</span></div>
      <div class="statRow"><span>Trades / min</span><strong id="statTpm">—</strong></div>
      <div class="statRow"><span>Buy ratio (USD)</span><strong id="statBuyRatio">—</strong></div>
      <div class="statRow"><span>VWAP</span><strong id="statVWAP">—</strong></div>
      <div class="statRow"><span>High / Low</span><strong id="statHiLo">—</strong></div>
      <div class="statRow"><span>Range</span><strong id="statRange">—</strong></div>
      <div class="statRow"><span>Avg size (BTC)</span><strong id="statAvgSz">—</strong></div>
      <div class="statRow"><span>Median size (BTC)</span><strong id="statMedSz">—</strong></div>
      <div class="statRow"><span>Largest buy</span><strong id="statBigBuy">—</strong></div>
      <div class="statRow"><span>Largest sell</span><strong id="statBigSell">—</strong></div>
    </div>

    <div class="card statsBox" style="margin:12px 0;">
      <div class="statsTitle">Last 1 hour <span class="pill" id="statCount1h">—</span></div>
      <div class="statRow"><span>Trades / min</span><strong id="statTpm1h">—</strong></div>
      <div class="statRow"><span>Buy ratio (USD)</span><strong id="statBuyRatio1h">—</strong></div>
      <div class="statRow"><span>VWAP</span><strong id="statVWAP1h">—</strong></div>
      <div class="statRow"><span>High / Low</span><strong id="statHiLo1h">—</strong></div>
      <div class="statRow"><span>Range</span><strong id="statRange1h">—</strong></div>
      <div class="statRow"><span>Avg size (BTC)</span><strong id="statAvgSz1h">—</strong></div>
      <div class="statRow"><span>Median size (BTC)</span><strong id="statMedSz1h">—</strong></div>
      <div class="statRow"><span>Largest buy</span><strong id="statBigBuy1h">—</strong></div>
      <div class="statRow"><span>Largest sell</span><strong id="statBigSell1h">—</strong></div>
    </div>

    <div class="card histBox">
      <div class="statsTitle">Trade size histogram (10m, <strong>₿</strong>)</div>
      <canvas id="histCanvas" width="400" height="160"></canvas>
    </div>
  </section>

  <!-- RIGHT: top transactions -->
  <aside id="rightCol">
    <section id="topTxCard" class="card topTx desktop-only">
      <h3>Top 5 (10m)</h3>
      <div class="txGrid" id="grid10m">
        <div class="txCol buyCol"><h4>Buys</h4><ul id="tx10mBuy" class="txList"></ul></div>
        <div class="txCol sellCol"><h4>Sells</h4><ul id="tx10mSell" class="txList"></ul></div>
      </div>
      <h3 style="margin-top:10px">Top 10 (1h)</h3>
      <div class="txGrid" id="grid1h">
        <div class="txCol buyCol"><h4>Buys</h4><ul id="tx1hBuy" class="txList"></ul></div>
        <div class="txCol sellCol"><h4>Sells</h4><ul id="tx1hSell" class="txList"></ul></div>
      </div>
      <h3 style="margin-top:10px">Top 10 (24h)</h3>
      <div class="txGrid" id="grid1d">
        <div class="txCol buyCol"><h4>Buys</h4><ul id="tx1dBuy" class="txList"></ul></div>
        <div class="txCol sellCol"><h4>Sells</h4><ul id="tx1dSell" class="txList"></ul></div>
      </div>
    </section>
  </aside>

  <!-- FAR RIGHT: ticker column -->
  <aside id="tickerCol">
    <section id="feedContainer" class="card">
      <div id="tickerHead">
        <div class="tops mobile-only" id="topsPanel">
          <button id="topsToggle" class="tops-summary" aria-expanded="false">
            <span class="vals" id="topsSummaryVals"><span class="buy">—</span> | <span class="sell">—</span></span>
            <span class="chev" id="topsChev">▼</span>
          </button>
          <div class="tops-grid" id="topsLists">
            <div><h4>Top Buys (10m)</h4><ul id="topBuys"><li class="muted">—</li></ul></div>
            <div><h4>Top Sells (10m)</h4><ul id="topSells"><li class="muted">—</li></ul></div>
          </div>
        </div>
        <div class="headerRow desktop-only">
          <div>Time</div><div>Price</div><div id="amountHeader" style="cursor:pointer;">Amount (USD)</div>
        </div>
      </div>
      <div id="tickerScroll"><!-- rows injected --></div>
    </section>
  </aside>
</div>

<script>
/* ---------- helpers & refs ---------- */
const $=s=>document.querySelector(s);

const priceEl=$('#livePrice'),changeEl=$('#liveChange');
const tickerScroll=$('#tickerScroll'),amountHeader=$('#amountHeader');
const topBuysEl=$('#topBuys'),topSellsEl=$('#topSells'),topsPanel=$('#topsPanel'),
      topsToggle=$('#topsToggle'),topsChev=$('#topsChev'),topsSummaryVals=$('#topsSummaryVals');

const chartCanvas=$('#chartCanvas'),ctx=chartCanvas.getContext('2d',{desynchronized:true});
const c1h=$('#chart1h'), c1d=$('#chart1d');
const ctx1h=c1h?.getContext('2d',{desynchronized:true});
const ctx1d=c1d?.getContext('2d',{desynchronized:true});
const volCanvas=$('#volCanvas'),vctx=volCanvas?.getContext('2d',{desynchronized:true});
const histCanvas=$('#histCanvas'),hctx=histCanvas?.getContext('2d',{desynchronized:true});

/* stats refs */
const statCount=$('#statCount'),statTpm=$('#statTpm'),statBuyRatio=$('#statBuyRatio'),statVWAP=$('#statVWAP'),
      statHiLo=$('#statHiLo'),statRange=$('#statRange'),statAvgSz=$('#statAvgSz'),statMedSz=$('#statMedSz'),
      statBigBuy=$('#statBigBuy'),statBigSell=$('#statBigSell');
const statCount1h=$('#statCount1h'),statTpm1h=$('#statTpm1h'),statBuyRatio1h=$('#statBuyRatio1h'),statVWAP1h=$('#statVWAP1h'),
      statHiLo1h=$('#statHiLo1h'),statRange1h=$('#statRange1h'),statAvgSz1h=$('#statAvgSz1h'),
      statMedSz1h=$('#statMedSz1h'),statBigBuy1h=$('#statBigBuy1h'),statBigSell1h=$('#statBigSell1h');
const d24Change=$('#d24Change'),d24HiLo=$('#d24HiLo'),d24Vol=$('#d24Vol');

/* Top Tx ULs */
const ul10mBuy=$('#tx10mBuy'),ul10mSell=$('#tx10mSell');
const ul1hBuy=$('#tx1hBuy'),ul1hSell=$('#tx1hSell');
const ul1dBuy=$('#tx1dBuy'),ul1dSell=$('#tx1dSell');

/* Formatters */
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtUSDChange=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2,signDisplay:'always'});
const fmtBTC=new Intl.NumberFormat(undefined,{maximumFractionDigits:5});
const fmtBTCc=new Intl.NumberFormat(undefined,{notation:'compact',maximumFractionDigits:2});
const btcLabel=(v,compact=false)=>compact?`₿${fmtBTCc.format(v)}`:`₿${fmtBTC.format(v)}`;
const fmtPct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const fmtPct2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

/* State */
const desktop=window.matchMedia('(min-width:1024px)');
let MAX_TRADES=desktop.matches?40:12; // ticker rows
desktop.addEventListener('change',e=>{MAX_TRADES=e.matches?40:12});
const MAX_ROWS=MAX_TRADES;
const WINDOW_10M_MS=10*60*1000,WINDOW_1H_MS=60*60*1000,WINDOW_1D_MS=24*60*60*1000;
let trades=[],window10m=[],window1h=[],window1d=[],series=[],lastPrice=null,showUSD=true;

/* ---------- canvas sizing ---------- */
function sizeCanvas(c, ctx){
  const dpr=Math.max(1,Math.min(window.devicePixelRatio||1,3));
  c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
}
function resizeAll(){
  sizeCanvas(chartCanvas,ctx); drawChart();
  if(ctx1h&&c1h){sizeCanvas(c1h,ctx1h); drawSubchart(ctx1h,data1h)}
  if(ctx1d&&c1d){sizeCanvas(c1d,ctx1d); drawSubchart(ctx1d,data1d)}
  if(vctx&&volCanvas){sizeCanvas(volCanvas,vctx); drawVolumeBars()}
  if(hctx&&histCanvas){sizeCanvas(histCanvas,hctx); drawHistogram()}
}
new ResizeObserver(resizeAll).observe(document.body);

/* ---------- websocket + fallbacks ---------- */
let ws=null,reconnectTimer=null,firstMsgTimer=null,gotMessage=false,lastWsMsgAt=0,lastRestAt=0;
function connectSequence(){connectWS('advanced')}
function connectWS(kind){
  clearTimeout(reconnectTimer);clearTimeout(firstMsgTimer);
  if(ws){try{ws.close()}catch(e){}ws=null}
  const url=kind==='advanced'?'wss://advanced-trade-ws.coinbase.com':'wss://ws-feed.exchange.coinbase.com';
  ws=new WebSocket(url);
  ws.onopen=()=>{gotMessage=false;
    if(kind==='advanced'){ws.send(JSON.stringify({type:'subscribe',channel:'market_trades',product_ids:['BTC-USD']}))}
    else{ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}))}
    firstMsgTimer=setTimeout(()=>{if(!gotMessage&&kind==='advanced'){try{ws.close()}catch(e){}connectWS('legacy')}},5000)
  };
  ws.onmessage=e=>{
    gotMessage=true;lastWsMsgAt=Date.now();
    try{
      const m=JSON.parse(e.data);
      if(m.channel==='market_trades'&&Array.isArray(m.events)){
        for(const ev of m.events){
          if(ev.type==='update'&&Array.isArray(ev.trades)){
            for(const tr of ev.trades){
              onTrade({price:+tr.price,size:+tr.size,side:String(tr.side||'').toLowerCase(),time:new Date(ev.timestamp||tr.time||Date.now())})
            }
          }
        }
        return;
      }
      if(m.type==='match'&&m.product_id==='BTC-USD'){
        onTrade({price:+m.price,size:+m.size,side:String(m.side||'').toLowerCase(),time:new Date(m.time||Date.now())});return;
      }
    }catch(_){}
  };
  ws.onclose=()=>{clearTimeout(firstMsgTimer);reconnectTimer=setTimeout(connectSequence,1000)};
  ws.onerror=()=>{try{ws.close()}catch(e){}};
}
async function pollTradesFallback(){
  const QUIET_MS=3500,now=Date.now();
  try{
    if(now-lastWsMsgAt>=QUIET_MS){
      const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/trades?limit=20',{headers:{Accept:'application/json'}});
      if(r.ok){const arr=await r.json();for(let i=arr.length-1;i>=0;i--){const t=arr[i];onTrade({price:+t.price,size:+t.size,side:String(t.side||'').toLowerCase(),time:new Date(t.time||now)})}
        lastRestAt=now;return}
    }
    if(now-Math.max(lastWsMsgAt,lastRestAt)>=QUIET_MS){
      const r2=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/ticker',{headers:{Accept:'application/json'}});
      if(r2.ok){const t=await r2.json();onTrade({price:+t.price,size:+(t.size||0.001),side:'buy',time:new Date(t.time||now)});lastRestAt=now;return}
    }
  }catch(_){}
}
setInterval(pollTradesFallback,1200);

/* ---------- trade handling ---------- */
function onTrade(t){
  const p=t.price,s=t.size,side=t.side==='sell'?'sell':'buy',time=t.time;
  const prev=trades.length?trades[trades.length-1].price:lastPrice,arrow=(prev!=null)?(p>prev?'▲':p<prev?'▼':'•'):'';
  if(lastPrice!==null){priceEl.classList.remove('up','down');if(p>lastPrice)priceEl.classList.add('up');else if(p<lastPrice)priceEl.classList.add('down')}
  lastPrice=p;priceEl.textContent=fmtUSD.format(p);
  trades.push({price:p,size:s,time,side,arrow});if(trades.length>MAX_TRADES)trades.shift();
  const epoch=time.getTime(),obj={price:p,size:s,side,time:epoch};
  window10m.push(obj);window1h.push(obj);window1d.push(obj);
  series.push({t:Date.now(),p});
  pruneWindows();renderFeed();renderTopTransactions();
}
function pruneWindows(){
  const now=Date.now();
  window10m=window10m.filter(t=>t.time>=now-WINDOW_10M_MS);
  window1h =window1h .filter(t=>t.time>=now-WINDOW_1H_MS);
  window1d =window1d .filter(t=>t.time>=now-WINDOW_1D_MS);
  while(series.length&&series[0].t<now-WINDOW_10M_MS)series.shift();
}

/* ---------- ticker render ---------- */
function renderFeed(){
  const frag=document.createDocumentFragment();
  const start=Math.max(0,trades.length-MAX_ROWS);
  for(let i=trades.length-1;i>=start;i--){
    const t=trades[i],row=document.createElement('div');row.className=`row ${t.side}`;
    const ts=new Date(t.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const amt=showUSD?fmtUSD.format(t.price*t.size):`${fmtBTC.format(t.size)} BTC`;
    row.innerHTML=`<div class="time">${ts}</div><div class="priceCell">${fmtUSD.format(t.price)} <span class="dir">${t.arrow}</span></div><div class="amountCell">${amt}</div>`;
    row.querySelector('.amountCell').addEventListener('click',toggleAmountView);
    frag.appendChild(row);
  }
  tickerScroll.innerHTML='';tickerScroll.appendChild(frag);
}

/* ---------- top transactions ---------- */
function renderTopTransactions(){
  const renderSide=(arr,ul,limit,side)=>{
    if(!ul)return;
    const items=arr.filter(t=>t.side===side).map(t=>({...t,usd:t.price*t.size}))
      .sort((a,b)=>b.usd-a.usd).slice(0,limit);
    if(!items.length){ul.innerHTML=`<li style="opacity:.7;padding:6px 8px">—</li>`;return;}
    ul.innerHTML=items.map(t=>{
      const time=new Date(t.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      return `<li class="txItem ${side}">
        <div class="txMeta">
          <span class="usd">${fmtUSD0.format(t.usd)}</span>
          <span class="btc">(${fmtBTC.format(t.size)} BTC)</span>
          <span class="t">${time}</span>
        </div>
      </li>`;
    }).join('');
  };
  renderSide(window10m,ul10mBuy,5,'buy');  renderSide(window10m,ul10mSell,5,'sell');
  renderSide(window1h, ul1hBuy,10,'buy');  renderSide(window1h, ul1hSell,10,'sell');
  renderSide(window1d, ul1dBuy,10,'buy');  renderSide(window1d, ul1dSell,10,'sell');
}

/* ---------- stats ---------- */
function computeWindow(arr, minutes){
  const count=arr.length, volBtc=arr.reduce((a,t)=>a+t.size,0), volUsd=arr.reduce((a,t)=>a+t.size*t.price,0);
  let buyUsd=0,sellUsd=0,buyMax=0,sellMax=0,hi=-Infinity,lo=Infinity;
  for(const t of arr){const usd=t.price*t.size;hi=Math.max(hi,t.price);lo=Math.min(lo,t.price);
    if(t.side==='buy'){buyUsd+=usd;buyMax=Math.max(buyMax,usd)}else{sellUsd+=usd;sellMax=Math.max(sellMax,usd)}}
  const vwap=volBtc?(arr.reduce((a,t)=>a+t.price*t.size,0)/volBtc):NaN;
  const rangeUsd=(isFinite(hi)&&isFinite(lo))?(hi-lo):NaN, rangePct=(isFinite(hi)&&isFinite(lo)&&lo>0)?((hi/lo-1)*100):NaN;
  const avgSz=count?(volBtc/count):NaN,medSz=medianSize(arr);
  return{count,tpm:(count/minutes),buyUsd,sellUsd,volUsd,hi:(hi===-Infinity?NaN:hi),lo:(lo===Infinity?NaN:lo),vwap,rangeUsd,rangePct,avgSz,medSz,buyMax,sellMax}
}
function renderStats(){
  const S=computeWindow(window10m,10);
  statCount.textContent=`${S.count} trades`;statTpm.textContent=S.tpm.toFixed(1);
  statBuyRatio.textContent=`${(S.volUsd?(S.buyUsd/S.volUsd*100):0).toFixed(1)}%`;
  statVWAP.textContent=isFinite(S.vwap)?fmtUSD.format(S.vwap):'—';
  statHiLo.textContent=(isFinite(S.hi)&&isFinite(S.lo))?`${fmtUSD.format(S.hi)} / ${fmtUSD.format(S.lo)}`:'—';
  statRange.textContent=(isFinite(S.rangeUsd)&&isFinite(S.rangePct))?`${fmtUSD0.format(S.rangeUsd)} (${fmtPct1.format(S.rangePct)}%)`:'—';
  statAvgSz.textContent=isFinite(S.avgSz)?S.avgSz.toLocaleString(undefined,{maximumFractionDigits:4}):'—';
  statMedSz.textContent=isFinite(S.medSz)?S.medSz.toLocaleString(undefined,{maximumFractionDigits:4}):'—';
  statBigBuy.textContent=S.buyMax?fmtUSD0.format(S.buyMax):'—';
  statBigSell.textContent=S.sellMax?fmtUSD0.format(S.sellMax):'—';

  const H=computeWindow(window1h,60);
  statCount1h.textContent=`${H.count} trades`;statTpm1h.textContent=H.tpm.toFixed(1);
  statBuyRatio1h.textContent=`${(H.volUsd?(H.buyUsd/H.volUsd*100):0).toFixed(1)}%`;
  statVWAP1h.textContent=isFinite(H.vwap)?fmtUSD.format(H.vwap):'—';
  statHiLo1h.textContent=(isFinite(H.hi)&&isFinite(H.lo))?`${fmtUSD.format(H.hi)} / ${fmtUSD.format(H.lo)}`:'—';
  statRange1h.textContent=(isFinite(H.rangeUsd)&&isFinite(H.rangePct))?`${fmtUSD0.format(H.rangeUsd)} (${fmtPct1.format(H.rangePct)}%)`:'—';
  statAvgSz1h.textContent=isFinite(H.avgSz)?H.avgSz.toLocaleString(undefined,{maximumFractionDigits:4}):'—';
  statMedSz1h.textContent=isFinite(H.medSz)?H.medSz.toLocaleString(undefined,{maximumFractionDigits:4}):'—';
  statBigBuy1h.textContent=H.buyMax?fmtUSD0.format(H.buyMax):'—';
  statBigSell1h.textContent=H.sellMax?fmtUSD0.format(H.sellMax):'—';
}
function medianSize(arr){const s=arr.map(t=>t.size).sort((a,b)=>a-b),n=s.length;if(!n)return NaN;return n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2}

/* ---------- volume (10m) — BTC + ₿ labels ---------- */
function minuteAlignedStart(){const now=Date.now();const ms=now-(now%60000);return ms-(9*60000)}
function minuteBucketsBTC(){
  const start=minuteAlignedStart();
  const bins=Array.from({length:10},(_,i)=>({buyBtc:0,sellBtc:0,ts:start+i*60000}));
  for(const t of window10m){
    if(t.time<start-1||t.time>=start+10*60000)continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/60000)));
    if(t.side==='buy')bins[idx].buyBtc+=t.size; else bins[idx].sellBtc+=t.size;
  }
  return bins;
}
function drawVolumeBars(){
  if(!vctx||!volCanvas)return;const w=volCanvas.clientWidth,h=volCanvas.clientHeight;vctx.clearRect(0,0,w,h);
  const bins=minuteBucketsBTC();const max=Math.max(1,...bins.map(b=>b.buyBtc+b.sellBtc));
  const padX=28,padYTop=8,padYBot=22;const chartH=h-padYTop-padYBot;const step=(w-padX*2)/bins.length;const barW=step*0.7;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim()||'#00ffb3';
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim()||'#ff3c3c';
  vctx.strokeStyle='rgba(255,255,255,.06)';vctx.lineWidth=1;for(let i=1;i<=3;i++){const y=padYTop+chartH*(i/4*(4/3));vctx.beginPath();vctx.moveTo(padX-6,y);vctx.lineTo(w-padX+6,y);vctx.stroke()}
  vctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';vctx.textAlign='center';vctx.textBaseline='top';vctx.fillStyle='rgba(255,255,255,.75)';
  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i];const xC=w-padX-((bins.length-1-i)*step)-step/2;const total=b.buyBtc+b.sellBtc;const hT=(total/max)*chartH;
    const hBuy=total?(b.buyBtc/total)*hT:0;const hSell=hT-hBuy;const yBase=padYTop+chartH;
    vctx.fillStyle=dn;vctx.fillRect(xC-barW/2,yBase-hSell,barW,hSell);
    vctx.fillStyle=up;vctx.fillRect(xC-barW/2,yBase-hSell-hBuy,barW,hBuy);
    vctx.save();vctx.fillStyle='rgba(0,0,0,.85)';vctx.textBaseline='middle';vctx.textAlign='center';
    const sellTxt=(hSell>16&&b.sellBtc>0)?`₿${fmtBTCc.format(b.sellBtc)}`:'';const buyTxt=(hBuy>16&&b.buyBtc>0)?`₿${fmtBTCc.format(b.buyBtc)}`:'';
    if(sellTxt)vctx.fillText(sellTxt,xC,yBase-hSell/2); if(buyTxt)vctx.fillText(buyTxt,xC,yBase-hSell-hBuy/2); vctx.restore();
    const mm=new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'});if((i%2)===1)vctx.fillText(':'+mm,xC,yBase+4)
  }
  vctx.textAlign='right';vctx.textBaseline='alphabetic';vctx.fillStyle='rgba(255,255,255,.8)';vctx.fillText(`max ₿${fmtBTC.format(max)}`,w-6,padYTop+10)
}

/* ---------- histogram (10m) — BTC + ₿ labels ---------- */
const BINS=[{label:"<0.01",lo:0,hi:0.01},{label:"0.01–0.05",lo:0.01,hi:0.05},{label:"0.05–0.1",lo:0.05,hi:0.1},{label:"0.1–0.5",lo:0.1,hi:0.5},{label:"0.5–1",lo:0.5,hi:1},{label:"1–3",lo:1,hi:3},{label:"3–10",lo:3,hi:10},{label:">10",lo:10,hi:Infinity}];
function histogramBucketsBTC(){const buys=new Array(BINS.length).fill(0),sells=new Array(BINS.length).fill(0);
  for(const t of window10m){const sz=t.size;for(let i=0;i<BINS.length;i++){const b=BINS[i];if(sz>=b.lo&&sz<b.hi){if(t.side==='buy')buys[i]+=sz;else sells[i]+=sz;break}}}
  return{buys,sells}}
function drawHistogram(){
  if(!hctx||!histCanvas)return;const w=histCanvas.clientWidth,h=histCanvas.clientHeight;hctx.clearRect(0,0,w,h);
  const {buys,sells}=histogramBucketsBTC();const totals=buys.map((v,i)=>v+sells[i]);const max=Math.max(1,...totals);
  const pad=12,barH=(h-pad*2)/BINS.length*0.68,step=(h-pad*2)/BINS.length;const x0=110;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim()||'#00ffb3';
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim()||'#ff3c3c';
  hctx.save();hctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';hctx.textBaseline='middle';hctx.textAlign='left';hctx.fillStyle='rgba(255,255,255,.85)';
  BINS.forEach((b,i)=>{const y=pad+i*step+(step-barH)/2;hctx.fillText(b.label,6,y+barH/2)});hctx.restore();
  BINS.forEach((b,i)=>{const y=pad+i*step+(step-barH)/2;const total=totals[i], fullW=(total/max)*(w-x0-12);const sellW=total?(sells[i]/total)*fullW:0, buyW=fullW-sellW;
    hctx.fillStyle=dn; hctx.fillRect(x0,y,sellW,barH);hctx.fillStyle=up; hctx.fillRect(x0+sellW,y,buyW,barH);
    hctx.save();hctx.textBaseline='middle';hctx.textAlign='center';
    const sellTxt=(sells[i]>0&&sellW>48)?`₿${fmtBTCc.format(sells[i])}`:'';const buyTxt=(buys[i]>0&&buyW>48)?`₿${fmtBTCc.format(buys[i])}`:'';
    if(sellTxt){hctx.fillStyle='rgba(0,0,0,.85)';hctx.fillText(sellTxt,x0+sellW/2,y+barH/2)}
    if(buyTxt ){hctx.fillStyle='rgba(0,0,0,.85)';hctx.fillText(buyTxt ,x0+sellW+buyW/2,y+barH/2)}
    hctx.restore()})
}

/* ---------- price chart (10m) + subcharts ---------- */
function drawChart(){const w=chartCanvas.clientWidth,h=chartCanvas.clientHeight,xPad=36,xRight=w;
  ctx.clearRect(0,0,w,h);ctx.fillStyle='#101010';ctx.fillRect(0,0,w,h);if(series.length<2)return;
  let min=Infinity,max=-Infinity,sum=0;for(const s of series){const p=s.p;if(p<min)min=p;if(p>max)max=p;sum+=p}
  const range=(max-min)||1,avg=sum/series.length;
  ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;for(let i=1;i<6;i++){const gy=(h/6)*i;ctx.beginPath();ctx.moveTo(xPad,gy);ctx.lineTo(xRight,gy);ctx.stroke()}
  ctx.fillStyle='rgba(255,255,255,.78)';ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';ctx.textBaseline='middle';
  const lab=v=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v);
  const yMin=h-((min-min)/range)*h,yMax=h-((max-min)/range)*h,yAvg=h-((avg-min)/range)*h;
  ctx.fillText(lab(max),6,Math.max(10,yMax));ctx.fillText(lab(avg),6,Math.max(14,Math.min(h-14,yAvg)));ctx.fillText(lab(min),6,Math.min(h-10,yMin));
  ctx.save();ctx.setLineDash([6,6]);ctx.strokeStyle='rgba(200,214,207,.6)';ctx.beginPath();ctx.moveTo(xPad,yAvg);ctx.lineTo(xRight,yAvg);ctx.stroke();ctx.restore();
  ctx.lineWidth=2;for(let i=1;i<series.length;i++){const p0=series[i-1].p,p1=series[i].p;const x0=((i-1)/(series.length-1))*(xRight-xPad)+xPad,x1=((i)/(series.length-1))*(xRight-xPad)+xPad;
    const y0=h-((p0-min)/range)*h,y1=h-((p1-min)/range)*h;ctx.strokeStyle=(p1>=avg)?'#00ffb3':'#ff3c3c';ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);ctx.stroke()}
  const now=Date.now(),start=now-10*60*1000;ctx.fillStyle='rgba(255,255,255,.75)';ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';ctx.textBaseline='top';ctx.textAlign='center';
  ctx.strokeStyle='rgba(255,255,255,.05)';for(let i=0;i<=10;i+=2){const t=start+i*60*1000;const x=xPad+((t-start)/(10*60*1000))*(xRight-xPad);
    ctx.beginPath();ctx.moveTo(x,h-18);ctx.lineTo(x,h-4);ctx.stroke();const mm=new Date(t).toLocaleTimeString([], {minute:'2-digit'});ctx.fillText(':'+mm,x,h-16)}}
function updateTenMinuteChange(){const cutoff=Date.now()-600000;while(series.length&&series[0].t<cutoff)series.shift();
  if(series.length<2){changeEl.textContent='—';changeEl.className='liveChange flat';return}
  const start=series[0].p,now=series[series.length-1].p,diff=now-start,pct=((now-start)/start)*100;
  const cls=diff>0?'up':diff<0?'down':'flat';changeEl.textContent=`${fmtUSDChange.format(diff)} (${fmtPct2.format(pct)}%)`;changeEl.className=`liveChange ${cls}`;void changeEl.offsetWidth;changeEl.classList.add('flash')}

async function fetch24h(){try{const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats',{headers:{Accept:'application/json'}});if(!r.ok)throw 0;const j=await r.json();
  const open=+j.open,last=+j.last,high=+j.high,low=+j.low,vol=+j.volume;if(Number.isFinite(open)&&Number.isFinite(last)){const diff=last-open,pct=open?(diff/open*100):0;
    d24Change.textContent=`24h Δ ${fmtUSDChange.format(diff)} (${fmtPct2.format(pct)}%)`;d24Change.style.color=diff>0?'var(--up)':(diff<0?'var(--down)':'var(--muted)')}
  d24HiLo.textContent=(Number.isFinite(high)&&Number.isFinite(low))?`H/L ${fmtUSD0.format(high)} / ${fmtUSD0.format(low)}`:'H/L —';d24Vol.textContent=Number.isFinite(vol)?`Vol ${vol.toLocaleString(undefined,{maximumFractionDigits:0})}`:'Vol —'}catch(_){d24Change.textContent='24h Δ —';d24Change.style.color='var(--muted)';d24HiLo.textContent='H/L —';d24Vol.textContent='Vol —'}}

let data1h=[],data1d=[];const iso=ms=>new Date(ms).toISOString();
async function fetchCandles(secsBack,gran){const end=Date.now(),start=end-secsBack*1000;
  const url=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=${gran}&start=${encodeURIComponent(iso(start))}&end=${encodeURIComponent(iso(end))}`;
  const r=await fetch(url,{headers:{Accept:'application/json'}});if(!r.ok)throw 0;const arr=await r.json();return arr.sort((a,b)=>a[0]-b[0]).map(x=>({t:x[0]*1000,c:+x[4]}))}
async function refreshSubcharts(){try{if(ctx1h)data1h=await fetchCandles(3600,60)}catch(_){ }try{if(ctx1d)data1d=await fetchCandles(86400,300)}catch(_){ }
  if(ctx1h){sizeCanvas(c1h,ctx1h);drawSubchart(ctx1h,data1h)}
  if(ctx1d){sizeCanvas(c1d,ctx1d);drawSubchart(ctx1d,data1d)}}
function drawSubchart(context,seriesIn){if(!context)return;const w=context.canvas.clientWidth,h=context.canvas.clientHeight;context.clearRect(0,0,w,h);context.fillStyle='#101010';context.fillRect(0,0,w,h);
  if(!seriesIn||seriesIn.length<2)return;const min=Math.min(...seriesIn.map(d=>d.c)),max=Math.max(...seriesIn.map(d=>d.c)),range=(max-min)||1,avg=seriesIn.reduce((a,d)=>a+d.c,0)/seriesIn.length;
  context.strokeStyle='rgba(255,255,255,.06)';context.lineWidth=1;for(let i=1;i<=4;i++){const y=(h/5)*i;context.beginPath();context.moveTo(0,y);context.lineTo(w,y);context.stroke()}
  const yAvg=h-((avg-min)/range)*h;context.save();context.setLineDash([6,6]);context.strokeStyle='rgba(200,214,207,.6)';context.beginPath();context.moveTo(0,yAvg);context.lineTo(w,yAvg);context.stroke();context.restore();
  context.lineWidth=2;for(let i=1;i<seriesIn.length;i++){const p0=seriesIn[i-1].c,p1=seriesIn[i].c;const x0=((i-1)/(seriesIn.length-1))*w,x1=((i)/(seriesIn.length-1))*w;const y0=h-((p0-min)/range)*h,y1=h-((p1-min)/range)*h;context.strokeStyle=(p1>=avg)?'#00ffb3':'#ff3c3c';context.beginPath();context.moveTo(x0,y0);context.lineTo(x1,y1);context.stroke()}
  const lab=v=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v);context.fillStyle='rgba(255,255,255,.75)';context.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';context.textBaseline='middle';
  context.fillText(lab(max),6,10);context.fillText(lab(avg),6,Math.max(14,Math.min(h-14,yAvg)));context.fillText(lab(min),6,h-10)}

/* ---------- loop & UI ---------- */
function loop(){renderStats();drawChart();drawVolumeBars();drawHistogram();updateTenMinuteChange();requestAnimationFrame(loop)}
function renderTops(){
  const buys=window10m.filter(t=>t.side==='buy').map(t=>({...t,btc:t.size})).sort((a,b)=>b.btc-a.btc).slice(0,3);
  const sells=window10m.filter(t=>t.side==='sell').map(t=>({...t,btc:t.size})).sort((a,b)=>b.btc-a.btc).slice(0,3);
  const fmtAmt=t=>`${fmtBTC.format(t.btc)} BTC`;
  if(topBuysEl)topBuysEl.innerHTML=buys.length?buys.map(t=>`<li class="buy">${fmtAmt(t)}</li>`).join(''):`<li class="muted">—</li>`;
  if(topSellsEl)topSellsEl.innerHTML=sells.length?sells.map(t=>`<li class="sell">${fmtAmt(t)}</li>`).join(''):`<li class="muted">—</li>`;
  if(topsSummaryVals){const tb=buys[0]?`<span class="buy">${fmtAmt(buys[0])}</span>`:'<span class="buy">—</span>';
    const ts=sells[0]?`<span class="sell">${fmtAmt(sells[0])}</span>`:'<span class="sell">—</span>';topsSummaryVals.innerHTML=`${tb} | ${ts}`}
}
function toggleAmountView(){showUSD=!showUSD;amountHeader.textContent=showUSD?'Amount (USD)':'Amount (BTC)';
  renderFeed();renderTops();renderStats();drawHistogram();renderTopTransactions()}
amountHeader?.addEventListener('click',toggleAmountView);
topsToggle?.addEventListener('click',()=>{const exp=topsPanel.classList.toggle('expanded');topsToggle.setAttribute('aria-expanded',exp?'true':'false');topsChev.textContent=exp?'▲':'▼'});

resizeAll();connectSequence();refreshSubcharts();fetch24h();requestAnimationFrame(loop);
setInterval(fetch24h,60000);setInterval(refreshSubcharts,60000);setInterval(pollTradesFallback,1200);
setInterval(()=>{renderFeed();renderTops();renderTopTransactions()},1500);
</script>
</body>
</html>
