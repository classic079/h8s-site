<script>
// --- Add/replace these helpers near your other formatters ---
const fmtBTC = new Intl.NumberFormat(undefined,{maximumFractionDigits:5});
const fmtBTCc = new Intl.NumberFormat(undefined,{notation:'compact',maximumFractionDigits:2});
const btcLabel = (v, compact=false) => compact ? `₿${fmtBTCc.format(v)}` : `₿${fmtBTC.format(v)}`;

// ===== 10m Volume bars — BTC with ₿ labels =====
function minuteAlignedStart(){ const now=Date.now(); const ms=now-(now%60000); return ms-(9*60000); }
function minuteBucketsBTC(){
  const start=minuteAlignedStart();
  const bins=Array.from({length:10},(_,i)=>({buyBtc:0,sellBtc:0,ts:start+i*60000}));
  for(const t of window10m){
    if(t.time<start-1||t.time>=start+10*60000) continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/60000)));
    if(t.side==='buy') bins[idx].buyBtc += t.size; else bins[idx].sellBtc += t.size;
  }
  return bins;
}
function drawVolumeBars(){
  if(!vctx||!volCanvas) return;
  const w=volCanvas.clientWidth, h=volCanvas.clientHeight;
  vctx.clearRect(0,0,w,h);

  const bins=minuteBucketsBTC();
  const max=Math.max(1,...bins.map(b=>b.buyBtc+b.sellBtc));

  const padX=28, padYTop=8, padYBot=22;
  const chartH = h - padYTop - padYBot;
  const step   = (w - padX*2) / bins.length;
  const barW   = step * 0.7;

  const up = getComputedStyle(document.documentElement).getPropertyValue('--up').trim()  || '#00ffb3';
  const dn = getComputedStyle(document.documentElement).getPropertyValue('--down').trim()|| '#ff3c3c';

  // light grid
  vctx.strokeStyle='rgba(255,255,255,.06)';
  vctx.lineWidth=1;
  for(let i=1;i<=3;i++){
    const y = padYTop + chartH*(i/4*(4/3));
    vctx.beginPath(); vctx.moveTo(padX-6,y); vctx.lineTo(w-padX+6,y); vctx.stroke();
  }

  vctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  vctx.textAlign='center';
  vctx.textBaseline='top';
  vctx.fillStyle='rgba(255,255,255,.75)';

  // draw right-to-left
  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i];
    const xC   = w - padX - ((bins.length-1-i)*step) - step/2;
    const total= b.buyBtc + b.sellBtc;
    const hT   = (total/max)*chartH;
    const hBuy = total ? (b.buyBtc/total)*hT : 0;
    const hSell= hT - hBuy;
    const yBase= padYTop + chartH;

    // bars
    vctx.fillStyle=dn; vctx.fillRect(xC-barW/2, yBase-hSell,       barW, hSell);
    vctx.fillStyle=up; vctx.fillRect(xC-barW/2, yBase-hSell-hBuy,  barW, hBuy);

    // in-bar BTC labels (use compact)
    vctx.save();
    vctx.fillStyle='rgba(0,0,0,.85)';
    vctx.textBaseline='middle';
    vctx.textAlign='center';
    const sellTxt = (hSell>16 && b.sellBtc>0) ? btcLabel(b.sellBtc, true) : '';
    const buyTxt  = (hBuy >16 && b.buyBtc >0) ? btcLabel(b.buyBtc , true) : '';
    if(sellTxt) vctx.fillText(sellTxt, xC, yBase - hSell/2);
    if(buyTxt)  vctx.fillText(buyTxt , xC, yBase - hSell - hBuy/2);
    vctx.restore();

    // time ticks (every other minute to reduce clutter)
    const mm = new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'});
    if((i%2)===1) vctx.fillText(':'+mm, xC, yBase+4);
  }

  // max label (top-right)
  vctx.textAlign='right';
  vctx.textBaseline='alphabetic';
  vctx.fillStyle='rgba(255,255,255,.8)';
  vctx.fillText(`max ${btcLabel(max)}`, w-6, padYTop+10);
}

// ===== Histogram — BTC per size bucket with ₿ labels =====
const BINS=[{label:"<0.01",lo:0,hi:0.01},{label:"0.01–0.05",lo:0.01,hi:0.05},{label:"0.05–0.1",lo:0.05,hi:0.1},{label:"0.1–0.5",lo:0.1,hi:0.5},{label:"0.5–1",lo:0.5,hi:1},{label:"1–3",lo:1,hi:3},{label:"3–10",lo:3,hi:10},{label:">10",lo:10,hi:Infinity}];
function histogramBucketsBTC(){
  const buys=new Array(BINS.length).fill(0), sells=new Array(BINS.length).fill(0);
  for(const t of window10m){
    const sz=t.size;
    for(let i=0;i<BINS.length;i++){
      const b=BINS[i]; if(sz>=b.lo && sz<b.hi){ if(t.side==='buy') buys[i]+=sz; else sells[i]+=sz; break; }
    }
  }
  return {buys,sells};
}
function drawHistogram(){
  if(!hctx||!histCanvas) return;
  const w=histCanvas.clientWidth, h=histCanvas.clientHeight;
  hctx.clearRect(0,0,w,h);

  const {buys,sells}=histogramBucketsBTC();
  const totals=buys.map((v,i)=>v+sells[i]);
  const max=Math.max(1,...totals);

  const pad=12, barH=(h-pad*2)/BINS.length*0.68, step=(h-pad*2)/BINS.length, x0=110;

  const up = getComputedStyle(document.documentElement).getPropertyValue('--up').trim()  || '#00ffb3';
  const dn = getComputedStyle(document.documentElement).getPropertyValue('--down').trim()|| '#ff3c3c';

  // left labels centered with rows
  hctx.save();
  hctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  hctx.textBaseline='middle';
  hctx.textAlign='left';
  hctx.fillStyle='rgba(255,255,255,.85)';
  BINS.forEach((b,i)=>{
    const y = pad + i*step + (step-barH)/2;
    hctx.fillText(b.label, 6, y+barH/2);
  });
  hctx.restore();

  // bars + in-bar ₿ values
  BINS.forEach((b,i)=>{
    const y = pad + i*step + (step-barH)/2;
    const total = totals[i];
    const fullW = (total/max) * (w - x0 - 12);
    const sellW = total ? (sells[i]/total)*fullW : 0;
    const buyW  = fullW - sellW;

    hctx.fillStyle=dn; hctx.fillRect(x0,         y, sellW, barH);
    hctx.fillStyle=up; hctx.fillRect(x0+sellW,   y, buyW , barH);

    // in-bar ₿ labels (compact)
    hctx.save();
    hctx.textBaseline='middle';
    hctx.textAlign='center';
    const sellTxt = (sells[i]>0 && sellW>48) ? btcLabel(sells[i], true) : '';
    const buyTxt  = (buys[i] >0 && buyW >48) ? btcLabel(buys[i] , true) : '';
    if(sellTxt){ hctx.fillStyle='rgba(0,0,0,.85)'; hctx.fillText(sellTxt, x0+sellW/2,      y+barH/2); }
    if(buyTxt ){ hctx.fillStyle='rgba(0,0,0,.85)'; hctx.fillText(buyTxt , x0+sellW+buyW/2, y+barH/2); }
    hctx.restore();
  });
}
</script>
