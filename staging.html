<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Live BTC/USD</title>
  <style>
    :root {
      --bg:#0a0a0a; --panel:#101010; --text:#e9fef7;
      --up:#00ffb3; --down:#ff3c3c; --muted:#c8d6cf;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{min-height:100%;padding-bottom:env(safe-area-inset-bottom);display:flex;flex-direction:column;align-items:center;}

    /* Top bar (unchanged) */
    .topbar{
      position:sticky;top:0;z-index:10;width:100%;
      background:linear-gradient(180deg,rgba(10,10,10,.95),rgba(10,10,10,.7));
      backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
      padding:calc(8px + env(safe-area-inset-top)) 14px 8px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex;justify-content:center;gap:12px;align-items:baseline;
      font-variant-numeric:tabular-nums;
    }
    .price{font-size:clamp(22px,7vw,40px);font-weight:800;line-height:1;transition:color .25s ease;color:#fff;text-shadow:0 0 18px rgba(0,0,0,.35);}
    .price.up{color:var(--up)} .price.down{color:var(--down)}
    .change{font-size:clamp(12px,3.2vw,16px);font-weight:700;opacity:.9;transition:color .25s ease;}
    .change.up{color:var(--up)} .change.down{color:var(--down)} .change.flat{color:var(--muted)}
    @keyframes changeFlash{0%{opacity:.4;transform:scale(.985)}60%{opacity:1;transform:scale(1)}100%{opacity:.95;transform:scale(1)}}
    .change.flash{animation:changeFlash 450ms ease-out;}

    /* === NEW: TPS mini bar directly under topbar === */
    #tpsRow{
      width:min(920px,96vw); margin:6px auto 2px;
      display:flex; align-items:center; gap:8px;
    }
    #tpsLabel{font-size:12px;opacity:.75;white-space:nowrap;}
    #tpsBox{
      flex:1; height:42px; background:var(--panel); border-radius:8px;
      box-shadow:0 0 0 1px rgba(255,255,255,.04),0 6px 18px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    #tpsCanvas{position:absolute; inset:0; display:block; width:100%; height:100%;}

    /* Chart (unchanged) */
    #chartContainer{position:relative;width:min(920px,96vw);height:clamp(130px,26vh,220px);margin:8px auto 10px;}
    #chartCanvas{position:absolute;inset:0;width:100%;height:100%;background:var(--panel);border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35);}

    /* Feed (unchanged) */
    #feedContainer{width:min(920px,96vw);height:56vh;background:var(--panel);border-radius:12px;padding:6px;
      overflow-y:auto;-webkit-overflow-scrolling:touch;
      box-shadow:0 0 0 1px rgba(255,255,255,.04),0 10px 30px rgba(0,0,0,.35);
    }
    .feedRow{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;font-size:14px;font-variant-numeric:tabular-nums;}
    .feedRow:nth-child(even){background:rgba(255,255,255,0.02);}
    .feedRow.buy{color:var(--up)} .feedRow.sell{color:var(--down)}
    .feedTime{opacity:.6;font-size:12px;}
    .feedQty{opacity:.8;font-weight:600;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="price" id="price">–</div>
      <div class="change flat" id="change">0.00%</div>
    </div>

    <!-- NEW: TPS bar (added, everything else unchanged) -->
    <div id="tpsRow" aria-label="Trades per second (last 60s)">
      <span id="tpsLabel">TPS (60s)</span>
      <div id="tpsBox"><canvas id="tpsCanvas"></canvas></div>
    </div>

    <div id="chartContainer">
      <canvas id="chartCanvas"></canvas>
    </div>

    <div id="feedContainer"></div>
  </div>

  <script>
    /* ==== ORIGINAL INDEX LOGIC (unchanged) ==== */
    const priceEl = document.getElementById('price');
    const changeEl = document.getElementById('change');
    const feedEl = document.getElementById('feedContainer');
    let lastPrice = null;

    function setPrice(p) {
      if (lastPrice !== null) {
        const diff = p - lastPrice;
        const pct = ((p - lastPrice) / lastPrice * 100).toFixed(2);
        changeEl.textContent = `${pct > 0 ? '+' : ''}${pct}%`;
        changeEl.className = 'change ' + (pct > 0 ? 'up' : pct < 0 ? 'down' : 'flat') + ' flash';
        priceEl.className = 'price ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : '');
      }
      priceEl.textContent = p.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
      lastPrice = p;
    }

    function addTrade({side, price, size, time}) {
      const row = document.createElement('div');
      row.className = `feedRow ${side || ''}`;
      row.innerHTML = `
        <div class="feedTime">${time ? new Date(time).toLocaleTimeString() : ''}</div>
        <div class="feedQty">${Number.isFinite(parseFloat(size)) ? parseFloat(size).toFixed(4) + ' BTC' : '—'}</div>
        <div>${Number.isFinite(parseFloat(price)) ? parseFloat(price).toLocaleString('en-US',{style:'currency',currency:'USD'}) : ''}</div>
      `;
      feedEl.prepend(row);
      if (feedEl.children.length > 120) feedEl.removeChild(feedEl.lastChild);
    }

    // Coinbase WebSocket feed (UNCHANGED except for one added line: tpsBump(1))
    const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: 'subscribe',
        channels: [{ name: 'ticker', product_ids: ['BTC-USD'] }]
      }));
    };
    ws.onmessage = e => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'ticker' && msg.price) {
          const p = parseFloat(msg.price);
          if (!isNaN(p)) setPrice(p);
          addTrade(msg);

          /* NEW: bump TPS counter (does nothing if TPS module isn’t loaded) */
          if (window.tpsBump) window.tpsBump(1);
        }
      } catch {}
    };

    // Chart canvas sizing (UNCHANGED)
    const chartCanvas = document.getElementById('chartCanvas');
    const chartCtx = chartCanvas.getContext('2d');
    function resizeChart(){
      const r = chartCanvas.getBoundingClientRect();
      chartCanvas.width = Math.floor(r.width * devicePixelRatio);
      chartCanvas.height = Math.floor(r.height * devicePixelRatio);
      chartCtx.fillStyle = 'rgba(255,255,255,0.02)';
      chartCtx.fillRect(0,0,chartCanvas.width,chartCanvas.height);
    }
    window.addEventListener('load', resizeChart);
    window.addEventListener('orientationchange', () => setTimeout(resizeChart, 250));
    window.addEventListener('resize', () => requestAnimationFrame(resizeChart));

    /* ==== NEW TPS MODULE (self-contained; won’t touch other code) ==== */
    (function initTPS(){
      const canvas = document.getElementById('tpsCanvas');
      const ctx = canvas.getContext('2d');

      const WINDOW = 60; // seconds
      const buckets = new Array(WINDOW).fill(0);
      let cursor = 0;
      let maxSeen = 1;
      let rafQueued = false;

      function size(){
        const r = canvas.getBoundingClientRect();
        canvas.width  = Math.max(1, Math.floor(r.width  * devicePixelRatio));
        canvas.height = Math.max(1, Math.floor(r.height * devicePixelRatio));
        draw();
      }

      function rotate(){
        cursor = (cursor + 1) % WINDOW;
        buckets[cursor] = 0;           // clear the new "now" second
        queueDraw();
      }

      function queueDraw(){
        if (!rafQueued){ rafQueued = true; requestAnimationFrame(()=>{ rafQueued=false; draw(); }); }
      }

      function draw(){
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);

        // subtle baseline
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        ctx.fillRect(0, h-2, w, 2);

        const cell = w / WINDOW;
        const gap = Math.max(1, Math.floor(cell * 0.2));
        const barW = Math.max(1, Math.floor(cell - gap));
        const scale = maxSeen > 0 ? (h - 6) / maxSeen : 1;

        // draw oldest→newest left→right
        for (let i=0;i<WINDOW;i++){
          const idx = (cursor + 1 + i) % WINDOW;
          const val = buckets[idx];
          const barH = Math.max(1, Math.round(val * scale));
          const x = Math.round(i * cell + (cell - barW));
          const y = h - 3 - barH;
          const alpha = Math.min(1, 0.25 + (val / (maxSeen || 1)) * 0.75);
          ctx.fillStyle = `rgba(0,255,179,${alpha})`;
          ctx.fillRect(x, y, barW, barH);
        }
      }

      // public bump (count/sec). To switch to BTC/sec later, pass size.
      window.tpsBump = function(amount){
        const inc = Number.isFinite(amount) ? amount : 1;
        buckets[cursor] += inc;
        if (buckets[cursor] > maxSeen) maxSeen = buckets[cursor];
        queueDraw();
      };

      setInterval(rotate, 1000);
      window.addEventListener('load', size);
      window.addEventListener('orientationchange', () => setTimeout(size, 250));
      window.addEventListener('resize', () => requestAnimationFrame(size));
    })();
  </script>
</body>
</html>
