<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s — mobile (classic + gauge + mirrored tops)</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;               /* theme-adjustable */
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.75); --pill-bd:rgba(255,255,255,.22);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .wrap{padding:14px 14px 120px; max-width:900px; margin:0 auto;}
  .card{background:var(--panel); border-radius:14px; box-shadow:var(--glow); position:relative;}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
        border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd);
        font-size:12px; white-space:nowrap; color:#fff;}
  .headerRow{display:grid; grid-template-columns:auto 1fr; align-items:center; gap:10px;
             padding:12px 12px 6px;}
  .gearBtn{width:34px;height:34px;border-radius:10px;border:1px solid var(--pill-bd);
           display:flex;align-items:center;justify-content:center;background:var(--pill-bg);cursor:pointer}
  .gearSvg{width:18px;height:18px;opacity:.95}
  .bigPrice{justify-self:center; font-weight:900; font-size: clamp(24px,7.6vw,44px);
            letter-spacing:.5px; margin:0}
  .bigPrice.up{color:var(--up)} .bigPrice.down{color:var(--down)}
  .chartBox{padding:0 10px 6px}
  canvas{display:block; width:100%; height:240px; border-radius:12px; background:var(--panel-2)}
  .volBox{height:210px}
  .legend{display:flex; align-items:center; gap:16px; padding:8px 10px 4px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .conn{position:fixed; left:14px; bottom:14px; z-index:30}

  /* gauge */
  .gaugeRow{display:flex; align-items:center; gap:10px; padding:6px 10px 2px; position:relative}
  .gLabel{font-size:12px; opacity:.9; user-select:none}
  .gLabel.buy{color:var(--up)} .gLabel.sell{color:var(--down)}
  #biasGauge{height:24px; border-radius:999px; background:transparent; box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);}
  .needle{position:absolute; top:3px; width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-top:10px solid #fff; filter:drop-shadow(0 2px 2px rgba(0,0,0,.35)); transition:left 0.2s ease;}
  .needleValue{position:absolute; top:-14px; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; font-size:11px; padding:2px 6px; border-radius:10px; border:1px solid rgba(255,255,255,.25);}

  /* mirrored tops */
  #topsCanvas{height:360px; margin-top:10px}

  /* settings sheet */
  .sheet{position:fixed; left:0; right:0; bottom:0; background:#0f0f0f; border-radius:16px 16px 0 0;
         box-shadow:0 -12px 30px rgba(0,0,0,.55); transform:translateY(110%); transition:.25s ease;
         border-top:1px solid rgba(255,255,255,.12); z-index:60}
  .sheet.open{transform:translateY(0)}
  .sheetInner{padding:14px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0}
  .row label{font-size:14px;opacity:.9}
  .row input[type="number"]{width:120px;background:#181818;border:1px solid rgba(255,255,255,.15);
    border-radius:8px;padding:6px 8px;color:#fff;}
  .row select{background:#181818;border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:8px;padding:6px 8px;}
  .sheetClose{display:block;margin:10px auto 0}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="headerRow">
        <button id="gearBtn" class="gearBtn" title="Settings">
          <svg class="gearSvg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
            <path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V20a2 2 0 1 1-4 0v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H4a2 2 0 1 1 0-4h.2a1 1 0 0 0 .9-.6Z"/>
          </svg>
        </button>
        <h1 id="bigPrice" class="bigPrice">$—</h1>
      </div>

      <div class="chartBox">
        <!-- Price (UNCHANGED classic) -->
        <canvas id="priceCanvas"></canvas>

        <!-- Gauge row -->
        <div class="gaugeRow">
          <span class="gLabel buy">Buys</span>
          <div style="position:relative; flex:1">
            <canvas id="biasGauge"></canvas>
            <div id="needle" class="needle" style="left:50%"></div>
            <div id="needleValue" class="needleValue" style="left:50%">0%</div>
          </div>
          <span class="gLabel sell">Sells</span>
        </div>

        <!-- Legend + max pill -->
        <div class="legend" style="margin-top:2px">
          <span class="dot up"></span><span class="muted">Buys</span>
          <span class="dot down"></span><span class="muted">Sells</span>
          <span style="margin-left:auto" class="pill muted" id="maxVolPill">max ₿—</span>
        </div>

        <!-- Volume -->
        <canvas id="volCanvas" class="volBox"></canvas>

        <!-- Mirrored Tops (canvas) -->
        <canvas id="topsCanvas"></canvas>
      </div>
    </section>

    <div class="pill conn" id="connPill">Live</div>
  </main>

  <!-- Settings sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="sheetInner">
      <div class="row">
        <label for="themeSel">Theme</label>
        <select id="themeSel">
          <option value="showgirl">Life of a Showgirl (teal/orange) — default</option>
          <option value="teal">Teal/Amber</option>
          <option value="emerald">Emerald/Orange</option>
          <option value="violet">Violet/Gold</option>
        </select>
      </div>
      <div class="row">
        <label for="scaleInp">Value scale (BTC)</label>
        <input id="scaleInp" type="number" step="0.0001" min="0" value="1.0" />
      </div>
      <div class="row">
        <label for="topNInp">Top list size (rows/side)</label>
        <input id="topNInp" type="number" step="1" min="5" max="40" value="20" />
      </div>
      <button id="closeSheet" class="pill sheetClose">Done</button>
    </div>
  </div>

<script>
/* ===== elements ===== */
const priceEl = document.getElementById('bigPrice');
const priceCanvas = document.getElementById('priceCanvas');
const volCanvas = document.getElementById('volCanvas');
const topsCanvas = document.getElementById('topsCanvas');
const maxVolPill = document.getElementById('maxVolPill');
const connPill = document.getElementById('connPill');
const sheet = document.getElementById('sheet');
const gearBtn = document.getElementById('gearBtn');
const themeSel = document.getElementById('themeSel');
const scaleInp = document.getElementById('scaleInp');
const topNInp = document.getElementById('topNInp');
const closeSheet = document.getElementById('closeSheet');
const biasGauge = document.getElementById('biasGauge');
const needle = document.getElementById('needle');
const needleValue = document.getElementById('needleValue');

/* ===== state ===== */
let lastPrice = null;
let rawLastPrice = null;   // unscaled price for charts
let series = [];           // {t, p}
let volBins = [];          // {ts,buy,sell} x10 fixed
let win10 = [];            // raw trades (last 10 minutes)
const MS10 = 600000;
let VALUE_SCALE = +(localStorage.getItem('h8s_scale')||'1') || 1;
let TOP_N = +(localStorage.getItem('h8s_topN')||'20') || 20;

/* theme handling (Showgirl default if not set) */
const SAVED_THEME = localStorage.getItem('h8s_theme') || 'showgirl';
applyTheme(SAVED_THEME);
themeSel.value = SAVED_THEME;
scaleInp.value = VALUE_SCALE.toString();
topNInp.value = TOP_N.toString();

/* ===== helpers ===== */
function sizeCanvas(c){
  const dpr = Math.min(3, window.devicePixelRatio||1);
  c.width = Math.max(1, c.clientWidth*dpr);
  c.height = Math.max(1, c.clientHeight*dpr);
  c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
  return c.getContext('2d');
}
const fmtUSD = (v,fd=0)=> new Intl.NumberFormat(
  undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v);
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}
function initBins(){
  const now = Date.now();
  const start = now - (now % 60000) - 9*60000;
  volBins = Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
}
initBins();

/* ===== settings ===== */
gearBtn.addEventListener('click', ()=>sheet.classList.add('open'));
closeSheet.addEventListener('click', ()=>sheet.classList.remove('open'));
themeSel.addEventListener('change', e=>{
  applyTheme(e.target.value);
  localStorage.setItem('h8s_theme', e.target.value);
});
scaleInp.addEventListener('change', e=>{
  const v = Math.max(0, +e.target.value || 0);
  VALUE_SCALE = v;
  localStorage.setItem('h8s_scale', String(v));
  if(rawLastPrice!=null){
    const scaled = rawLastPrice * VALUE_SCALE;
    priceEl.textContent = fmtUSD(scaled,2);
  }
});
topNInp.addEventListener('change', e=>{
  TOP_N = Math.min(40, Math.max(5, Math.floor(+e.target.value || 20)));
  localStorage.setItem('h8s_topN', String(TOP_N));
  resizeTopsHeight();
});

/* theme palettes */
function applyTheme(t){
  const r = document.documentElement.style;
  if(t==='emerald'){ r.setProperty('--up','#34d399'); r.setProperty('--down','#fb923c'); }
  else if(t==='violet'){ r.setProperty('--up','#a78bfa'); r.setProperty('--down','#fbbf24'); }
  else if(t==='showgirl'){ r.setProperty('--up','#2dd4bf'); r.setProperty('--down','#f59e0b'); }
  else { r.setProperty('--up','#2dd4bf'); r.setProperty('--down','#f59e0b'); }
}

/* ===== trade intake ===== */
function onTrade({price,size,side,time}){
  const ts = new Date(time).getTime();
  rawLastPrice = price;
  const scaled = price * VALUE_SCALE;

  series.push({t:ts,p:price});
  win10.push({t:ts, price, size, side: (side==='sell'?'sell':'buy')});

  // volume minute bins (scroll left->right)
  const startAligned = ts - (ts % 60000) - 9*60000;
  while(volBins.length && volBins[0].ts < startAligned) volBins.shift();
  while(volBins.length<10){
    const lastTs = volBins.length?volBins[volBins.length-1].ts:startAligned;
    volBins.push({ts:lastTs+60000,buy:0,sell:0});
  }
  const i = Math.min(9,Math.max(0,Math.floor((ts - volBins[0].ts)/60000)));
  if(side==='sell') volBins[i].sell += size; else volBins[i].buy += size;

  // price color only on number
  if(lastPrice!=null){
    priceEl.classList.remove('up','down');
    if(scaled>lastPrice) priceEl.classList.add('up');
    else if(scaled<lastPrice) priceEl.classList.add('down');
  }
  lastPrice = scaled;
  priceEl.textContent = fmtUSD(scaled,2);
}
function prune(){
  const now = Date.now();
  series = series.filter(d=> d.t >= now-MS10);
  win10 = win10.filter(t=> t.t >= now-MS10);
}

/* ===== price chart (LEFT→RIGHT grow until 10m, then roll) — UNCHANGED ===== */
function drawPrice(){
  const ctx = sizeCanvas(priceCanvas);
  const w = priceCanvas.clientWidth, h = priceCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);
  if(series.length<2) return;

  const now = Date.now();
  const firstTs = Math.min(...series.map(d=>d.t));
  const elapsed = now - firstTs;

  const growMode = elapsed < MS10;
  const startT = growMode ? firstTs : (now - MS10);
  const span   = MS10;
  const endT   = growMode ? now : (startT + MS10);

  // collect samples (1s) within [startT, endT] using latest <= t
  const step = 1000, buckets=[];
  for(let t = startT; t <= endT; t += step){
    let last=null;
    for(let i=series.length-1;i>=0;i--){
      const s=series[i];
      if(s.t <= t){ last = s; break; }
    }
    if(last) buckets.push(last);
  }
  if(buckets.length<2) return;

  // stats
  let min=Infinity,max=-Infinity,sum=0;
  for(const b of buckets){ if(b.p<min)min=b.p; if(b.p>max)max=b.p; sum+=b.p; }
  const range=(max-min)||1, avg=sum/buckets.length;

  const padX=14, padY=20;

  // grid
  ctx.strokeStyle='var(--grid)';
  for(let i=1;i<=3;i++){
    const y=padY+(h-2*padY)*(i/4*(4/3));
    ctx.beginPath(); ctx.moveTo(padX,y); ctx.lineTo(w-padX,y); ctx.stroke();
  }

  // average dashed
  const yAvg=padY+(h-2*padY)*(1-(avg-min)/range);
  ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(255,255,255,.35)';
  ctx.beginPath(); ctx.moveTo(padX,yAvg); ctx.lineTo(w-padX,yAvg); ctx.stroke();
  ctx.setLineDash([]);

  // map to pixels (strictly increasing X over fixed 10m)
  const usableW=(w-2*padX), pts=[]; let lastX=-1;
  for(const d of buckets){
    const x=padX+((d.t - startT)/span)*usableW;
    const y=padY+(h-2*padY)*(1-(d.p-min)/range);
    const xi=Math.round(x); if(xi<=lastX) continue; lastX=xi; pts.push({x:xi,y});
  }
  if(pts.length<2) return;

  // Catmull–Rom → Bézier smoothing
  const cr2bz=(p0,p1,p2,p3,t=0.5)=>{
    const d1x=(p2.x-p0.x)*t, d1y=(p2.y-p0.y)*t;
    const d2x=(p3.x-p1.x)*t, d2y=(p3.y-p1.y)*t;
    return [{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}];
  };
  const up=getComputedStyle(document.body).getPropertyValue('--up').trim();
  ctx.strokeStyle=up; ctx.lineWidth=2.25; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i-1]||pts[i], p1=pts[i], p2=pts[i+1], p3=pts[i+2]||p2;
    const [c1,c2]=cr2bz(p0,p1,p2,p3,.5);
    ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);
  }
  ctx.stroke();

  // labels (max/avg/min)
  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  ctx.fillText(fmtUSD(max,0), padX, padY+4);
  ctx.fillText(fmtUSD(avg,0), padX, Math.max(padY+12, Math.min(h-padY-12, yAvg)));
  ctx.fillText(fmtUSD(min,0), padX, h-padY-4);

  // last price pill (raw)
  const last=pts[pts.length-1];
  const label=fmtUSD(rawLastPrice||0,0);
  const tw=ctx.measureText(label).width+18, th=22;
  const bx=Math.min(w-tw-8, Math.max(8, last.x - tw/2)), by=Math.max(8, last.y - th - 8);
  ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.25)';
  roundRect(ctx,bx,by,tw,th,10,true,true);
  ctx.fillStyle='#fff'; ctx.textBaseline='middle'; ctx.fillText(label, bx+9, by+th/2);
}

/* ===== volume (stacked) + max pill ===== */
function drawVol(){
  const ctx = sizeCanvas(volCanvas);
  const w = volCanvas.clientWidth, h = volCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  const max = Math.max(0.01, ...volBins.map(b=>b.buy+b.sell));
  maxVolPill.textContent = `max ₿${max.toFixed(2)}`;

  const padX=16, padTop=14, padBottom=26;
  const chartH = h - padTop - padBottom;
  const step = (w - padX*2) / volBins.length;
  const barW = step*0.62;

  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();

  // faint grid
  ctx.strokeStyle='var(--grid-2)';
  for(let i=1;i<=2;i++){ const y=padTop+chartH*(i/3*(3/2)); ctx.beginPath(); ctx.moveTo(padX-6,y); ctx.lineTo(w-padX+6,y); ctx.stroke(); }

  // bottom time labels (every other minute)
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='top';
  for(let i=0;i<volBins.length;i+=2){
    const xC=padX+i*step+step/2;
    const t=new Date(volBins[i].ts).toLocaleTimeString([],{minute:'2-digit'});
    ctx.fillText(':'+t, xC-8, h-18);
  }

  for(let i=0;i<volBins.length;i++){
    const b=volBins[i]; const xC=padX+i*step+step/2; const tot=b.buy+b.sell;
    const hT=Math.max(4,(tot/max)*chartH);
    const hBuy=tot?(b.buy/tot)*hT:0, hSell=hT-hBuy;
    const yB=padTop+chartH;

    ctx.fillStyle=dn; ctx.fillRect(xC-barW/2, yB-hSell, barW, hSell);
    ctx.fillStyle=up; ctx.fillRect(xC-barW/2, yB-hSell-hBuy, barW, hBuy);
  }
}

/* ===== bias gauge (eased needle + value pill) ===== */
let needlePos = 0.5;  // 0..1
function drawGauge(){
  const ctx = sizeCanvas(biasGauge);
  const w = biasGauge.clientWidth, h = biasGauge.clientHeight;
  ctx.clearRect(0,0,w,h);

  // totals for last 10m
  let buy=0, sell=0;
  for(const b of volBins){ buy+=b.buy; sell+=b.sell; }
  const tot=buy+sell;
  const target = tot ? (buy/tot) : 0.5;

  // ease toward target
  needlePos += (target - needlePos) * 0.25;

  // base bar gradient from sells→buys with split at needlePos
  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();
  const g = ctx.createLinearGradient(0,0,w,0);
  const split=needlePos;
  g.addColorStop(0, dn);
  g.addColorStop(Math.max(0, split-0.001), dn);
  g.addColorStop(Math.min(1, split+0.001), up);
  g.addColorStop(1, up);

  const r=h/2;
  ctx.fillStyle=g;
  roundRect(ctx,1,1,w-2,h-2,r-1,true,false);

  // mild dominance overlay
  ctx.globalAlpha=.18;
  ctx.fillStyle=(needlePos>=0.5)?up:dn;
  const domW=(needlePos>=0.5)?(w*needlePos):(w*(1-needlePos));
  const domX=(needlePos>=0.5)?0:(w*needlePos);
  roundRect(ctx,domX,1,domW,h-2,r-1,true,false);
  ctx.globalAlpha=1;

  // place needle + value pill
  const leftPx = Math.round(biasGauge.getBoundingClientRect().width * needlePos);
  needle.style.left = `${leftPx}px`;
  const biasPct = tot ? ((buy - sell)/tot)*100 : 0;
  needleValue.textContent = `${biasPct>=0?'+':''}${biasPct.toFixed(0)}%`;
  needleValue.style.left = `${leftPx}px`;
}

/* ===== mirrored tops: pole bars from outside → center (translucent text backgrounds) ===== */
function resizeTopsHeight(){
  const rows = Math.max(
    Math.min(TOP_N, win10.filter(t=>t.side==='buy').length),
    Math.min(TOP_N, win10.filter(t=>t.side==='sell').length)
  );
  const padY=14, gap=6, rowH=24;
  const px = padY*2 + Math.max(1, rows)*(rowH+gap);
  topsCanvas.style.height = Math.max(140, px) + 'px';
}
function drawTops(){
  resizeTopsHeight();
  const ctx = sizeCanvas(topsCanvas);
  const w = topsCanvas.clientWidth, h = topsCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  const items = win10.map(t=>({...t, usd: t.price*t.size }));
  const buys = items.filter(i=>i.side==='buy').sort((a,b)=>b.usd-a.usd).slice(0,TOP_N);
  const sells= items.filter(i=>i.side==='sell').sort((a,b)=>b.usd-a.usd).slice(0,TOP_N);

  const rows = Math.max(buys.length, sells.length);
  const padX = 10, padY = 14, gap = 6, rowH = 24, midX = Math.floor(w/2);

  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();

  // center divider
  ctx.strokeStyle='rgba(255,255,255,.18)';
  ctx.beginPath(); ctx.moveTo(midX+.5, padY-8); ctx.lineTo(midX+.5, h-padY+8); ctx.stroke();

  const maxUSD = Math.max(1, ...buys.map(b=>b.usd), ...sells.map(s=>s.usd));
  const leftMaxW  = midX - padX - 10;
  const rightMaxW = w - midX - padX - 10;

  ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  ctx.textBaseline = 'middle';

  for(let i=0;i<rows;i++){
    const y = padY + i*(rowH+gap) + rowH/2;

    // SELL (left → center)
    const s = sells[i];
    if(s){
      const frac = Math.min(1, s.usd / maxUSD);
      const barW = Math.max(4, frac * leftMaxW);
      const x0 = midX - barW;
      ctx.fillStyle = dn;
      roundRect(ctx, x0, y-rowH/2, barW, rowH, 6, true, false);

      // translucent overlay for text background
      const labelW = Math.min(barW, 160);
      ctx.fillStyle = 'rgba(0,0,0,.5)';
      ctx.fillRect(midX - labelW, y-rowH/2, labelW, rowH);

      // text
      ctx.fillStyle = '#fff';
      const txt = `${fmtUSD(s.usd,0)}  (${s.size.toFixed(2)} BTC)`;
      ctx.textAlign = 'right';
      ctx.fillText(txt, midX - 8, y);
    }

    // BUY (right → center)
    const b = buys[i];
    if(b){
      const frac = Math.min(1, b.usd / maxUSD);
      const barW = Math.max(4, frac * rightMaxW);
      const x0 = midX;
      ctx.fillStyle = up;
      roundRect(ctx, x0, y-rowH/2, barW, rowH, 6, true, false);

      // translucent overlay behind text
      const labelW = Math.min(barW, 160);
      ctx.fillStyle = 'rgba(0,0,0,.5)';
      ctx.fillRect(midX, y-rowH/2, labelW, rowH);

      // text
      ctx.fillStyle = '#fff';
      const txt = `${fmtUSD(b.usd,0)}  (${b.size.toFixed(2)} BTC)`;
      ctx.textAlign = 'left';
      ctx.fillText(txt, midX + 8, y);
    }
  }
}

/* ===== loop ===== */
function frame(){ prune(); drawPrice(); drawVol(); drawGauge(); drawTops(); requestAnimationFrame(frame); }

/* ===== feed ===== */
let ws, recon;
function startWS(){
  try{ ws && ws.close(); }catch{}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  ws.onopen = ()=>{
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
    connPill.textContent='Live';
  };
  ws.onmessage = (e)=>{
    try{
      const m = JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        onTrade({price:+m.price,size:+m.size,side:m.side,time:m.time});
      }
    }catch{}
  };
  ws.onclose = ()=>{ connPill.textContent='Reconnecting…'; recon=setTimeout(startWS,1000); };
  ws.onerror = ()=>{ try{ws.close()}catch{} };
}
startWS();

/* ===== layout ===== */
new ResizeObserver(()=>{ drawPrice(); drawVol(); drawGauge(); drawTops(); }).observe(document.body);
requestAnimationFrame(frame);
</script>
</body>
</html>