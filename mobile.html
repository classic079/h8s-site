<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s.us — Mobile</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --ink:#eafaf3; --muted:#c5d3cc;
    --up:#2dd4bf; --down:#f59e0b; --glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .page{max-width:780px;margin:0 auto;padding:12px}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px var(--glass);padding:14px;margin:10px 0}

  .priceWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .livePrice{font-size:clamp(28px,9vw,48px);font-weight:900;line-height:1}
  .livePrice.up{color:var(--up)} .livePrice.down{color:var(--down)}

  .sectionTitle{display:flex;align-items:baseline;gap:10px;margin:6px 2px 10px;font-weight:800;
    font-size:clamp(18px,5.5vw,28px)}
  .rightHint{margin-left:auto;font-size:12px;opacity:.7}

  .chartBox{padding:8px;border-radius:12px;background:#0f0f0f}
  canvas{display:block;width:100%;height:auto}

  .legend{display:flex;gap:12px;align-items:center;margin:4px 2px 8px}
  .dot{width:14px;height:14px;border-radius:3px;display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .maxLbl{margin-left:auto;opacity:.85;font-weight:700}

  .badge{
    position:absolute;transform:translate(-50%,-50%);
    padding:1px 6px;border-radius:999px;font-size:11px;font-weight:800;
    background:rgba(0,0,0,.85);color:var(--ink);white-space:nowrap;pointer-events:none
  }
  .badge.diffUP{outline:2px solid color-mix(in oklab, var(--up) 65%, transparent)}
  .badge.diffDN{outline:2px solid color-mix(in oklab, var(--down) 65%, transparent)}
  .badge.total{outline:1px solid rgba(255,255,255,.25)}
  .livePill{position:fixed;left:12px;bottom:12px;padding:6px 10px;border-radius:10px;
    background:#15201c;color:var(--up);border:1px solid rgba(45,212,191,.25);font-weight:700}
</style>
</head>
<body>
  <div class="page">

    <!-- Live price only -->
    <div class="card">
      <div class="priceWrap">
        <div id="livePrice" class="livePrice">$—</div>
      </div>
    </div>

    <!-- Dynamic price: 1h window shrinks & slides to 10m -->
    <div class="card">
      <div class="sectionTitle">
        <span>Dynamic price (1h → live)</span>
        <span id="winHint" class="rightHint">window 60m</span>
      </div>
      <div class="chartBox">
        <canvas id="dynCanvas" width="800" height="360"></canvas>
      </div>
    </div>

    <!-- Per-minute volume -->
    <div class="card">
      <div class="sectionTitle">
        <span>Per-minute volume (10m, ₿)</span>
      </div>
      <div class="legend">
        <span class="dot up"></span><span>Buys</span>
        <span class="dot down"></span><span>Sells</span>
        <span class="maxLbl" id="volMax">max —</span>
      </div>
      <div class="chartBox" style="position:relative">
        <canvas id="volCanvas" width="800" height="240"></canvas>
        <div id="volBadges" style="position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none"></div>
      </div>
    </div>

  </div>

  <span id="conn" class="livePill">Connecting…</span>

<script>
/* ---------- Helpers ---------- */
const $=s=>document.querySelector(s);
const fmtUSD  = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0 = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtBTC2 = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

const COLOR_UP   = getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
const COLOR_DOWN = getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

const livePriceEl=$('#livePrice'), connEl=$('#conn'), winHintEl=$('#winHint');

const dynC=$('#dynCanvas'), dctx=dynC.getContext('2d',{desynchronized:true});
const volC=$('#volCanvas'), vctx=volC.getContext('2d',{desynchronized:true});
const volBadges=$('#volBadges'), volMaxEl=$('#volMax');

function fitCanvas(c,ctx){const dpr=Math.max(1,Math.min(devicePixelRatio||1,2.5)); c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);}
new ResizeObserver(()=>{fitCanvas(dynC,dctx);fitCanvas(volC,vctx);drawDyn();drawVol();}).observe(document.body);

/* ---------- State ---------- */
let ws, lastPrice=null, lastWs=0;
let series1h=[];     // preload 1h candles {t,p}
let seriesLive=[];   // live trades downsampled to line {t,p}
let firstLiveMS=null;

let win10=[];       // recent trades for volume {time,size,side,price}

const MS10=600000, MS60=3600000;
const TRANSITION_MS=30000; // 30s “melt to side”
const DIFF_MIN_BTC=0.15;

/* ---------- Networking ---------- */
function setConn(txt,color){connEl.textContent=txt; if(color) connEl.style.color=color;}
function startWS(){
  try{ws&&ws.close()}catch{}
  ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('Connecting…','#fbbf24');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{
    lastWs=Date.now();
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match'&&m.product_id==='BTC-USD'){
        ingestTrade(+new Date(m.time), +m.price, +m.size, String(m.side||'buy'));
      }
    }catch{}
  };
  ws.onclose=()=>setTimeout(startWS,900);
  ws.onerror =()=>setConn('Fallback','#fb7185');
}
async function preload1h(){
  try{
    const end=Date.now(), start=end-MS60;
    const u=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=60&start=${new Date(start).toISOString()}&end=${new Date(end).toISOString()}`;
    const r=await fetch(u,{headers:{Accept:'application/json'}});
    const js=await r.json();
    series1h = js.sort((a,b)=>a[0]-b[0]).map(c=>({t:c[0]*1000,p:+c[4]}));
    drawDyn();
  }catch{}
}

/* ---------- Ingest ---------- */
function ingestTrade(t,p,sz,side){
  if(lastPrice!==null){livePriceEl.classList.remove('up','down'); if(p>lastPrice)livePriceEl.classList.add('up'); else if(p<lastPrice)livePriceEl.classList.add('down');}
  lastPrice=p; livePriceEl.textContent=fmtUSD.format(p); setConn('Live',COLOR_UP);

  // push to live series (light downsample to keep smooth)
  seriesLive.push({t,p});
  const cut=Date.now()-MS10; while(seriesLive.length && seriesLive[0].t<cut) seriesLive.shift();
  if(firstLiveMS==null) firstLiveMS=t;

  // volume window
  win10.push({time:t,size:sz,side,price:p}); while(win10.length && win10[0].time<cut) win10.shift();

  drawDyn(); drawVol();
}

/* ---------- Utilities ---------- */
function resetStroke(ctx){ ctx.setLineDash([]); ctx.globalAlpha=1; ctx.lineWidth=2; }
function windowSeries(start,end,arr){ return arr.filter(s=>s.t>=start && s.t<=end); }
function extents(arr){ let lo=Infinity,hi=-Infinity,sum=0,n=0; for(const s of arr){if(Number.isFinite(s.p)){if(s.p<lo)lo=s.p;if(s.p>hi)hi=s.p;sum+=s.p;n++;}} return n?{lo,hi,avg:sum/n}:null; }
function yFor(p,lo,hi,h,pt,pb){const R=(hi-lo)||1; return pt+(h-pt-pb)*(1-(p-lo)/R);}

/* ---------- Dynamic price (side-melt) ---------- */
function drawLine(ctx,pts,lo,hi,w,h,pl,pr,pt,pb,color,alpha){
  if(!pts || pts.length<2) return;
  resetStroke(ctx);
  ctx.globalAlpha=alpha; ctx.strokeStyle=color; ctx.beginPath();
  const t0=pts[0].t, t1=pts.at(-1).t, span=(t1-t0)||1, x0=pl, x1=w-pr;
  for(let i=0;i<pts.length;i++){
    const s=pts[i];
    const x=x0+((s.t-t0)/span)*(x1-x0);
    const y=yFor(s.p,lo,hi,h,pt,pb);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke(); resetStroke(ctx);
}

function drawDyn(){
  fitCanvas(dynC,dctx);
  const w=dynC.clientWidth, h=dynC.clientHeight;
  dctx.clearRect(0,0,w,h);
  dctx.fillStyle='#101010'; dctx.fillRect(0,0,w,h);

  // layout
  const padL=58, padR=16, padT=20, padB=44;

  // Compute shrinking time window (60m → 10m) sliding to now
  const now=Date.now();
  let f=0; if(firstLiveMS!=null) f=Math.max(0,Math.min(1,(now-firstLiveMS)/TRANSITION_MS));
  const spanMs = MS60 - (MS60-MS10)*f;          // from 60m to 10m
  const start  = now - spanMs;                  // window end stays at now
  const end    = now;

  winHintEl.textContent = `window ${Math.round(spanMs/60000)}m`;

  // Data inside the window (use both sources)
  const base = windowSeries(start,end, series1h).concat(windowSeries(start,end, seriesLive));
  if(base.length<2) return;

  // extents based on the current window (so labels are “right”)
  const ex = extents(base); if(!ex) return;

  // grid
  resetStroke(dctx);
  dctx.strokeStyle='rgba(255,255,255,.06)'; dctx.lineWidth=1;
  for(let i=1;i<=3;i++){
    const gy=padT + (h-padT-padB)*(i/4*(4/3));
    dctx.beginPath(); dctx.moveTo(padL-6,gy); dctx.lineTo(w-padR+6,gy); dctx.stroke();
  }

  // price labels (hi/avg/lo)
  dctx.fillStyle='rgba(255,255,255,.85)'; dctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; dctx.textBaseline='middle';
  const yHi=yFor(ex.hi,ex.lo,ex.hi,h,padT,padB), yLo=yFor(ex.lo,ex.lo,ex.hi,h,padT,padB), yAvg=yFor(ex.avg,ex.lo,ex.hi,h,padT,padB);
  dctx.fillText(fmtUSD0.format(ex.hi), 6, Math.max(padT+8,yHi));
  dctx.fillText(fmtUSD0.format(ex.avg), 6, Math.max(padT+14,Math.min(h-padB-14,yAvg)));
  dctx.fillText(fmtUSD0.format(ex.lo), 6, Math.min(h-padB-8,yLo));
  dctx.save(); dctx.setLineDash([6,6]); dctx.strokeStyle='rgba(200,214,207,.6)';
  dctx.beginPath(); dctx.moveTo(padL,yAvg); dctx.lineTo(w-padR,yAvg); dctx.stroke(); dctx.restore();

  // Draw 1h portion remaining in window (if any) in light grey
  const win1h = windowSeries(start,end, series1h);
  if(win1h.length>=2) drawLine(dctx, win1h, ex.lo,ex.hi, w,h, padL,padR,padT,padB, 'rgba(255,255,255,.45)', 1);

  // Draw live portion (full strength)
  const live = windowSeries(start,end, seriesLive);
  if(live.length>=2) drawLine(dctx, live, ex.lo,ex.hi, w,h, padL,padR,padT,padB, COLOR_UP, 1);

  // X labels — minutes across current window, step every 2 mins
  dctx.fillStyle='rgba(255,255,255,.78)'; dctx.textAlign='center'; dctx.textBaseline='top';
  const step=120000, x0=padL, x1=w-padR, span= end-start;
  const tFirst = start + (step - (start%step)); // align ticks
  for(let t=tFirst; t<=end; t+=step){
    const x=x0 + ((t-start)/span)*(x1-x0);
    dctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}), x, h-padB+8);
  }
}

/* ---------- Volume (unchanged logic, fixed headroom) ---------- */
function fixedBins10(){
  const end=Date.now(), start=end-MS10;
  const bins=Array.from({length:10},(_,i)=>({ts:start+i*60000, buy:0, sell:0}));
  for(const t of win10){
    if(t.time<start||t.time>=end) continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/60000)));
    if(t.side==='sell') bins[idx].sell+=t.size; else bins[idx].buy+=t.size;
  }
  return bins;
}
function drawVol(){
  fitCanvas(volC,vctx);
  const w=volC.clientWidth, h=volC.clientHeight;
  vctx.clearRect(0,0,w,h);
  vctx.fillStyle='#101010'; vctx.fillRect(0,0,w,h);

  const bins=fixedBins10();
  const totals=bins.map(b=>b.buy+b.sell);
  let max=Math.max(0.01,...totals)*1.18; // headroom so labels never clip
  volMaxEl.textContent='max ₿'+fmtBTC2.format(Math.max(...totals));

  const padL=36, padR=16, padT=6, padB=28, chartH=h-padT-padB, step=(w-padL-padR)/bins.length, barW=step*0.72;

  // grid
  resetStroke(vctx);
  vctx.strokeStyle='rgba(255,255,255,.06)'; vctx.lineWidth=1;
  for(let i=1;i<=3;i++){
    const gy=padT+chartH*(i/4*(4/3));
    vctx.beginPath(); vctx.moveTo(padL-6,gy); vctx.lineTo(w-padR+6,gy); vctx.stroke();
  }

  volBadges.innerHTML='';

  for(let i=0;i<bins.length;i++){
    const b=bins[i], total=b.buy+b.sell, xC=padL+i*step+step/2;
    const hT=Math.max(3,(total/max)*chartH), hBuy=total?(b.buy/total)*hT:0, yBase=padT+chartH;

    // stacked bars
    vctx.fillStyle=COLOR_DOWN; vctx.fillRect(xC-barW/2, yBase-(hT-hBuy), barW, (hT-hBuy));
    vctx.fillStyle=COLOR_UP;   vctx.fillRect(xC-barW/2, yBase-hT,       barW, hBuy);

    // x labels every 2 minutes
    if(i%2===0){
      vctx.fillStyle='rgba(255,255,255,.78)'; vctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
      vctx.textAlign='center'; vctx.textBaseline='top';
      vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}), xC, yBase+6);
    }

    // badges
    if(total>0){
      if(hT>18){
        const sp=document.createElement('span'); sp.className='badge total';
        sp.textContent='₿'+fmtBTC2.format(total);
        sp.style.left=`${xC}px`; sp.style.top=`${yBase-hT/2}px`; volBadges.appendChild(sp);
      }
      const diff=b.buy-b.sell;
      if(Math.abs(diff)>=DIFF_MIN_BTC){
        const sp=document.createElement('span'); sp.className='badge '+(diff>=0?'diffUP':'diffDN');
        sp.textContent=(diff>=0?'+':'')+fmtBTC2.format(diff);
        const by=yBase - (diff>=0 ? hT - hBuy/2 : (hT - (hT-hBuy)/2));
        sp.style.left=`${xC}px`; sp.style.top=`${by}px`; volBadges.appendChild(sp);
      }
    }
  }
}

/* ---------- Loop / Boot ---------- */
function tick(){ drawDyn(); drawVol(); requestAnimationFrame(tick); }

fitCanvas(dynC,dctx); fitCanvas(volC,vctx);
(async()=>{ await preload1h(); startWS(); tick(); })();
</script>
</body>
</html>