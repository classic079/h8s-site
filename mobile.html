<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Coinbase Stalker — Mobile</title>
<meta name="theme-color" content="#0a0a0a" />
<link rel="canonical" href="./index.html">
<style>
  :root{
    --bg:#0a0a0a; --panel:#101010; --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b; --glow: rgba(45,212,191,.22);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

  .wrap{min-height:100vh;display:flex;flex-direction:column;padding:10px;gap:10px}

  .topbar{display:flex;flex-direction:column;align-items:center;gap:8px}
  .price{font-size:clamp(24px,8vw,40px);font-weight:800}
  .price.up{color:var(--up)} .price.down{color:var(--down)}
  .pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .pill{border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:4px 9px;font-size:12px;white-space:nowrap}
  .pill.up{color:var(--up)} .pill.down{color:var(--down)} .pill.flat{color:var(--muted)}

  .card{background:var(--panel);border-radius:12px;box-shadow:0 0 0 1px rgba(255,255,255,.06),0 8px 24px rgba(0,0,0,.35)}

  .chartBox{padding:10px}
  .chartTitle{font-weight:700;margin:0 0 8px 2px}
  #chartCanvas{display:block;width:100%;height:180px;border-radius:10px}

  .volBox{padding:10px}
  .volTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:700}
  .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  #volCanvas{display:block;width:100%;height:140px;border-radius:10px}

  /* Ticker (no time column on mobile) */
  .ticker{display:flex;flex-direction:column;min-height:0}
  .tickerHead{position:sticky;top:0;background:linear-gradient(180deg,rgba(16,16,16,1),rgba(16,16,16,.6));padding:10px;border-bottom:1px solid rgba(255,255,255,.08);border-radius:12px 12px 0 0}
  .gridHead{display:grid;grid-template-columns:1fr 100px;gap:8px;font-size:12px;opacity:.75;text-transform:uppercase;letter-spacing:.4px}
  .tickerBody{padding:6px 10px 10px}
  .row{display:grid;grid-template-columns:1fr 100px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.06);font-variant-numeric:tabular-nums}
  .row:last-child{border-bottom:none}
  .row.buy{color:var(--up)} .row.sell{color:var(--down)}

  .footerLinks{display:flex;justify-content:center;gap:10px;opacity:.85}
  .linkBtn{appearance:none;border:1px solid rgba(255,255,255,.14);background:transparent;border-radius:999px;padding:8px 12px;color:var(--text);font-size:12px;text-decoration:none}

  /* small helpers */
  #connPill{position:fixed;left:10px;bottom:10px;z-index:50;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px;font-size:11px}
  .conn-ok{color:var(--up)} .conn-warn{color:#fbbf24} .conn-err{color:#fb7185}
</style>
</head>
<body>
<span id="connPill" class="conn-warn">Connecting…</span>

<div class="wrap">
  <!-- Top live -->
  <section class="topbar">
    <div id="livePrice" class="price">$—</div>
    <div class="pills">
      <span id="pill10m" class="pill flat">10m Δ —</span>
      <span id="pill24h" class="pill">24h Δ —</span>
      <span id="pill24v" class="pill">24h Vol —</span>
    </div>
  </section>

  <!-- 10m price chart -->
  <section class="card chartBox">
    <h3 class="chartTitle">Last 10 minutes — Price</h3>
    <canvas id="chartCanvas"></canvas>
  </section>

  <!-- Per-minute volume (10m, BTC) -->
  <section class="card volBox">
    <div class="volTitle">
      <span>Per-minute volume (10m, ₿)</span>
      <span><span class="dot up"></span>Buys <span style="display:inline-block;width:8px"></span><span class="dot down"></span>Sells</span>
    </div>
    <canvas id="volCanvas"></canvas>
  </section>

  <!-- Ticker (no time column) -->
  <section class="card ticker">
    <div class="tickerHead">
      <div class="gridHead">
        <div>Price</div>
        <div id="amountHeader" style="text-align:right;cursor:pointer;">Amount (USD)</div>
      </div>
    </div>
    <div id="tickerBody" class="tickerBody"></div>
  </section>

  <div class="footerLinks">
    <button class="linkBtn" id="forceDesktopBtn" title="Always open desktop here">View Desktop</button>
    <a class="linkBtn" href="./index.html?desktop=1" title="Skip mobile just once">Open Desktop (once)</a>
  </div>
</div>

<script>
/* ===== Shorthands ===== */
const $=s=>document.querySelector(s);
const priceEl=$('#livePrice'), pill10m=$('#pill10m'), pill24h=$('#pill24h'), pill24v=$('#pill24v');
const amountHeader=$('#amountHeader'), bodyEl=$('#tickerBody'), connPill=$('#connPill');

const chart=$('#chartCanvas'), ctx=chart.getContext('2d',{desynchronized:true});
const vol=$('#volCanvas'), vctx=vol.getContext('2d',{desynchronized:true});

const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtUSDchg=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2,signDisplay:'always'});
const fmtBTC2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
const pct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const pct2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

/* ===== State ===== */
let trades=[], win10=[], lastPrice=null, showUSD=true, series=[];
const MS10=600000;

/* ===== View/Desktop override ===== */
$('#forceDesktopBtn').addEventListener('click',()=>{
  localStorage.setItem('preferDesktop','1');
  location.href='index.html?desktop=1';
});

/* ===== Canvas sizing ===== */
function sizeCanvas(c, ctx){
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,3));
  c.width=Math.max(1,c.clientWidth*dpr);
  c.height=Math.max(1,c.clientHeight*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function resizeAll(){ sizeCanvas(chart,ctx); drawChart(); sizeCanvas(vol,vctx); drawVol(); renderTicker(); }
new ResizeObserver(resizeAll).observe(document.body);

/* ===== Connection ===== */
let ws,recon,lastWs=0,lastRest=0;
function setConn(state,msg){connPill.classList.remove('conn-ok','conn-warn','conn-err');connPill.classList.add(state==='ok'?'conn-ok':state==='warn'?'conn-warn':'conn-err');connPill.textContent=msg;}
function startWS(){clearTimeout(recon);try{ws&&ws.close()}catch{}ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('conn-warn','Connecting…');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{lastWs=Date.now();setConn('conn-ok','Live');try{const m=JSON.parse(e.data);if(m.type==='match'&&m.product_id==='BTC-USD'){onTrade({price:+m.price,size:+m.size,side:String(m.side||'').toLowerCase(),time:new Date(m.time)})}}catch{}};
  ws.onclose=()=>{setConn('conn-warn','Reconnecting…');recon=setTimeout(startWS,1000)}; ws.onerror=()=>{setConn('conn-err','Fallback');try{ws.close()}catch{}};}
async function restFallback(){const QUIET=3500,now=Date.now();try{
  if(now-lastWs>=QUIET){const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/trades?limit=20',{headers:{Accept:'application/json'}});if(r.ok){const arr=await r.json();for(let i=arr.length-1;i>=0;i--){const t=arr[i];onTrade({price:+t.price,size:+t.size,side:String(t.side||'').toLowerCase(),time:new Date(t.time||now)})}lastRest=now;setConn('conn-err','Fallback');return;}}
  if(now-Math.max(lastWs,lastRest)>=QUIET){const r2=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/ticker',{headers:{Accept:'application/json'}});if(r2.ok){const t=await r2.json();onTrade({price:+t.price,size:+(t.size||0.001),side:'buy',time:new Date(t.time||now)});lastRest=now;setConn('conn-err','Fallback');}}
}catch{setConn('conn-err','Fallback');}}
setInterval(restFallback,1200);

/* ===== Ticker sizing & cap ===== */
let MAX_ROWS=28, ROW_H=22;
function measureRow(){ const tmp=document.createElement('div'); tmp.className='row'; tmp.style.visibility='hidden'; tmp.innerHTML=`<div>$0</div><div>$0</div>`; bodyEl.appendChild(tmp); ROW_H=Math.max(18,tmp.getBoundingClientRect().height||ROW_H); tmp.remove(); }
function recalcRows(){ const H = bodyEl.parentElement.clientHeight; MAX_ROWS = Math.max(10, Math.floor((H-16)/ROW_H)); }
function cap(){ const HARD=MAX_ROWS+4; while(trades.length>HARD) trades.shift(); }

/* ===== Trade ingestion ===== */
function onTrade(t){
  const p=t.price, s=t.size, side=t.side==='sell'?'sell':'buy', time=t.time;
  const prev=trades.length?trades[trades.length-1].price:lastPrice, arrow=(prev!=null)?(p>prev?'▲':p<prev?'▼':'•'):'';
  if(lastPrice!==null){priceEl.classList.remove('up','down'); if(p>lastPrice)priceEl.classList.add('up'); else if(p<lastPrice)priceEl.classList.add('down');}
  lastPrice=p; priceEl.textContent=fmtUSD.format(p);

  trades.push({price:p,size:s,side,time,arrow}); cap();
  series.push({t:Date.now(),p});
  win10.push({price:p,size:s,side,time:time.getTime()});
  prune(); renderTicker();
}
function prune(){ const now=Date.now(); win10=win10.filter(t=>t.time>=now-MS10); while(series.length && series[0].t<now-MS10) series.shift(); }

/* ===== Ticker (no time column) ===== */
function renderTicker(){
  const frag=document.createDocumentFragment();
  const start=Math.max(0,trades.length-MAX_ROWS);
  for(let i=trades.length-1;i>=start;i--){
    const t=trades[i];
    const row=document.createElement('div');
    row.className=`row ${t.side}`;
    const amt=showUSD ? fmtUSD.format(t.price*t.size) : `${fmtBTC2.format(t.size)} BTC`;
    row.innerHTML=`<div>${fmtUSD.format(t.price)} <span style="opacity:.65">${t.arrow}</span></div>
                   <div style="text-align:right;white-space:nowrap">${amt}</div>`;
    frag.appendChild(row);
  }
  bodyEl.innerHTML=''; bodyEl.appendChild(frag);
}
amountHeader.addEventListener('click',()=>{ showUSD=!showUSD; amountHeader.textContent=showUSD?'Amount (USD)':'Amount (BTC)'; renderTicker(); });

/* ===== Stats pills ===== */
function renderPills(){
  // 10m Δ
  const first=series[0]?.p, last=series.at(-1)?.p;
  if(first && last){
    const diff=last-first, pct=first?diff/first*100:0;
    pill10m.textContent=`10m Δ ${fmtUSDchg.format(diff)} (${pct2.format(pct)}%)`;
    pill10m.classList.remove('up','down','flat');
    pill10m.classList.add(diff>0?'up':diff<0?'down':'flat');
  } else { pill10m.textContent='10m Δ —'; pill10m.classList.add('flat'); }

  // 24h stats (change + volume)
  // (No day H/L on mobile per your request)
}
async function fetch24h(){
  try{
    const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats',{headers:{Accept:'application/json'}});
    if(!r.ok) throw 0; const j=await r.json();
    const open=+j.open,last=+j.last,vol=+j.volume;
    if(Number.isFinite(open)&&Number.isFinite(last)){
      const diff=last-open,pct=open?(diff/open*100):0;
      pill24h.textContent=`24h Δ ${fmtUSDchg.format(diff)} (${pct2.format(pct)}%)`;
      pill24h.classList.remove('up','down','flat'); pill24h.classList.add(diff>0?'up':diff<0?'down':'flat');
    } else {
      pill24h.textContent='24h Δ —'; pill24h.classList.add('flat');
    }
    pill24v.textContent = Number.isFinite(vol) ? `24h Vol ${vol.toLocaleString()}` : '24h Vol —';
  }catch{
    pill24h.textContent='24h Δ —'; pill24h.classList.add('flat');
    pill24v.textContent='24h Vol —';
  }
}

/* ===== 10m chart ===== */
function drawChart(){
  const c=chart, w=c.clientWidth, h=c.clientHeight, pad=12, xPad=28;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();
  ctx.clearRect(0,0,w,h); ctx.fillStyle='#101010'; ctx.fillRect(0,0,w,h);
  if(series.length<2) return;
  let min=Infinity,max=-Infinity,sum=0;
  for(const s of series){const p=s.p;if(!isFinite(p))continue; if(p<min)min=p; if(p>max)max=p; sum+=p;}
  if(!isFinite(min)||!isFinite(max)) return;
  const range=(max-min)||1,avg=sum/series.length;

  ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.lineWidth=1;
  for(let i=1;i<5;i++){const gy=pad+(h-2*pad)/5*i; ctx.beginPath(); ctx.moveTo(pad+xPad,gy); ctx.lineTo(w-pad,gy); ctx.stroke();}
  ctx.fillStyle='rgba(255,255,255,.78)'; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  const lab=v=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v);
  const yAvg=pad+(h-2*pad)-((avg-min)/range)*(h-2*pad);
  ctx.fillText(lab(max),pad+4,pad+8); ctx.fillText(lab(avg),pad+4,Math.max(pad+12,Math.min(h-pad-12,yAvg))); ctx.fillText(lab(min),pad+4,h-pad-8);
  ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,.6)'; ctx.beginPath(); ctx.moveTo(pad+xPad,yAvg); ctx.lineTo(w-pad,yAvg); ctx.stroke(); ctx.restore();

  const MAX_JUMP=avg*0.08; ctx.lineWidth=2;
  for(let i=1;i<series.length;i++){
    const p0=series[i-1].p,p1=series[i].p;
    if(!isFinite(p0)||!isFinite(p1)) continue;
    if(Math.abs(p1-p0)>MAX_JUMP) continue;
    const x0=pad+xPad+((i-1)/(series.length-1))*(w-2*pad-xPad);
    const x1=pad+xPad+((i)/(series.length-1))*(w-2*pad-xPad);
    const y0=pad+(h-2*pad)-((p0-min)/range)*(h-2*pad), y1=pad+(h-2*pad)-((p1-min)/range)*(h-2*pad);
    ctx.strokeStyle=(p1>=avg)?up:dn; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
  }
}

/* ===== 10m per-minute volume (BTC) ===== */
function bins10(){
  const now=Date.now(), start=now - (now%60000) - 9*60000;
  const bins=Array.from({length:10},(_,i)=>({buy:0,sell:0,ts:start+i*60000}));
  for(const t of win10){
    if(t.time<start||t.time>=start+10*60000) continue;
    const idx=Math.floor((t.time-start)/60000);
    if(idx>=0 && idx<10){ if(t.side==='buy') bins[idx].buy+=t.size; else bins[idx].sell+=t.size; }
  }
  return bins;
}
function drawVol(){
  const w=vol.clientWidth,h=vol.clientHeight; vctx.clearRect(0,0,w,h);
  const bins=bins10(); const sums=bins.map(b=>b.buy+b.sell); const max=Math.max(1,...sums);
  const padX=24,padTop=6,padBot=20,chartH=h-padTop-padBot, step=(w-padX*2)/bins.length, barW=step*0.7;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

  vctx.strokeStyle='rgba(255,255,255,.06)';
  for(let i=1;i<=3;i++){const y=padTop+chartH*(i/4*(4/3)); vctx.beginPath(); vctx.moveTo(padX-6,y); vctx.lineTo(w-padX+6,y); vctx.stroke();}

  vctx.font='10px system-ui,-apple-system,Segoe UI,Roboto,Arial'; vctx.textAlign='center'; vctx.textBaseline='top'; vctx.fillStyle='rgba(255,255,255,.75)';

  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i], xC=w-padX-((bins.length-1-i)*step)-step/2, tot=b.buy+b.sell;
    const hT=Math.max(chartH*0.06,(tot/max)*chartH), hBuy=tot?(b.buy/tot)*hT:0, hSell=hT-hBuy, yB=padTop+chartH;

    vctx.fillStyle=dn; vctx.fillRect(xC-barW/2,yB-hSell,barW,hSell);
    vctx.fillStyle=up; vctx.fillRect(xC-barW/2,yB-hSell-hBuy,barW,hBuy);

    if((i%2)===1){ vctx.fillStyle='rgba(255,255,255,.75)'; vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}),xC,yB+3); }
  }
}

/* ===== Loop & boot ===== */
function frame(){ renderPills(); drawChart(); drawVol(); requestAnimationFrame(frame); }

measureRow(); recalcRows(); cap(); renderTicker();
startWS(); setInterval(restFallback, 1200);
fetch24h(); setInterval(fetch24h,60000);
new ResizeObserver(()=>{ recalcRows(); cap(); renderTicker(); }).observe(bodyEl.parentElement);
new ResizeObserver(()=>{ recalcRows(); cap(); renderTicker(); }).observe(document.body);
requestAnimationFrame(frame);
</script>
</body>
</html>
