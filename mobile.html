<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>10m — h8s</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#101010; --ink:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b; --grid:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .wrap{padding:12px;max-width:760px;margin:0 auto}
  .card{background:var(--panel);border-radius:16px;padding:10px 10px 12px;
        box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 10px 26px rgba(0,0,0,.35)}
  #price{font-size:clamp(28px,8vw,44px);font-weight:900;text-align:center;margin:0 0 8px}
  #price.up{color:var(--up)} #price.down{color:var(--down)}
  .can{display:block;width:100%;height:240px;border-radius:12px}
  #vol{height:160px;margin-top:10px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 2px 4px}
  .pill{font-size:11px;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:3px 8px;opacity:.9}
  .lgd{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px}
  .up{background:var(--up)} .down{background:var(--down)}
  #conn{position:fixed;left:12px;bottom:12px;z-index:10}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div id="price">$—</div>
    <canvas id="chart" class="can"></canvas>

    <div class="row">
      <div class="lgd">
        <span class="dot up"></span><small>Buys</small>
        <span class="dot down"></span><small>Sells</small>
      </div>
      <span id="maxVol" class="pill">max —</span>
    </div>

    <canvas id="vol" class="can"></canvas>
  </div>
</div>

<span id="conn" class="pill">Connecting…</span>

<script>
/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtBTC=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
const priceEl=$('#price'), connEl=$('#conn'), maxVolEl=$('#maxVol');
const chart=$('#chart'), ctx=chart.getContext('2d',{desynchronized:true});
const vol=$('#vol'), vctx=vol.getContext('2d',{desynchronized:true});

function sizeCanvas(c, ctx){
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,3));
  const {clientWidth:w, clientHeight:h}=c;
  c.width=Math.max(1,w*dpr); c.height=Math.max(1,h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function resizeAll(){ sizeCanvas(chart,ctx); sizeCanvas(vol,vctx); draw(); }
new ResizeObserver(resizeAll).observe(document.body);

/* ---------- state ---------- */
let trades=[], series=[];
let lastPrice=null, startTime=null;
const MS10 = 600000;

/* ---------- WS ---------- */
let ws, recon;
function setConn(txt){connEl.textContent=txt;}

function startWS(){
  try{ ws && ws.close(); }catch(e){}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('Connecting…');
  ws.onopen=()=> {
    setConn('Live');
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  };
  ws.onmessage = e=>{
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        const t={ t: new Date(m.time).getTime(), p:+m.price, s:+m.size,
                  side:(m.side||'buy').toLowerCase() };
        ingest(t);
      }
    }catch{}
  };
  ws.onclose = () => { setConn('Reconnecting…'); clearTimeout(recon); recon=setTimeout(startWS,1000); };
  ws.onerror = () => { setConn('Reconnecting…'); try{ws.close()}catch{} };
}
startWS();

/* ---------- ingestion ---------- */
function ingest(t){
  if(!startTime) startTime=t.t;

  // color only price number, not background
  if(lastPrice!==null){
    priceEl.classList.remove('up','down');
    if(t.p>lastPrice) priceEl.classList.add('up');
    else if(t.p<lastPrice) priceEl.classList.add('down');
  }
  lastPrice=t.p;
  priceEl.textContent=fmtUSD.format(t.p);

  trades.push(t);
  series.push({t:t.t, p:t.p});

  const cutoff = Date.now() - MS10;
  trades = trades.filter(tr=>tr.t>=cutoff);
  series = series.filter(s=>s.t>=cutoff);

  draw();
}

/* ---------- draw loop ---------- */
function draw(){ drawPrice(); drawVol(); }

/* ----- PRICE CHART ----- */
function drawPrice(){
  const w=chart.clientWidth, h=chart.clientHeight;
  ctx.clearRect(0,0,w,h);

  const padX=10, padY=10, innerW=w-2*padX, innerH=h-2*padY;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();

  if(series.length<2){ grid(ctx,w,h); return; }

  // when under 10m old, fill from left proportionally
  const now = Date.now();
  const elapsed = now - startTime;
  const windowLength = Math.min(MS10, elapsed);
  const start = now - windowLength;
  const fillRatio = windowLength / MS10;

  let min=Infinity,max=-Infinity;
  for(const s of series){ if(s.t>=start){min=Math.min(min,s.p);max=Math.max(max,s.p);} }
  if(!isFinite(min)||!isFinite(max)){ grid(ctx,w,h); return; }
  const range=(max-min)||1;

  grid(ctx,w,h);

  ctx.lineWidth=2;
  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const s=series[i]; if(s.t<start) continue;
    const x = padX + innerW * ((s.t - start) / windowLength); // left → right growth
    const y = padY + innerH * (1 - (s.p-min)/range);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle=up; ctx.stroke();
}

/* grid lines */
function grid(context,w,h){
  context.strokeStyle='var(--grid)'; context.lineWidth=1;
  context.beginPath();
  for(let i=1;i<=2;i++){ const y=(h/3)*i; context.moveTo(10,y); context.lineTo(w-10,y); }
  context.stroke();
}

/* ----- VOLUME CHART ----- */
function bins10(){
  const now=Date.now();
  const start = startTime ? startTime : now - (now % 60000);
  const bins = Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
  for(const t of trades){
    const idx = Math.floor((t.t - start)/60000);
    if(idx>=0 && idx<10){ if(t.side==='sell') bins[idx].sell += t.s; else bins[idx].buy += t.s; }
  }
  return bins;
}

function drawVol(){
  const w=vol.clientWidth,h=vol.clientHeight;
  vctx.clearRect(0,0,w,h);
  const bins=bins10();
  const totals=bins.map(b=>b.buy+b.sell);
  const max=Math.max(1,...totals);
  maxVolEl.textContent='max ₿'+fmtBTC.format(Math.max(...totals)||0);

  const padX=22,padY=10,innerW=w-2*padX,innerH=h-2*padY;
  const step=innerW/10,barW=step*0.6;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

  for(let i=0;i<bins.length;i++){
    const b=bins[i];
    const x=padX+step*i+(step-barW)/2;
    const tot=b.buy+b.sell;
    const hTot=Math.max(2,innerH*(tot/max));
    const hSell=(b.sell/tot||0)*hTot;
    const hBuy=hTot-hSell;
    const yBase=padY+innerH;

    vctx.fillStyle=dn; vctx.fillRect(x,yBase-hSell,barW,hSell);
    vctx.fillStyle=up; vctx.fillRect(x,yBase-hSell-hBuy,barW,hBuy);
  }
}
resizeAll();
</script>
</body>
</html>