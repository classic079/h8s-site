<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Coinbase Stalker — Mobile</title>
<style>
  :root {
    --bg:#0a0a0a; --panel:#101010; --ink:#0f0f0f;
    --text:#e9fef7; --muted:#c8d6cf; --ring:rgba(255,255,255,.08);
    --up:#2dd4bf; --down:#f59e0b;
  }
  * { box-sizing:border-box; }
  html,body {
    margin:0; height:100%; background:var(--bg); color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap { max-width:760px; margin:0 auto; padding:10px 10px 60px;
          display:flex; flex-direction:column; gap:10px; }
  .card { background:var(--panel); border-radius:16px;
          box-shadow:0 0 0 1px var(--ring); }
  .pad { padding:14px; }

  .live { display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center; }
  .price { font-weight:900; line-height:1; font-size:clamp(28px,7vw,42px); }
  .price.up{color:var(--up)} .price.down{color:var(--down)}
  .chips { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
  .chip { border:1px solid var(--ring); border-radius:999px;
          padding:6px 10px; font-size:12px; }
  .chip.up{color:var(--up)} .chip.down{color:var(--down)} .chip.muted{color:var(--muted)}

  .dynHead { font-weight:800; margin:8px 0 10px 2px; }
  #dyn { width:100%; height:180px; display:block; border-radius:12px; }

  .volHead { display:flex; justify-content:space-between;
             align-items:center; margin-bottom:8px; }
  .titleRow { display:flex; align-items:baseline; gap:10px; }
  .maxVol { font-size:12px; color:var(--muted); }
  .legend { display:flex; gap:12px; align-items:center; }
  .dot { width:12px; height:12px; border-radius:3px;
         display:inline-block; margin-right:6px; }
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  #vol{width:100%;height:150px;display:block;border-radius:12px;}

  .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .tile { border-radius:14px; background:var(--ink);
          box-shadow:0 0 0 1px var(--ring); padding:14px; }
  .k { font-size:12px; color:var(--muted); margin-bottom:6px; }
  .v { font-size:20px; font-weight:800; letter-spacing:.2px; }
  .v.small{font-size:18px}
  .hl { display:flex; flex-direction:column; line-height:1.15; }
  .good{color:var(--up)} .bad{color:var(--down)}

  .conn { position:fixed; left:12px; bottom:12px; font-size:12px;
          padding:6px 10px; border-radius:999px; border:1px solid var(--ring);
          background:var(--panel); z-index:50; }
  .conn.ok{color:var(--up)} .conn.warn{color:#fbbf24} .conn.err{color:#fb7185}
</style>
</head>
<body>
<div class="wrap">

  <section class="card pad">
    <div class="live">
      <div id="price" class="price">$—</div>
      <div class="chips">
        <span id="chip10" class="chip muted">10m Δ —</span>
        <span id="chipHL" class="chip">H/L —</span>
        <span id="chipVol" class="chip">24h Vol —</span>
      </div>
      <div class="dynHead">Dynamic price (1h → live 10m)</div>
      <canvas id="dyn"></canvas>
    </div>
  </section>

  <section class="card pad">
    <div class="volHead">
      <div class="titleRow">
        <div style="font-weight:800;font-size:22px">Per-minute volume (10m, <b>₿</b>)</div>
        <span id="maxVolLabel" class="maxVol">max —</span>
      </div>
      <div class="legend">
        <span><i class="dot up"></i>Buys</span>
        <span><i class="dot down"></i>Sells</span>
      </div>
    </div>
    <canvas id="vol"></canvas>
  </section>

  <section class="grid">
    <div class="tile"><div class="k">Trades / min</div><div id="tpm" class="v">—</div></div>
    <div class="tile"><div class="k">Buy ratio (USD)</div><div id="buyRatio" class="v">—</div></div>
    <div class="tile"><div class="k">VWAP</div><div id="vwap" class="v">$—</div></div>
    <div class="tile"><div class="k">High / Low</div><div id="hl" class="v hl"><span>—</span><span>—</span></div></div>
    <div class="tile"><div class="k">Range</div><div id="range" class="v small">—</div></div>
    <div class="tile"><div class="k">Avg / Median (USD)</div><div id="avgMed" class="v small">—</div></div>
  </section>

</div>

<span id="conn" class="conn warn">Connecting…</span>

<script>
const $=s=>document.querySelector(s);
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const pct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const pct2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
const btc2=v=>`₿${(+v).toFixed(2)}`;
const css=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const priceEl=$('#price'), chip10=$('#chip10'), chipHL=$('#chipHL'), chipVol=$('#chipVol');
const tpmEl=$('#tpm'), buyEl=$('#buyRatio'), vwapEl=$('#vwap'), hlEl=$('#hl'), rangeEl=$('#range'), avgMedEl=$('#avgMed');
const maxVolLabel=$('#maxVolLabel');
const connEl=$('#conn');
const dyn=$('#dyn'), dctx=dyn.getContext('2d',{desynchronized:true});
const vol=$('#vol'), vctx=vol.getContext('2d',{desynchronized:true});
function sizeCanvas(c,ctx){const dpr=Math.min(1.5,Math.max(1,(devicePixelRatio||1)));c.width=Math.floor(c.clientWidth*dpr);c.height=Math.floor(c.clientHeight*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);}

let ws,lastPrice=null,trades10=[],seed1h=[],live1m=[];
const MS10=600000, MS1M=60000;
let needsDyn=true,needsVol=true;

function drawIfNeeded(){if(needsDyn){drawDyn();needsDyn=false;}if(needsVol){drawVol();needsVol=false;}}
function markDyn(){needsDyn=true;drawIfNeeded()} function markVol(){needsVol=true;drawIfNeeded()}

function conn(state,msg){connEl.className='conn '+(state==='ok'?'ok':state==='err'?'err':'warn');connEl.textContent=msg;}
function startWS(){try{ws&&ws.close()}catch{};ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  conn('warn','Connecting…');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{try{const m=JSON.parse(e.data);
    if(m.type==='match'){ingest(+m.price,+m.size,(m.side||'buy').toLowerCase(),new Date(m.time).getTime());conn('ok','Live');}
  }catch{}};ws.onclose=()=>{conn('warn','Reconnecting…');setTimeout(startWS,1000);};ws.onerror=()=>conn('err','Error');
}

const iso=ms=>new Date(ms).toISOString();
async function loadSeed1h(){try{const end=Date.now(),start=end-3600*1000;
  const u=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=60&start=${encodeURIComponent(iso(start))}&end=${encodeURIComponent(iso(end))}`;
  const r=await fetch(u);if(!r.ok)return;const a=(await r.json()).sort((x,y)=>x[0]-y[0]);seed1h=a.map(x=>({t:x[0]*1000,p:+x[4]})).slice(-60);markDyn();}catch{}}

function ingest(price,size,side,ts){
  if(lastPrice!==null){priceEl.classList.remove('up','down');priceEl.classList.add(price>lastPrice?'up':'down');}
  lastPrice=price;priceEl.textContent=fmtUSD.format(price);
  trades10.push({time:ts,price,size,side});const now=Date.now();trades10=trades10.filter(t=>t.time>=now-MS10);
  const m=ts-(ts%MS1M),last=live1m.at(-1);if(!last||last.t!==m)live1m.push({t:m,c:price});else last.c=price;
  while(live1m.length&&live1m[0].t<now-MS10)live1m.shift();markDyn();markVol();
}

function drawDyn(){
  sizeCanvas(dyn,dctx);const w=dyn.clientWidth,h=dyn.clientHeight,pad=10,xPad=34;
  dctx.clearRect(0,0,w,h);dctx.fillStyle='#0f0f0f';dctx.fillRect(0,0,w,h);
  const now=Date.now(),start=now-3600*1000,fadeStart=now-MS10;
  const seed=seed1h.filter(p=>p.t>=start),live=live1m.filter(p=>p.t>=start);
  if(seed.length+live.length<2)return;
  const all=[...seed,...live],min=Math.min(...all.map(s=>s.p)),max=Math.max(...all.map(s=>s.p)),range=(max-min)||1;
  const avg=all.reduce((a,s)=>a+s.p,0)/all.length,up=css('--up'),dn=css('--down');
  const X=t=>pad+xPad+((t-start)/3600000)*(w-2*pad-xPad),Y=p=>pad+(h-2*pad)-((p-min)/range)*(h-2*pad);
  const seedOld=seed.filter(s=>s.t<fadeStart),seedNew=seed.filter(s=>s.t>=fadeStart);
  if(seedOld.length>1){dctx.strokeStyle='rgba(200,214,207,.55)';dctx.beginPath();dctx.moveTo(X(seedOld[0].t),Y(seedOld[0].p));
    seedOld.forEach((s,i)=>{if(i)dctx.lineTo(X(s.t),Y(s.p));});dctx.stroke();}
  if(seedNew.length>1){const liveStart=live.length?live[0].t:now,progress=Math.min(1,(now-liveStart)/MS10);
    dctx.globalAlpha=1-progress;dctx.strokeStyle='rgba(200,214,207,.65)';dctx.beginPath();
    dctx.moveTo(X(seedNew[0].t),Y(seedNew[0].p));seedNew.forEach((s,i)=>{if(i)dctx.lineTo(X(s.t),Y(s.p));});
    dctx.stroke();dctx.globalAlpha=1;}
  if(live.length>1){live.forEach((p,i)=>{if(i){const p0=live[i-1].p,p1=p.p;x0=X(live[i-1].t);x1=X(p.t);y0=Y(p0);y1=Y(p1);
      dctx.strokeStyle=(p1>=avg)?up:dn;dctx.beginPath();dctx.moveTo(x0,y0);dctx.lineTo(x1,y1);dctx.stroke();}});}
}

function minuteAlignedStart(){const now=Date.now();const snap=now-(now%MS1M);return snap-9*MS1M;}
function bins10(){const start=minuteAlignedStart();const bins=Array.from({length:10},(_,i)=>({ts:start+i*MS1M,buy:0,sell:0}));
  for(const t of trades10){if(t.time<start||t.time>=start+10*MS1M)continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/MS1M)));
    if(t.side==='buy')bins[idx].buy+=t.size;else bins[idx].sell+=t.size;}return bins;}
function pill(ctx,x,y,w,h,r,f){ctx.save();ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.fillStyle=f;ctx.fill();ctx.restore();}
function drawVol(){sizeCanvas(vol,vctx);const w=vol.clientWidth,h=vol.clientHeight;vctx.clearRect(0,0,w,h);
  const up=css('--up'),dn=css('--down');const bins=bins10();const totals=bins.map(b=>b.buy+b.sell);const max=Math.max(0,...totals);
  maxVolLabel.textContent=max?`max ${btc2(max)}`:'max —';
  const padX=34,padTop=8,padBot=14,chartH=h-padTop-padBot,step=(w-padX*2)/bins.length,barW=Math.min(30,step*0.74);
  for(let i=bins.length-1;i>=0;i--){const b=bins[i];const xC=w-padX-((bins.length-1-i)*step)-step/2;
    const tot=b.buy+b.sell,hT=max?Math.max(chartH*0.06,(tot/max)*chartH):0,yB=padTop+chartH;
    const hBuy=tot?(b.buy/tot)*hT:0,hSell=hT-hBuy;
    vctx.fillStyle=dn;vctx.fillRect(xC-barW/2,yB-hSell,barW,hSell);
    vctx.fillStyle=up;vctx.fillRect(xC-barW/2,yB-hSell-hBuy,barW,hBuy);
    if(tot>=0.01){vctx.fillStyle='rgba(255,255,255,.95)';vctx.fillText(btc2(tot),xC,yB-hT-8);}
    if(tot>=0.25&&hT>=18){const diff=b.buy-b.sell,text=(diff>=0?'+':'')+(Math.abs(diff)<1?diff.toFixed(3):diff.toFixed(2));
      const tw=vctx.measureText(text).width+10,th=18,px=xC-tw/2,py=yB-hSell-th/2;
      pill(vctx,px,py,tw,th,6,'rgba(0,0,0,.66)');vctx.fillStyle=diff>=0?up:dn;vctx.fillText(text,xC,py+th/2);}
  }}
function fetch24h(){fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats').then(r=>r.json()).then(j=>{
  chipHL.textContent=`H/L ${fmtUSD0.format(j.high)} / ${fmtUSD0.format(j.low)}`;
  chipVol.textContent=`24h Vol ${(+j.volume).toLocaleString()}`;}).catch(()=>{});}

new ResizeObserver(()=>{needsDyn=true;needsVol=true;drawIfNeeded();}).observe(document.body);
setInterval(()=>{needsDyn=true;needsVol=true;drawIfNeeded();},1000);

startWS();loadSeed1h();fetch24h();setInterval(fetch24h,60000);
needsDyn=needsVol=true;drawIfNeeded();
</script>
</body>
</html>