<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>10m — h8s</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#101010; --ink:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b; --grid:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .wrap{padding:12px;max-width:760px;margin:0 auto}
  .card{background:var(--panel);border-radius:16px;padding:10px 10px 12px;
        box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 10px 26px rgba(0,0,0,.35)}
  #price{font-size:clamp(28px,8vw,44px);font-weight:900;text-align:center;margin:0 0 8px}
  #price.up{color:var(--up)} #price.down{color:var(--down)}
  .can{display:block;width:100%;height:240px;border-radius:12px}
  #vol{height:160px;margin-top:10px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 2px 4px}
  .pill{font-size:11px;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:3px 8px;opacity:.9}
  .lgd{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px}
  .up{background:var(--up)} .down{background:var(--down)}
  #conn{position:fixed;left:12px;bottom:12px;z-index:10}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div id="price">$—</div>
    <canvas id="chart" class="can"></canvas>

    <div class="row">
      <div class="lgd">
        <span class="dot up"></span><small>Buys</small>
        <span class="dot down"></span><small>Sells</small>
      </div>
      <span id="maxVol" class="pill">max —</span>
    </div>

    <canvas id="vol" class="can"></canvas>
  </div>
</div>

<span id="conn" class="pill">Connecting…</span>

<script>
/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtBTC=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
const priceEl=$('#price'), connEl=$('#conn'), maxVolEl=$('#maxVol');
const chart=$('#chart'), ctx=chart.getContext('2d',{desynchronized:true});
const vol=$('#vol'), vctx=vol.getContext('2d',{desynchronized:true});

function sizeCanvas(c, ctx){
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,3));
  const {clientWidth:w, clientHeight:h}=c;
  c.width=Math.max(1,w*dpr); c.height=Math.max(1,h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function resizeAll(){ sizeCanvas(chart,ctx); sizeCanvas(vol,vctx); draw(); }
new ResizeObserver(resizeAll).observe(document.body);
addEventListener('orientationchange',()=>setTimeout(resizeAll,150));

/* ---------- state (10m live only) ---------- */
let trades=[];          // newest last; {t(ms), p, s(size), side}
let series=[];          // {t, p} for price line
let lastPrice=null;

const MS10 = 10*60*1000;

/* ---------- data plumbing ---------- */
let ws, recon;
function setConn(txt){connEl.textContent=txt;}

function startWS(){
  try{ ws && ws.close(); }catch(e){}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('Connecting…');
  ws.onopen=()=> {
    setConn('Live');
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  };
  ws.onmessage = e=>{
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        const t={ t: new Date(m.time).getTime(),
                  p: +m.price, s: +m.size,
                  side: (m.side||'buy').toLowerCase() };
        ingest(t);
      }
    }catch{}
  };
  ws.onclose = () => { setConn('Reconnecting…'); clearTimeout(recon); recon=setTimeout(startWS,1000); };
  ws.onerror = () => { setConn('Reconnecting…'); try{ws.close()}catch{} };
}
startWS();

/* ---------- ingestion ---------- */
function ingest(t){
  // price header
  if(lastPrice!==null){ priceEl.classList.remove('up','down');
    if(t.p>lastPrice) priceEl.classList.add('up'); else if(t.p<lastPrice) priceEl.classList.add('down');
  }
  lastPrice=t.p; priceEl.textContent=fmtUSD.format(t.p);

  trades.push(t);
  series.push({t:t.t, p:t.p});

  // prune to 10 minutes only
  const cutoff = Date.now() - MS10;
  while(trades.length && trades[0].t<cutoff) trades.shift();
  while(series.length && series[0].t<cutoff) series.shift();

  draw();
}

/* ---------- drawing ---------- */
function draw(){
  drawPrice();
  drawVolume();
}

function drawPrice(){
  const w=chart.clientWidth, h=chart.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(series.length<2){ grids(ctx,w,h); return; }

  const padX=10, padY=10, innerW=w-2*padX, innerH=h-2*padY;

  // x window = last 10m, right -> left fill
  const now=Date.now(), start=now-MS10;

  // y scale from live 10m only
  let min=Infinity,max=-Infinity,sum=0,n=0;
  for(const s of series){ if(s.t>=start){min=Math.min(min,s.p);max=Math.max(max,s.p);sum+=s.p;n++;} }
  if(!isFinite(min)||!isFinite(max)){ grids(ctx,w,h); return; }
  const avg=sum/n, range=(max-min)||1;

  // grid
  ctx.strokeStyle='var(--grid)'; ctx.lineWidth=1;
  ctx.beginPath();
  for(let i=1;i<=2;i++){ const y=padY + innerH*(i/3); ctx.moveTo(padX, y); ctx.lineTo(padX+innerW, y); }
  ctx.stroke();

  // dashed avg
  const yAvg = padY + innerH*(1 - (avg-min)/range);
  ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,.5)';
  ctx.beginPath(); ctx.moveTo(padX, yAvg); ctx.lineTo(padX+innerW, yAvg); ctx.stroke(); ctx.restore();

  // polyline
  ctx.lineWidth=2;
  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const s=series[i]; if(s.t<start) continue;
    const x = padX + innerW * ( (s.t-start)/MS10 );      // left→right
    const y = padY + innerH * (1 - (s.p-min)/range);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  ctx.stroke();

  // sparse time ticks bottom (every 2 minutes)
  ctx.strokeStyle='var(--grid)';
  ctx.fillStyle='rgba(255,255,255,.65)';
  ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let i=0;i<=10;i+=2){
    const t = start + i*60000;
    const x = padX + innerW * (i/10);
    ctx.beginPath(); ctx.moveTo(x,h-padY-10); ctx.lineTo(x,h-padY); ctx.stroke();
    ctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}), x, h-padY+2);
  }
}

function grids(context,w,h){
  context.strokeStyle='var(--grid)'; context.lineWidth=1;
  context.beginPath();
  for(let i=1;i<=2;i++){ const y=(h/3)*i; context.moveTo(10,y); context.lineTo(w-10,y); }
  context.stroke();
}

/* per-minute stacked BTC volume */
function bins10(){
  const now=Date.now();
  const start = now - (now % 60000) - 9*60000;  // align 10 bins to minutes
  const bins = Array.from({length:10},(_,i)=>({ts:start+i*60000, buy:0, sell:0}));
  for(const t of trades){
    const i = Math.floor((t.t - start)/60000);
    if(i>=0 && i<10){ if(t.side==='sell') bins[i].sell += t.s; else bins[i].buy += t.s; }
  }
  return bins;
}

function drawVolume(){
  const w=vol.clientWidth, h=vol.clientHeight;
  vctx.clearRect(0,0,w,h);
  const bins=bins10();
  const totals=bins.map(b=>b.buy+b.sell);
  const max = Math.max(1, ...totals);
  maxVolEl.textContent = 'max ₿' + fmtBTC.format(Math.max(...totals)||0);

  const padX=22, padY=10, innerW=w-2*padX, innerH=h-2*padY;
  const step = innerW/10, barW = Math.max(6, step*0.55);

  // grid
  vctx.strokeStyle='var(--grid)'; vctx.lineWidth=1;
  vctx.beginPath();
  for(let i=1;i<=2;i++){ const y=padY + innerH*(i/3); vctx.moveTo(padX,y); vctx.lineTo(padX+innerW,y); }
  vctx.stroke();

  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

  // draw newest at right
  for(let i=0;i<bins.length;i++){
    const b=bins[i];
    const x = padX + step*i + (step-barW)/2;
    const tot = b.buy+b.sell;
    const hTot = Math.max(2, innerH * (tot/max));

    const hSell = (tot? b.sell/tot : 0) * hTot;
    const hBuy  = hTot - hSell;
    const yBase = padY + innerH;

    // sells (bottom)
    vctx.fillStyle=dn; vctx.fillRect(x, yBase-hSell, barW, hSell);
    // buys (top)
    vctx.fillStyle=up; vctx.fillRect(x, yBase-hSell-hBuy, barW, hBuy);
  }

  // minute ticks at bottom (every 2 min to keep sparse)
  vctx.strokeStyle='var(--grid)';
  vctx.fillStyle='rgba(255,255,255,.65)';
  vctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  vctx.textAlign='center'; vctx.textBaseline='top';
  const startTS = bins[0]?.ts ?? (Date.now()-9*60000);
  for(let i=0;i<10;i+=2){
    const x = padX + step*i + step/2;
    const ts = startTS + i*60000;
    vctx.beginPath(); vctx.moveTo(x, h-padY-10); vctx.lineTo(x, h-padY); vctx.stroke();
    vctx.fillText(':'+new Date(ts).toLocaleTimeString([],{minute:'2-digit'}), x, h-padY+2);
  }
}

/* initial sizing */
resizeAll();
</script>
</body>
</html>