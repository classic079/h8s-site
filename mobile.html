<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s.us — 10m R→L</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --ink:#eafaf3; --muted:#c5d3cc;
    --up:#2dd4bf; --down:#f59e0b; --glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .wrap{max-width:780px;margin:0 auto;padding:12px}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px var(--glass);padding:14px;margin:10px 0}
  .title{font-weight:800;font-size:clamp(18px,5.5vw,28px);margin:6px 2px 10px}
  .livePrice{font-size:clamp(28px,9vw,48px);font-weight:900;text-align:center}
  .livePrice.up{color:var(--up)} .livePrice.down{color:var(--down)}
  .chartBox{padding:8px;border-radius:12px;background:#0f0f0f}
  canvas{display:block;width:100%;height:auto}
  .legend{display:flex;gap:12px;align-items:center;margin:4px 2px 8px}
  .dot{width:14px;height:14px;border-radius:3px;display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .maxLbl{margin-left:auto;opacity:.85;font-weight:700}
  .pill{position:fixed;left:12px;bottom:12px;padding:6px 10px;border-radius:10px;
        background:#15201c;color:var(--up);border:1px solid rgba(45,212,191,.25);font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="price" class="livePrice">$—</div>
    </div>

    <div class="card">
      <div class="title">Price (last 10 minutes)</div>
      <div class="chartBox"><canvas id="priceChart" width="800" height="320"></canvas></div>
    </div>

    <div class="card">
      <div class="title">Per-minute volume (10m, ₿)</div>
      <div class="legend">
        <span class="dot up"></span><span>Buys</span>
        <span class="dot down"></span><span>Sells</span>
        <span id="volMax" class="maxLbl">max —</span>
      </div>
      <div class="chartBox"><canvas id="volChart" width="800" height="220"></canvas></div>
    </div>
  </div>

  <span id="conn" class="pill">Connecting…</span>

<script>
/* ============ Setup ============ */
const $ = s => document.querySelector(s);
const priceEl = $('#price');
const connEl  = $('#conn');
const pCan = $('#priceChart'), pctx = pCan.getContext('2d', {desynchronized:true});
const vCan = $('#volChart'),   vctx = vCan.getContext('2d',   {desynchronized:true});
const volMaxEl = $('#volMax');

const fmtUSD  = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0 = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtBTC2 = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

const COLOR_UP   = getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
const COLOR_DOWN = getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

function fit(c,ctx){const dpr=Math.max(1,Math.min(devicePixelRatio||1,2.5)); c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);}
new ResizeObserver(()=>{fit(pCan,pctx);fit(vCan,vctx);drawPrice();drawVol();}).observe(document.body);

/* ============ Data ============ */
const MS10 = 600000;
let lastPrice=null;
let series=[];              // {t,p}
let win10=[];               // {time,size,side}

/* ============ WS ============ */
function setConn(txt,color){connEl.textContent=txt; if(color) connEl.style.color=color;}
function startWS(){
  const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('Connecting…','#fbbf24');
  ws.onopen = ()=> ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage = e=>{
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        const t=+new Date(m.time), p=+m.price, s=+m.size, side=String(m.side||'buy');
        ingest(t,p,s,side);
      }
    }catch{}
  };
  ws.onclose  = ()=>{setConn('Reconnecting…','#fbbf24'); setTimeout(startWS,900)};
  ws.onerror  = ()=> setConn('Fallback','#fb7185');
}

/* ============ Ingest ============ */
function ingest(t,p,sz,side){
  // live price
  if(lastPrice!==null){priceEl.classList.remove('up','down'); if(p>lastPrice)priceEl.classList.add('up'); else if(p<lastPrice)priceEl.classList.add('down');}
  lastPrice=p; priceEl.textContent=fmtUSD.format(p); setConn('Live',COLOR_UP);

  // 10m line series
  series.push({t,p});
  const cut = Date.now()-MS10;
  while(series.length && series[0].t<cut) series.shift();

  // 10m volume bins
  win10.push({time:t,size:sz,side});
  while(win10.length && win10[0].time<cut) win10.shift();

  drawPrice(); drawVol();
}

/* ============ Price chart (10m, right→left) ============ */
function drawPrice(){
  fit(pCan,pctx);
  const w=pCan.clientWidth, h=pCan.clientHeight;
  pctx.clearRect(0,0,w,h); pctx.fillStyle='#101010'; pctx.fillRect(0,0,w,h);
  const padL=58,padR=16,padT=20,padB=44;

  const now=Date.now(), start=now-MS10;
  const pts = series.filter(s=>s.t>=start);
  if(pts.length<2) return;

  // extents only from 10m window
  let lo=Infinity, hi=-Infinity, sum=0;
  for(const s of pts){ if(s.p<lo) lo=s.p; if(s.p>hi) hi=s.p; sum+=s.p; }
  if(!isFinite(lo)||!isFinite(hi)) return;
  const avg=sum/pts.length, span=MS10;

  // grid
  pctx.strokeStyle='rgba(255,255,255,.06)'; pctx.lineWidth=1;
  for(let i=1;i<=3;i++){const y=padT+(h-padT-padB)*(i/4*(4/3)); pctx.beginPath(); pctx.moveTo(padL-6,y); pctx.lineTo(w-padR+6,y); pctx.stroke();}

  // labels
  const y = v=> padT+(h-padT-padB)*(1-(v-lo)/((hi-lo)||1));
  pctx.fillStyle='rgba(255,255,255,.85)'; pctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; pctx.textBaseline='middle';
  const yHi=y(hi), yLo=y(lo), yAvg=y(avg);
  pctx.fillText(fmtUSD0.format(hi), 6, Math.max(padT+8,yHi));
  pctx.fillText(fmtUSD0.format(avg), 6, Math.max(padT+14,Math.min(h-padB-14,yAvg)));
  pctx.fillText(fmtUSD0.format(lo), 6, Math.min(h-padB-8,yLo));
  pctx.save(); pctx.setLineDash([6,6]); pctx.strokeStyle='rgba(200,214,207,.6)';
  pctx.beginPath(); pctx.moveTo(padL,yAvg); pctx.lineTo(w-padR,yAvg); pctx.stroke(); pctx.restore();

  // X axis minute ticks (right→left)
  pctx.fillStyle='rgba(255,255,255,.78)'; pctx.textAlign='center'; pctx.textBaseline='top';
  const step=120000, x0=padL, x1=w-padR;
  const firstTick = start + (step - (start%step));
  for(let t=firstTick; t<=now; t+=step){
    const x=x1 - ((t-start)/span)*(x1-x0);
    pctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}), x, h-padB+8);
  }

  // live line (right→left)
  pctx.lineWidth=2; pctx.strokeStyle=COLOR_UP; pctx.beginPath();
  for(let i=0;i<pts.length;i++){
    const x=x1 - ((pts[i].t-start)/span)*(x1-x0);
    const yy=y(pts[i].p);
    if(i===0) pctx.moveTo(x,yy); else pctx.lineTo(x,yy);
  }
  pctx.stroke();
}

/* ============ Volume chart (10m, right→left) ============ */
function bins10(){
  const end=Date.now(), start=end-MS10;
  const bins=Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
  for(const t of win10){
    if(t.time<start||t.time>=end) continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/60000)));
    if(t.side==='sell') bins[idx].sell+=t.size; else bins[idx].buy+=t.size;
  }
  return bins;
}
function drawVol(){
  fit(vCan,vctx);
  const w=vCan.clientWidth, h=vCan.clientHeight;
  vctx.clearRect(0,0,w,h); vctx.fillStyle='#101010'; vctx.fillRect(0,0,w,h);

  const padL=36,padR=16,padT=8,padB=28;
  const chartH=h-padT-padB, step=(w-padL-padR)/10, barW=step*0.72;

  const bins=bins10();
  const totals=bins.map(b=>b.buy+b.sell);
  const maxRaw=Math.max(0.01,...totals), max=maxRaw*1.25;
  volMaxEl.textContent='max ₿'+fmtBTC2.format(maxRaw);

  // grid
  vctx.strokeStyle='rgba(255,255,255,.06)'; vctx.lineWidth=1;
  for(let i=1;i<=3;i++){const y=padT+chartH*(i/4*(4/3)); vctx.beginPath(); vctx.moveTo(padL-6,y); vctx.lineTo(w-padR+6,y); vctx.stroke();}

  const x0=padL, x1=w-padR;
  const end=Date.now(), start=end-MS10, span=MS10;
  vctx.textAlign='center'; vctx.textBaseline='top'; vctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  for(let i=0;i<bins.length;i++){
    const b=bins[i], total=b.buy+b.sell;
    const rel=(b.ts-start)/span;
    const x=x1 - rel*(x1-x0) - step/2;
    const yBase=padT+chartH, hT=Math.max(2,(total/max)*chartH), hBuy=total?(b.buy/total)*hT:0;

    // sells (bottom), buys (top)
    vctx.fillStyle=COLOR_DOWN; vctx.fillRect(x-barW/2, yBase-(hT-hBuy), barW, hT-hBuy);
    vctx.fillStyle=COLOR_UP;   vctx.fillRect(x-barW/2, yBase-hT,       barW, hBuy);

    // label every 2 minutes
    if(i%2===0){
      vctx.fillStyle='rgba(255,255,255,.78)';
      vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}), x, yBase+6);
    }
  }
}

/* ============ Kickoff ============ */
fit(pCan,pctx); fit(vCan,vctx);
startWS();
</script>
</body>
</html>
