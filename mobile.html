<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s — mobile (classic)</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.75); --pill-bd:rgba(255,255,255,.22);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{padding:14px 14px calc(90px + env(safe-area-inset-bottom)); max-width:900px; margin:0 auto;}
  .card{background:var(--panel); border-radius:14px; box-shadow:var(--glow)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
        border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd);
        font-size:12px; white-space:nowrap; color:#fff;}
  .bigPrice{font-weight:900; font-size: clamp(24px,7.8vw,44px); letter-spacing:.5px; text-align:center; margin:18px 0 6px}
  .bigPrice.up{color:var(--up)} .bigPrice.down{color:var(--down)}
  .chartBox{padding:10px 10px 6px; position:relative;}
  canvas{display:block; width:100%; height:240px; border-radius:12px; background:var(--panel-2)}
  .volBox canvas{height:210px}
  .legend{display:flex; align-items:center; gap:16px; padding:10px 10px 4px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .conn{position:fixed; left:14px; bottom:14px; z-index:30}

  /* Gear now INSIDE the card, slightly down-right */
  #gearBtn{
    position:absolute;
    top:12px; left:14px;
    width:36px; height:36px; z-index:5;
    display:grid; place-items:center;
    border-radius:10px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.45);
    -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
  }
  #gearBtn svg{width:20px; height:20px; fill:#fff}
  #gearBtn:active{transform:scale(.97)}

  /* Settings sheet */
  #sheet{position:fixed; inset:0; z-index:1100; display:none; background:rgba(0,0,0,.35)}
  #sheet.open{display:block}
  .panel{
    position:absolute; left:12px; right:12px; top:calc(env(safe-area-inset-top) + 12px);
    background:var(--panel); border:1px solid var(--pill-bd); border-radius:14px; box-shadow:var(--glow);
    padding:14px;
  }
  .panel h3{margin:0 0 8px; font-size:14px}
  .row{display:flex; align-items:center; gap:10px}
  .field{display:flex; align-items:center; gap:10px; margin:8px 0}
  .field input[type="number"]{
    width:140px; padding:8px 10px; border-radius:10px; background:var(--panel-2);
    border:1px solid var(--pill-bd); color:var(--text);
  }
  .btn{padding:8px 12px; border-radius:10px; border:1px solid var(--pill-bd); background:var(--panel-2); color:var(--text); cursor:pointer}
  .btn.save{background:var(--up); color:#00130f; border-color:transparent}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card chartBox">
      <!-- gear lives in the price card now -->
      <button id="gearBtn" aria-label="Settings">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm9.44-3.5c0-.45-.04-.9-.1-1.33l2.13-1.66a1 1 0 0 0 .23-1.32l-2-3.46a1 1 0 0 0-1.22-.44l-2.5 1a9.77 9.77 0 0 0-2.3-1.33l-.38-2.64A1 1 0 0 0 12.64 0h-4a1 1 0 0 0-.99.84L7.27 3.5a9.84 9.84 0 0 0-2.3 1.33l-2.5-1a1 1 0 0 0-1.22.44l-2 3.46a1 1 0 0 0 .23 1.32L1.6 10.67c-.07.43-.11.88-.11 1.33s.04.9.1 1.33l-2.13 1.66a1 1 0 0 0-.23 1.32l2 3.46a1 1 0 0 0 1.22.44l2.5-1c.7.54 1.48.99 2.3 1.33l.38 2.64a1 1 0 0 0 .99.84h4a1 1 0 0 0 .99-.84l.38-2.64a9.77 9.77 0 0 0 2.3-1.33l2.5 1a1 1 0 0 0 1.22-.44l2-3.46a1 1 0 0 0-.23-1.32l-2.13-1.66c.07-.43.11-.88.11-1.33Z"/>
        </svg>
      </button>

      <div id="bigPrice" class="bigPrice">$—</div>
      <canvas id="priceCanvas"></canvas>

      <div class="legend">
        <span class="dot up"></span><span class="muted">Buys</span>
        <span class="dot down"></span><span class="muted">Sells</span>
        <span style="margin-left:auto" class="pill muted" id="maxVolPill">max ₿—</span>
      </div>
      <canvas id="volCanvas"></canvas>
    </section>
    <div class="pill conn" id="connPill">Live</div>
  </main>

  <!-- Settings sheet -->
  <div id="sheet">
    <div class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <h3>Settings</h3>
        <button class="btn" id="closeBtn">Close</button>
      </div>
      <div class="field">
        <label for="btcAmt" class="muted">BTC amount</label>
        <input id="btcAmt" type="number" min="0.00000001" step="0.0001" value="1.0" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn save" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

<script>
/* ====== elements ====== */
const priceEl = document.getElementById('bigPrice');
const priceCanvas = document.getElementById('priceCanvas');
const volCanvas = document.getElementById('volCanvas');
const maxVolPill = document.getElementById('maxVolPill');
const connPill = document.getElementById('connPill');

const gearBtn = document.getElementById('gearBtn');
const sheet = document.getElementById('sheet');
const closeBtn = document.getElementById('closeBtn');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const btcAmt = document.getElementById('btcAmt');

/* ====== state ====== */
let lastPrice = null;
let series = [];           // {t, p}
let volBins = [];          // {ts,buy,sell} x10 fixed
const MS10 = 600000;

/* ====== helpers ====== */
function sizeCanvas(c){
  const dpr = Math.min(3, window.devicePixelRatio||1);
  c.width = Math.max(1, c.clientWidth*dpr);
  c.height = Math.max(1, c.clientHeight*dpr);
  c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
  return c.getContext('2d');
}
function fmtUSD(v,fd=0){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v); }
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}
function initBins(){
  const now = Date.now();
  const start = now - (now % 60000) - 9*60000;
  volBins = Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
}
initBins();

/* ====== price scaling ====== */
const loadScale = () => { try { return parseFloat(localStorage.getItem('m.scale')||'1')||1 } catch { return 1 } };
const saveScale = (v) => localStorage.setItem('m.scale', String(v));
let priceScale = loadScale();
btcAmt.value = priceScale;

/* ====== trade intake ====== */
function onTrade({price,size,side,time}){
  const ts = new Date(time).getTime();
  series.push({t:ts,p:price});

  // fixed 10 bins aligned to minutes (left→right)
  const startAligned = ts - (ts % 60000) - 9*60000;
  while(volBins.length && volBins[0].ts < startAligned) volBins.shift();
  while(volBins.length<10){
    const lastTs = volBins.length?volBins[volBins.length-1].ts:startAligned;
    volBins.push({ts:lastTs+60000,buy:0,sell:0});
  }
  const i = Math.min(9,Math.max(0,Math.floor((ts - volBins[0].ts)/60000)));
  if(side==='buy') volBins[i].buy += size; else volBins[i].sell += size;

  // number color only
  if(lastPrice!=null){
    priceEl.classList.remove('up','down');
    if(price>lastPrice) priceEl.classList.add('up');
    else if(price<lastPrice) priceEl.classList.add('down');
  }
  lastPrice = price;
  paintBigPrice();
}
function prune(){
  const now = Date.now();
  series = series.filter(d=> d.t >= now-MS10);
}
function paintBigPrice(){
  if(lastPrice==null){ priceEl.textContent = '$—'; return; }
  const scaled = lastPrice * (priceScale || 1);
  priceEl.textContent = fmtUSD(scaled,2);
}

/* ====== price chart (Catmull–Rom → Bézier; rounded caps/joins) ====== */
function drawPrice(){
  const ctx = sizeCanvas(priceCanvas);
  const w = priceCanvas.clientWidth, h = priceCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);
  if(series.length<2) return;

  const min = Math.min(...series.map(d=>d.p));
  const max = Math.max(...series.map(d=>d.p));
  const range = (max-min)||1;

  const padX=12, padY=18;
  // grid lines
  ctx.strokeStyle='var(--grid)';
  for(let i=1;i<=3;i++){
    const y = padY+(h-2*padY)*(i/4*(4/3));
    ctx.beginPath(); ctx.moveTo(padX,y); ctx.lineTo(w-padX,y); ctx.stroke();
  }
  // average line
  const avg = series.reduce((a,d)=>a+d.p,0)/series.length;
  const yAvg = padY + (h-2*padY)*(1-(avg-min)/range);
  ctx.setLineDash([6,6]);
  ctx.strokeStyle='rgba(255,255,255,.35)';
  ctx.beginPath(); ctx.moveTo(padX,yAvg); ctx.lineTo(w-padX,yAvg); ctx.stroke();
  ctx.setLineDash([]);

  // map points over last 10m
  const span = MS10; const now = Date.now();
  const pts = series.map(d=>{
    const x = padX + ((d.t-(now-span))/span)*(w-2*padX);
    const y = padY + (h-2*padY)*(1-(d.p-min)/range);
    return {x,y};
  }).filter(p=>p.x>=padX-4);

  if(pts.length<2) return;

  // Catmull–Rom → Bezier
  const cr2bz = (p0,p1,p2,p3,t=0.5)=>{
    const d1x=(p2.x-p0.x)*t, d1y=(p2.y-p0.y)*t;
    const d2x=(p3.x-p1.x)*t, d2y=(p3.y-p1.y)*t;
    return [{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}];
  };
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--up').trim();
  ctx.lineWidth=2.25; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i-1]||pts[i], p1=pts[i], p2=pts[i+1], p3=pts[i+2]||p2;
    const [c1,c2]=cr2bz(p0,p1,p2,p3,0.5);
    ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);
  }
  ctx.stroke();

  // labels
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  ctx.fillText(fmtUSD(max,0), padX, padY+4);
  ctx.fillText(fmtUSD(avg,0), padX, Math.max(padY+12, Math.min(h-padY-12, yAvg)));
  ctx.fillText(fmtUSD(min,0), padX, h-padY-4);

  // last price pill
  if(lastPrice!=null){
    const last = pts[pts.length-1];
    const label = fmtUSD(lastPrice,0);
    const tw = ctx.measureText(label).width+18, th=22;
    const bx = Math.min(w-tw-8, Math.max(8, last.x - tw/2)), by = Math.max(8, last.y - th - 8);
    ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.25)';
    roundRect(ctx,bx,by,tw,th,10,true,true);
    ctx.fillStyle='#fff'; ctx.textBaseline='middle'; ctx.fillText(label, bx+9, by+th/2);
  }
}

/* ====== volume (stacked) with +/- pill) ====== */
function drawVol(){
  const ctx = sizeCanvas(volCanvas);
  const w = volCanvas.clientWidth, h = volCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  const max = Math.max(0.01, ...volBins.map(b=>b.buy+b.sell));
  maxVolPill.textContent = `max ₿${max.toFixed(2)}`;

  const padX=16, padTop=14, padBottom=22;
  const chartH = h - padTop - padBottom;
  const step = (w - padX*2) / volBins.length;
  const barW = step*0.62;

  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();

  // faint lines
  ctx.strokeStyle='var(--grid-2)';
  for(let i=1;i<=2;i++){
    const y = padTop + chartH*(i/3*(3/2));
    ctx.beginPath(); ctx.moveTo(padX-6,y); ctx.lineTo(w-padX+6,y); ctx.stroke();
  }

  // bottom time labels
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='top';
  for(let i=0;i<volBins.length;i+=2){
    const xC = padX + i*step + step/2;
    const t = new Date(volBins[i].ts).toLocaleTimeString([],{minute:'2-digit'});
    ctx.fillText(':'+t, xC-8, h-18);
  }

  for(let i=0;i<volBins.length;i++){
    const b = volBins[i];
    const xC = padX + i*step + step/2;
    const tot = b.buy + b.sell;
    const hT = Math.max(4, (tot/max)*chartH);
    const hBuy = tot?(b.buy/tot)*hT:0, hSell=hT-hBuy;
    const yB = padTop + chartH;

    // bars
    ctx.fillStyle = dn; ctx.fillRect(xC-barW/2, yB-hSell, barW, hSell);
    ctx.fillStyle = up; ctx.fillRect(xC-barW/2, yB-hSell-hBuy, barW, hBuy);

    // +/- diff pill
    if(hT>26){
      const diff = b.buy - b.sell;
      const txt = `${diff>=0?'+':''}${diff.toFixed(2)}`;
      const tw = ctx.measureText(txt).width+16, th=20;
      const bx = xC - tw/2, by = yB - hT - th - 4;
      ctx.fillStyle='rgba(0,0,0,.88)'; ctx.strokeStyle='rgba(255,255,255,.25)';
      roundRect(ctx,bx,by,tw,th,10,true,true);
      ctx.fillStyle = diff>=0 ? up : dn;
      ctx.textBaseline='middle'; ctx.fillText(txt, bx+8, by+th/2);
    }
  }
}

/* ====== loop ====== */
function drawAll(){ prune(); drawPrice(); drawVol(); requestAnimationFrame(drawAll); }

/* ====== feed ====== */
let ws, recon;
function startWS(){
  try{ ws && ws.close(); }catch{}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  ws.onopen = ()=>{
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
    connPill.textContent='Live';
  };
  ws.onmessage = (e)=>{
    try{
      const m = JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        onTrade({price:+m.price,size:+m.size,side:m.side,time:m.time});
      }
    }catch{}
  };
  ws.onclose = ()=>{ connPill.textContent='Reconnecting…'; recon=setTimeout(startWS,1000); };
  ws.onerror = ()=>{ try{ws.close()}catch{} };
}
startWS();

/* ====== layout/loop ====== */
new ResizeObserver(()=>{ drawAll(); }).observe(document.body);
requestAnimationFrame(drawAll);

/* ====== settings handlers ====== */
gearBtn.onclick = ()=> sheet.classList.add('open');
closeBtn.onclick = ()=> sheet.classList.remove('open');
resetBtn.onclick = ()=>{ btcAmt.value = 1; };
saveBtn.onclick = ()=>{
  const v = Math.max(0.00000001, parseFloat(btcAmt.value||'1'));
  priceScale = v; saveScale(v); paintBigPrice();
  sheet.classList.remove('open');
};
</script>
</body>
</html>