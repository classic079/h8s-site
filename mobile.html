<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Coinbase Stalker — Mobile</title>
<meta name="theme-color" content="#0a0a0a" />
<style>
  :root{
    --bg:#0a0a0a; --panel:#101010; --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b; --glow: rgba(45,212,191,.22);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

  .wrap{min-height:100vh;display:flex;flex-direction:column;gap:10px;padding:10px}

  .card{background:var(--panel);border-radius:12px;
        box-shadow:0 0 0 1px rgba(255,255,255,.06),0 8px 24px rgba(0,0,0,.35)}

  /* Connection pill */
  #connPill{position:fixed;left:10px;bottom:10px;z-index:50;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px;font-size:11px}
  .conn-ok{color:var(--up)} .conn-warn{color:#fbbf24} .conn-err{color:#fb7185}

  /* Header: price + 10m stats */
  .headerCard{padding:12px}
  .topRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .livePrice{font-size:clamp(26px,8vw,40px);font-weight:800;line-height:1}
  .livePrice.up{color:var(--up)} .livePrice.down{color:var(--down)}
  .actions{display:flex;gap:8px;align-items:center}
  .pill{border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 9px;font-size:12px;white-space:nowrap}
  .pill.up{color:var(--up)} .pill.down{color:var(--down)} .pill.flat{color:var(--muted)}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);
       border-radius:10px;padding:8px 12px;font-size:12px;cursor:pointer}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .stat{border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
  .stat h4{margin:0 0 6px;font-size:12px;opacity:.8}
  .stat .v{font-variant-numeric:tabular-nums;font-weight:800}
  .metricGood{color:var(--up)} .metricBad{color:var(--down)} .metricNeutral{color:var(--muted)}

  /* Price chart */
  .chartCard{padding:10px}
  .chartTitle{font-weight:700;margin:0 0 8px 2px}
  #chartCanvas{display:block;width:100%;height:200px;border-radius:10px}

  /* Per-minute volume (10m, BTC) */
  .volCard{padding:10px}
  .volTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .volTitle{font-weight:700}
  .legend{opacity:.9;font-size:12px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  #volCanvas{display:block;width:100%;height:160px;border-radius:10px}

  /* Ticker (toggle, hidden by default) — two columns: Price | Amount */
  .tickerWrap{display:none}
  .tickerHead{position:sticky;top:0;background:linear-gradient(180deg,rgba(16,16,16,1),rgba(16,16,16,.6));padding:10px;border-bottom:1px solid rgba(255,255,255,.08);border-radius:12px 12px 0 0}
  .gridHead{display:grid;grid-template-columns:1fr 110px;gap:8px;font-size:11px;opacity:.75;text-transform:uppercase;letter-spacing:.4px}
  .tickerBody{padding:6px 10px 10px}
  .row{display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.06);font-variant-numeric:tabular-nums}
  .row:last-child{border-bottom:none}
  .row.buy{color:var(--up)} .row.sell{color:var(--down)}
</style>
</head>
<body>
<span id="connPill" class="conn-warn">Connecting…</span>

<div class="wrap">

  <!-- Top: price + 10m stats -->
  <section class="card headerCard">
    <div class="topRow">
      <div id="livePrice" class="livePrice">$—</div>
      <div class="actions">
        <span id="pill10m" class="pill flat">10m Δ —</span>
        <button id="toggleTicker" class="btn" aria-pressed="false">Show Ticker</button>
      </div>
    </div>

    <div class="grid">
      <div class="stat"><h4>Trades / min</h4><div id="sTpm" class="v">—</div></div>
      <div class="stat"><h4>Buy ratio (USD)</h4><div id="sBuyR" class="v">—</div></div>
      <div class="stat"><h4>VWAP</h4><div id="sVWAP" class="v">—</div></div>
      <div class="stat"><h4>High / Low</h4><div id="sHiLo" class="v">—</div></div>
      <div class="stat"><h4>Range</h4><div id="sRange" class="v">—</div></div>
      <div class="stat"><h4>Avg / Median (USD)</h4><div id="sAvgMed" class="v">—</div></div>
    </div>
  </section>

  <!-- 10m price chart -->
  <section class="card chartCard">
    <h3 class="chartTitle">Last 10 minutes — Price</h3>
    <canvas id="chartCanvas"></canvas>
  </section>

  <!-- Per-minute volume (10m, BTC) -->
  <section class="card volCard">
    <div class="volTop">
      <div class="volTitle">Per-minute volume (10m, ₿)</div>
      <div class="legend"><span class="dot up"></span>Buys &nbsp; <span class="dot down"></span>Sells</div>
    </div>
    <canvas id="volCanvas"></canvas>
  </section>

  <!-- Ticker (hidden by default; Show Ticker toggles it) -->
  <section id="ticker" class="card tickerWrap">
    <div class="tickerHead">
      <div class="gridHead">
        <div>Price</div>
        <div id="amountHeader" style="text-align:right;cursor:pointer;">Amount (USD)</div>
      </div>
    </div>
    <div id="tickerBody" class="tickerBody"></div>
  </section>

</div>

<script>
/* ===== Helpers & formatters ===== */
const $=s=>document.querySelector(s);
const priceEl=$('#livePrice'), pill10m=$('#pill10m'), connPill=$('#connPill');
const sTpm=$('#sTpm'), sBuyR=$('#sBuyR'), sVWAP=$('#sVWAP'), sHiLo=$('#sHiLo'), sRange=$('#sRange'), sAvgMed=$('#sAvgMed');

const chart=$('#chartCanvas'), ctx=chart.getContext('2d',{desynchronized:true});
const vol=$('#volCanvas'), vctx=vol.getContext('2d',{desynchronized:true});

const tickerWrap=$('#ticker'), toggleTicker=$('#toggleTicker'), tickerBody=$('#tickerBody'), amountHeader=$('#amountHeader');
let tickerOn=false, showUSD=true;

const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtUSDchg=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2,signDisplay:'always'});
const fmtBTC2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
const pct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const pct2=new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

/* ===== State ===== */
let trades=[], win10=[], series=[], lastPrice=null;
const MS10=600000;

/* ===== Toggle ticker (hidden by default) ===== */
toggleTicker.addEventListener('click',()=>{
  tickerOn=!tickerOn;
  toggleTicker.textContent = tickerOn ? 'Hide Ticker' : 'Show Ticker';
  toggleTicker.setAttribute('aria-pressed', tickerOn?'true':'false');
  tickerWrap.style.display = tickerOn ? 'block' : 'none';
  if(tickerOn){ recalcRows(); capTrades(); renderTicker(); }
});
amountHeader?.addEventListener('click',()=>{ showUSD=!showUSD; amountHeader.textContent=showUSD?'Amount (USD)':'Amount (BTC)'; renderTicker(); });

/* ===== Canvas sizing ===== */
function sizeCanvas(c, ctx){
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,3));
  c.width=Math.max(1,c.clientWidth*dpr);
  c.height=Math.max(1,c.clientHeight*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function resizeAll(){
  sizeCanvas(chart,ctx); drawChart();
  sizeCanvas(vol,vctx); drawVol();
  if(tickerOn){ recalcRows(); capTrades(); renderTicker(); }
}
new ResizeObserver(resizeAll).observe(document.body);

/* ===== WS + Fallback ===== */
let ws,recon,lastWs=0,lastRest=0;
function setConn(state,msg){connPill.classList.remove('conn-ok','conn-warn','conn-err');connPill.classList.add(state==='ok'?'conn-ok':state==='warn'?'conn-warn':'conn-err');connPill.textContent=msg;}
function startWS(){clearTimeout(recon);try{ws&&ws.close()}catch{}ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('conn-warn','Connecting…');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{lastWs=Date.now();setConn('conn-ok','Live');try{const m=JSON.parse(e.data);if(m.type==='match'&&m.product_id==='BTC-USD'){ingest({price:+m.price,size:+m.size,side:String(m.side||'').toLowerCase(),time:new Date(m.time)});}}catch{}};
  ws.onclose=()=>{setConn('conn-warn','Reconnecting…');recon=setTimeout(startWS,1000)};
  ws.onerror=()=>{setConn('conn-err','Fallback');try{ws.close()}catch{}};
}
async function restFallback(){const QUIET=3500,now=Date.now();try{
  if(now-lastWs>=QUIET){const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/trades?limit=20',{headers:{Accept:'application/json'}});if(r.ok){const arr=await r.json();for(let i=arr.length-1;i>=0;i--){const t=arr[i];ingest({price:+t.price,size:+t.size,side:String(t.side||'').toLowerCase(),time:new Date(t.time||now)})}lastRest=now;setConn('conn-err','Fallback');return;}}
  if(now-Math.max(lastWs,lastRest)>=QUIET){const r2=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/ticker',{headers:{Accept:'application/json'}});if(r2.ok){const t=await r2.json();ingest({price:+t.price,size:+(t.size||0.001),side:'buy',time:new Date(t.time||now)});lastRest=now;setConn('conn-err','Fallback');}}
}catch{setConn('conn-err','Fallback');}}
setInterval(restFallback,1200);

/* ===== Ingest trade ===== */
function ingest(t){
  const p=t.price,s=t.size,side=t.side==='sell'?'sell':'buy',time=t.time;
  const prev=trades.length?trades[trades.length-1].price:lastPrice;
  if(lastPrice!==null){priceEl.classList.remove('up','down'); if(p>lastPrice)priceEl.classList.add('up'); else if(p<lastPrice)priceEl.classList.add('down')}
  lastPrice=p; priceEl.textContent=fmtUSD.format(p);

  trades.push({price:p,size:s,side,time});
  series.push({t:Date.now(),p});
  win10.push({price:p,size:s,side,time:time.getTime()});
  prune();

  renderStats();
  drawChart(); drawVol();
  if(tickerOn){ capTrades(); renderTicker(); }
}
function prune(){const now=Date.now(); win10=win10.filter(t=>t.time>=now-MS10); while(series.length && series[0].t<now-MS10) series.shift();}

/* ===== Stats (10m) ===== */
function median(a){const x=[...a].sort((m,n)=>m-n),n=x.length;return n?(n&1?x[(n-1)/2]:(x[n/2-1]+x[n/2])/2):NaN;}
function winStats(arr,min){
  const n=arr.length, btc=arr.reduce((a,t)=>a+t.size,0), usd=arr.reduce((a,t)=>a+t.price*t.size,0);
  let buy=0,hi=-Infinity,lo=Infinity; const usdEach=[];
  for(const t of arr){const u=t.price*t.size; usdEach.push(u); if(t.price>hi)hi=t.price; if(t.price<lo)lo=t.price; if(t.side==='buy')buy+=u;}
  const vwap=btc?usd/btc:NaN, rangeUSD=(isFinite(hi)&&isFinite(lo))?(hi-lo):NaN, rangePct=(isFinite(hi)&&isFinite(lo)&&lo>0)?((hi/lo-1)*100):NaN;
  return {tpm:n/min, buyRatio:usd?buy/usd*100:0, vwap, hi, lo, rangeUSD, rangePct, avg:n?usd/n:NaN, med:median(usdEach)};
}
function renderStats(){
  const S=win10.length?winStats(win10,10):{tpm:0,buyRatio:0,vwap:NaN,hi:NaN,lo:NaN,rangeUSD:NaN,rangePct:NaN,avg:NaN,med:NaN};
  sTpm.textContent = S.tpm.toFixed(1);
  sBuyR.textContent = `${pct1.format(S.buyRatio)}%`;
  sVWAP.textContent = isFinite(S.vwap)?fmtUSD.format(S.vwap):'—';
  sHiLo.textContent = (isFinite(S.hi)&&isFinite(S.lo))?`${fmtUSD0.format(S.hi)} / ${fmtUSD0.format(S.lo)}`:'—';
  sRange.textContent = (isFinite(S.rangeUSD)&&isFinite(S.rangePct))?`${fmtUSD0.format(S.rangeUSD)} (${pct1.format(S.rangePct)}%)`:'—';
  sAvgMed.textContent = (isFinite(S.avg)&&isFinite(S.med))?`${fmtUSD0.format(S.avg)} / ${fmtUSD0.format(S.med)}`:'—';

  // 10m Δ pill
  const first=series[0]?.p, last=series.at(-1)?.p;
  if(first && last){
    const diff=last-first, pct=first?diff/first*100:0;
    pill10m.textContent=`10m Δ ${fmtUSDchg.format(diff)} (${pct2.format(pct)}%)`;
    pill10m.classList.remove('up','down','flat'); pill10m.classList.add(diff>0?'up':diff<0?'down':'flat');
  } else {
    pill10m.textContent='10m Δ —'; pill10m.classList.add('flat');
  }
}

/* ===== 10m price chart ===== */
function drawChart(){
  const w=chart.clientWidth,h=chart.clientHeight,pad=12,xPad=32;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();
  ctx.clearRect(0,0,w,h); ctx.fillStyle='#101010'; ctx.fillRect(0,0,w,h);
  if(series.length<2) return;

  let min=Infinity,max=-Infinity,sum=0;
  for(const s of series){const p=s.p;if(!isFinite(p))continue; if(p<min)min=p; if(p>max)max=p; sum+=p;}
  if(!isFinite(min)||!isFinite(max)) return;
  const range=(max-min)||1,avg=sum/series.length;

  // grid
  ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.lineWidth=1;
  for(let i=1;i<6;i++){const gy=pad+(h-2*pad)/6*i; ctx.beginPath(); ctx.moveTo(pad+xPad,gy); ctx.lineTo(w-pad,gy); ctx.stroke();}

  // y labels & avg line
  ctx.fillStyle='rgba(255,255,255,.78)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  const lab=v=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v);
  const yAvg=pad+(h-2*pad)-((avg-min)/range)*(h-2*pad);
  ctx.fillText(lab(max),pad+6,pad+10);
  ctx.fillText(lab(avg),pad+6,Math.max(pad+14,Math.min(h-pad-14,yAvg)));
  ctx.fillText(lab(min),pad+6,h-pad-10);
  ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,.6)';
  ctx.beginPath(); ctx.moveTo(pad+xPad,yAvg); ctx.lineTo(w-pad,yAvg); ctx.stroke(); ctx.restore();

  // line
  const MAX_JUMP=avg*0.08; ctx.lineWidth=2;
  for(let i=1;i<series.length;i++){
    const p0=series[i-1].p,p1=series[i].p;
    if(!isFinite(p0)||!isFinite(p1)) continue;
    if(Math.abs(p1-p0)>MAX_JUMP) continue;
    const x0=pad+xPad+((i-1)/(series.length-1))*(w-2*pad-xPad);
    const x1=pad+xPad+((i)/(series.length-1))*(w-2*pad-xPad);
    if(x1<=x0) continue;
    const y0=pad+(h-2*pad)-((p0-min)/range)*(h-2*pad),
          y1=pad+(h-2*pad)-((p1-min)/range)*(h-2*pad);
    ctx.strokeStyle=(p1>=avg)?up:dn;
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
  }

  // x ticks every 2 minutes
  const now=Date.now(), start=now-MS10;
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  ctx.textAlign='center'; ctx.textBaseline='top'; ctx.strokeStyle='rgba(255,255,255,.05)';
  for(let i=0;i<=10;i+=2){
    const t=start+i*60000;
    const x=pad+xPad+((t-start)/MS10)*(w-2*pad-xPad);
    ctx.beginPath(); ctx.moveTo(x,h-pad-18); ctx.lineTo(x,h-pad-4); ctx.stroke();
    ctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}),x,h-pad-16);
  }
}

/* ===== Per-minute volume (10m, BTC) ===== */
function alignedStart(){const now=Date.now();const ms=now-(now%60000);return ms-(9*60000)}
function bins10(){
  const start=alignedStart();
  const bins=Array.from({length:10},(_,i)=>({buy:0,sell:0,ts:start+i*60000}));
  for(const t of win10){
    if(t.time<start-1||t.time>=start+10*60000) continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.time-start)/60000)));
    if(t.side==='buy') bins[idx].buy+=t.size; else bins[idx].sell+=t.size;
  }
  return bins;
}
function drawVol(){
  const w=vol.clientWidth,h=vol.clientHeight; vctx.clearRect(0,0,w,h);
  const bins=bins10(); const sums=bins.map(b=>b.buy+b.sell);
  const max=Math.max(1,...sums);
  const padX=24,padTop=8,padBot=24,chartH=h-padTop-padBot, step=(w-padX*2)/bins.length, barW=step*0.72;
  const up=getComputedStyle(document.documentElement).getPropertyValue('--up').trim();
  const dn=getComputedStyle(document.documentElement).getPropertyValue('--down').trim();

  // light grid
  vctx.strokeStyle='rgba(255,255,255,.06)'; vctx.lineWidth=1;
  for(let i=1;i<=3;i++){const y=padTop+chartH*(i/4*(4/3)); vctx.beginPath(); vctx.moveTo(padX-6,y); vctx.lineTo(w-padX+6,y); vctx.stroke();}

  // bars (no text inside)
  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i], xC=w-padX-((bins.length-1-i)*step)-step/2, tot=b.buy+b.sell;
    const hT=Math.max(chartH*0.06,(tot/max)*chartH);
    const hBuy=tot?(b.buy/tot)*hT:0, hSell=hT-hBuy, yB=padTop+chartH;

    vctx.fillStyle=dn; vctx.fillRect(xC-barW/2,yB-hSell,barW,hSell);
    vctx.fillStyle=up; vctx.fillRect(xC-barW/2,yB-hSell-hBuy,barW,hBuy);

    if((i%2)===1){
      vctx.fillStyle='rgba(255,255,255,.75)';
      vctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';
      vctx.textAlign='center'; vctx.textBaseline='top';
      vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}),xC,yB+4);
    }
  }
}

/* ===== Ticker (price | amount, capped) ===== */
let MAX_ROWS=28, ROW_H=22;
function measureRow(){const tmp=document.createElement('div');tmp.className='row';tmp.style.visibility='hidden';tmp.innerHTML=`<div>$0</div><div>$0</div>`;document.body.appendChild(tmp);ROW_H=Math.max(18,tmp.getBoundingClientRect().height||ROW_H);tmp.remove();}
function recalcRows(){const H=tickerBody.parentElement.clientHeight; MAX_ROWS=Math.max(10,Math.floor((H-16)/ROW_H));}
function capTrades(){const HARD=MAX_ROWS+4; while(trades.length>HARD) trades.shift();}
function renderTicker(){
  if(!tickerOn) return;
  const frag=document.createDocumentFragment();
  const start=Math.max(0,trades.length-MAX_ROWS);
  for(let i=trades.length-1;i>=start;i--){
    const t=trades[i],row=document.createElement('div'); row.className=`row ${t.side}`;
    const amt=showUSD?fmtUSD.format(t.price*t.size):`${fmtBTC2.format(t.size)} BTC`;
    row.innerHTML=`<div>${fmtUSD.format(t.price)} <span style="opacity:.65">${(i>0 && trades[i].price>trades[i-1].price)?'▲':(i>0 && trades[i].price<trades[i-1].price)?'▼':'•'}</span></div>
                   <div style="text-align:right;white-space:nowrap">${amt}</div>`;
    frag.appendChild(row);
  }
  tickerBody.innerHTML=''; tickerBody.appendChild(frag);
}

/* ===== Loop & boot ===== */
function frame(){ // lightweight: keep charts fresh on idle
  drawChart(); drawVol();
  requestAnimationFrame(frame);
}
function init(){
  measureRow();
  resizeAll();
  startWS();
  setInterval(restFallback,1200);
  requestAnimationFrame(frame);
}
init();
</script>
</body>
</html>
