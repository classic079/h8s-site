<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s — mobile (classic)</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(0,0,0,.75); --pill-bd:rgba(255,255,255,.22);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .wrap{padding:14px 14px 90px; max-width:900px; margin:0 auto;}
  .card{background:var(--panel); border-radius:14px; box-shadow:var(--glow)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
        border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd);
        font-size:12px; white-space:nowrap; color:#fff;}
  .bigRow{display:flex; align-items:center; gap:10px; padding:10px 10px 0}
  .gear{width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
        border:1px solid var(--pill-bd); background:var(--pill-bg)}
  .gear svg{width:20px; height:20px; opacity:.95}
  .bigPrice{flex:1; text-align:center; font-weight:900; font-size: clamp(24px,7.8vw,44px);
            letter-spacing:.5px; margin:0}
  .bigPrice.up{color:var(--up)} .bigPrice.down{color:var(--down)}
  .chartBox{padding:10px 10px 6px}
  canvas{display:block; width:100%; height:240px; border-radius:12px; background:var(--panel-2)}
  .volBox canvas{height:210px}
  .legend{display:flex; align-items:center; gap:16px; padding:10px 10px 4px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .conn{position:fixed; left:14px; bottom:14px; z-index:30}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card chartBox">
      <div class="bigRow">
        <button id="gearBtn" class="gear" aria-label="settings">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm8.3 3.5a6.7 6.7 0 0 0-.1-.9l2.2-1.7-2-3.4-2.6 1a7.2 7.2 0 0 0-1.6-.9l-.4-2.7H8.2l-.4 2.7a7.2 7.2 0 0 0-1.6.9l-2.6-1-2 3.4 2.2 1.7a6.7 6.7 0 0 0 0 1.8L1.6 14l2 3.4 2.6-1c.5.4 1 .7 1.6.9l.4 2.7h5.6l.4-2.7c.6-.2 1.1-.5 1.6-.9l2.6 1 2-3.4-2.2-1.7c.1-.3.1-.6.1-.9Z" fill="#e9fef7"/></svg>
        </button>
        <h1 id="bigPrice" class="bigPrice">$—</h1>
      </div>

      <canvas id="priceCanvas"></canvas>

      <div class="legend">
        <span class="dot up"></span><span class="muted">Buys</span>
        <span class="dot down"></span><span class="muted">Sells</span>
        <span style="margin-left:auto" class="pill muted" id="maxVolPill">max ₿—</span>
      </div>

      <div class="volBox"><canvas id="volCanvas"></canvas></div>
    </section>

    <div class="pill conn" id="connPill">Live</div>
  </main>

<script>
/* ===== elements ===== */
const priceEl = document.getElementById('bigPrice');
const priceCanvas = document.getElementById('priceCanvas');
const volCanvas = document.getElementById('volCanvas');
const maxVolPill = document.getElementById('maxVolPill');
const connPill = document.getElementById('connPill');

/* ===== state ===== */
let lastPrice = null;
let series = [];           // {t, p}
let volBins = [];          // {ts,buy,sell} x10 fixed
const MS10 = 600000;

/* ===== helpers ===== */
function sizeCanvas(c){
  const dpr = Math.min(3, window.devicePixelRatio||1);
  c.width = Math.max(1, c.clientWidth*dpr);
  c.height = Math.max(1, c.clientHeight*dpr);
  c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
  return c.getContext('2d');
}
const fmtUSD = (v,fd=0)=> new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:fd}).format(v);
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}
function initBins(){
  const now = Date.now();
  const start = now - (now % 60000) - 9*60000;
  volBins = Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
}
initBins();

/* ===== trade intake ===== */
function onTrade({price,size,side,time}){
  const ts = new Date(time).getTime();
  series.push({t:ts,p:price});

  // keep 10 bins aligned to minutes (scroll left-to-right)
  const startAligned = ts - (ts % 60000) - 9*60000;
  while(volBins.length && volBins[0].ts < startAligned) volBins.shift();
  while(volBins.length<10){
    const lastTs = volBins.length?volBins[volBins.length-1].ts:startAligned;
    volBins.push({ts:lastTs+60000,buy:0,sell:0});
  }
  const i = Math.min(9,Math.max(0,Math.floor((ts - volBins[0].ts)/60000)));
  if(side==='buy') volBins[i].buy += size; else volBins[i].sell += size;

  // price color only on number
  if(lastPrice!=null){
    priceEl.classList.remove('up','down');
    if(price>lastPrice) priceEl.classList.add('up');
    else if(price<lastPrice) priceEl.classList.add('down');
  }
  lastPrice = price;
  priceEl.textContent = fmtUSD(price,2);
}
function prune(){
  const now = Date.now();
  series = series.filter(d=> d.t >= now-MS10);
}

/* ===== price chart (left-start + smoother curve) ===== */
function drawPrice(){
  const ctx = sizeCanvas(priceCanvas);
  const w = priceCanvas.clientWidth, h = priceCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);
  if(series.length<2) return;

  const min = Math.min(...series.map(d=>d.p));
  const max = Math.max(...series.map(d=>d.p));
  const range = (max-min)||1;

  const padX=12, padY=18;

  // grid lines
  ctx.strokeStyle='var(--grid)';
  for(let i=1;i<=3;i++){
    const y = padY+(h-2*padY)*(i/4*(4/3));
    ctx.beginPath(); ctx.moveTo(padX,y); ctx.lineTo(w-padX,y); ctx.stroke();
  }

  // average line
  const avg = series.reduce((a,d)=>a+d.p,0)/series.length;
  const yAvg = padY + (h-2*padY)*(1-(avg-min)/range);
  ctx.setLineDash([6,6]);
  ctx.strokeStyle='rgba(255,255,255,.35)';
  ctx.beginPath(); ctx.moveTo(padX,yAvg); ctx.lineTo(w-padX,yAvg); ctx.stroke();
  ctx.setLineDash([]);

  // map points over last 10m (fills from left → right)
  const span = MS10; const now = Date.now();
  let pts = series.map(d=>{
    const x = padX + ((d.t-(now-span))/span)*(w-2*padX);
    const y = padY + (h-2*padY)*(1-(d.p-min)/range);
    return {x,y};
  }).filter(p=>p.x>=padX-4);

  if(pts.length<2) return;

  // ensure the stroke begins at the left edge with same Y as first visible point
  if(pts[0].x > padX) pts.unshift({x:padX, y:pts[0].y});

  // light 3-point smoothing on Y (keeps X positions)
  const sm = new Array(pts.length);
  for(let i=0;i<pts.length;i++){
    const y0 = pts[Math.max(0,i-1)].y;
    const y1 = pts[i].y;
    const y2 = pts[Math.min(pts.length-1,i+1)].y;
    sm[i] = 0.25*y0 + 0.5*y1 + 0.25*y2;
  }
  pts = pts.map((p,i)=>({x:p.x,y:sm[i]}));

  // Catmull–Rom → Bézier with slightly higher tension for a cleaner line
  const cr2bz = (p0,p1,p2,p3,t=0.6)=>{
    const d1x=(p2.x-p0.x)*t, d1y=(p2.y-p0.y)*t;
    const d2x=(p3.x-p1.x)*t, d2y=(p3.y-p1.y)*t;
    return [{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}];
  };
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--up').trim();
  ctx.lineWidth=2.25; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i-1]||pts[i], p1=pts[i], p2=pts[i+1], p3=pts[i+2]||p2;
    const [c1,c2]=cr2bz(p0,p1,p2,p3,0.6);
    ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);
  }
  ctx.stroke();

  // axis labels (3 prices)
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  ctx.fillText(fmtUSD(max,0), padX, padY+4);
  ctx.fillText(fmtUSD(avg,0), padX, Math.max(padY+12, Math.min(h-padY-12, yAvg)));
  ctx.fillText(fmtUSD(min,0), padX, h-padY-4);

  // last price pill
  const last = pts[pts.length-1];
  const label = fmtUSD(lastPrice,0);
  const tw = ctx.measureText(label).width+18, th=22;
  const bx = Math.min(w-tw-8, Math.max(8, last.x - tw/2)), by = Math.max(8, last.y - th - 8);
  ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.25)';
  roundRect(ctx,bx,by,tw,th,10,true,true);
  ctx.fillStyle='#fff'; ctx.textBaseline='middle'; ctx.fillText(label, bx+9, by+th/2);
}

/* ===== volume (stacked) with +/- pill and max-height cap ===== */
const MAX_BAR_RATIO = 0.78; // keep room for the pill

function drawVol(){
  const ctx = sizeCanvas(volCanvas);
  const w = volCanvas.clientWidth, h = volCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  const max = Math.max(0.01, ...volBins.map(b=>b.buy+b.sell));
  maxVolPill.textContent = `max ₿${max.toFixed(2)}`;

  const padX=16, padTop=14, padBottom=22;
  const chartH = h - padTop - padBottom;
  const step = (w - padX*2) / volBins.length;
  const barW = step*0.62;

  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();

  // faint grid
  ctx.strokeStyle='var(--grid-2)';
  for(let i=1;i<=2;i++){
    const y = padTop + chartH*(i/3*(3/2));
    ctx.beginPath(); ctx.moveTo(padX-6,y); ctx.lineTo(w-padX+6,y); ctx.stroke();
  }

  // time labels (every 2 minutes)
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='top';
  for(let i=0;i<volBins.length;i+=2){
    const xC = padX + i*step + step/2;
    const t = new Date(volBins[i].ts).toLocaleTimeString([],{minute:'2-digit'});
    ctx.fillText(':'+t, xC-8, h-18);
  }

  for(let i=0;i<volBins.length;i++){
    const b = volBins[i];
    const xC = padX + i*step + step/2;
    const tot = b.buy + b.sell;

    const unclamped = (tot/max)*chartH;
    const hT = Math.max(4, Math.min(chartH*MAX_BAR_RATIO, unclamped));

    const yB = padTop + chartH;
    const buyFrac = tot ? (b.buy/tot) : 0;
    const hBuy = hT * buyFrac;
    const hSell = hT - hBuy;

    ctx.fillStyle = dn; ctx.fillRect(xC-barW/2, yB-hSell, barW, hSell);
    ctx.fillStyle = up; ctx.fillRect(xC-barW/2, yB-hSell-hBuy, barW, hBuy);

    if(hT>26){
      const diff = b.buy - b.sell;
      const txt = `${diff>=0?'+':''}${diff.toFixed(2)}`;
      const tw = ctx.measureText(txt).width+16, th=20;
      const bx = xC - tw/2, by = yB - hT - th - 6;
      ctx.fillStyle='rgba(0,0,0,.88)'; ctx.strokeStyle='rgba(255,255,255,.25)';
      roundRect(ctx,bx,by,tw,th,10,true,true);
      ctx.fillStyle = diff>=0 ? up : dn;
      ctx.textBaseline='middle'; ctx.fillText(txt, bx+8, by+th/2);
    }
  }
}

/* ===== loop ===== */
function drawAll(){ prune(); drawPrice(); drawVol(); requestAnimationFrame(drawAll); }

/* ===== feed ===== */
let ws, recon;
function startWS(){
  try{ ws && ws.close(); }catch{}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  ws.onopen = ()=>{
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
    connPill.textContent='Live';
  };
  ws.onmessage = (e)=>{
    try{
      const m = JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        onTrade({price:+m.price,size:+m.size,side:m.side,time:m.time});
      }
    }catch{}
  };
  ws.onclose = ()=>{ connPill.textContent='Reconnecting…'; recon=setTimeout(startWS,1000); };
  ws.onerror = ()=>{ try{ws.close()}catch{} };
}
startWS();

/* ===== layout ===== */
new ResizeObserver(()=>{ drawAll(); }).observe(document.body);
requestAnimationFrame(drawAll);
</script>
</body>
</html>