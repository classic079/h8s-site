<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coinbase Stalker — Mobile</title>
<style>
:root{
  --bg:#0a0a0a; --panel:#111; --text:#e9fef7; --muted:#c8d6cf;
  --up:#2dd4bf; --down:#f59e0b; --axis:rgba(255,255,255,.08); --grid:rgba(255,255,255,.06);
  --pill:rgba(255,255,255,.08);
}
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
.card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px rgba(255,255,255,.06)}
.wrap{padding:12px 12px 24px;max-width:820px;margin:0 auto}
.hdr{padding:14px 18px 10px}
.price{font-size:34px;font-weight:900;text-align:center}
.pills{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.pill{background:var(--pill);border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;white-space:nowrap}
.pill.up{color:var(--up)} .pill.down{color:var(--down)}
.section{margin-top:12px}
.titleRow{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 4px 8px}
.title{font-size:22px;font-weight:900}
.legend{display:flex;align-items:center;gap:14px;font-weight:800}
.dot{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:6px}
.dot.up{background:var(--up)} .dot.down{background:var(--down)}

.canvasBox{padding:8px}
canvas{display:block;width:100%;height:210px;border-radius:12px}
#priceCanvas{height:220px}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 2px 0}
.stat{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 0 0 1px rgba(255,255,255,.06)}
.stat h4{margin:0 0 4px;font-size:12px;color:var(--muted);letter-spacing:.2px}
.stat strong{font-size:18px}

.badge{position:absolute;padding:2px 6px;border-radius:999px;font-weight:900;font-size:12px;backdrop-filter:blur(2px)}
.badge.total{background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.25)}
.badge.diff.pos{background:rgba(9,95,83,.85);color:#d8fff7;border:1px solid rgba(45,212,191,.55)}
.badge.diff.neg{background:rgba(87,54,3,.9);color:#fff3d4;border:1px solid rgba(245,158,11,.55)}
.maxNote{font-size:13px;opacity:.85}
#conn{position:fixed;left:10px;bottom:10px;padding:6px 10px;border-radius:999px;background:var(--pill)}
#conn.ok{color:var(--up)} #conn.warn{color:#fbbf24} #conn.err{color:#fb7185}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<span id="conn" class="pill">Connecting…</span>
<div class="wrap">
  <div class="card hdr">
    <div id="livePrice" class="price">$—</div>
    <div class="pills">
      <span id="p10" class="pill">10m Δ —</span>
      <span id="hl" class="pill">H/L —</span>
      <span id="v24" class="pill">24h Vol —</span>
    </div>
  </div>

  <!-- Dynamic price (1h seed -> live 10m) -->
  <section class="card section">
    <div class="titleRow">
      <div class="title">Dynamic price (1h → live 10m)</div>
      <div class="small" id="covNote">seed 100%</div>
    </div>
    <div class="canvasBox"><canvas id="priceCanvas"></canvas></div>
  </section>

  <!-- Volume (10m, BTC) -->
  <section class="card section">
    <div class="titleRow">
      <div class="title">Per-minute volume (10m, ₿)</div>
      <div class="legend">
        <span class="maxNote" id="maxNote">max ₿0.00</span>
        <span><i class="dot up"></i>Buys</span>
        <span><i class="dot down"></i>Sells</span>
      </div>
    </div>
    <div class="canvasBox" style="padding-bottom:2px"><canvas id="volCanvas" style="height:150px"></canvas></div>
  </section>

  <!-- Stats grid -->
  <section class="grid">
    <div class="stat"><h4>Trades / min</h4><strong id="tpm">—</strong></div>
    <div class="stat"><h4>Buy ratio (USD)</h4><strong id="br">—</strong></div>
    <div class="stat"><h4>VWAP</h4><strong id="vwap">—</strong></div>
    <div class="stat"><h4>High / Low</h4><strong id="hilo">—</strong></div>
    <div class="stat"><h4>Range</h4><strong id="rng">—</strong></div>
    <div class="stat"><h4>Avg / Median (USD)</h4><strong id="am">—</strong></div>
  </section>
</div>

<script>
/* ===== utilities ===== */
const $=s=>document.querySelector(s);
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const pct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const btc2=v=>Number(v).toFixed(2);

/* ===== elements ===== */
const conn=$('#conn'); const livePrice=$('#livePrice');
const p10=$('#p10'), hl=$('#hl'), v24=$('#v24'), covNote=$('#covNote');
const tpmEl=$('#tpm'), brEl=$('#br'), vwapEl=$('#vwap'), hiloEl=$('#hilo'), rngEl=$('#rng'), amEl=$('#am');
const priceCanvas=$('#priceCanvas'), pctx=priceCanvas.getContext('2d',{desynchronized:true});
const volCanvas=$('#volCanvas'), vctx=volCanvas.getContext('2d',{desynchronized:true});
const maxNote=$('#maxNote');

/* ===== state ===== */
let seed1h=[];           // [{t, p}] 60 points / 1m granularity
let live10m=[];          // [{t, p}] recent <= 10m
let win10=[];            // trades window for 10m stats & vol
let lastPrice=null;
const MS10=600000;

/* ===== sizing ===== */
function sizeCanvas(c,ctx){
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,3));
  c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
}
new ResizeObserver(()=>{ sizeCanvas(priceCanvas,pctx); drawPrice(); sizeCanvas(volCanvas,vctx); drawVol(); }).observe(document.body);

/* ===== 24h stats (open/high/low/vol) ===== */
async function fetch24h(){
  try{
    const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats',{headers:{Accept:'application/json'}});
    const j=await r.json(); const open=+j.open, last=+j.last;
    if(Number.isFinite(open)&&Number.isFinite(last)){
      const diff=last-open, pct=open?diff/open*100:0;
      p10.textContent=`10m Δ —`;   // 10m pill will be filled by live series; keep placeholder here
      hl.textContent=`H/L ${fmtUSD0.format(+j.high)} / ${fmtUSD0.format(+j.low)}`;
      v24.textContent=`24h Vol ${(+j.volume).toLocaleString()}`;
    }
  }catch{}
}

/* ===== 1h seed candles ===== */
function iso(ms){return new Date(ms).toISOString();}
async function get1hSeed(){
  const end=Date.now(), start=end-3600_000;
  const u=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=60&start=${encodeURIComponent(iso(start))}&end=${encodeURIComponent(iso(end))}`;
  try{
    const r=await fetch(u,{headers:{Accept:'application/json'}}); const a=await r.json();
    seed1h=a.sort((x,y)=>x[0]-y[0]).map(x=>({t:x[0]*1000,p:+x[4]}));
    sizeCanvas(priceCanvas,pctx); drawPrice();
  }catch{}
}

/* ===== websocket + fallback ===== */
let ws, lastWs=0, recon;
function setConn(state,msg){conn.className='pill'; if(state==='ok')conn.id='ok',conn.classList.add('ok'); if(state==='warn')conn.classList.add('warn'); if(state==='err')conn.classList.add('err'); conn.textContent=msg;}
function startWS(){
  try{ws&&ws.close()}catch{}
  ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('warn','Connecting…');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{
    lastWs=Date.now();
    setConn('ok','Live');
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match'&&m.product_id==='BTC-USD'){
        const price=+m.price, size=+m.size, side=(m.side||'buy').toLowerCase(), t=new Date(m.time).getTime();
        onTrade({t, price, size, side});
      }
    }catch{}
  };
  ws.onclose=()=>{setConn('warn','Reconnecting…'); recon=setTimeout(startWS,1200)};
  ws.onerror=()=>{setConn('err','Fallback'); try{ws.close()}catch{}};
}
async function restTick(){
  const QUIET=4000, now=Date.now();
  if(now-lastWs<QUIET) return;
  try{
    const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/trades?limit=10',{headers:{Accept:'application/json'}});
    if(r.ok){
      const arr=await r.json();
      for(let i=arr.length-1;i>=0;i--){
        const t=arr[i];
        onTrade({t:new Date(t.time).getTime(), price:+t.price, size:+t.size, side:(t.side||'buy').toLowerCase()});
      }
      setConn('err','Fallback');
    }
  }catch{}
}
setInterval(restTick,1200);

/* ===== trade ingestion ===== */
function onTrade({t,price,size,side}){
  // live price
  if(lastPrice!==null){ livePrice.style.color = price>lastPrice?'var(--up)':price<lastPrice?'var(--down)':'inherit'; }
  lastPrice=price; livePrice.textContent=fmtUSD.format(price);

  // live price series (<=10m)
  live10m.push({t,p:price});
  const cutoff=Date.now()-MS10; while(live10m.length && live10m[0].t<cutoff) live10m.shift();

  // 10m trades window
  win10.push({t,price,size,side}); while(win10.length && win10[0].t<cutoff) win10.shift();

  updateStats(); drawPrice(); drawVol(); update10mChange();
}

function update10mChange(){
  if(live10m.length<2){ p10.textContent='10m Δ —'; p10.classList.remove('up','down'); return; }
  const first=live10m[0].p, last=live10m[live10m.length-1].p;
  const diff=last-first, pct=first?diff/first*100:0;
  p10.textContent=`10m Δ ${fmtUSD.format(diff)} (${pct1.format(pct)}%)`;
  p10.classList.toggle('up',diff>0); p10.classList.toggle('down',diff<0);
}

/* ===== stats (10m) ===== */
function median(a){const s=[...a].sort((x,y)=>x-y); const n=s.length; return n?(n&1?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):NaN;}
function updateStats(){
  const n=win10.length; if(!n){ tpmEl.textContent='—'; brEl.textContent='—'; vwapEl.textContent='—'; hiloEl.textContent='—'; rngEl.textContent='—'; amEl.textContent='—'; return; }
  const btc=win10.reduce((a,t)=>a+t.size,0);
  const usd=win10.reduce((a,t)=>a+t.price*t.size,0);
  const buy=win10.reduce((a,t)=>a+(t.side==='buy'?t.price*t.size:0),0);
  const sell=usd-buy;
  const hi=Math.max(...win10.map(t=>t.price)), lo=Math.min(...win10.map(t=>t.price));
  const vwap=btc?usd/btc:NaN; const range=hi-lo; const pct=lo?((hi/lo-1)*100):NaN;
  const avg=usd/n, med=median(win10.map(t=>t.price*t.size));
  const span = (win10.at(-1).t - win10[0].t) || 1;
  const tpm = n / (span/60000);

  tpmEl.textContent=tpm.toFixed(1);
  brEl.textContent=`${pct1.format(usd?buy/usd*100:0)}%`;
  vwapEl.textContent=isFinite(vwap)?fmtUSD.format(vwap):'—';
  hiloEl.textContent=`${fmtUSD0.format(hi)} / ${fmtUSD0.format(lo)}`;
  rngEl.textContent=`${fmtUSD0.format(range)} (${isFinite(pct)?pct1.format(pct):'0'}%)`;
  amEl.textContent=`${fmtUSD0.format(avg)} / ${fmtUSD0.format(med)}`;
}

/* ===== draw dynamic price ===== */
function drawPrice(){
  sizeCanvas(priceCanvas,pctx);
  const ctx=pctx, w=priceCanvas.clientWidth, h=priceCanvas.clientHeight, pad=10, xpad=38;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle=varGet('--panel'); ctx.fillRect(0,0,w,h);

  // compose series to draw window (last 70 minutes to be safe)
  const now=Date.now(), start=now-70*60000;
  const seed = seed1h.filter(d=>d.t>=start);
  const live = live10m;

  // axes & grid
  ctx.strokeStyle='var(--grid)'; for(let i=1;i<=4;i++){const y=(h/5)*i; ctx.beginPath();ctx.moveTo(xpad,y);ctx.lineTo(w-6,y);ctx.stroke();}

  // y domain from combined
  const comb = [...seed, ...live];
  if(comb.length<2) return;
  const min=Math.min(...comb.map(d=>d.p)), max=Math.max(...comb.map(d=>d.p)), R=(max-min)||1, avg=comb.reduce((a,b)=>a+b.p,0)/comb.length;
  const y=(p)=> pad + (h-2*pad) - ((p-min)/R)*(h-2*pad);
  // x maps: we show last 10m tight, but also render seed (1h) with same domain
  const x=(t)=> xpad + ((t-(now-MS10))/MS10) * (w - xpad - 8);

  // coverage & blending
  let cov = 0; 
  if(live.length>=2){ const span=live.at(-1).t - live[0].t; cov = Math.max(0, Math.min(1, span / MS10)); }
  const seedAlpha = (live.length>=2) ? Math.max(0, 1 - cov) : 1;
  const seedAlphaFloor = (live.length>=2) ? 0.35 : 1;      // keep visible until meaningful coverage
  const seedA = Math.max(seedAlpha, seedAlphaFloor*(seed.length?1:0));
  covNote.textContent = live.length>=2 ? `live ${Math.round(cov*100)}%` : 'seed 100%';

  // seed line
  if(seed.length>=2 && seedA>0){
    ctx.save(); ctx.globalAlpha = seedA;
    ctx.lineWidth=2; ctx.strokeStyle = '#a3a3a3';
    ctx.beginPath();
    for(let i=0;i<seed.length;i++){
      const d=seed[i], xx = x(d.t), yy=y(d.p);
      if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
    }
    ctx.stroke(); ctx.restore();
  }

  // live line
  if(live.length>=2){
    ctx.lineWidth=2.25; 
    for(let i=1;i<live.length;i++){
      const p0=live[i-1].p, p1=live[i].p;
      ctx.strokeStyle = (p1>=avg)?varGet('--up'):varGet('--down');
      ctx.beginPath(); ctx.moveTo(x(live[i-1].t),y(p0)); ctx.lineTo(x(live[i].t),y(p1)); ctx.stroke();
    }
  }

  // price labels
  ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  ctx.fillText(fmtUSD0.format(max),6, y(max)); ctx.fillText(fmtUSD0.format(avg),6, y(avg));
  ctx.fillText(fmtUSD0.format(min),6, y(min));
  // avg dashed
  ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,.6)'; ctx.beginPath(); ctx.moveTo(xpad,y(avg)); ctx.lineTo(w-8,y(avg)); ctx.stroke(); ctx.restore();

  // time ticks every 2 minutes across the last 10m
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textBaseline='top'; ctx.textAlign='center';
  for(let i=0;i<=10;i+=2){
    const t = now - MS10 + i*60000, xx=x(t);
    ctx.beginPath(); ctx.moveTo(xx,h-18); ctx.lineTo(xx,h-8); ctx.strokeStyle='var(--axis)'; ctx.stroke();
    ctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}), xx, h-16);
  }
}

/* ===== volume 10m (locked 1-minute bins, right→left) ===== */
const DIFF_MIN_BTC = 0.15;     // show +/- badge only above this
function startAligned(){const now=Date.now(); const ms=now - (now%60000); return ms - 9*60000;}
function bins10(){
  const start=startAligned();
  const b=Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
  for(const t of win10){
    if(t.t<start || t.t>=start+10*60000) continue;
    const idx=Math.min(9, Math.max(0, Math.floor((t.t-start)/60000)));
    if(t.side==='buy') b[idx].buy += t.size; else b[idx].sell += t.size;
  }
  return b;
}
function drawVol(){
  sizeCanvas(volCanvas,vctx);
  const w=volCanvas.clientWidth, h=volCanvas.clientHeight, padX=30, padT=8, padB=24, innerH=h-padT-padB;
  const bins=bins10(); const totals=bins.map(b=>b.buy+b.sell); const max=Math.max(1,...totals);
  maxNote.textContent=`max ₿${btc2(Math.max(...totals)||0)}`;

  // grid
  vctx.clearRect(0,0,w,h);
  vctx.strokeStyle='var(--grid)'; for(let i=1;i<=3;i++){const y=padT+innerH*(i/4*(4/3)); vctx.beginPath(); vctx.moveTo(padX-6,y); vctx.lineTo(w-padX+6,y); vctx.stroke();}

  const step=(w-padX*2)/10, barW=Math.max(10, step*0.65), baseY=padT+innerH;

  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i], xC=w-padX-((bins.length-1-i)*step)-step/2, tot=b.buy+b.sell;
    const hTot=Math.max(innerH*0.06, (tot/max)*innerH);
    const hBuy=tot?(b.buy/tot)*hTot:0, hSell=hTot-hBuy;

    // stacked bars
    vctx.fillStyle=getVar('--down'); vctx.fillRect(xC-barW/2, baseY-hSell, barW, hSell);
    vctx.fillStyle=getVar('--up');   vctx.fillRect(xC-barW/2, baseY-hSell-hBuy, barW, hBuy);

    // badges
    const diff=b.buy-b.sell, showDiff=Math.abs(diff)>=DIFF_MIN_BTC;
    const labelY = baseY - hTot - 14;
    // total always (if visible enough)
    if(hTot>16 && tot>0){
      badge(xC, labelY, `₿${btc2(tot)}`, 'total');
    }
    if(showDiff){
      const yMid = baseY - hSell - hBuy/2;
      badge(xC, yMid, `${diff>0?'+':''}${btc2(diff)}`, diff>0?'diff pos':'diff neg', true);
    }
    // x labels every other bin
    if(i%2===1){
      vctx.fillStyle='rgba(255,255,255,.8)'; vctx.font='11px system-ui'; vctx.textAlign='center'; vctx.textBaseline='top';
      vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}), xC, baseY+4);
    }
  }
}
// draw a rounded pill-ish badge
function badge(cx, cy, text, kind, center=false){
  const ctx=vctx;
  ctx.save();
  ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  const padX=8, padY=3; const w=ctx.measureText(text).width + padX*2, h=18;
  const x= Math.round(cx - w/2), y=Math.round(cy - h/2);
  if(kind==='total'){ ctx.fillStyle='rgba(0,0,0,.80)'; ctx.strokeStyle='rgba(255,255,255,.22)'; }
  else if(kind==='diff pos'){ ctx.fillStyle='rgba(9,95,83,.88)'; ctx.strokeStyle='rgba(45,212,191,.55)'; }
  else if(kind==='diff neg'){ ctx.fillStyle='rgba(87,54,3,.92)'; ctx.strokeStyle='rgba(245,158,11,.55)'; }
  ctx.lineWidth=1;
  roundRect(ctx,x,y,w,h,9,true,true);
  ctx.fillStyle='#fff'; ctx.textAlign='center';
  ctx.fillText(text, cx, cy+0.5);
  ctx.restore();
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath();
  ctx.moveTo(x+r, y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

/* ===== helpers for CSS vars ===== */
function varGet(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function getVar(n){return varGet(n);}

/* ===== boot ===== */
sizeCanvas(priceCanvas,pctx); sizeCanvas(volCanvas,vctx);
fetch24h(); get1hSeed(); startWS();
requestAnimationFrame(function raf(){ drawPrice(); drawVol(); requestAnimationFrame(raf); });
</script>
</body>
</html>