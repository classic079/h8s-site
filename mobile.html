<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coinbase Stalker — Mobile</title>
<style>
:root{
  --bg:#0a0a0a; --panel:#111; --text:#e9fef7; --muted:#c8d6cf;
  --up:#2dd4bf; --down:#f59e0b; --grid:rgba(255,255,255,.06); --axis:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px rgba(255,255,255,.06)}
.wrap{padding:12px 12px 24px;max-width:820px;margin:0 auto}
.hdr{padding:14px 18px}
.price{font-size:34px;font-weight:900;text-align:center}

/* pills removed per request (kept class in case you want to re-enable later) */
.pills{display:none}

.section{margin-top:12px}
.titleRow{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 4px 8px}
.title{font-size:22px;font-weight:900}
.small{font-size:12px;color:var(--muted)}
.canvasBox{padding:8px}
canvas{display:block;width:100%;height:210px;border-radius:12px}
#priceCanvas{height:220px}

.legend{display:flex;align-items:center;gap:14px;font-weight:800}
.dot{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:6px}
.dot.up{background:var(--up)} .dot.down{background:var(--down)}
.maxNote{font-size:13px;opacity:.85}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 2px 0}
.stat{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 0 0 1px rgba(255,255,255,.06)}
.stat h4{margin:0 0 4px;font-size:12px;color:var(--muted)}
.stat strong{font-size:18px}

.badge{position:absolute;padding:2px 6px;border-radius:999px;font-weight:900;font-size:12px;backdrop-filter:blur(2px)}
.badge.total{background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.25)}
.badge.diff.pos{background:rgba(9,95,83,.85);color:#d8fff7;border:1px solid rgba(45,212,191,.55)}
.badge.diff.neg{background:rgba(87,54,3,.9);color:#fff3d4;border:1px solid rgba(245,158,11,.55)}

#conn{position:fixed;left:10px;bottom:10px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08)}
#conn.ok{color:var(--up)} #conn.warn{color:#fbbf24} #conn.err{color:#fb7185}
</style>
</head>
<body>
<span id="conn" class="pill">Connecting…</span>

<div class="wrap">
  <div class="card hdr">
    <div id="livePrice" class="price">$—</div>
    <div class="pills" id="pillRow"><!-- intentionally hidden --></div>
  </div>

  <!-- Dynamic price (1h seed -> live 10m) -->
  <section class="card section">
    <div class="titleRow">
      <div class="title">Dynamic price (1h → live 10m)</div>
      <div class="small" id="covNote">seed 100%</div>
    </div>
    <div class="canvasBox"><canvas id="priceCanvas"></canvas></div>
  </section>

  <!-- Volume (10m, BTC) -->
  <section class="card section">
    <div class="titleRow">
      <div class="title">Per-minute volume (10m, ₿)</div>
      <div class="legend">
        <span class="maxNote" id="maxNote">max ₿0.00</span>
        <span><i class="dot up"></i>Buys</span>
        <span><i class="dot down"></i>Sells</span>
      </div>
    </div>
    <div class="canvasBox" style="padding-bottom:2px"><canvas id="volCanvas" style="height:150px"></canvas></div>
  </section>

  <!-- compact stats -->
  <section class="grid">
    <div class="stat"><h4>Trades / min</h4><strong id="tpm">—</strong></div>
    <div class="stat"><h4>Buy ratio (USD)</h4><strong id="br">—</strong></div>
    <div class="stat"><h4>VWAP</h4><strong id="vwap">—</strong></div>
    <div class="stat"><h4>High / Low</h4><strong id="hilo">—</strong></div>
    <div class="stat"><h4>Range</h4><strong id="rng">—</strong></div>
    <div class="stat"><h4>Avg / Median (USD)</h4><strong id="am">—</strong></div>
  </section>
</div>

<script>
/* ===== utils ===== */
const $=s=>document.querySelector(s);
const fmtUSD=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtUSD0=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const pct1=new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
const btc2=v=>Number(v).toFixed(2);
function cssVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

/* ===== els ===== */
const conn=$('#conn'), livePrice=$('#livePrice'), covNote=$('#covNote');
const maxNote=$('#maxNote');
const tpmEl=$('#tpm'), brEl=$('#br'), vwapEl=$('#vwap'), hiloEl=$('#hilo'), rngEl=$('#rng'), amEl=$('#am');
const priceCanvas=$('#priceCanvas'), pctx=priceCanvas.getContext('2d',{desynchronized:true});
const volCanvas=$('#volCanvas'), vctx=volCanvas.getContext('2d',{desynchronized:true});

/* ===== state ===== */
let seed1h=[];              // [{t,p}] 1-min candles (1h)
let live10m=[];             // [{t,p}] live <=10m
let win10=[];               // trades for 10m stats/volume
let lastPrice=null;
const MS10=600000, DIFF_MIN_BTC=0.15;

/* ===== sizing ===== */
function sizeCanvas(c,ctx){const dpr=Math.max(1,Math.min(devicePixelRatio||1,3)); c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);}
new ResizeObserver(()=>{ sizeCanvas(priceCanvas,pctx); drawPrice(); sizeCanvas(volCanvas,vctx); drawVol(); }).observe(document.body);

/* ===== seed candles (1h) ===== */
function iso(ms){return new Date(ms).toISOString();}
async function get1hSeed(){
  const end=Date.now(), start=end-3600_000;
  const u=`https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=60&start=${encodeURIComponent(iso(start))}&end=${encodeURIComponent(iso(end))}`;
  try{
    const r=await fetch(u,{headers:{Accept:'application/json'}}); const a=await r.json();
    seed1h=a.sort((x,y)=>x[0]-y[0]).map(x=>({t:x[0]*1000,p:+x[4]}));
    sizeCanvas(priceCanvas,pctx); drawPrice();
  }catch{}
}

/* ===== websocket + fallback ===== */
let ws,lastWs=0,recon;
function setConn(state,msg){conn.className=''; conn.classList.add(state==='ok'?'ok':state==='warn'?'warn':'err'); conn.id=state; conn.textContent=msg;}
function startWS(){
  try{ws&&ws.close()}catch{}
  ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');
  setConn('warn','Connecting…');
  ws.onopen=()=>ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
  ws.onmessage=e=>{
    lastWs=Date.now(); setConn('ok','Live');
    try{
      const m=JSON.parse(e.data);
      if(m.type==='match'&&m.product_id==='BTC-USD'){
        const price=+m.price, size=+m.size, side=(m.side||'buy').toLowerCase(), t=new Date(m.time).getTime();
        onTrade({t,price,size,side});
      }
    }catch{}
  };
  ws.onclose=()=>{setConn('warn','Reconnecting…'); recon=setTimeout(startWS,1200)};
  ws.onerror=()=>{setConn('err','Fallback'); try{ws.close()}catch{}};
}
async function restTick(){
  const QUIET=4000, now=Date.now(); if(now-lastWs<QUIET) return;
  try{
    const r=await fetch('https://api.exchange.coinbase.com/products/BTC-USD/trades?limit=10',{headers:{Accept:'application/json'}});
    if(r.ok){
      const arr=await r.json();
      for(let i=arr.length-1;i>=0;i--){
        const t=arr[i];
        onTrade({t:new Date(t.time).getTime(), price:+t.price, size:+t.size, side:(t.side||'buy').toLowerCase()});
      }
      setConn('err','Fallback');
    }
  }catch{}
}
setInterval(restTick,1200);

/* ===== ingestion ===== */
function onTrade({t,price,size,side}){
  if(lastPrice!==null){ livePrice.style.color = price>lastPrice?'var(--up)':price<lastPrice?'var(--down)':'inherit'; }
  lastPrice=price; livePrice.textContent=fmtUSD.format(price);

  live10m.push({t,p:price}); const cut=Date.now()-MS10; while(live10m.length && live10m[0].t<cut) live10m.shift();
  win10.push({t,price,size,side}); while(win10.length && win10[0].t<cut) win10.shift();

  updateStats(); drawPrice(); drawVol();
}

/* ===== stats ===== */
function median(a){const s=[...a].sort((x,y)=>x-y); const n=s.length; return n?(n&1?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):NaN;}
function updateStats(){
  const n=win10.length; if(!n){ tpmEl.textContent='—'; brEl.textContent='—'; vwapEl.textContent='—'; hiloEl.textContent='—'; rngEl.textContent='—'; amEl.textContent='—'; return; }
  const btc=win10.reduce((a,t)=>a+t.size,0), usd=win10.reduce((a,t)=>a+t.price*t.size,0);
  const buy=win10.reduce((a,t)=>a+(t.side==='buy'?t.price*t.size:0),0), sell=usd-buy;
  const hi=Math.max(...win10.map(t=>t.price)), lo=Math.min(...win10.map(t=>t.price));
  const vwap=btc?usd/btc:NaN; const range=hi-lo; const pct=lo?((hi/lo-1)*100):NaN;
  const avg=usd/n, med=median(win10.map(t=>t.price*t.size));
  const span=(win10.at(-1).t-win10[0].t)||1; const tpm=n/(span/60000);
  tpmEl.textContent=tpm.toFixed(1);
  brEl.textContent=`${pct1.format(usd?buy/usd*100:0)}%`;
  vwapEl.textContent=isFinite(vwap)?fmtUSD.format(vwap):'—';
  hiloEl.textContent=`${fmtUSD0.format(hi)} / ${fmtUSD0.format(lo)}`;
  rngEl.textContent=`${fmtUSD0.format(range)} (${isFinite(pct)?pct1.format(pct):'0'}%)`;
  amEl.textContent=`${fmtUSD0.format(avg)} / ${fmtUSD0.format(med)}`;
}

/* ===== dynamic price draw (seed range controls Y) ===== */
function drawPrice(){
  sizeCanvas(priceCanvas,pctx);
  const ctx=pctx, w=priceCanvas.clientWidth, h=priceCanvas.clientHeight, pad=10, xpad=38;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='var(--grid)'; for(let i=1;i<=4;i++){const y=(h/5)*i; ctx.beginPath(); ctx.moveTo(xpad,y); ctx.lineTo(w-6,y); ctx.stroke();}

  const now=Date.now(), start=now-70*60000;
  const seed = seed1h.filter(d=>d.t>=start);
  const live = live10m;

  if((seed.length+live.length)<2) return;

  // coverage
  let cov=0; if(live.length>=2){ const span=live.at(-1).t-live[0].t; cov=Math.max(0,Math.min(1,span/MS10)); }
  covNote.textContent = live.length>=2 ? `live ${Math.round(cov*100)}%` : 'seed 100%';

  // *** Y-domain from seed 1h high/low so the line spans the labels exactly ***
  const minSeed = seed.length? Math.min(...seed.map(d=>d.p)) : Math.min(...live.map(d=>d.p));
  const maxSeed = seed.length? Math.max(...seed.map(d=>d.p)) : Math.max(...live.map(d=>d.p));
  const minY=minSeed, maxY=maxSeed; const R=(maxY-minY)||1;
  const avgSeed = seed.length? seed.reduce((a,b)=>a+b.p,0)/seed.length : (minY+maxY)/2;

  const y=p=> pad + (h-2*pad) - ((p-minY)/R)*(h-2*pad);
  const x=t=> xpad + ((t-(now-MS10))/MS10) * (w - xpad - 8);

  // seed alpha fade only when we have meaningful live points
  const seedAlpha = (live.length>=2) ? Math.max(0, 1 - cov) : 1;
  const seedAlphaFloor = (live.length>=2) ? 0.35 : 1;
  const seedA = Math.max(seedAlpha, seedAlphaFloor*(seed.length?1:0));

  // draw seed
  if(seed.length>=2 && seedA>0){
    ctx.save(); ctx.globalAlpha=seedA; ctx.lineWidth=2; ctx.strokeStyle='#a3a3a3';
    ctx.beginPath(); for(let i=0;i<seed.length;i++){ const d=seed[i]; const xx=x(d.t), yy=y(d.p); if(i===0)ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); }
    ctx.stroke(); ctx.restore();
  }

  // draw live
  if(live.length>=2){
    ctx.lineWidth=2.25;
    for(let i=1;i<live.length;i++){
      const p0=live[i-1].p, p1=live[i].p;
      ctx.strokeStyle = (p1>=avgSeed)?cssVar('--up'):cssVar('--down');
      ctx.beginPath(); ctx.moveTo(x(live[i-1].t),y(p0)); ctx.lineTo(x(live[i].t),y(p1)); ctx.stroke();
    }
  }

  // labels (use seed domain so they match range visually)
  ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  ctx.fillText(fmtUSD0.format(maxY), 6, y(maxY));
  ctx.fillText(fmtUSD0.format(avgSeed), 6, y(avgSeed));
  ctx.fillText(fmtUSD0.format(minY), 6, y(minY));
  ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(200,214,207,.6)'; ctx.beginPath(); ctx.moveTo(xpad,y(avgSeed)); ctx.lineTo(w-8,y(avgSeed)); ctx.stroke(); ctx.restore();

  // time ticks every 2 minutes for the 10m window
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.textAlign='center'; ctx.textBaseline='top';
  for(let i=0;i<=10;i+=2){
    const t = now - MS10 + i*60000, xx=x(t);
    ctx.beginPath(); ctx.moveTo(xx,h-18); ctx.lineTo(xx,h-8); ctx.strokeStyle='var(--axis)'; ctx.stroke();
    ctx.fillText(':'+new Date(t).toLocaleTimeString([],{minute:'2-digit'}), xx, h-16);
  }

  // If you want the chart to switch to a pure 10m live domain at 100% coverage,
  // you can recompute minY/maxY from live only when cov>=1 and redraw – left as a toggle.
}

/* ===== volume (locked 1m bins, right->left) ===== */
function startAligned(){const now=Date.now(); const ms=now-(now%60000); return ms-9*60000;}
function bins10(){
  const start=startAligned();
  const b=Array.from({length:10},(_,i)=>({ts:start+i*60000,buy:0,sell:0}));
  for(const t of win10){
    if(t.t<start || t.t>=start+10*60000) continue;
    const idx=Math.min(9,Math.max(0,Math.floor((t.t-start)/60000)));
    if(t.side==='buy') b[idx].buy+=t.size; else b[idx].sell+=t.size;
  }
  return b;
}
function drawVol(){
  sizeCanvas(volCanvas,vctx);
  const w=volCanvas.clientWidth, h=volCanvas.clientHeight, padX=30, padT=8, padB=24, innerH=h-padT-padB;
  const bins=bins10(); const totals=bins.map(b=>b.buy+b.sell); const max=Math.max(1,...totals);
  maxNote.textContent=`max ₿${btc2(Math.max(...totals)||0)}`;

  vctx.clearRect(0,0,w,h);
  vctx.strokeStyle='var(--grid)'; for(let i=1;i<=3;i++){const y=padT+innerH*(i/4*(4/3)); vctx.beginPath(); vctx.moveTo(padX-6,y); vctx.lineTo(w-padX+6,y); vctx.stroke();}

  const step=(w-padX*2)/10, barW=Math.max(10,step*0.65), baseY=padT+innerH;

  for(let i=bins.length-1;i>=0;i--){
    const b=bins[i], xC=w-padX-((bins.length-1-i)*step)-step/2, tot=b.buy+b.sell;
    const hTot=Math.max(innerH*0.06,(tot/max)*innerH), hBuy=tot?(b.buy/tot)*hTot:0, hSell=hTot-hBuy;
    vctx.fillStyle=cssVar('--down'); vctx.fillRect(xC-barW/2,baseY-hSell,barW,hSell);
    vctx.fillStyle=cssVar('--up');   vctx.fillRect(xC-barW/2,baseY-hSell-hBuy,barW,hBuy);

    // total badge (only if tall enough)
    if(hTot>16 && tot>0) pill(vctx,xC, baseY-hTot-14, `₿${btc2(tot)}`, 'total');

    // diff badge if meaningful
    const diff=b.buy-b.sell;
    if(Math.abs(diff)>=DIFF_MIN_BTC){
      pill(vctx,xC, baseY-hSell-hBuy/2, `${diff>0?'+':''}${btc2(diff)}`, diff>0?'pos':'neg');
    }

    if(i%2===1){
      vctx.fillStyle='rgba(255,255,255,.8)'; vctx.font='11px system-ui'; vctx.textAlign='center'; vctx.textBaseline='top';
      vctx.fillText(':'+new Date(b.ts).toLocaleTimeString([],{minute:'2-digit'}), xC, baseY+4);
    }
  }
}
function pill(ctx,cx,cy,text,kind){
  ctx.save();
  ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textBaseline='middle';
  const padX=8, w=ctx.measureText(text).width+padX*2, h=18, x=Math.round(cx-w/2), y=Math.round(cy-h/2);
  ctx.beginPath();
  ctx.moveTo(x+9,y); ctx.arcTo(x+w,y,x+w,y+h,9); ctx.arcTo(x+w,y+h,x,y+h,9);
  ctx.arcTo(x,y+h,x,y,9); ctx.arcTo(x,y,x+w,y,9); ctx.closePath();
  if(kind==='total'){ ctx.fillStyle='rgba(0,0,0,.80)'; ctx.strokeStyle='rgba(255,255,255,.22)' }
  else if(kind==='pos'){ ctx.fillStyle='rgba(9,95,83,.88)'; ctx.strokeStyle='rgba(45,212,191,.55)' }
  else { ctx.fillStyle='rgba(87,54,3,.92)'; ctx.strokeStyle='rgba(245,158,11,.55)' }
  ctx.fill(); ctx.stroke();
  ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.fillText(text,cx,cy+0.5);
  ctx.restore();
}

/* ===== boot ===== */
sizeCanvas(priceCanvas,pctx); sizeCanvas(volCanvas,vctx);
get1hSeed(); startWS(); setInterval(()=>{ // keep labels/stats responsive even with low trade rates
  drawPrice(); drawVol();
}, 1000);
</script>
</body>
</html>