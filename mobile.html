<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>h8s — mobile</title>
<style>
  /* ---------- THEME TOKENS ---------- */
  :root{
    --bg:#0a0a0a; --panel:#111; --panel-2:#0d0d0d;
    --text:#e9fef7; --muted:#c8d6cf;
    --up:#2dd4bf; --down:#f59e0b;
    --grid:rgba(255,255,255,.08); --grid-2:rgba(255,255,255,.06);
    --pill-bg:rgba(255,255,255,.06); --pill-bd:rgba(255,255,255,.12);
    --glow:0 0 0 1px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.45);
  }
  /* Extra palettes (match desktop feel) */
  body[data-theme="teal-amber"] { --up:#2dd4bf; --down:#f59e0b; }
  body[data-theme="violet-lime"]{ --up:#a78bfa; --down:#84cc16; }
  body[data-theme="cyan-coral"] { --up:#22d3ee; --down:#fb7185; }
  body[data-theme="slate-peach"]{ --up:#60a5fa; --down:#fca5a5; }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

  .wrap{padding:14px 14px 90px; max-width:900px; margin:0 auto;}
  .card{background:var(--panel); border-radius:14px; box-shadow:var(--glow)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; 
        border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd);
        font-size:12px; white-space:nowrap;}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .muted{opacity:.8}
  .bigPrice{font-weight:900; font-size: clamp(24px,7.8vw,44px); letter-spacing:.5px; text-align:center; margin:18px 0 6px}
  .bigPrice.up{color:var(--up)} .bigPrice.down{color:var(--down)}

  .chartBox{padding:10px 10px 6px}
  canvas{display:block; width:100%; height:240px; border-radius:12px; background:var(--panel-2)}
  .volBox canvas{height:210px}

  .legend{display:flex; align-items:center; gap:16px; padding:10px 10px 4px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}

  /* ---------- SETTINGS (gear) ---------- */
  .gearBtn{
    position:fixed; top:10px; left:10px; z-index:40;
    width:36px; height:36px; border-radius:10px; background:var(--panel);
    display:grid; place-items:center; border:1px solid var(--pill-bd); box-shadow:var(--glow); cursor:pointer;
  }
  .gearBtn svg{width:18px; height:18px; fill:var(--text); opacity:.9}

  .sheet{
    position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:39; display:none;
  }
  .sheet.open{display:block}
  .sheetPanel{
    position:absolute; left:12px; right:12px; top:12px;
    background:var(--panel); border:1px solid var(--pill-bd); border-radius:14px; box-shadow:var(--glow);
    padding:14px;
  }
  .sheet h3{margin:0 0 8px; font-size:14px; opacity:.92}
  .optRow{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px}
  .chip{border:1px solid var(--pill-bd); background:var(--panel-2); padding:8px 10px; border-radius:10px; font-size:13px; cursor:pointer}
  .chip.active{outline:2px solid var(--up)}
  .field{display:flex; gap:10px; align-items:center}
  .field input[type="number"]{width:120px; padding:8px 10px; border-radius:10px; background:var(--panel-2); border:1px solid var(--pill-bd); color:var(--text)}
  .sheet .row{margin-top:10px}
  .btn{padding:8px 12px; border-radius:10px; border:1px solid var(--pill-bd); background:var(--panel-2); color:var(--text); cursor:pointer}
  .btn.save{background:var(--up); color:#00130f; border-color:transparent}
  .btn.close{opacity:.85}
</style>
</head>
<body data-theme="teal-amber">
  <!-- SETTINGS BUTTON -->
  <button class="gearBtn" id="gearBtn" aria-label="settings">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm9.44-3.5c0-.45-.04-.9-.1-1.33l2.13-1.66a1 1 0 0 0 .23-1.32l-2-3.46a1 1 0 0 0-1.22-.44l-2.5 1a9.77 9.77 0 0 0-2.3-1.33l-.38-2.64A1 1 0 0 0 12.64 0h-4a1 1 0 0 0-.99.84L7.27 3.5a9.84 9.84 0 0 0-2.3 1.33l-2.5-1a1 1 0 0 0-1.22.44l-2 3.46a1 1 0 0 0 .23 1.32L1.6 10.67c-.07.43-.11.88-.11 1.33s.04.9.1 1.33l-2.13 1.66a1 1 0 0 0-.23 1.32l2 3.46a1 1 0 0 0 1.22.44l2.5-1c.7.54 1.48.99 2.3 1.33l.38 2.64a1 1 0 0 0 .99.84h4a1 1 0 0 0 .99-.84l.38-2.64a9.77 9.77 0 0 0 2.3-1.33l2.5 1a1 1 0 0 0 1.22-.44l2-3.46a1 1 0 0 0-.23-1.32l-2.13-1.66c.07-.43.11-.88.11-1.33Z"/></svg>
  </button>

  <!-- SETTINGS SHEET -->
  <div class="sheet" id="sheet">
    <div class="sheetPanel">
      <div class="row">
        <h3 style="margin:0">Settings</h3>
        <button class="btn close" id="closeSheet">Close</button>
      </div>

      <h3>Theme</h3>
      <div class="optRow" id="themeRow">
        <button class="chip" data-theme="teal-amber">Teal / Amber</button>
        <button class="chip" data-theme="violet-lime">Violet / Lime</button>
        <button class="chip" data-theme="cyan-coral">Cyan / Coral</button>
        <button class="chip" data-theme="slate-peach">Slate / Peach</button>
      </div>

      <h3>Price scale</h3>
      <div class="field">
        <label for="sizeBTC" class="muted">BTC amount&nbsp;</label>
        <input id="sizeBTC" type="number" min="0.00000001" step="0.0001" value="1.0" />
        <span class="muted">Big price = BTC amount × spot</span>
      </div>

      <div class="row">
        <button class="btn" id="resetBtn">Reset</button>
        <div style="flex:1"></div>
        <button class="btn save" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="card chartBox">
      <div id="bigPrice" class="bigPrice">$—</div>
      <canvas id="priceCanvas"></canvas>
      <div class="legend">
        <span class="dot up"></span><span class="muted">Buys</span>
        <span class="dot down"></span><span class="muted">Sells</span>
        <span style="margin-left:auto" class="pill muted" id="maxVolPill">max ₿—</span>
      </div>
      <canvas id="volCanvas"></canvas>
    </section>
    <div class="pill" id="connPill" style="position:fixed;left:14px;bottom:14px;z-index:30">Live</div>
  </main>

<script>
/* =========================
   SETTINGS / THEME / SCALE
   ========================= */
const gearBtn = document.getElementById('gearBtn');
const sheet = document.getElementById('sheet');
const closeSheet = document.getElementById('closeSheet');
const themeRow = document.getElementById('themeRow');
const sizeBTCInput = document.getElementById('sizeBTC');
const resetBtn = document.getElementById('resetBtn');
const saveBtn = document.getElementById('saveBtn');

const store = {
  get(){ try{ return JSON.parse(localStorage.getItem('m.settings')||'{}'); }catch{ return {}; } },
  set(v){ localStorage.setItem('m.settings', JSON.stringify(v)); }
};
const settings = Object.assign({ theme:'teal-amber', sizeBTC:1.0 }, store.get());

document.body.dataset.theme = settings.theme;
sizeBTCInput.value = settings.sizeBTC;

function paintThemeChips(){
  [...themeRow.querySelectorAll('.chip')].forEach(ch=>{
    ch.classList.toggle('active', ch.dataset.theme===settings.theme);
  });
}
paintThemeChips();

gearBtn.onclick = ()=> sheet.classList.add('open');
closeSheet.onclick = ()=> sheet.classList.remove('open');
sheet.addEventListener('click',(e)=>{ if(e.target===sheet) sheet.classList.remove('open'); });

themeRow.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  settings.theme = chip.dataset.theme;
  document.body.dataset.theme = settings.theme;
  paintThemeChips();
});
resetBtn.onclick = ()=>{
  settings.theme = 'teal-amber';
  settings.sizeBTC = 1.0;
  document.body.dataset.theme = settings.theme;
  sizeBTCInput.value = settings.sizeBTC;
  paintThemeChips();
  store.set(settings);
  drawAll();
  updateBigPrice();
  sheet.classList.remove('open');
};
saveBtn.onclick = ()=>{
  const v = parseFloat(sizeBTCInput.value);
  settings.sizeBTC = Number.isFinite(v)&&v>0 ? v : 1.0;
  store.set(settings);
  updateBigPrice();
  sheet.classList.remove('open');
};

/* =========================
   LIVE DATA / CHARTS
   (10m price + volume)
   ========================= */
const priceEl = document.getElementById('bigPrice');
const priceCanvas = document.getElementById('priceCanvas');
const volCanvas = document.getElementById('volCanvas');
const maxVolPill = document.getElementById('maxVolPill');
const connPill = document.getElementById('connPill');

let lastPrice = null;
let series = [];             // [{t, p}]
let volBins = [];            // [{ts, buy, sell}] 10 slots
const MS10 = 600000;

function initBins(){
  const now = Date.now();
  const start = now - (now % 60000) - 9*60000;
  volBins = Array.from({length:10}, (_,i)=>({ts:start+i*60000, buy:0, sell:0}));
}
initBins();

function sizeCanvas(c){
  const dpr = Math.min(3, window.devicePixelRatio||1);
  c.width = Math.max(1, c.clientWidth * dpr);
  c.height = Math.max(1, c.clientHeight * dpr);
  const ctx = c.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

function updateBigPrice(){
  if(lastPrice==null){ priceEl.textContent = '$—'; return; }
  const val = lastPrice * (settings.sizeBTC||1);
  priceEl.textContent = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}).format(val);
}
function setPriceTrend(p){
  if(lastPrice==null){ lastPrice=p; return; }
  priceEl.classList.remove('up','down');
  if(p>lastPrice) priceEl.classList.add('up');
  else if(p<lastPrice) priceEl.classList.add('down');
  lastPrice = p;
}

function onTrade(tr){
  const {price, size, side, time} = tr;
  const ts = new Date(time).getTime();
  series.push({t: ts, p: price});
  // Volume bin
  const startAligned = ts - (ts % 60000) - 9*60000;
  while(volBins.length && volBins[0].ts < startAligned) volBins.shift();
  while(volBins.length<10){
    const lastTs = volBins.length? volBins[volBins.length-1].ts : startAligned;
    volBins.push({ts:lastTs+60000, buy:0, sell:0});
  }
  const i = Math.min(9, Math.max(0, Math.floor((ts - volBins[0].ts)/60000)));
  if(side==='buy') volBins[i].buy += size; else volBins[i].sell += size;

  // price
  setPriceTrend(price);
  updateBigPrice();
}

function prune(){
  const now = Date.now();
  series = series.filter(d=> d.t >= now - MS10);
}

function drawPrice(){
  const ctx = sizeCanvas(priceCanvas);
  const w = priceCanvas.clientWidth, h = priceCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  if(series.length<2) return;

  // min/max in view
  const min = Math.min(...series.map(d=>d.p));
  const max = Math.max(...series.map(d=>d.p));
  const range = (max-min)||1;
  const padY = 18, padX = 10;

  // grid
  ctx.strokeStyle='var(--grid)';
  ctx.lineWidth=1;
  for(let i=1;i<=3;i++){
    const y = padY + (h-2*padY)*(i/4*(4/3));
    ctx.beginPath(); ctx.moveTo(padX,y); ctx.lineTo(w-padX,y); ctx.stroke();
  }
  // avg line
  const avg = series.reduce((a,d)=>a+d.p,0)/series.length;
  const yAvg = padY + (h-2*padY) * (1 - (avg-min)/range);
  ctx.setLineDash([6,6]);
  ctx.strokeStyle='rgba(255,255,255,.35)';
  ctx.beginPath(); ctx.moveTo(padX,yAvg); ctx.lineTo(w-padX,yAvg); ctx.stroke();
  ctx.setLineDash([]);

  // Catmull–Rom -> Bézier smoothing
  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  ctx.strokeStyle = up;
  ctx.lineWidth = 2.25;
  ctx.lineJoin = 'round'; ctx.lineCap='round';

  // map to x,y
  const leftStart = padX;               // start at left and grow right
  const span = MS10;
  const now = Date.now();
  const pts = series.map(d=>{
    const x = leftStart + ( (d.t-(now-span)) / span ) * (w-2*padX);
    const y = padY + (h-2*padY) * (1 - (d.p-min)/range);
    return {x,y};
  });

  if(pts.length<2) return;

  const cr2bz = (p0,p1,p2,p3,t=0.5)=>{
    const d1x = (p2.x-p0.x)*t, d1y=(p2.y-p0.y)*t;
    const d2x = (p3.x-p1.x)*t, d2y=(p3.y-p1.y)*t;
    return [{x:p1.x+d1x/3,y:p1.y+d1y/3},{x:p2.x-d2x/3,y:p2.y-d2y/3}];
  };
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i-1]||pts[i], p1=pts[i], p2=pts[i+1], p3=pts[i+2]||p2;
    const [c1,c2]=cr2bz(p0,p1,p2,p3,0.5);
    ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,p2.x,p2.y);
  }
  ctx.stroke();

  // last price pill
  const last = pts[pts.length-1];
  const val = lastPrice * (settings.sizeBTC||1);
  const label = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(val);
  ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
  const tw = ctx.measureText(label).width+18, th=22;
  const bx = Math.min(w-tw-8, Math.max(8, last.x - tw/2)), by = Math.max(8, last.y- th-8);
  ctx.fillStyle='rgba(0,0,0,.8)'; ctx.strokeStyle='rgba(255,255,255,.25)';
  roundRect(ctx,bx,by,tw,th,10,true,true);
  ctx.fillStyle='#fff'; ctx.textBaseline='middle'; ctx.fillText(label, bx+9, by+th/2);
}

function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); 
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

function drawVol(){
  const ctx = sizeCanvas(volCanvas);
  const w = volCanvas.clientWidth, h = volCanvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-2').trim();
  ctx.fillRect(0,0,w,h);

  const max = Math.max(0.01, ...volBins.map(b=>b.buy+b.sell));
  maxVolPill.textContent = `max ₿${max.toFixed(2)}`;

  const padX=16, padTop=14, padBottom=22;
  const chartH = h - padTop - padBottom;
  const step = (w - padX*2) / volBins.length;
  const barW = step*0.62;

  const up = getComputedStyle(document.body).getPropertyValue('--up').trim();
  const dn = getComputedStyle(document.body).getPropertyValue('--down').trim();

  // grid
  ctx.strokeStyle='var(--grid-2)';
  for(let i=1;i<=2;i++){
    const y = padTop + chartH*(i/3*(3/2));
    ctx.beginPath(); ctx.moveTo(padX-6,y); ctx.lineTo(w-padX+6,y); ctx.stroke();
  }

  for(let i=0;i<volBins.length;i++){
    const b = volBins[i];
    const xC = padX + i*step + step/2;
    const tot = b.buy + b.sell;
    const hT = Math.max(4, (tot/max)*chartH);
    const hBuy = tot?(b.buy/tot)*hT:0, hSell=hT-hBuy;
    const yB = padTop + chartH;

    // stacked
    ctx.fillStyle = dn; ctx.fillRect(xC-barW/2, yB-hSell, barW, hSell);
    ctx.fillStyle = up; ctx.fillRect(xC-barW/2, yB-hSell-hBuy, barW, hBuy);

    // label pill with +/- diff (buy - sell) only if bar tall enough
    if(hT>26){
      const diff = b.buy - b.sell; // BTC
      const txt = `${diff>=0?'+':''}${diff.toFixed(2)}`;
      const tw = ctx.measureText(txt).width+16, th=20;
      const bx = xC - tw/2, by = yB - hT - th - 4;
      ctx.fillStyle='rgba(0,0,0,.88)'; ctx.strokeStyle='rgba(255,255,255,.25)';
      roundRect(ctx,bx,by,tw,th,10,true,true);
      ctx.fillStyle = diff>=0 ? up : dn;
      ctx.textBaseline='middle'; ctx.fillText(txt, bx+8, by+th/2);
    }
  }
}

function drawAll(){ prune(); drawPrice(); drawVol(); requestAnimationFrame(drawAll); }

/* =========================
   FEED
   ========================= */
let ws, recon;
function startWS(){
  try{ ws && ws.close(); }catch{}
  ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
  ws.onopen = ()=> {
    ws.send(JSON.stringify({type:'subscribe',product_ids:['BTC-USD'],channels:['matches']}));
    connPill.textContent='Live';
  };
  ws.onmessage = (e)=>{
    try{
      const m = JSON.parse(e.data);
      if(m.type==='match' && m.product_id==='BTC-USD'){
        onTrade({price:+m.price,size:+m.size,side:m.side,time:m.time});
      }
    }catch{}
  };
  ws.onclose = ()=> { connPill.textContent='Reconnecting…'; recon=setTimeout(startWS,1000); };
  ws.onerror = ()=> { try{ws.close()}catch{} };
}
startWS();

/* =========================
   LAYOUT WATCHERS
   ========================= */
new ResizeObserver(()=>{ drawAll(); }).observe(document.body);
requestAnimationFrame(drawAll);
</script>
</body>
</html>